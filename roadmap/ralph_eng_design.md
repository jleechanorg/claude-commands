# Proto Genesis Interactive Goal Refinement System - Engineering Design

## Table of Contents
1. [Engineering Goals](#engineering-goals)
2. [Technical Overview](#technical-overview)
3. [System Architecture](#system-architecture)
4. [Implementation Details](#implementation-details)
5. [Integration Points](#integration-points)
6. [Usage Patterns](#usage-patterns)
7. [Decision Records](#decision-records)

## Engineering Goals

### Primary Engineering Goals
- **Simplicity First**: Simple Python script using subprocess calls to `claude -p --dangerously-skip-permissions`
- **Manual Control**: User controls execution through copy-paste commands generated by `/raph`
- **Goal Integration**: Seamless integration with existing `/goal` command for structured goal refinement
- **Session Persistence**: Basic JSON-based session tracking for iteration management

### Secondary Engineering Goals
- **Dual Mode Operation**: Standard mode (goal directory) and interactive mode (`--refine` flag)
- **Progress Tracking**: Update goal directory files during iteration execution
- **Error Handling**: Graceful fallbacks when Claude CLI unavailable
- **Clean Separation**: `/proto_genesis` handles setup, `proto_genesis.py` handles execution

## Technical Overview

Proto Genesis is a lightweight goal refinement system that uses direct subprocess calls to the Claude CLI. The system operates in two phases: interactive goal setup via `/proto_genesis` slash command, followed by manual execution of the generated `proto_genesis.py` command.

**Architecture Approach**: Simple procedural Python script with subprocess integration
**Technology Choices**: Python 3.x, subprocess module, JSON for persistence, integration with existing `/goal` command
**Integration Points**: `/goal` command, `/converge` pattern, `/consensus` evaluation, goal directory structure

## System Architecture

### Core Components

```
/proto_genesis slash command
├── Uses /goal command for interactive refinement
├── Generates copy-paste command for proto_genesis.py
└── Provides manual execution control

proto_genesis.py script
├── load_goal_from_directory() - Read from goal directory structure
├── refine_goal_interactive() - Interactive refinement (--refine mode)
├── make_progress() - Execute /converge via claude -p
├── check_consensus() - Execute /consensus via claude -p
├── update_progress_file() - Update goal directory files
└── run_claude() - Subprocess wrapper for claude -p calls
```

### Data Flow

```
1. User: /proto_genesis "goal description"
2. /proto_genesis → /goal command (interactive refinement)
3. /goal creates: goals/YYYY-MM-DD-HHMM-slug/
4. /proto_genesis generates: python proto_genesis.py goals/YYYY-MM-DD-HHMM-slug/ 10
5. User copies and runs command manually
6. proto_genesis.py loads goal from directory
7. proto_genesis.py iterates: make_progress() → check_consensus()
8. Progress saved to goal directory and session JSON
```

## Implementation Details

### Core Functions

#### `run_claude(prompt, timeout=300)`
- **Purpose**: Execute `claude -p --dangerously-skip-permissions` with subprocess
- **Error Handling**: Timeout, FileNotFoundError, general exceptions
- **Returns**: stdout.strip() on success, None on failure

#### `load_goal_from_directory(goal_dir)`
- **Purpose**: Read refined goal and exit criteria from `/goal` directory structure
- **Files Read**: `00-goal-definition.md`, `01-success-criteria.md`
- **Parsing**: Extract refined goal and criteria from markdown files
- **Fallbacks**: Graceful handling of missing or malformed files

#### `make_progress(refined_goal, iteration_num, previous_work)`
- **Purpose**: Execute `/converge` pattern for goal progress
- **Prompt Structure**: Structured prompt with goal, iteration context, previous work
- **Output Format**: WORK COMPLETED, CHALLENGES, PROGRESS %, NEXT STEPS
- **Integration**: Uses claude -p subprocess call

#### `check_consensus(refined_goal, exit_criteria, all_work_done)`
- **Purpose**: Execute `/consensus` pattern for goal evaluation
- **Assessment Areas**: Completion percentage, criteria met, remaining gaps
- **Output Format**: COMPLETION %, CRITERIA MET, REMAINING GAPS, EXPLANATION
- **Integration**: Uses claude -p subprocess call

### Session Management

#### JSON Persistence
```json
{
  "goal_directory": "goals/timestamp-slug/",
  "refined_goal": "specific technical description",
  "exit_criteria": "formatted criteria text",
  "max_iterations": 10,
  "current_iteration": 3,
  "work_completed": ["iteration summaries"],
  "latest_consensus": "consensus evaluation"
}
```

#### Goal Directory Updates
- **File**: `02-progress-tracking.md`
- **Updates**: Append iteration data after each cycle
- **Format**: Markdown with iteration headers and structured data
- **Purpose**: Maintain progress history in goal directory

### Command Line Interface

#### Standard Mode (Default)
```bash
python ralph.py goals/2025-01-22-1530-rest-api/ 10
```
- Loads goal from directory structure
- Executes specified number of iterations
- Updates goal directory files
- Saves session JSON to goal directory

#### Interactive Mode (--refine flag)
```bash
python ralph.py --refine "build a REST API" 5
```
- Interactive goal refinement loop
- User approval for refined goals
- Saves session JSON to current directory
- Bypasses goal directory integration

## Integration Points

### `/goal` Command Integration
- **Directory Structure**: Uses standard goal directory layout
- **File Parsing**: Reads `00-goal-definition.md` and `01-success-criteria.md`
- **Progress Updates**: Writes to `02-progress-tracking.md`
- **Metadata**: Respects `metadata.json` structure

### Slash Command Integration
- **File**: `.claude/commands/proto_genesis.md`, `.claude/commands/pgen.md` (alias)
- **Execution**: Uses `/goal` command for refinement
- **Output**: Generates copy-paste commands
- **Exclusion**: Not exported via `/exportcommands`

### Claude CLI Integration
- **Command**: `claude -p --dangerously-skip-permissions`
- **Input**: Structured prompts via stdin
- **Output**: Parsed from stdout
- **Error Handling**: Subprocess timeout and error management

## Usage Patterns

### Typical Workflow
```bash
# Step 1: Interactive goal setup
/proto_genesis "build user authentication system"
# Or use alias: /pgen "build user authentication system"

# Step 2: Copy generated command
python proto_genesis.py goals/2025-01-22-1530-user-auth/ 10

# Step 3: Review progress in goal directory
cat goals/2025-01-22-1530-user-auth/02-progress-tracking.md
```

### Development Workflow
```bash
# Direct usage with refinement
python proto_genesis.py --refine "add JWT authentication" 5

# Resume interrupted session
python proto_genesis.py goals/existing-goal-dir/ 15
```

### Error Recovery
- **Claude CLI Missing**: Clear error message with installation guidance
- **Goal Directory Missing**: Error with path validation
- **Malformed Goal Files**: Fallback parsing with warnings
- **Subprocess Timeout**: Graceful handling with retry suggestions

## Decision Records

### **Decision**: Direct Claude CLI Integration via Subprocess
**Date**: 2025-01-XX
**Context**: Need to integrate with Claude for goal refinement iterations
**Options**:
1. Direct subprocess calls to `claude -p`
2. API integration with Cerebras/other services
3. MCP integration complexity
**Rationale**: Subprocess approach is simple, reliable, and leverages existing CLI tool
**Consequences**: Requires Claude CLI installation, but provides maximum simplicity and control

### **Decision**: Manual Execution Control
**Date**: 2025-01-XX
**Context**: User requested copy-paste commands rather than automatic execution
**Options**:
1. Automatic execution from `/raph`
2. Copy-paste command generation
3. Hybrid approach with user choice
**Rationale**: Copy-paste provides user control and visibility into execution commands
**Consequences**: Two-step workflow, but user maintains full control over when and how execution happens

### **Decision**: JSON Session Persistence
**Date**: 2025-01-XX
**Context**: Need to maintain state across iterations and interruptions
**Options**:
1. In-memory only (lose state on interruption)
2. JSON file persistence
3. Database storage
**Rationale**: JSON provides simplicity with human-readable debugging capability
**Consequences**: Manual session cleanup required, but adequate for expected usage patterns

### **Decision**: Goal Directory Integration
**Date**: 2025-01-XX
**Context**: Need to integrate with existing `/goal` command structure
**Options**:
1. Independent goal management
2. Integration with `/goal` directory structure
3. Hybrid approach with migration
**Rationale**: Leverage existing `/goal` infrastructure for consistency and user familiarity
**Consequences**: Dependency on `/goal` command, but provides seamless workflow integration

## File Structure

### Repository Layout
```
proto_genesis.py                      # Main execution script (368 lines)
.claude/commands/proto_genesis.md     # Slash command definition
.claude/commands/pgen.md              # Alias command
roadmap/ralph_eng_design.md          # This engineering design document
```

### Goal Directory Structure (Created by `/goal`)
```
goals/YYYY-MM-DD-HHMM-[slug]/
├── 00-goal-definition.md         # Original and refined goal (read by proto_genesis.py)
├── 01-success-criteria.md        # Exit criteria (read by proto_genesis.py)
├── 02-progress-tracking.md       # Progress updates (written by proto_genesis.py)
├── 03-validation-log.md          # Validation attempts (unused by proto_genesis.py)
├── metadata.json                 # Goal metadata (unused by proto_genesis.py)
└── proto_genesis_session.json    # Session data (created by proto_genesis.py)
```

## Quality Considerations

### Error Handling Strategy
- **Subprocess Failures**: Clear error messages with actionable guidance
- **File I/O Issues**: Graceful degradation with progress preservation
- **Claude CLI Unavailability**: Informative error with installation instructions
- **Goal Directory Corruption**: Fallback parsing with user notification

### User Experience
- **Clear Command Usage**: Comprehensive help text with examples
- **Progress Visibility**: Real-time iteration feedback and session saving
- **Manual Control**: User decides when and how to execute iterations
- **Session Recovery**: Can resume interrupted sessions from goal directory

### Maintainability
- **Simple Architecture**: Procedural Python with clear function boundaries
- **Minimal Dependencies**: Uses standard library plus subprocess
- **Self-Contained**: Single file execution with clear integration points
- **Documentation**: Clear docstrings and inline comments for key functions

This engineering design reflects the actual simple, effective implementation of the Proto Genesis system as built, focusing on subprocess integration and manual execution control rather than complex API management.
