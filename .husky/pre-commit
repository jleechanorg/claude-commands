#!/bin/sh
# Husky pre-commit hook for WorldArchitect.AI
# Runs code quality checks before allowing commits

echo "üîç Running pre-commit checks..."
echo ""

# Exit on first error
set -e

# Get list of staged Python files (null-terminated for safe handling)
STAGED_PY_FILES=$(git diff --cached --name-only --diff-filter=ACM -z | grep -z '\.py$' || true)

if [ -n "$STAGED_PY_FILES" ]; then
    # 1. Python: Ruff linting (includes import sorting via "I" rule)
    echo "üìã Running ruff check on staged files..."
    if command -v ruff >/dev/null 2>&1; then
        printf '%s' "$STAGED_PY_FILES" | xargs -0 ruff check --fix
        # Re-stage files that were auto-fixed
        printf '%s' "$STAGED_PY_FILES" | xargs -0 git add
        echo "‚úÖ Ruff check passed"
    else
        echo "‚ö†Ô∏è  Warning: ruff not found, skipping Python linting"
    fi
    echo ""

    # 2. Python: Ruff formatting
    echo "üé® Checking Python formatting on staged files..."
    if command -v ruff >/dev/null 2>&1; then
        printf '%s' "$STAGED_PY_FILES" | xargs -0 ruff format
        # Re-stage formatted files
        printf '%s' "$STAGED_PY_FILES" | xargs -0 git add
        echo "‚úÖ Python formatting passed"
    else
        echo "‚ö†Ô∏è  Warning: ruff not found, skipping Python formatting"
    fi
    echo ""
else
    echo "‚ÑπÔ∏è  No staged Python files to check"
    echo ""
fi

# 3. JavaScript/MJS: ESLint on staged files (null-terminated for safe handling)
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM -z | grep -zE '\.(js|mjs)$' || true)

if [ -n "$STAGED_JS_FILES" ]; then
    echo "üìã Running ESLint on staged files..."
    if [ -f "package.json" ]; then
        printf '%s' "$STAGED_JS_FILES" | xargs -0 npx eslint --fix
        # Re-stage fixed files
        printf '%s' "$STAGED_JS_FILES" | xargs -0 git add
        echo "‚úÖ ESLint passed"
    else
        echo "‚ö†Ô∏è  Warning: package.json not found, skipping ESLint"
    fi
    echo ""
else
    echo "‚ÑπÔ∏è  No staged JavaScript files to check"
    echo ""
fi

# 4. Python: Quick test validation (optional - can be commented out if too slow)
# Uncomment the following lines to run tests on pre-commit:
# echo "üß™ Running quick Python tests..."
# if [ -f "run_tests.sh" ]; then
#     # Run tests for changed files only (intelligent mode)
#     ./run_tests.sh
#     echo "‚úÖ Tests passed"
# else
#     echo "‚ö†Ô∏è  Warning: run_tests.sh not found, skipping tests"
# fi
# echo ""

echo "‚úÖ All pre-commit checks passed!"
echo ""
echo "üí° Tip: Use 'git commit --no-verify' to skip these checks if needed"
