<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; object-src 'none'; base-uri 'self'; form-action 'self';">
    <title>XSS Security Demo - Error Handling</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: white;
        }
        .demo-section {
            background: #16213e;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #0f3460;
        }
        .test-button {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #6d28d9;
        }
        .result {
            background: #0f3460;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .safe {
            border-left: 4px solid #16a34a;
        }
        .dangerous {
            border-left: 4px solid #dc2626;
        }
    </style>
</head>
<body>
    <h1>ðŸ”’ XSS Security Demo - Error Handling</h1>
    <p>This demo shows how the errorHandling.ts file prevents XSS attacks by properly sanitizing user input.</p>

    <div class="demo-section">
        <h2>Test 1: Script Tag Injection</h2>
        <button id="script-test-btn" class="test-button">
            Test Script Tag XSS
        </button>
        <div id="script-result" class="result"></div>
    </div>

    <div class="demo-section">
        <h2>Test 2: Event Handler Injection</h2>
        <button id="event-test-btn" class="test-button">
            Test Event Handler XSS
        </button>
        <div id="event-result" class="result"></div>
    </div>

    <div class="demo-section">
        <h2>Test 3: Context Parameter XSS</h2>
        <button id="context-test-btn" class="test-button">
            Test Context XSS
        </button>
        <div id="context-result" class="result"></div>
    </div>

    <div class="demo-section">
        <h2>Test 4: HTML Entity Handling</h2>
        <button id="entity-test-btn" class="test-button">
            Test HTML Entity Handling
        </button>
        <div id="entity-result" class="result"></div>
    </div>

    <div class="demo-section">
        <h2>Security Recommendations</h2>
        <div class="result safe">
            <h3>âœ… Best Practices Implemented:</h3>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li><strong>Content Security Policy (CSP):</strong> Added to page header to prevent inline script execution</li>
                <li><strong>DOM-based Sanitization:</strong> Using textContent instead of regex for safe HTML escaping</li>
                <li><strong>Allowlist Filtering:</strong> Only permitting safe characters rather than blocklisting dangerous ones</li>
                <li><strong>Input Validation:</strong> Type checking and length limits on all user inputs</li>
                <li><strong>Safe DOM Manipulation:</strong> Using createElement() and textContent instead of innerHTML</li>
            </ul>
            <p><strong>Note:</strong> In production, consider using a robust sanitization library like DOMPurify for comprehensive XSS protection.</p>
        </div>
    </div>

    <script type="module">
        // Enhanced sanitization using DOMParser and allowlist approach
        function sanitizeForDisplay(input) {
            if (!input || typeof input !== 'string') {
                return 'Invalid input';
            }

            // Create a temporary DOM element for safe parsing
            const tempDiv = document.createElement('div');
            tempDiv.textContent = input; // This automatically escapes HTML
            let sanitized = tempDiv.textContent;

            // Additional safety: remove protocol handlers and event attributes
            sanitized = sanitized
                .replace(/javascript:/gi, '')
                .replace(/data:/gi, '')
                .replace(/vbscript:/gi, '')
                .replace(/on\w+\s*=/gi, '');

            // Allowlist approach: only allow safe characters
            sanitized = sanitized.replace(/[^\w\s\-\.,:;!?()\[\]{}]/g, '');

            // Limit length to prevent abuse
            const maxLength = 500;
            if (sanitized.length > maxLength) {
                sanitized = sanitized.substring(0, maxLength) + '...';
            }

            return sanitized.trim() || 'Error message unavailable';
        }

        // Mock showErrorToast that demonstrates safe DOM manipulation
        function showErrorToastDemo(message, options = {}) {
            const sanitizedMessage = sanitizeForDisplay(message);
            const sanitizedContext = options.context ? sanitizeForDisplay(options.context) : null;

            const finalMessage = sanitizedContext
                ? `[${sanitizedContext}] ${sanitizedMessage}`
                : sanitizedMessage;

            // Create notification safely using DOM methods
            const notification = document.createElement('div');
            notification.style.cssText = `
                background: #dc2626;
                color: white;
                padding: 12px 16px;
                margin: 10px 0;
                border-radius: 4px;
                border-left: 4px solid rgba(255, 255, 255, 0.4);
            `;

            // Safe: using textContent instead of innerHTML
            notification.textContent = `Error: ${finalMessage}`;

            return {
                element: notification,
                sanitizedMessage: finalMessage,
                originalMessage: message
            };
        }

        // Test functions
        window.testScriptInjection = function() {
            const maliciousInput = '<scr' + 'ipt>alert("XSS Attack!")</scr' + 'ipt>Database error occurred';
            const result = showErrorToastDemo(maliciousInput);

            const resultDiv = document.getElementById('script-result');
            resultDiv.innerHTML = '';
            resultDiv.className = 'result safe';

            resultDiv.innerHTML = `
                <strong>Original Input:</strong> ${escapeHtml(maliciousInput)}<br>
                <strong>Sanitized Output:</strong> ${escapeHtml(result.sanitizedMessage)}<br>
                <strong>Status:</strong> âœ… XSS Prevented - Script tags removed
            `;

            // Add the actual notification to show it's safe
            resultDiv.appendChild(result.element);
        };

        window.testEventHandlerInjection = function() {
            const maliciousInput = 'Error occurred onmouseover=alert("XSS") onclick=alert("XSS")';
            const result = showErrorToastDemo(maliciousInput);

            const resultDiv = document.getElementById('event-result');
            resultDiv.innerHTML = '';
            resultDiv.className = 'result safe';

            resultDiv.innerHTML = `
                <strong>Original Input:</strong> ${escapeHtml(maliciousInput)}<br>
                <strong>Sanitized Output:</strong> ${escapeHtml(result.sanitizedMessage)}<br>
                <strong>Status:</strong> âœ… XSS Prevented - Event handlers removed
            `;

            resultDiv.appendChild(result.element);
        };

        window.testContextInjection = function() {
            const message = 'Database connection failed';
            const maliciousContext = '<img src=x onerror=alert("XSS")>';
            const result = showErrorToastDemo(message, { context: maliciousContext });

            const resultDiv = document.getElementById('context-result');
            resultDiv.innerHTML = '';
            resultDiv.className = 'result safe';

            resultDiv.innerHTML = `
                <strong>Message:</strong> ${escapeHtml(message)}<br>
                <strong>Malicious Context:</strong> ${escapeHtml(maliciousContext)}<br>
                <strong>Sanitized Output:</strong> ${escapeHtml(result.sanitizedMessage)}<br>
                <strong>Status:</strong> âœ… XSS Prevented - HTML tags and event handlers removed
            `;

            resultDiv.appendChild(result.element);
        };

        window.testHtmlEntities = function() {
            const maliciousInput = '&lt;script&gt;alert("XSS")&lt;/script&gt;Error occurred';
            const result = showErrorToastDemo(maliciousInput);

            const resultDiv = document.getElementById('entity-result');
            resultDiv.innerHTML = '';
            resultDiv.className = 'result safe';

            // Create elements safely using DOM methods
            const originalLabel = document.createElement('strong');
            originalLabel.textContent = 'Original Input: ';
            const originalText = document.createTextNode(maliciousInput);

            const sanitizedLabel = document.createElement('strong');
            sanitizedLabel.textContent = 'Sanitized Output: ';
            const sanitizedText = document.createTextNode(result.sanitizedMessage);

            const statusLabel = document.createElement('strong');
            statusLabel.textContent = 'Status: ';
            const statusText = document.createTextNode('âœ… XSS Prevented - Safe DOM manipulation with textContent');

            resultDiv.appendChild(originalLabel);
            resultDiv.appendChild(originalText);
            resultDiv.appendChild(document.createElement('br'));
            resultDiv.appendChild(sanitizedLabel);
            resultDiv.appendChild(sanitizedText);
            resultDiv.appendChild(document.createElement('br'));
            resultDiv.appendChild(statusLabel);
            resultDiv.appendChild(statusText);

            resultDiv.appendChild(result.element);
        };

        // Helper function to escape HTML for display
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Set up CSP-compliant event handlers
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('script-test-btn').addEventListener('click', window.testScriptInjection);
            document.getElementById('event-test-btn').addEventListener('click', window.testEventHandlerInjection);
            document.getElementById('context-test-btn').addEventListener('click', window.testContextInjection);
            document.getElementById('entity-test-btn').addEventListener('click', window.testHtmlEntities);
        });
    </script>
</body>
</html>
