"""
Demonstration test showing how to use fake services instead of mocks.
This replaces complex mock setups with simple, realistic fake data.
"""

import unittest
import json
import sys
import os

# Add path for imports
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from fake_services import FakeServiceManager


class TestFakeServicesDemo(unittest.TestCase):
    """Demonstrate the fake services pattern."""
    
    def test_fake_services_basic_functionality(self):
        """Test that fake services work correctly without web framework."""
        
        # Set up fake services
        services = FakeServiceManager()
        services.setup_environment()
        services.start_patches()
        
        try:
            # Set up test data - no complex mock configuration needed
            user_id = "demo-user"
            services.setup_user(user_id, "demo@test.com")
            
            # Test Firestore operations
            campaign_data = {
                "title": "Dragon's Quest",
                "character": "Brave Knight",
                "setting": "Medieval Kingdom",
                "description": "A heroic adventure",
                "user_id": user_id
            }
            
            # Store campaign
            campaign_doc = services.firestore.collection("campaigns").document("test-campaign")
            campaign_doc.set(campaign_data)
            
            # Verify storage
            stored_data = campaign_doc.get().to_dict()
            self.assertEqual(stored_data['title'], "Dragon's Quest")
            self.assertEqual(stored_data['user_id'], user_id)
            
            # Test Gemini AI
            model = services.gemini_client.models.get("gemini-2.5-flash")
            response = model.generate_content("Create story for Brave Knight in Medieval Kingdom")
            
            # Verify AI response
            self.assertIsInstance(response.text, str)
            response_data = json.loads(response.text)
            self.assertIn('narrative', response_data)
            self.assertIn('Brave Knight', response_data['narrative'])
            
            # Test Auth
            user = services.auth.get_user(user_id)
            self.assertEqual(user.uid, user_id)
            
        finally:
            services.stop_patches()
            services.restore_environment()
    
    def test_data_integration_flow(self):
        """Test complete data flow through all fake services."""
        
        services = FakeServiceManager()
        services.setup_environment()
        services.start_patches()
        
        try:
            # Set up complete scenario
            user_id = "flow-test-user"
            campaign_id = "flow-test-campaign"
            
            services.setup_user(user_id)
            campaign_data = services.setup_campaign(campaign_id, user_id)
            
            # Test complete data flow
            # 1. Get campaign from Firestore
            campaign_doc = services.firestore.collection("campaigns").document(campaign_id)
            campaign = campaign_doc.get().to_dict()
            
            # 2. Generate story content with Gemini
            prompt = f"Continue the story for {campaign['character']} in {campaign['setting']}"
            model = services.gemini_client.models.get("gemini-2.5-flash")
            ai_response = model.generate_content(prompt)
            
            # 3. Parse response (should be valid JSON, not Mock)
            story_data = json.loads(ai_response.text)
            
            # 4. Store back to Firestore
            story_doc = campaign_doc.collection("story").document("scene-2")
            story_doc.set(story_data)
            
            # 5. Verify complete flow worked
            stored_story = story_doc.get().to_dict()
            
            # All data should be realistic and JSON-serializable
            self.assertIsInstance(stored_story['narrative'], str)
            self.assertIn(campaign['character'], stored_story['narrative'])
            self.assertIn('mechanics', stored_story)
            self.assertIn('scene', stored_story)
            
            # No Mock objects anywhere in the data
            story_json = json.dumps(stored_story)  # Should not fail
            self.assertGreater(len(story_json), 100)  # Should have substantial content
            
        finally:
            services.stop_patches()
            services.restore_environment()


if __name__ == '__main__':
    unittest.main()