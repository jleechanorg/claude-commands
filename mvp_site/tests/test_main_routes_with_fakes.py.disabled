"""
CONVERTED: Demonstration of fake services for route testing.
Shows how fakes simplify testing compared to complex mock setups.
"""

import unittest
import json
import sys
import os

# Add paths for imports
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

# Import fake services
from fake_services import FakeServiceManager


class TestMainRoutesWithFakes(unittest.TestCase):
    """Demonstrate fake services for route testing - much simpler than mocks!"""
    
    def setUp(self):
        """Set up fake services for testing."""
        # Create fake service manager
        self.services = FakeServiceManager()
        self.services.setup_environment()
        self.services.start_patches()
        
        # Set up test data using fake services
        self.test_user_id = "test-user-123"
        self.test_campaign_id = "test-campaign"
        
        # Create test user
        self.services.setup_user(self.test_user_id)
        
        # Create test campaigns
        campaign1 = self.services.setup_campaign("campaign1", self.test_user_id)
        campaign1_doc = self.services.firestore.collection("campaigns").document("campaign1")
        campaign1_doc.update({
            "title": "Adventure 1",
            "description": "First test adventure"
        })
        
        campaign2 = self.services.setup_campaign("campaign2", self.test_user_id)
        campaign2_doc = self.services.firestore.collection("campaigns").document("campaign2")
        campaign2_doc.update({
            "title": "Adventure 2", 
            "description": "Second test adventure"
        })
        
        # Create detailed test campaign
        detailed_campaign = self.services.setup_campaign(self.test_campaign_id, self.test_user_id)
    
    def tearDown(self):
        """Clean up after each test."""
        self.services.stop_patches()
        self.services.restore_environment()
    
    def test_fake_services_data_operations(self):
        """Test data operations using fake services - NO FLASK APP NEEDED!"""
        
        # Get campaigns directly from fake Firestore
        campaigns_collection = self.services.firestore.collection("campaigns")
        user_campaigns = []
        for doc in campaigns_collection.stream():
            data = doc.get().to_dict()
            if data.get('user_id') == self.test_user_id:
                user_campaigns.append(data)
        
        # Should have our test campaigns
        self.assertGreaterEqual(len(user_campaigns), 2)
        
        # Find our test campaigns
        titles = [camp.get('title') for camp in user_campaigns]
        self.assertIn('Adventure 1', titles)
        self.assertIn('Adventure 2', titles)
        
        # Verify data structure is realistic (not Mock objects)
        campaign = user_campaigns[0]
        self.assertIn('id', campaign)
        self.assertIn('title', campaign)
        self.assertIn('user_id', campaign)
        
        # Data should be JSON serializable
        json_str = json.dumps(user_campaigns)
        self.assertGreater(len(json_str), 10)
    
    def test_campaign_story_generation(self):
        """Test AI story generation - REALISTIC RESPONSES!"""
        
        # Test campaign creation workflow
        campaign_data = {
            "title": "Dragon's Quest",
            "character": "Brave Knight",
            "setting": "Medieval Kingdom",
            "description": "A heroic adventure",
            "user_id": self.test_user_id
        }
        
        # Store campaign in fake Firestore
        campaign_id = "dragons-quest-campaign"
        campaign_doc = self.services.firestore.collection("campaigns").document(campaign_id)
        campaign_doc.set(campaign_data)
        
        # Generate story with fake Gemini
        model = self.services.gemini_client.models.get("gemini-2.5-flash")
        prompt = f"Create story for {campaign_data['character']} in {campaign_data['setting']}"
        ai_response = model.generate_content(prompt)
        
        # Parse and store story
        story_data = json.loads(ai_response.text)
        story_doc = campaign_doc.collection("story").document("current")
        story_doc.set(story_data)
        
        # Verify story was generated and stored
        stored_story = story_doc.get().to_dict()
        
        self.assertIn('narrative', stored_story)
        # Fake Gemini should include character in narrative
        self.assertIn('Brave Knight', stored_story['narrative'])
        
        # Should have realistic mechanics
        self.assertIn('mechanics', stored_story)
        mechanics = stored_story['mechanics']
        self.assertIn('health', mechanics)
        self.assertIsInstance(mechanics['health'], int)
    
    def test_story_continuation_workflow(self):
        """Test story continuation - REALISTIC AI RESPONSES!"""
        
        # Set up existing campaign with story
        campaign_doc = self.services.firestore.collection("campaigns").document(self.test_campaign_id)
        existing_campaign = campaign_doc.get().to_dict()
        
        # Simulate user input
        user_input = "draws sword and approaches the dragon"
        
        # Generate continuation with fake Gemini
        model = self.services.gemini_client.models.get("gemini-2.5-flash")
        prompt = f"Character: {existing_campaign['character']}, User Input: {user_input}"
        ai_response = model.generate_content(prompt)
        
        # Parse response
        story_data = json.loads(ai_response.text)
        
        # Verify realistic response
        self.assertIn('narrative', story_data)
        narrative = story_data['narrative']
        self.assertIn(user_input, narrative)
        
        # Should update game state
        self.assertIn('state_updates', story_data)
        
        # Store updated story
        story_doc = campaign_doc.collection("story").document("current")
        story_doc.set(story_data)
        
        # Verify storage
        stored_story = story_doc.get().to_dict()
        self.assertIn(user_input, stored_story['narrative'])
    
    def test_auth_integration(self):
        """Test authentication integration with fake services!"""
        
        # Test user lookup
        user = self.services.auth.get_user(self.test_user_id)
        self.assertEqual(user.uid, self.test_user_id)
        
        # Test token creation and verification
        token = self.services.auth.create_custom_token(self.test_user_id)
        self.assertIsInstance(token, str)
        
        decoded = self.services.auth.verify_id_token(token)
        self.assertEqual(decoded.uid, self.test_user_id)
        
        # User data should be JSON serializable
        user_dict = user.to_dict()
        json_str = json.dumps(user_dict)
        self.assertIn(self.test_user_id, json_str)


if __name__ == '__main__':
    unittest.main(verbosity=2)