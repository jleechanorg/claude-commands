Generated on: Tue Jun 17 07:42:44 AM UTC 2025

--- FILE START ---
Location: ./test_gemini_service.py
Name: test_gemini_service.py
--- CONTENT ---
import unittest
from unittest.mock import patch, MagicMock
import os

# Set a dummy API key BEFORE we import the service.
os.environ["GEMINI_API_KEY"] = "DUMMY_KEY_FOR_TESTING"
import gemini_service

class TestGeminiService(unittest.TestCase):

    @patch('gemini_service.get_client')
    def test_get_initial_story(self, mock_get_client):
        """
        Tests the get_initial_story function with the new client SDK.
        """
        mock_client = MagicMock()
        mock_client.models.generate_content.return_value.text = "The adventure begins!"
        mock_get_client.return_value = mock_client
        
        test_prompt = "A wizard enters a tavern."
        result = gemini_service.get_initial_story(test_prompt)

        self.assertEqual(result, "The adventure begins!")
        mock_client.models.generate_content.assert_called_once()
        call_args = mock_client.models.generate_content.call_args
        self.assertIn(test_prompt, call_args.kwargs['contents'])


    @patch('gemini_service.get_client')
    def test_continue_story_character_mode(self, mock_get_client):
        """
        Tests the continue_story function in 'character' mode with the new SDK.
        """
        mock_client = MagicMock()
        mock_client.models.generate_content.return_value.text = "The story continues..."
        mock_get_client.return_value = mock_client

        user_input = "I inspect the strange orb."
        story_context = [{'actor': 'gemini', 'text': 'You see a strange orb on a pedestal.'}]
        
        result = gemini_service.continue_story(user_input, "character", story_context)

        # 1. Verify it returns the mocked text
        self.assertEqual(result, "The story continues...")
        
        # 2. Verify the API was called exactly once
        mock_client.models.generate_content.assert_called_once()
        
        # --- THIS IS THE FIX ---
        # 3. Verify the user's input was included in the prompt, without
        #    caring about the exact template string. This is a robust test.
        call_args = mock_client.models.generate_content.call_args
        self.assertIn(user_input, call_args.kwargs['contents'][0])


    @patch('gemini_service.get_client')
    def test_continue_story_god_mode(self, mock_get_client):
        """
        Tests the continue_story function in 'god' mode with the new SDK.
        """
        mock_client = MagicMock()
        mock_client.models.generate_content.return_value.text = "The world changes."
        mock_get_client.return_value = mock_client

        user_input = "A dragon suddenly appears."
        story_context = [{'actor': 'gemini', 'text': 'The room is quiet.'}]
        
        result = gemini_service.continue_story(user_input, "god", story_context)
        self.assertEqual(result, "The world changes.")
        mock_client.models.generate_content.assert_called_once()
        call_args = mock_client.models.generate_content.call_args
        self.assertIn(user_input, call_args.kwargs['contents'][0])

    def test_continue_story_invalid_mode(self):
        """
        Tests that continue_story raises a ValueError for an invalid mode.
        """
        with self.assertRaises(ValueError) as context:
            gemini_service.continue_story("test", "invalid_mode", [])
        
        self.assertEqual(str(context.exception), "Invalid interaction mode specified.")

if __name__ == '__main__':
    unittest.main()

--- FILE END ---

--- FILE START ---
Location: ./create_snapshot.sh
Name: create_snapshot.sh
--- CONTENT ---
#!/bin/bash

# This script creates a single text file snapshot of the entire repository.

# Define the name of the file that will contain the output.
OUTPUT_FILE="repo_snapshot.txt"

# Start with a clean slate by overwriting the file if it exists.
echo "Creating repository snapshot..."
echo "Generated on: $(date)" > "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Find all files in the current directory and subdirectories.
# Exclude the .git directory, venv, __pycache__, .bak files, and the output file itself.
# For each file found, run a loop.
find . -type f -not -path "./.git/*" -not -path "*/__pycache__/*" -not -path "*/venv/*" -not -name "*.bak" -not -name "$OUTPUT_FILE" | while read -r filepath; do
    
    # Print a clear separator and the file metadata to the output file.
    echo "--- FILE START ---" >> "$OUTPUT_FILE"
    echo "Location: $filepath" >> "$OUTPUT_FILE"
    echo "Name: $(basename "$filepath")" >> "$OUTPUT_FILE"
    echo "--- CONTENT ---" >> "$OUTPUT_FILE"
    
    # Append the actual content of the file.
    cat "$filepath" >> "$OUTPUT_FILE"
    
    # Print a separator at the end of the file content for clarity.
    # The two blank lines make the final text file easier to read.
    echo "" >> "$OUTPUT_FILE"
    echo "--- FILE END ---" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
done

echo "Snapshot complete."
echo "The file '$OUTPUT_FILE' has been created in your current directory."
echo "Please upload this file so I can analyze the state of the repository."

--- FILE END ---

--- FILE START ---
Location: ./inspect_sdk.py
Name: inspect_sdk.py
--- CONTENT ---
import os
import sys

# --- THIS IS THE FIX ---
# First, load the API key from the local file and set the environment variable.
try:
    with open('local_api_key.txt', 'r') as f:
        api_key = f.read().strip()
    os.environ["GEMINI_API_KEY"] = api_key
except FileNotFoundError:
    print("ERROR: 'local_api_key.txt' not found.")
    sys.exit(1)

# Now that the environment is set, we can safely import our service.
import gemini_service

# Get the client object
client = gemini_service.get_client()

# --- This is how you can check for yourself ---
# Print the official help documentation for the method we are using.
print("\n--- Official SDK Documentation for client.models.generate_content ---\n")
help(client.models.generate_content)

--- FILE END ---

--- FILE START ---
Location: ./local_api_key.txt
Name: local_api_key.txt
--- CONTENT ---
AIzaSyAfngmuVONpJPEbXpEZ1LwJnpDi2Vrdwb8
--- FILE END ---

--- FILE START ---
Location: ./decorators.py
Name: decorators.py
--- CONTENT ---
import functools
import logging
import traceback

# Get a logger instance for this module
logger = logging.getLogger(__name__)

def log_exceptions(func):
    """
    A decorator that wraps a function in a try-except block
    and logs any exceptions with a full stack trace.
    """
    @functools.wraps(func)
    def wrapper(*args, **kwargs):
        try:
            # Attempt to execute the decorated function
            return func(*args, **kwargs)
        except Exception as e:
            # Construct a detailed error message
            # The function name is retrieved using func.__name__
            # Args and kwargs are included for context
            error_message = (
                f"--- EXCEPTION IN: {func.__name__} ---\n"
                f"Args: {args}\n"
                f"Kwargs: {kwargs}\n"
                f"Error: {e}\n"
                f"Traceback:\n{traceback.format_exc()}"
                f"--- END EXCEPTION ---"
            )
            logger.error(error_message)
            # Re-raise the exception so it can be handled by the calling code (e.g., the route)
            raise
    return wrapper

--- FILE END ---

--- FILE START ---
Location: ./test_syntax.py
Name: test_syntax.py
--- CONTENT ---
import unittest
import os

class TestModuleSyntax(unittest.TestCase):

    def test_gemini_service_import(self):
        """
        Tests if the gemini_service.py module can be imported.
        A failure here indicates a syntax error in the file.
        """
        print("\n--- Attempting to import gemini_service.py ---")
        
        # We must set the API key environment variable BEFORE importing,
        # because the module uses it immediately upon import.
        # We can use a dummy value for this syntax test.
        if "GEMINI_API_KEY" not in os.environ:
            print("Setting dummy GEMINI_API_KEY for import test...")
            os.environ["GEMINI_API_KEY"] = "DUMMY_KEY_FOR_SYNTAX_TEST"
            
        try:
            import gemini_service
            # If we get here, the import was successful.
            print("SUCCESS: gemini_service.py was imported without a syntax error.")
            self.assertTrue(True)
        except (SyntaxError, IndentationError) as e:
            # If we get here, the import failed due to a syntax error.
            print(f"FAILURE: A syntax error was found in gemini_service.py: {e}")
            self.fail(f"SyntaxError or IndentationError in gemini_service.py: {e}")
        except Exception as e:
            # Catch any other potential import-time errors.
            print(f"FAILURE: An unexpected error occurred during import: {e}")
            self.fail(f"An unexpected error occurred during import: {e}")

if __name__ == '__main__':
    unittest.main()

--- FILE END ---

--- FILE START ---
Location: ./static/index.html
Name: index.html
--- CONTENT ---
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorldArchitect.AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loading-overlay">
        <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
    </div>
    <div class="container mt-5">
        <h1 class="text-center">WorldArchitect.AI</h1>
        <div id="auth-view" class="text-center mt-4"><div id="auth-container"></div></div>
        <div id="dashboard-view" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>My Campaigns</h2>
                <div>
                    <button id="go-to-new-campaign" class="btn btn-primary">Start New Campaign</button>
                    <button id="signOutBtnDashboard" class="btn btn-danger ms-2">Sign Out</button>
                </div>
            </div>
            <div id="campaign-list" class="list-group"></div>
        </div>
        <div id="new-campaign-view" style="display:none;">
            <h2 class="text-center">Start a New Campaign</h2>
            <form id="new-campaign-form" class="mt-3">
                <div class="mb-3"><label for="campaign-title" class="form-label">Campaign Title</label><input type="text" class="form-control" id="campaign-title" value="My Epic Adventure" required></div>
                <div class="mb-3"><label for="campaign-prompt" class="form-label">Describe your world...</label><textarea class="form-control" id="campaign-prompt" rows="3">A brave knight in a land of dragons.</textarea></div>
                <button type="submit" class="btn btn-success">Begin Adventure!</button>
            </form>
        </div>
        <div id="game-view" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 id="game-title"></h2>
                <button id="back-to-dashboard" class="btn btn-secondary">Back to Dashboard</button>
            </div>
            <div id="story-content" class="p-3 border rounded bg-light"></div>
            <div id="timer-info" class="mt-2 text-muted text-center small"></div>
            <form id="interaction-form" class="mt-3">
                <div class="input-group">
                    <textarea class="form-control" id="user-input" placeholder="What do you do?" rows="5" required></textarea>
                    <button class="btn btn-primary" type="submit">Send</button>
                </div>
                <div class="form-check form-check-inline mt-2">
                    <input class="form-check-input" type="radio" name="interactionMode" id="char-mode" value="character" checked>
                    <label class="form-check-label" for="char-mode">Character Mode</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="interactionMode" id="god-mode" value="god">
                    <label class="form-check-label" for="god-mode">God Mode</label>
                </div>
            </form>
            <div id="loading-spinner" class="text-center mt-3" style="display: none;">
                <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
            </div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="auth.js"></script>
    <script src="api.js"></script>
    <script src="app.js"></script>
</body>
</html>

--- FILE END ---

--- FILE START ---
Location: ./static/style.css
Name: style.css
--- CONTENT ---
body { background-color: #f8f9fa; }
#auth-container button { cursor: pointer; }

#story-content p {
    white-space: pre-wrap;
    margin-bottom: 1rem;
}

#loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    display: none;
}

#loading-overlay .spinner-border {
    width: 3rem;
    height: 3rem;
    color: white;
}

#game-view {
    display: flex;
    flex-direction: column;
    height: 85vh; 
}

#story-content {
    flex-grow: 1;
    overflow-y: auto;
    min-height: 0;
    border: 1px solid #dee2e6;
    border-radius: .25rem;
    padding: 1rem;
    background-color: #f8f9fa;
}

/* ADDED: Style for the new textarea */
#interaction-form textarea {
    resize: vertical; /* Allow vertical resizing only */
}

--- FILE END ---

--- FILE START ---
Location: ./static/auth.js
Name: auth.js
--- CONTENT ---
document.addEventListener('DOMContentLoaded', () => {
  const firebaseConfig = {
    apiKey: "AIzaSyARs7IekRptvhZIwtV7lwJh3axWFsn_4c8",
    authDomain: "worldarchitecture-ai.firebaseapp.com",
    projectId: "worldarchitecture-ai",
    storageBucket: "worldarchitecture-ai.firebasestorage.app",
    messagingSenderId: "754683067800",
    appId: "1:754683067800:web:3b38787c69de301c147fed",
    measurementId: "G-EFX5VFZ7CV"
  };
  try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Error initializing Firebase:", e); return; }
  
  const auth = firebase.auth();
  const provider = new firebase.auth.GoogleAuthProvider();

  const authContainer = document.getElementById('auth-container');
  // Get the new button
  const signOutBtnDashboard = document.getElementById('signOutBtnDashboard');

  const signIn = () => auth.signInWithPopup(provider).catch(e => console.error("Sign-in error:", e));
  const signOut = () => auth.signOut().catch(e => console.error("Sign-out error:", e));

  // Attach the signOut function to the new button's click event
  if (signOutBtnDashboard) {
      signOutBtnDashboard.onclick = signOut;
  }

  auth.onAuthStateChanged(user => {
    if (user) {
      // User is signed in, so the sign-in button should not be displayed.
      // We keep the container for layout purposes but ensure it's empty.
      authContainer.innerHTML = '';
    } else {
      // User is signed out, show the sign-in button.
      authContainer.innerHTML = '<button class="btn btn-primary" id="signInBtn">Sign in with Google</button>';
      document.getElementById('signInBtn').onclick = signIn;
    }
  });
});

--- FILE END ---

--- FILE START ---
Location: ./static/api.js
Name: api.js
--- CONTENT ---
async function fetchApi(path, options = {}) {
    const startTime = performance.now();
    const user = firebase.auth().currentUser;
    if (!user) throw new Error('User not authenticated');

    const token = await user.getIdToken();
    const defaultHeaders = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
    const config = { ...options, headers: { ...defaultHeaders, ...options.headers } };

    const response = await fetch(path, config);
    const duration = ((performance.now() - startTime) / 1000).toFixed(2);

    if (!response.ok) {
        let errorPayload = {
            message: `HTTP Error: ${response.status} ${response.statusText}`,
            traceback: `Status code ${response.status} indicates a server-side problem. Check the Cloud Run logs for details.`
        };
        try {
            // Attempt to parse the body as JSON, it might contain our detailed error
            const jsonError = await response.json();
            errorPayload.message = jsonError.error || errorPayload.message;
            errorPayload.traceback = jsonError.traceback || errorPayload.traceback;
        } catch (e) {
            // The response was not JSON. The server likely sent a plain HTML error page.
            console.error("Failed to parse error response as JSON.", e);
        }
        // Throw an object that our UI knows how to render.
        const error = new Error(errorPayload.message);
        error.traceback = errorPayload.traceback;
        throw error;
    }

    const data = await response.json();
    return { data, duration };
}

--- FILE END ---

--- FILE START ---
Location: ./static/app.js
Name: app.js
--- CONTENT ---
document.addEventListener('DOMContentLoaded', () => {
    // --- State and Constants ---
    const views = { auth: document.getElementById('auth-view'), dashboard: document.getElementById('dashboard-view'), newCampaign: document.getElementById('new-campaign-view'), game: document.getElementById('game-view') };
    const loadingOverlay = document.getElementById('loading-overlay');
    let currentCampaignId = null;

    // --- Core UI & Navigation Logic ---
    const showSpinner = () => loadingOverlay.style.display = 'flex';
    const hideSpinner = () => loadingOverlay.style.display = 'none';
    const showView = (viewName) => { Object.values(views).forEach(v => v.style.display = 'none'); if(views[viewName]) views[viewName].style.display = 'block'; };
    const scrollToBottom = (element) => { element.scrollTop = element.scrollHeight; };

    let handleRouteChange = () => {
        if (!firebase.auth().currentUser) { showView('auth'); return; }
        const path = window.location.pathname;
        const campaignIdMatch = path.match(/^\/game\/([a-zA-Z0-9]+)/);
        if (campaignIdMatch) {
            currentCampaignId = campaignIdMatch[1];
            resumeCampaign(currentCampaignId);
        } else if (path === '/new-campaign') {
            showView('newCampaign');
        } else {
            currentCampaignId = null;
            renderCampaignList();
            showView('dashboard');
        }
    };
    
    const appendToStory = (actor, text) => {
        const storyContainer = document.getElementById('story-content');
        const entryEl = document.createElement('p');
        const label = actor === 'gemini' ? 'Story' : 'You';
        entryEl.innerHTML = `<strong>${label}:</strong> ${text}`;
        storyContainer.appendChild(entryEl);
    };

    // --- Data Fetching and Rendering ---
    let renderCampaignList = async () => {
        showSpinner();
        try {
            const { data: campaigns } = await fetchApi('/api/campaigns');
            const listEl = document.getElementById('campaign-list');
            listEl.innerHTML = '';
            if (campaigns.length === 0) { listEl.innerHTML = '<p>You have no campaigns. Start a new one!</p>'; }
            campaigns.forEach(campaign => {
                const campaignEl = document.createElement('div');
                campaignEl.className = 'list-group-item list-group-item-action';
                campaignEl.innerHTML = `<div class="d-flex w-100 justify-content-between"><h5 class="mb-1">${campaign.title}</h5><small>Last played: ${new Date(campaign.last_played).toLocaleString()}</small></div><p class="mb-1">${campaign.initial_prompt.substring(0, 100)}...</p>`;
                campaignEl.onclick = () => {
                    history.pushState({ campaignId: campaign.id }, '', `/game/${campaign.id}`);
                    handleRouteChange();
                };
                listEl.appendChild(campaignEl);
            });
        } catch (error) { console.error("Error fetching campaigns:", error); }
        finally { hideSpinner(); }
    };

    let resumeCampaign = async (campaignId) => {
        showSpinner();
        try {
            const { data } = await fetchApi(`/api/campaigns/${campaignId}`);
            document.getElementById('game-title').innerText = data.campaign.title;
            const storyContainer = document.getElementById('story-content');
            storyContainer.innerHTML = '';
            data.story.forEach(entry => appendToStory(entry.actor, entry.text));
            showView('game');
            scrollToBottom(storyContainer);
        } catch (error) {
            console.error('Failed to resume campaign:', error);
            history.pushState({}, '', '/');
            handleRouteChange();
        } finally {
            hideSpinner();
        }
    };
    
    // --- Event Listeners ---
    document.getElementById('new-campaign-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        showSpinner();
        const prompt = document.getElementById('campaign-prompt').value;
        const title = document.getElementById('campaign-title').value;
        try {
            const { data } = await fetchApi('/api/campaigns', { method: 'POST', body: JSON.stringify({ prompt, title }) });
            history.pushState({ campaignId: data.campaign_id }, '', `/game/${data.campaign_id}`);
            handleRouteChange();
        } catch (error) {
            console.error("Error creating campaign:", error);
            alert('Failed to start a new campaign.');
            hideSpinner();
        }
    });

    document.getElementById('interaction-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const userInputEl = document.getElementById('user-input');
        let userInput = userInputEl.value.trim();
        if (!userInput || !currentCampaignId) return;
        const mode = document.querySelector('input[name="interactionMode"]:checked').value;
        const localSpinner = document.getElementById('loading-spinner');
        const timerInfo = document.getElementById('timer-info');
        localSpinner.style.display = 'block';
        userInputEl.disabled = true;
        timerInfo.textContent = '';
        appendToStory('user', userInput);
        userInputEl.value = '';
        try {
            const { data, duration } = await fetchApi(`/api/campaigns/${currentCampaignId}/interaction`, {
                method: 'POST', body: JSON.stringify({ input: userInput, mode }),
            });
            appendToStory('gemini', data.response);
            timerInfo.textContent = `Response time: ${duration}s`;
        } catch (error) {
            console.error("Interaction failed:", error);
            appendToStory('system', 'Sorry, an error occurred. Please try again.');
        } finally {
            localSpinner.style.display = 'none';
            userInputEl.disabled = false;
            userInputEl.focus();
        }
    });
    
    document.getElementById('go-to-new-campaign').onclick = () => { history.pushState({}, '', '/new-campaign'); handleRouteChange(); };
    document.getElementById('back-to-dashboard').onclick = () => { history.pushState({}, '', '/'); handleRouteChange(); };
    window.addEventListener('popstate', handleRouteChange);
    firebase.auth().onAuthStateChanged(user => handleRouteChange());
});

--- FILE END ---

--- FILE START ---
Location: ./Dockerfile
Name: Dockerfile
--- CONTENT ---
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
# --- THIS IS THE FIX ---
# We've added the --timeout flag and set it to 300 seconds.
CMD ["gunicorn", "--bind", "0.0.0.0:8080", "--timeout", "300", "main:app"]

--- FILE END ---

--- FILE START ---
Location: ./test_integration.py
Name: test_integration.py
--- CONTENT ---
import unittest
import os
import json
from unittest.mock import patch, MagicMock

# We still need the dummy key for the import-time initialization check
os.environ["GEMINI_API_KEY"] = "DUMMY_KEY_FOR_INTEGRATION_TESTING"

import main

class TestInteractionIntegration(unittest.TestCase):

    def setUp(self):
        """
        Set up a test client and create a new campaign for each test.
        """
        # --- THIS IS THE FIX ---
        # 1. Create a patcher for the get_client function.
        self.patcher = patch('gemini_service.get_client')
        
        # 2. Start the patcher and get the mock object.
        mock_get_client = self.patcher.start()
        
        # 3. Configure the mock client that all tests in this class will use.
        self.mock_client = MagicMock()
        mock_get_client.return_value = self.mock_client
        
        # Configure the mock for the 'create campaign' call in this setUp method
        self.mock_client.models.generate_content.return_value.text = "This is a test opening story."
        
        # Standard setup
        self.app = main.create_app()
        self.app.config['TESTING'] = True
        self.client = self.app.test_client()
        self.user_id = "test-suite-user-123"

        print("\n--- (setUp) Creating a new campaign for the test ---")
        create_response = self.client.post(
            '/api/campaigns',
            headers={'Content-Type': 'application/json', 'X-Test-Bypass-Auth': 'true', 'X-Test-User-ID': self.user_id},
            data=json.dumps({'prompt': 'A test campaign', 'title': 'Integration Test'})
        )
        self.assertEqual(create_response.status_code, 201, "Failed to create campaign in setUp")
        create_data = create_response.get_json()
        self.campaign_id = create_data.get('campaign_id')
        self.assertIsNotNone(self.campaign_id, "Campaign ID not found in setUp response")
        print(f"--- (setUp) Campaign {self.campaign_id} created ---")

    def tearDown(self):
        """
        Clean up any test data and stop the patcher.
        """
        # --- THIS IS THE FIX ---
        # 4. Stop the patcher to clean up the environment after each test.
        self.patcher.stop()
        print(f"--- (tearDown) Test finished for campaign {self.campaign_id} ---")
        pass

    def test_character_mode_interaction(self):
        """
        Tests a full interaction flow using 'character' mode.
        """
        self.mock_client.models.generate_content.return_value.text = "The character sees a door."
        
        print("\n--- RUNNING: test_character_mode_interaction ---")
        response = self.client.post(
            f'/api/campaigns/{self.campaign_id}/interaction',
            headers={'Content-Type': 'application/json', 'X-Test-Bypass-Auth': 'true', 'X-Test-User-ID': self.user_id},
            data=json.dumps({'input': 'I check the door for traps.', 'mode': 'character'})
        )
        print(f"Character Mode Response: {response.get_data(as_text=True)}")
        self.assertEqual(response.status_code, 200)
        response_data = response.get_json()
        self.assertEqual(response_data.get('response'), "The character sees a door.")

    def test_god_mode_interaction(self):
        """
        Tests a full interaction flow using 'god' mode.
        """
        self.mock_client.models.generate_content.return_value.text = "An earthquake shakes the room."

        print("\n--- RUNNING: test_god_mode_interaction ---")
        response = self.client.post(
            f'/api/campaigns/{self.campaign_id}/interaction',
            headers={'Content-Type': 'application/json', 'X-Test-Bypass-Auth': 'true', 'X-Test-User-ID': self.user_id},
            data=json.dumps({'input': 'A sudden earthquake shakes the dungeon.', 'mode': 'god'})
        )
        print(f"God Mode Response: {response.get_data(as_text=True)}")
        self.assertEqual(response.status_code, 200)
        response_data = response.get_json()
        self.assertEqual(response_data.get('response'), "An earthquake shakes the room.")

if __name__ == '__main__':
    unittest.main()

--- FILE END ---

--- FILE START ---
Location: ./requirements.txt
Name: requirements.txt
--- CONTENT ---
Flask==3.0.0
gunicorn==21.2.0
firebase-admin==6.5.0
google-cloud-firestore==2.16.0
google-genai
protobuf==4.25.3
Flask-Cors==4.0.0

--- FILE END ---

--- FILE START ---
Location: ./gemini_service.py
Name: gemini_service.py
--- CONTENT ---
import os
from google import genai
from google.genai import types
import logging
from decorators import log_exceptions
import sys

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')

# --- CONSTANTS ---
MODEL_NAME = 'gemini-2.5-flash-preview-05-20'
MAX_TOKENS = 8192 
TEMPERATURE = 0.9
TARGET_WORD_COUNT = 400
HISTORY_TURN_LIMIT = 50
SAFETY_SETTINGS = [
    types.SafetySetting(category=types.HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold=types.HarmBlockThreshold.BLOCK_NONE),
    types.SafetySetting(category=types.HarmCategory.HARM_CATEGORY_HARASSMENT, threshold=types.HarmBlockThreshold.BLOCK_NONE),
    types.SafetySetting(category=types.HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold=types.HarmBlockThreshold.BLOCK_NONE),
    types.SafetySetting(category=types.HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold=types.HarmBlockThreshold.BLOCK_NONE),
]
# --- END CONSTANTS ---

_client = None

def get_client():
    """Initializes and returns a singleton Gemini client."""
    global _client
    if _client is None:
        logging.info("--- Initializing Gemini Client ---")
        api_key = os.environ.get("GEMINI_API_KEY")
        if not api_key:
            raise ValueError("CRITICAL: GEMINI_API_KEY environment variable not found!")
        _client = genai.Client(api_key=api_key)
        logging.info("--- Gemini Client Initialized Successfully ---")
    return _client

def _call_gemini_api(prompt_contents):
    """Calls the Gemini API with a given prompt and returns the response."""
    client = get_client()
    logging.info(f"--- Calling Gemini API with prompt: {str(prompt_contents)[:300]}... ---")
    
    response = client.models.generate_content(
        model=MODEL_NAME,
        contents=prompt_contents,
        config=types.GenerateContentConfig(
            max_output_tokens=MAX_TOKENS,
            temperature=TEMPERATURE,
            safety_settings=SAFETY_SETTINGS
        )
    )
    return response

def _get_text_from_response(response):
    """Safely extracts text from a Gemini response object."""
    try:
        if response.text:
            return response.text
    except ValueError as e:
        logging.warning(f"ValueError while extracting text: {e}")
    except Exception as e:
        logging.error(f"Unexpected error in _get_text_from_response: {e}")
    
    logging.warning(f"--- Response did not contain valid text. Full response object: {response} ---")
    return "[System Message: The model returned a non-text response. Please check the logs for details.]"

@log_exceptions
def get_initial_story(prompt):
    """Generates the initial story opening."""
    full_prompt = f"{prompt}\n\n(Please keep the response to about {TARGET_WORD_COUNT} words.)"
    response = _call_gemini_api([full_prompt])
    return _get_text_from_response(response)

# --- THIS IS THE ONLY FUNCTION THAT HAS BEEN CHANGED ---
@log_exceptions
def continue_story(user_input, mode, story_context):
    """Generates the next part of the story by concatenating the chat history."""
    
    # 1. Take only the most recent turns from the full story context.
    recent_context = story_context[-HISTORY_TURN_LIMIT:]
    
    # 2. Build a single context string from the history.
    history_parts = []
    for entry in recent_context:
        actor_label = "Story" if entry.get('actor') == 'gemini' else "You"
        history_parts.append(f"{actor_label}: {entry.get('text')}")
    
    context_string = "\n\n".join(history_parts)

    # 3. Create the final prompt for the current user turn.
    if mode == 'character':
        prompt_template = "Acting as the main character {user_input}. Continue the story in about {word_count} words."
    else: # god mode
        prompt_template = "{user_input}. Continue the story in about {word_count} words."

    current_prompt_text = prompt_template.format(user_input=user_input, word_count=TARGET_WORD_COUNT)

    # 4. Combine the context and the current prompt into one large string.
    full_prompt = f"CONTEXT:\n{context_string}\n\nYOUR TURN:\n{current_prompt_text}"
    
    # 5. Call the API helper with the single, concatenated prompt string.
    response = _call_gemini_api([full_prompt])
    return _get_text_from_response(response)

# --- Main block for rapid, direct testing ---
if __name__ == "__main__":
    print("--- Running gemini_service.py in chained conversation test mode ---")
    
    try:
        with open('local_api_key.txt', 'r') as f:
            api_key = f.read().strip()
        os.environ["GEMINI_API_KEY"] = api_key
        print("Successfully loaded API key from local_api_key.txt")
    except FileNotFoundError:
        print("\nERROR: 'local_api_key.txt' not found.")
        sys.exit(1)
        
    get_client() # Initialize client
    
    # --- Turn 1: Initial Story ---
    print("\n--- Turn 1: get_initial_story ---")
    turn_1_prompt = "start a story about a haunted lighthouse"
    print(f"Using prompt: '{turn_1_prompt}'")
    turn_1_response = get_initial_story(turn_1_prompt)
    print("\n--- LIVE RESPONSE 1 ---")
    print(turn_1_response)
    print("--- END OF RESPONSE 1 ---\n")
    
    # Create the initial history from the real response
    history = [{'actor': 'user', 'text': turn_1_prompt}, {'actor': 'gemini', 'text': turn_1_response}]

    # --- Turn 2: Continue Story ---
    print("\n--- Turn 2: continue_story ---")
    turn_2_prompt = "A lone ship, tossed by the raging sea, sees a faint, flickering light from the abandoned tower."
    print(f"Using prompt: '{turn_2_prompt}'")
    turn_2_response = continue_story(turn_2_prompt, 'god', history)
    print("\n--- LIVE RESPONSE 2 ---")
    print(turn_2_response)
    print("--- END OF RESPONSE 2 ---\n")
    
    # Update the history with the real response from turn 2
    history.append({'actor': 'user', 'text': turn_2_prompt})
    history.append({'actor': 'gemini', 'text': turn_2_response})

    # --- Turn 3: Continue Story Again ---
    print("\n--- Turn 3: continue_story ---")
    turn_3_prompt = "The ship's captain, a grizzled old sailor named Silas, decides to steer towards the light, ignoring the warnings of his crew."
    print(f"Using prompt: '{turn_3_prompt}'")
    turn_3_response = continue_story(turn_3_prompt, 'god', history)
    print("\n--- LIVE RESPONSE 3 ---")
    print(turn_3_response)
    print("--- END OF RESPONSE 3 ---\n")

--- FILE END ---

--- FILE START ---
Location: ./firestore_service.py
Name: firestore_service.py
--- CONTENT ---
import datetime
from firebase_admin import firestore
from decorators import log_exceptions # Import the decorator

# No need for a separate logger instance here anymore, the decorator handles it.

def get_db():
    """Returns the Firestore client."""
    return firestore.client()

@log_exceptions
def get_campaigns_for_user(user_id):
    """Retrieves all campaigns for a given user, ordered by most recently played."""
    db = get_db()
    campaigns_ref = db.collection('users').document(user_id).collection('campaigns')
    campaigns_query = campaigns_ref.order_by('last_played', direction=firestore.Query.DESCENDING)
    
    campaign_list = []
    for campaign in campaigns_query.stream():
        campaign_data = campaign.to_dict()
        campaign_data['id'] = campaign.id
        campaign_data['created_at'] = campaign_data['created_at'].isoformat()
        campaign_data['last_played'] = campaign_data['last_played'].isoformat()
        campaign_list.append(campaign_data)
    
    return campaign_list

@log_exceptions
def get_campaign_by_id(user_id, campaign_id):
    """Retrieves a single campaign and its full story."""
    db = get_db()
    campaign_ref = db.collection('users').document(user_id).collection('campaigns').document(campaign_id)
    
    campaign_doc = campaign_ref.get()
    if not campaign_doc.exists:
        return None, None

    story_ref = campaign_ref.collection('story').order_by('timestamp', direction=firestore.Query.ASCENDING)
    story_docs = story_ref.stream()
    
    story = []
    for doc in story_docs:
        doc_data = doc.to_dict()
        doc_data['timestamp'] = doc_data['timestamp'].isoformat()
        story.append(doc_data)

    return campaign_doc.to_dict(), story

@log_exceptions
def add_story_entry(user_id, campaign_id, actor, text, mode=None):
    """Adds a new entry to a campaign's story and updates the last_played timestamp."""
    db = get_db()
    campaign_doc_ref = db.collection('users').document(user_id).collection('campaigns').document(campaign_id)
    story_ref = campaign_doc_ref.collection('story')
    
    entry_data = {
        'actor': actor,
        'text': text,
        'timestamp': datetime.datetime.now(datetime.timezone.utc)
    }
    if mode:
        entry_data['mode'] = mode
        
    story_ref.add(entry_data)
    campaign_doc_ref.update({'last_played': datetime.datetime.now(datetime.timezone.utc)})

@log_exceptions
def create_campaign(user_id, title, initial_prompt, opening_story):
    """Creates a new campaign document in Firestore."""
    db = get_db()
    campaign_ref = db.collection('users').document(user_id).collection('campaigns').document()
    
    campaign_data = {
        'title': title,
        'initial_prompt': initial_prompt,
        'created_at': datetime.datetime.now(datetime.timezone.utc),
        'last_played': datetime.datetime.now(datetime.timezone.utc)
    }
    campaign_ref.set(campaign_data)
    add_story_entry(user_id, campaign_ref.id, 'gemini', opening_story)
    return campaign_ref.id

--- FILE END ---

--- FILE START ---
Location: ./main.py
Name: main.py
--- CONTENT ---
import os
from functools import wraps
from flask import Flask, request, jsonify, send_from_directory
from flask_cors import CORS
import firebase_admin
from firebase_admin import auth
import traceback

def create_app():
    app = Flask(__name__, static_folder='static', static_url_path='')
    CORS(app, resources={r"/api/*": {"origins": "*"}})

    if not firebase_admin._apps:
        firebase_admin.initialize_app()

    import gemini_service
    import firestore_service

    def check_token(f):
        @wraps(f)
        def wrap(*args, **kwargs):
            # --- THIS IS THE NEW BYPASS LOGIC ---
            if app.config['TESTING'] and request.headers.get('X-Test-Bypass-Auth') == 'true':
                kwargs['user_id'] = request.headers.get('X-Test-User-ID', 'test-user') # Use a provided test user ID
                return f(*args, **kwargs)
            # --- END OF NEW LOGIC ---

            if not request.headers.get('Authorization'): return jsonify({'message': 'No token provided'}), 401
            try:
                id_token = request.headers['Authorization'].split(' ').pop()
                decoded_token = auth.verify_id_token(id_token)
                kwargs['user_id'] = decoded_token['uid']
            except Exception as e:
                return jsonify({'success': False, 'error': f"Auth failed: {e}", 'traceback': traceback.format_exc()}), 401
            return f(*args, **kwargs)
        return wrap

    # --- API Routes ---
    @app.route('/api/campaigns', methods=['GET'])
    @check_token
    def get_campaigns(user_id):
        try:
            return jsonify(firestore_service.get_campaigns_for_user(user_id))
        except Exception as e:
            return jsonify({'success': False, 'error': str(e), 'traceback': traceback.format_exc()}), 500

    @app.route('/api/campaigns/<campaign_id>', methods=['GET'])
    @check_token
    def get_campaign(user_id, campaign_id):
        try:
            campaign, story = firestore_service.get_campaign_by_id(user_id, campaign_id)
            if not campaign: return jsonify({'error': 'Campaign not found'}), 404
            return jsonify({'campaign': campaign, 'story': story})
        except Exception as e:
            return jsonify({'success': False, 'error': str(e), 'traceback': traceback.format_exc()}), 500

    @app.route('/api/campaigns', methods=['POST'])
    @check_token
    def create_campaign(user_id):
        try:
            data = request.get_json()
            prompt, title = data.get('prompt'), data.get('title')
            opening_story = gemini_service.get_initial_story(prompt)
            campaign_id = firestore_service.create_campaign(user_id, title, prompt, opening_story)
            return jsonify({'success': True, 'campaign_id': campaign_id}), 201
        except Exception as e:
            return jsonify({'success': False, 'error': str(e), 'traceback': traceback.format_exc()}), 500

    @app.route('/api/campaigns/<campaign_id>/interaction', methods=['POST'])
    @check_token
    def handle_interaction(user_id, campaign_id):
        try:
            data = request.get_json()
            user_input, mode = data.get('input'), data.get('mode', 'character')
            _, story_context = firestore_service.get_campaign_by_id(user_id, campaign_id)
            firestore_service.add_story_entry(user_id, campaign_id, 'user', user_input, mode)
            gemini_response = gemini_service.continue_story(user_input, mode, story_context)
            firestore_service.add_story_entry(user_id, campaign_id, 'gemini', gemini_response)
            return jsonify({'success': True, 'response': gemini_response})
        except Exception as e:
            return jsonify({'success': False, 'error': str(e), 'traceback': traceback.format_exc()}), 500

    # --- Frontend Serving ---
    @app.route('/', defaults={'path': ''})
    @app.route('/<path:path>')
    def serve_frontend(path):
        return send_from_directory(app.static_folder, 'index.html')

    return app

app = create_app()

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 8080)), debug=True)

--- FILE END ---

