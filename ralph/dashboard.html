<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ralph Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #0d1117;
      color: #c9d1d9;
      font-family: 'SF Mono', 'Fira Code', monospace;
      padding: 24px;
    }

    h1 {
      color: #58a6ff;
      font-size: 24px;
      margin-bottom: 4px;
    }

    .subtitle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .subtitle {
      color: #8b949e;
      font-size: 13px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .card {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 16px;
    }

    .card h2 {
      color: #58a6ff;
      font-size: 14px;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .full {
      grid-column: 1 / -1;
    }

    /* Progress bar */
    .progress-wrap {
      margin-bottom: 8px;
    }

    .progress-bar {
      height: 28px;
      background: #21262d;
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #238636, #2ea043);
      transition: width 0.5s ease;
      border-radius: 6px;
    }

    .progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: bold;
      font-size: 14px;
      color: #fff;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* Phase table */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      color: #8b949e;
      font-size: 12px;
      padding: 6px 8px;
      border-bottom: 1px solid #30363d;
    }

    td {
      padding: 8px;
      border-bottom: 1px solid #21262d;
      font-size: 13px;
    }

    .done {
      color: #3fb950;
    }

    .wip {
      color: #d29922;
    }

    .pending {
      color: #8b949e;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }

    .badge.done {
      background: #238636;
      color: #fff;
    }

    .badge.wip {
      background: #9e6a03;
      color: #fff;
    }

    .badge.pending {
      background: #30363d;
      color: #8b949e;
    }

    /* Commits */
    .commit {
      display: flex;
      gap: 8px;
      padding: 4px 0;
      font-size: 12px;
      border-bottom: 1px solid #21262d;
    }

    .commit:last-child {
      border: none;
    }

    .commit .hash {
      color: #d29922;
      min-width: 60px;
    }

    .commit .time {
      color: #8b949e;
      min-width: 80px;
    }

    .commit .msg {
      color: #c9d1d9;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Stories list */
    .story {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
      font-size: 12px;
      border-bottom: 1px solid #21262d;
    }

    .story:last-child {
      border: none;
    }

    .story .id {
      color: #d29922;
      min-width: 90px;
      font-weight: bold;
    }

    .story .title {
      flex: 1;
    }

    .check {
      color: #3fb950;
    }

    .cross {
      color: #8b949e;
    }

    /* Status indicator */
    .status-line {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .dot.running {
      background: #3fb950;
      animation: pulse 1.5s infinite;
    }

    .dot.stopped {
      background: #f85149;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.4;
      }
    }

    /* Next story highlight */
    .next-story {
      background: #1c2333;
      border: 1px solid #388bfd;
      border-radius: 6px;
      padding: 12px;
      margin-top: 8px;
    }

    .next-story .label {
      color: #8b949e;
      font-size: 11px;
      text-transform: uppercase;
    }

    .next-story .value {
      color: #58a6ff;
      font-size: 15px;
      font-weight: bold;
      margin-top: 4px;
    }

    /* Elapsed warning */
    .elapsed {
      font-size: 13px;
      margin-top: 8px;
    }

    .elapsed.ok {
      color: #3fb950;
    }

    .elapsed.warn {
      color: #d29922;
    }

    .elapsed.danger {
      color: #f85149;
    }

    /* Refresh indicator */
    .refresh {
      color: #8b949e;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .countdown-ring {
      width: 24px;
      height: 24px;
      position: relative;
    }

    .countdown-ring svg {
      transform: rotate(-90deg);
    }

    .countdown-ring circle {
      fill: none;
      stroke-width: 3;
    }

    .countdown-ring .bg {
      stroke: #30363d;
    }

    .countdown-ring .fg {
      stroke: #58a6ff;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.1s linear;
    }

    .countdown-sec {
      color: #58a6ff;
      font-weight: bold;
      font-size: 14px;
      min-width: 20px;
      text-align: center;
    }
  </style>
</head>

<body>
  <h1>üê∫ Ralph Dashboard</h1>
  <div class="subtitle-row">
    <div class="subtitle">Auto-refresh every <span id="intervalLabel">3</span>s (<a href="?refresh=1"
        style="color:#58a6ff">1s</a> | <a href="?refresh=3" style="color:#58a6ff">3s</a> | <a href="?refresh=5"
        style="color:#58a6ff">5s</a> | <a href="?refresh=10" style="color:#58a6ff">10s</a>)</div>
    <div class="refresh">
      <div class="countdown-ring">
        <svg viewBox="0 0 24 24">
          <circle class="bg" cx="12" cy="12" r="10" />
          <circle class="fg" id="countdownArc" cx="12" cy="12" r="10" />
        </svg>
      </div>
      <span class="countdown-sec" id="countdownSec">3</span>
      <span>Last: <span id="lastUpdate">--</span></span>
    </div>
  </div>

  <div id="errorBanner" style="display:none;background:#f85149;color:#fff;padding:8px 12px;border-radius:6px;margin-bottom:16px;"></div>

  <div class="grid">
    <!-- Progress -->
    <div class="card full">
      <h2>Overall Progress</h2>
      <div class="progress-wrap">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width:0%"></div>
          <div class="progress-text" id="progressText">0%</div>
        </div>
      </div>
      <div class="status-line">
        <div class="dot" id="statusDot"></div>
        <span id="statusText">Checking...</span>
      </div>
    </div>

    <!-- Phases -->
    <div class="card">
      <h2>Phases</h2>
      <table>
        <thead>
          <tr>
            <th>Phase</th>
            <th>Status</th>
            <th>Progress</th>
          </tr>
        </thead>
        <tbody id="phaseTable"></tbody>
      </table>
      <div class="next-story">
        <div class="label">Next Story</div>
        <div class="value" id="nextStory">--</div>
      </div>
    </div>

    <!-- Commits -->
    <div class="card">
      <h2>Recent Commits</h2>
      <div id="commits"></div>
      <div class="elapsed" id="elapsed"></div>
    </div>

    <!-- All Stories -->
    <div class="card full">
      <h2>All Stories</h2>
      <div id="stories"></div>
    </div>
  </div>

  <script>
    // HTML escape helper to prevent XSS from commit messages and PRD content
    function esc(s) {
      if (s == null || s === undefined) return '';
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    async function fetchData() {
      const errEl = document.getElementById('errorBanner');
      const lastEl = document.getElementById('lastUpdate');
      try {
        const res = await fetch('/api/status');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (data.error) throw new Error(data.error);
        if (errEl) errEl.style.display = 'none';
        render(data);
        lastEl.textContent = new Date().toLocaleTimeString();
      } catch (e) {
        console.error('Fetch error:', e);
        if (errEl) {
          errEl.textContent = 'Error: ' + esc(e.message);
          errEl.style.display = 'block';
        }
        lastEl.textContent = 'Failed';
      }
    }

    function render(d) {
      // Progress
      const pct = d.total > 0 ? Math.round(d.passed * 100 / d.total) : 0;
      document.getElementById('progressFill').style.width = pct + '%';
      document.getElementById('progressText').textContent = `${pct}% (${d.passed}/${d.total})`;

      // Status
      const dot = document.getElementById('statusDot');
      const stxt = document.getElementById('statusText');
      if (d.ralph_running) {
        dot.className = 'dot running';
        stxt.textContent = `Ralph RUNNING (PID ${d.ralph_pid})`;
      } else {
        dot.className = 'dot stopped';
        stxt.textContent = 'Ralph NOT RUNNING';
      }

      // Phases
      const pt = document.getElementById('phaseTable');
      pt.innerHTML = (d.phases || []).map(p => {
        const cls = p.done === p.total ? 'done' : p.done > 0 ? 'wip' : 'pending';
        const label = p.done === p.total ? 'DONE' : p.done > 0 ? 'WIP' : '---';
        return `<tr><td>${esc(p.name)}</td><td><span class="badge ${cls}">${label}</span></td><td>${p.done}/${p.total}</td></tr>`;
      }).join('');

      // Next story
      document.getElementById('nextStory').textContent = d.next_story || 'ALL COMPLETE üéâ';

      // Commits (escape to prevent XSS from commit messages)
      const cm = document.getElementById('commits');
      cm.innerHTML = (d.commits || []).map(c =>
        `<div class="commit"><span class="hash">${esc(c.hash)}</span><span class="time">${esc(c.ago)}</span><span class="msg">${esc(c.message)}</span></div>`
      ).join('');

      // Elapsed
      const el = document.getElementById('elapsed');
      if (d.last_commit_elapsed_sec != null) {
        const min = Math.floor(d.last_commit_elapsed_sec / 60);
        const sec = d.last_commit_elapsed_sec % 60;
        const cls = min > 5 ? 'danger' : min > 2 ? 'warn' : 'ok';
        const icon = min > 5 ? '‚ö†Ô∏è' : '‚úÖ';
        el.className = `elapsed ${cls}`;
        el.textContent = `${icon} Last commit ${min}m ${sec}s ago`;
      }

      // Stories (escape id/title to prevent XSS from PRD content)
      const st = document.getElementById('stories');
      st.innerHTML = (d.stories || []).map(s =>
        `<div class="story"><span class="${s.passes ? 'check' : 'cross'}">${s.passes ? '‚úÖ' : '‚¨ú'}</span><span class="id">${esc(s.id)}</span><span class="title">${esc(s.title)}</span></div>`
      ).join('');
    }

    // Configurable refresh: ?refresh=3 (seconds)
    const params = new URLSearchParams(window.location.search);
    const REFRESH_SEC = Math.max(1, Math.min(60, parseInt(params.get('refresh')) || 3));
    const REFRESH_MS = REFRESH_SEC * 1000;
    const CIRC = 2 * Math.PI * 10; // circumference of r=10 circle

    document.getElementById('intervalLabel').textContent = REFRESH_SEC;

    // Countdown state
    let countdown = REFRESH_SEC;
    const arc = document.getElementById('countdownArc');
    const secEl = document.getElementById('countdownSec');
    arc.setAttribute('stroke-dasharray', CIRC);

    function updateCountdown() {
      countdown -= 0.1;
      if (countdown < 0) countdown = 0;
      const frac = countdown / REFRESH_SEC;
      arc.setAttribute('stroke-dashoffset', CIRC * (1 - frac));
      secEl.textContent = Math.ceil(countdown);
    }

    async function tick() {
      countdown = REFRESH_SEC;
      await fetchData();
    }

    tick();
    setInterval(tick, REFRESH_MS);
    setInterval(updateCountdown, 100);
  </script>
</body>

</html>