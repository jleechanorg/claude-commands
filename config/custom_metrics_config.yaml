# ========================================================================
# Claude Code Custom Metrics System Configuration
# ========================================================================
# Version: 3.0 - Generic Event Monitoring Framework
#
# This configuration defines custom events to monitor in Claude responses
# with configurable patterns, actions, and metrics collection.
# ========================================================================

# Event Types Configuration - Define custom events to monitor
event_types:
  # Example: Sycophantic behavior detection (can be disabled/modified)
  sycophantic_patterns:
    enabled: true
    description: "Detects overly agreeable responses that may indicate mistakes"
    patterns:
      - pattern: "\\babsolutely right\\b"
        weight: 89
        name: "absolutely_right"
        description: "Agreement without verification"

      - pattern: "\\byou're absolutely correct\\b"
        weight: 91
        name: "absolutely_correct"
        description: "Blind confirmation"

      - pattern: "\\bexactly\\b(?!\\s*(?:one|two|three|four|five|six|seven|eight|nine|ten|\\d+))"
        weight: 74
        name: "exactly"
        description: "Premature consensus (excluding numbers)"

      - pattern: "\\bspot on\\b"
        weight: 86
        name: "spot_on"
        description: "Uncritical validation"

      - pattern: "\\byou're correct\\b"
        weight: 78
        name: "youre_correct"
        description: "Surface-level agreement"

    # Actions to trigger when this event type is detected
    actions:
      - type: "trigger_command"
        command: ["claude", "slash-command", "learn"]
        description: "Auto-trigger learning when sycophantic patterns detected"

    # Optional metadata
    metadata:
      source: "PR #1580 research"
      correlation_threshold: 70

  # Example: Code quality patterns (disabled by default)
  code_quality_patterns:
    enabled: false
    description: "Detects potentially problematic code quality indicators"
    patterns:
      - pattern: "\\btodo\\b|\\bfixme\\b|\\bhack\\b"
        weight: 50
        name: "technical_debt"
        description: "Technical debt indicators"

      - pattern: "\\bquick(ly)?\\s+(fix|hack|solution)\\b"
        weight: 75
        name: "quick_fix"
        description: "Quick fix indicators"

    actions:
      - type: "trigger_command"
        command: ["echo", "Code quality event detected"]
        description: "Log code quality events"

    metadata:
      category: "code_quality"
      severity: "medium"

  # Example: Performance concern patterns (disabled by default)
  performance_patterns:
    enabled: false
    description: "Detects mentions of performance concerns"
    patterns:
      - pattern: "\\bslow\\b|\\bperformance\\s+issue\\b|\\btimeout\\b"
        weight: 60
        name: "performance_concern"
        description: "Performance-related mentions"

    actions: []  # No actions, just metrics collection
    metadata:
      category: "performance"
      auto_action: false


# Performance Configuration
performance:
  # Execution time limits (in milliseconds)
  pattern_detection_timeout: 100
  action_timeout: 30000  # 30 seconds for command actions
  metrics_ingestion_timeout: 500
  total_hook_timeout: 200

  # Async execution settings
  enable_async_actions: true
  enable_async_metrics: true
  max_concurrent_operations: 3

# GCP Cloud Monitoring Configuration
gcp:
  # Project and authentication
  project_id: "gen-lang-client-0586126505"
  credentials_file: "~/.config/gcp/custom-metrics-service-account.json"

  # Metric configuration
  metric_type: "custom.googleapis.com/claude_custom_metrics"
  metric_display_name: "Claude Code Custom Metrics"
  metric_description: "Tracks configurable events in Claude responses with weights and actions"

  # Resource and labels
  resource_type: "global"
  metric_labels:
    - "event_type"        # Event type name (e.g., "sycophantic_patterns")
    - "pattern"          # Pattern name (e.g., "absolutely_right")
    - "actions_triggered" # Whether configured actions were triggered
    - "branch"           # Git branch name
    - "project"          # Project identifier

  # API settings
  api_timeout: 5.0
  retry_attempts: 3
  retry_delay: 1.0
  batch_size: 10  # Metrics to batch together

# Grafana Configuration
grafana:
  # Dashboard settings
  dashboard_name: "Claude Code Custom Metrics"
  refresh_interval: "30s"
  time_range: "1h"

  # Panel configurations
  panels:
    - name: "Event Detection Rate"
      type: "stat"
      targets: ["custom_metrics_count"]

    - name: "Event Type Distribution"
      type: "piechart"
      targets: ["event_type_breakdown"]

    - name: "Pattern Distribution"
      type: "piechart"
      targets: ["pattern_breakdown"]

    - name: "Correlation Scores Timeline"
      type: "timeseries"
      targets: ["correlation_timeline"]

    - name: "Auto-Learn Success Rate"
      type: "gauge"
      targets: ["learn_success_rate"]

# Security Configuration
security:
  # File permissions
  log_file_permissions: "0600"
  config_file_permissions: "0600"
  credentials_permissions: "0600"

  # Content filtering
  max_content_length: 10000  # Maximum chars to analyze
  enable_content_redaction: true
  redaction_patterns:
    - '\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b'  # Email addresses
    - '\b\d{3}-\d{2}-\d{4}\b'  # SSN pattern
    - '\bsk-[a-zA-Z0-9]{48}\b'  # OpenAI API keys
    - '\bAIza[0-9A-Za-z-_]{35}\b'  # Google API keys

# Learning System Integration
learning:
  # Command execution
  learn_command: ["claude", "slash-command", "learn"]
  learn_timeout: 30
  max_retries: 2

  # Context capture
  capture_conversation_context: true
  context_window_size: 2000  # Characters before/after detection
  exclude_system_messages: true

# Logging Configuration
logging:
  # Log levels: DEBUG, INFO, WARNING, ERROR, CRITICAL
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

  # File logging
  log_file: "~/tmp/custom-metrics/custom-metrics.log"
  max_log_size: "10MB"
  backup_count: 5

  # Console output
  enable_console_output: true
  colored_output: true

# Cost Optimization
cost_optimization:
  # Stay within free tiers
  target_monthly_cost: 0.00

  # GCP free tier limits (150MB/month metric ingestion)
  max_monthly_metrics: 50000
  metrics_size_estimate: 3000  # bytes per metric

  # Grafana free tier limits
  max_metric_series: 10000
  retention_days: 14
  max_users: 3

# Debug and Development
debug:
  enable_debug_mode: false
  debug_log_file: "~/tmp/mistake-detection/debug.log"
  save_raw_responses: false  # Security: Don't save full responses
  simulate_patterns: false   # For testing without real patterns

  # Test patterns (only used when simulate_patterns=true)
  test_patterns:
    - "absolutely right test"
    - "you're absolutely correct test"
    - "exactly what I meant test"

# Feature Flags
features:
  enable_event_detection: true
  enable_gcp_metrics: true
  enable_grafana_logging: true
  enable_actions: true
  enable_context_capture: true
  enable_performance_monitoring: true

# Error Handling
error_handling:
  # Graceful degradation
  continue_on_gcp_failure: true
  continue_on_action_failure: true

  # Error notifications
  log_all_errors: true
  alert_on_critical_errors: false  # Set to true for production alerting

  # Recovery settings
  auto_retry_failed_operations: true
  max_error_rate: 0.1  # 10% error rate threshold

# ========================================================================
# CONFIGURATION GUIDE:
# ========================================================================
#
# This is a generic Claude Code custom metrics framework. To add new event types:
#
# 1. Add new event_types entry with:
#    - enabled: true/false
#    - description: what this event type detects
#    - patterns: list of regex patterns with weights and names
#    - actions: list of commands/actions to trigger
#    - metadata: optional additional data
#
# 2. Configure actions:
#    - type: "trigger_command" for shell commands
#    - command: list of command parts ["command", "arg1", "arg2"]
#    - description: human-readable description
#
# 3. Patterns support full regex with named groups and weights
#
# 4. Enable/disable individual event types as needed
#
# 5. Metrics are automatically sent to GCP Cloud Monitoring
#
# Example use cases:
# - Code quality detection (TODO/FIXME patterns)
# - Performance mention tracking
# - Security keyword monitoring
# - Custom domain-specific patterns
# - Response quality analysis
#
# ========================================================================
