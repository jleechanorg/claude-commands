# âš ï¸ EXAMPLE WORKFLOW - REQUIRES INTEGRATION
# This workflow was exported from a working project and serves as an EXAMPLE ONLY.
# You MUST adapt the following before using:
# - $GCP_PROJECT_ID â†’ Your Google Cloud project ID
# - $GITHUB_REPOSITORY â†’ Your repository (owner/repo)
# - $GITHUB_OWNER â†’ Your GitHub username or org
# - Service account configurations and secrets
# - Environment-specific variables and paths
#
# See workflows/README.md for integration instructions.
# ---

# Deploy to Production
# Manual trigger only - requires approval via protected environment

name: Deploy to Production

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy-production:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Production deployments may take longer

    # ðŸš¨ PROTECTED ENVIRONMENT - Requires manual approval in GitHub UI
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1

      - name: Production deployment notice
        run: |
          echo "ðŸš¨ DEPLOYING TO PRODUCTION ðŸš¨"
          echo "Environment: production"
          echo "Service: mvp-site-app-stable"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "âš ï¸  This deployment has been manually approved"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@55bd3a7c6e2ae7cf1877fd1ccb9d54c0503c457c  # v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@98ddc00a17442e89a24bbf282954a3b65ce6d200  # v2

      - name: Configure gcloud CLI defaults
        run: |
          gcloud config set project $GCP_PROJECT_ID
          gcloud config set run/region us-central1

      - name: Verify GCP authentication
        run: |
          echo "ðŸ” Verifying GCP authentication..."
          gcloud auth list
          gcloud config list project
          echo "âœ… GCP authentication verified"

      - name: Deploy to Cloud Run (Production)
        env:
          GITHUB_ACTIONS: "true"
        run: |
          chmod +x ./deploy.sh
          echo "ðŸš¨ DEPLOYING TO PRODUCTION ðŸš¨"
          ./deploy.sh mvp_site stable
        timeout-minutes: 40  # Production build time

      - name: Get deployment URL
        id: get-url
        run: |
          URL=$(gcloud run services describe mvp-site-app-stable \
            --region=us-central1 \
            --project=$GCP_PROJECT_ID \
            --format='value(status.url)')
          if [ -z "$URL" ]; then
            echo "âŒ Failed to retrieve deployment URL"
            exit 1
          fi
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "ðŸŒ Production URL: $URL"

      - name: Health check
        run: |
          HEALTH_URL="${{ steps.get-url.outputs.url }}/health"
          echo "ðŸ¥ Performing health check at ${HEALTH_URL}"
          MAX_RETRIES=15  # More retries for production
          RETRY_COUNT=0
          SLEEP_DURATION=10  # Longer wait between retries

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Health check attempt $(($RETRY_COUNT + 1))/$MAX_RETRIES..."

            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || true)
            if [ "$STATUS" = "200" ]; then
              echo "âœ… Production health check passed!"
              exit 0
            fi

            echo "Health check returned status $STATUS"
            RETRY_COUNT=$(($RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Health check failed, retrying in ${SLEEP_DURATION}s..."
              sleep $SLEEP_DURATION
            fi
          done

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Production deployment summary
        if: success()
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **PRODUCTION DEPLOYMENT COMPLETED**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** mvp-site-app-stable" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** us-central1" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** $GCP_PROJECT_ID" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** ${{ steps.get-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Service Health](${{ steps.get-url.outputs.url }}/health)" >> $GITHUB_STEP_SUMMARY
          echo "- [Cloud Run Console](https://console.cloud.google.com/run/detail/us-central1/mvp-site-app-stable?project=$GCP_PROJECT_ID)" >> $GITHUB_STEP_SUMMARY
          echo "- [Logs](https://console.cloud.google.com/logs/query?project=$GCP_PROJECT_ID&query=resource.type%3D%22cloud_run_revision%22%0Aresource.labels.service_name%3D%22mvp-site-app-stable%22)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "The service has been deployed to production and health checks passed." >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ Production Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** production" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Failed step:** Check workflow logs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **PRODUCTION WAS NOT UPDATED**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the workflow logs for details and retry after fixing the issue." >> $GITHUB_STEP_SUMMARY

      - name: Send failure email notification
        if: failure()
        uses: ./.github/actions/send-deploy-notification
        with:
          status: failure
          environment: production
          service_name: mvp-site-app-stable
          region: us-central1
          project: $GCP_PROJECT_ID
          branch: ${{ github.ref_name }}
          commit_sha: ${{ github.sha }}
          commit_url: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          # pr_url will normally be empty here because this workflow is triggered manually (workflow_dispatch), not by pull request events.
          pr_url: ${{ github.event.pull_request.html_url || '' }}
          deployment_url: ${{ steps.get-url.outputs.url }}
          workflow_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          email_user: ${{ secrets.EMAIL_USER }}
          email_password: ${{ secrets.EMAIL_APP_PASSWORD }}

      - name: Send success email notification
        if: success()
        uses: ./.github/actions/send-deploy-notification
        with:
          status: success
          environment: production
          service_name: mvp-site-app-stable
          region: us-central1
          project: $GCP_PROJECT_ID
          branch: ${{ github.ref_name }}
          commit_sha: ${{ github.sha }}
          commit_url: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          # pr_url will normally be empty here because this workflow is triggered manually (workflow_dispatch), not by pull request events.
          pr_url: ${{ github.event.pull_request.html_url || '' }}
          deployment_url: ${{ steps.get-url.outputs.url }}
          workflow_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          email_user: ${{ secrets.EMAIL_USER }}
          email_password: ${{ secrets.EMAIL_APP_PASSWORD }}
