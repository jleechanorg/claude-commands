# âš ï¸ EXAMPLE WORKFLOW - REQUIRES INTEGRATION
# This workflow was exported from a working project and serves as an EXAMPLE ONLY.
# You MUST adapt the following before using:
# - $GCP_PROJECT_ID â†’ Your Google Cloud project ID
# - $GITHUB_REPOSITORY â†’ Your repository (owner/repo)
# - $GITHUB_OWNER â†’ Your GitHub username or org
# - Service account configurations and secrets
# - Environment-specific variables and paths
#
# See workflows/README.md for integration instructions.
# ---

name: MCP Smoke Tests

# Security permissions
permissions:
  contents: read
  pull-requests: write
  issues: write

# Smoke coverage:
# - Mock API smoke tests on PR/push to main/dev, or after preview deploy completion (workflow_run)
# - Real E2E preview smoke tests on /smoke comments or workflow_dispatch only
# CI trigger noop: 2026-02-22T14:44:00Z
on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to test'
        required: true
        type: number
      test_mode:
        description: 'Test mode (mock or real)'
        required: false
        type: string
        default: 'real'
  workflow_run:
    workflows: ["Deploy PR Preview (Rotating Pool)"]
    types: [completed]
  pull_request:
    paths:
      - 'mvp_site/mcp_*.py'
      - 'mvp_site/tests/mcp_*.py'
      - 'mvp_site/tests/test_mcp_*.py'
      - 'mvp_site/firestore_service.py'
      - 'mvp_site/world_logic.py'
      - 'mvp_site/game_state.py'
      - 'mvp_site/llm_service.py'
      - '.github/workflows/mcp-smoke-tests.yml'
      - 'scripts/mcp_smoke_test.sh'
      - 'testing_mcp/test_smoke.py'
      - 'testing_mcp/lib/**'
      - 'scripts/mcp-smoke-tests.mjs'
  push:
    branches: [ main, dev ]
    paths:
      - 'mvp_site/mcp_*.py'
      - 'mvp_site/tests/mcp_*.py'
      - 'mvp_site/tests/test_mcp_*.py'
      - 'mvp_site/firestore_service.py'
      - 'mvp_site/world_logic.py'
      - 'mvp_site/game_state.py'
      - 'mvp_site/llm_service.py'
      - '.github/workflows/mcp-smoke-tests.yml'
      - 'scripts/mcp_smoke_test.sh'
      - 'testing_mcp/test_smoke.py'
      - 'testing_mcp/lib/**'
      - 'scripts/mcp-smoke-tests.mjs'

jobs:
  limit-pr-runs:
    if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      pull-requests: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1 # v4.1.1
      - name: Limit PR runs
        uses: ./.github/actions/limit-pr-runs
        with:
          gh_token: ${{ secrets.GITHUB_TOKEN }}

  try-self-hosted:
    name: MCP Server Smoke Tests [Mock APIs]
    if: github.event_name == 'pull_request' || github.event_name == 'push' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: [self-hosted, claude]
    continue-on-error: true
    outputs:
      success: ${{ steps.mark-success.outputs.success }}
    timeout-minutes: 10
    env:
      GCP_REGION: us-central1
      GCP_PROJECT: $GCP_PROJECT_ID
      PYTHON_VERSION: '3.11'
      TESTING: true
      FLASK_ENV: testing
      TEST_MODE: mock
      MOCK_SERVICES_MODE: true
      STREAM_RESPONSE_SIGNING_SECRET: ${{ secrets.STREAM_RESPONSE_SIGNING_SECRET }}
      SMOKE_TOKEN: ${{ secrets.SMOKE_TOKEN }}

    steps:

    - name: Get PR ref for workflow_run trigger
      if: github.event_name == 'workflow_run'
      id: pr_ref
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
      with:
        result-encoding: string
        script: |
          const workflowRun = context.payload.workflow_run;
          let prNumber;
          let fallbackSha = workflowRun?.head_sha || '';

          if (workflowRun?.pull_requests && workflowRun.pull_requests.length > 0) {
            prNumber = workflowRun.pull_requests[0].number;
          } else if (workflowRun?.head_branch) {
            const match = workflowRun.head_branch.match(/pr-(\d+)/);
            if (match) {
              prNumber = Number(match[1]);
            }
          }

          if (!prNumber || Number.isNaN(prNumber)) {
            // Use fallback SHA from workflow_run event
            core.setOutput('pr_number', '');
            return fallbackSha || context.sha;
          }

          const pr = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber
          });

          // Export PR number and tested SHA for comment posting
          const testedSha = fallbackSha || pr.data.head.sha || context.sha;
          core.setOutput('pr_number', String(prNumber));
          core.setOutput('tested_sha', testedSha);

          // Use SHA from completed deployment run to match deployed code
          return testedSha;

    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1  # v4.1.1
      with:
        ref: ${{ github.event_name == 'workflow_run' && steps.pr_ref.outputs.result || '' }}
        submodules: recursive

    - name: Set up Python
      if: runner.os == 'Linux'
      uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c  # v5.0.0
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809  # v4.2.4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('mvp_site/requirements*.txt', 'requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Cache fastembed model
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809  # v4.2.4
      with:
        path: ~/.cache/fastembed
        key: fastembed-bge-small-en-v1.5

    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install -r mvp_site/requirements.txt
        if [ -f mvp_site/requirements-test.txt ]; then pip3 install -r mvp_site/requirements-test.txt; fi

    - name: Pre-warm fastembed model
      run: |
        python3 -c "from fastembed import TextEmbedding; TextEmbedding(model_name='BAAI/bge-small-en-v1.5', cache_dir='$HOME/.cache/fastembed'); print('fastembed model ready')"

    - name: Setup test environment
      run: |
        # Create necessary directories
        mkdir -p /tmp/your-project.com/test

    - name: Authenticate to Google Cloud
      if: github.event_name == 'workflow_run' || github.event_name == 'pull_request'
      uses: google-github-actions/auth@55bd3a7c6e2ae7cf1877fd1ccb9d54c0503c457c  # v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up gcloud SDK
      if: github.event_name == 'workflow_run' || github.event_name == 'pull_request'
      uses: google-github-actions/setup-gcloud@98ddc00a17442e89a24bbf282954a3b65ce6d200  # v2
      with:
        project_id: ${{ env.GCP_PROJECT }}

    - name: Determine deployed preview service URL
      id: service_url
      run: |
        set -euo pipefail

        if [ "${{ github.event_name }}" = "workflow_run" ]; then
          PR_NUMBER="${{ steps.pr_ref.outputs.pr_number }}"
          PR_HEAD_SHA="${{ steps.pr_ref.outputs.tested_sha }}"
          if [ -z "$PR_NUMBER" ] || [ -z "$PR_HEAD_SHA" ]; then
            echo "::error::Could not resolve PR number or commit SHA for workflow_run"
            echo "deployed=false" >> "$GITHUB_OUTPUT"
            echo "service_url=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          PR_NUMBER="${{ github.event.number }}"
          PR_HEAD_SHA="${{ github.event.pull_request.head.sha }}"
        else
          echo "âš ï¸  No preview lookup needed for this event"
          echo "deployed=false" >> "$GITHUB_OUTPUT"
          echo "service_url=" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        if [ -z "$PR_NUMBER" ] || [ -z "$PR_HEAD_SHA" ]; then
          echo "âš ï¸  Could not resolve preview lookup context"
          echo "deployed=false" >> "$GITHUB_OUTPUT"
          echo "service_url=" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "ðŸ” Searching for preview for PR #${PR_NUMBER} at commit ${PR_HEAD_SHA}"
        SERVICE_NAME=$(gcloud run services list \
          --region="${GCP_REGION}" \
          --project="${GCP_PROJECT}" \
          --filter="metadata.labels.pr-number=$PR_NUMBER AND metadata.labels.commit-sha=$PR_HEAD_SHA" \
          --format="value(metadata.name)" \
          --limit=1 \
          --quiet 2>/dev/null || echo "")

        if [ -z "$SERVICE_NAME" ]; then
          echo "âš ï¸  No service found"
          echo "deployed=false" >> "$GITHUB_OUTPUT"
          echo "service_url=" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        SERVICE_URL=$(gcloud run services describe "$SERVICE_NAME" \
          --platform managed \
          --region "${GCP_REGION}" \
          --project "${GCP_PROJECT}" \
          --format="value(status.url)" \
          --quiet 2>/dev/null || echo "")

        if [ -z "$SERVICE_URL" ]; then
          echo "âš ï¸  Found service $SERVICE_NAME but no URL was returned"
          echo "deployed=false" >> "$GITHUB_OUTPUT"
          echo "service_url=" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "âœ… Found deployed preview: $SERVICE_URL"
        echo "deployed=true" >> "$GITHUB_OUTPUT"
        echo "service_url=$SERVICE_URL" >> "$GITHUB_OUTPUT"

    - name: Run MCP smoke tests
      id: smoke_tests
      run: |
        chmod +x scripts/mcp_smoke_test.sh
        if [ "${{ github.event_name }}" = "workflow_run" ]; then
          if [ "${{ steps.service_url.outputs.deployed }}" != "true" ]; then
            echo "::error::Could not find deployed preview for mock smoke tests"
            exit 1
          fi
          export MCP_SERVER_URL="${{ steps.service_url.outputs.service_url }}"
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          if [ "${{ steps.service_url.outputs.deployed }}" != "true" ]; then
            echo "::warning::Could not find deployed preview for mock smoke tests; skipping"
            exit 0
          fi
          export MCP_SERVER_URL="${{ steps.service_url.outputs.service_url }}"
        fi
        ./scripts/mcp_smoke_test.sh

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
      with:
        name: mcp-smoke-test-results-mock-apis
        path: |
          /tmp/your-project.com/test/*.log
          /tmp/your-project.com/test/smoke-test-results.json
          /tmp/your-project.com/test/mcp-requests-responses.json
        retention-days: 7

    - name: Mark successful completion
      id: mark-success
      if: success()
      run: echo "success=true" >> $GITHUB_OUTPUT

    - name: Read test results
      id: test-results
      if: github.event_name == 'workflow_run' && steps.pr_ref.outputs.pr_number && always()
      run: |
        if [ -f /tmp/your-project.com/test/smoke-test-results.json ]; then
          if command -v jq >/dev/null 2>&1; then
            TEST_DETAILS=$(cat /tmp/your-project.com/test/smoke-test-results.json | jq -c '.test_details // []' 2>&1) || {
              echo "âš ï¸  Warning: jq parse failed, defaulting to empty array" >&2
              TEST_DETAILS="[]"
            }
            RESULT_SERVER_URL=$(jq -r '.server_url // ""' /tmp/your-project.com/test/smoke-test-results.json 2>/dev/null || echo "")
          else
            echo "âš ï¸  Warning: jq not found, defaulting to empty array" >&2
            TEST_DETAILS="[]"
            RESULT_SERVER_URL=""
          fi
          echo "test_details=$TEST_DETAILS" >> $GITHUB_OUTPUT
          echo "server_url=$RESULT_SERVER_URL" >> $GITHUB_OUTPUT
        else
          echo "test_details=[]" >> $GITHUB_OUTPUT
          echo "server_url=" >> $GITHUB_OUTPUT
        fi

    - name: Build workflow_run comment body
      if: github.event_name == 'workflow_run' && steps.pr_ref.outputs.pr_number && steps.service_url.outputs.deployed == 'true' && always()
      id: smoke_comment_body
      run: |
        RESULT="${{ steps.smoke_tests.outcome }}"
        if [ -z "$RESULT" ]; then
          RESULT="failure"
        fi
        TEST_DETAILS='${{ steps.test-results.outputs.test_details }}'
        if [ "$TEST_DETAILS" = "[]" ] || [ -z "$TEST_DETAILS" ]; then
          TEST_DETAILS=""
        fi
        # Require deployed preview URL for reporting context
        DISPLAY_URL="${{ steps.service_url.outputs.service_url }}"
        if [ -z "$DISPLAY_URL" ]; then
          echo "::error::Missing deployed preview URL for MCP smoke test report"
          exit 1
        fi

        node scripts/mcp_smoke_comment.js \
          --result "$RESULT" \
          --mode "${{ env.TEST_MODE }}" \
          --service-url "$DISPLAY_URL" \
          ${TEST_DETAILS:+--items "$TEST_DETAILS"} \
          --run-id "${{ github.run_id }}" \
          --repo "${{ github.repository }}" \
          --server-url "${{ github.server_url }}" \
          --commit-sha "${{ steps.pr_ref.outputs.tested_sha }}" \
          > /tmp/mcp-smoke-comment-body.md

    - name: Post workflow_run comment
      if: github.event_name == 'workflow_run' && steps.pr_ref.outputs.pr_number && steps.service_url.outputs.deployed == 'true' && always()
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const body = fs.readFileSync('/tmp/mcp-smoke-comment-body.md', 'utf8');

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: Number('${{ steps.pr_ref.outputs.pr_number }}'),
            body
          });

  fallback-github-hosted:
    name: MCP Server Smoke Tests [Mock APIs] (Fallback)
    needs: try-self-hosted
    if: (github.event_name == 'pull_request' || github.event_name == 'push' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')) && needs.try-self-hosted.outputs.success != 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      GCP_REGION: us-central1
      GCP_PROJECT: $GCP_PROJECT_ID
      PYTHON_VERSION: '3.11'
      TESTING: true
      FLASK_ENV: testing
      TEST_MODE: mock
      MOCK_SERVICES_MODE: true
      STREAM_RESPONSE_SIGNING_SECRET: ${{ secrets.STREAM_RESPONSE_SIGNING_SECRET }}
      SMOKE_TOKEN: ${{ secrets.SMOKE_TOKEN }}

    steps:
    - name: Get PR ref for workflow_run trigger
      if: github.event_name == 'workflow_run'
      id: pr_ref
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
      with:
        result-encoding: string
        script: |
          const workflowRun = context.payload.workflow_run;
          let prNumber;
          let fallbackSha = workflowRun?.head_sha || '';

          if (workflowRun?.pull_requests && workflowRun.pull_requests.length > 0) {
            prNumber = workflowRun.pull_requests[0].number;
          } else if (workflowRun?.head_branch) {
            const match = workflowRun.head_branch.match(/pr-(\d+)/);
            if (match) {
              prNumber = Number(match[1]);
            }
          }

          if (!prNumber || Number.isNaN(prNumber)) {
            // Use fallback SHA from workflow_run event
            core.setOutput('pr_number', '');
            return fallbackSha || context.sha;
          }

          const pr = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: prNumber
          });

          // Export PR number and tested SHA for comment posting
          const testedSha = fallbackSha || pr.data.head.sha || context.sha;
          core.setOutput('pr_number', String(prNumber));
          core.setOutput('tested_sha', testedSha);

          // Use SHA from completed deployment run to match deployed code
          return testedSha;

    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1  # v4.1.1
      with:
        ref: ${{ github.event_name == 'workflow_run' && steps.pr_ref.outputs.result || '' }}
        submodules: recursive

    - name: Set up Python
      uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c  # v5.0.0
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Cache pip dependencies
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809  # v4.2.4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('mvp_site/requirements*.txt', 'requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Cache fastembed model
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809  # v4.2.4
      with:
        path: ~/.cache/fastembed
        key: fastembed-bge-small-en-v1.5

    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        if [ -f mvp_site/requirements.txt ]; then pip3 install -r mvp_site/requirements.txt; fi

    - name: Pre-warm fastembed model
      run: |
        python3 -c "from fastembed import TextEmbedding; TextEmbedding(model_name='BAAI/bge-small-en-v1.5', cache_dir='$HOME/.cache/fastembed'); print('fastembed model ready')"

    - name: Setup test environment
      run: |
        # Create necessary directories
        mkdir -p /tmp/your-project.com/test

    - name: Authenticate to Google Cloud
      if: github.event_name == 'workflow_run' || github.event_name == 'pull_request'
      uses: google-github-actions/auth@55bd3a7c6e2ae7cf1877fd1ccb9d54c0503c457c  # v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up gcloud SDK
      if: github.event_name == 'workflow_run' || github.event_name == 'pull_request'
      uses: google-github-actions/setup-gcloud@98ddc00a17442e89a24bbf282954a3b65ce6d200  # v2
      with:
        project_id: ${{ env.GCP_PROJECT }}

    - name: Determine deployed preview service URL
      id: service_url
      run: |
        set -euo pipefail

        if [ "${{ github.event_name }}" = "workflow_run" ]; then
          PR_NUMBER="${{ steps.pr_ref.outputs.pr_number }}"
          PR_HEAD_SHA="${{ steps.pr_ref.outputs.tested_sha }}"
          if [ -z "$PR_NUMBER" ] || [ -z "$PR_HEAD_SHA" ]; then
            echo "::error::Could not resolve PR number or commit SHA for workflow_run"
            echo "deployed=false" >> "$GITHUB_OUTPUT"
            echo "service_url=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          PR_NUMBER="${{ github.event.number }}"
          PR_HEAD_SHA="${{ github.event.pull_request.head.sha }}"
        else
          echo "âš ï¸  No preview lookup needed for this event"
          echo "deployed=false" >> "$GITHUB_OUTPUT"
          echo "service_url=" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        if [ -z "$PR_NUMBER" ] || [ -z "$PR_HEAD_SHA" ]; then
          echo "âš ï¸  Could not resolve preview lookup context"
          echo "deployed=false" >> "$GITHUB_OUTPUT"
          echo "service_url=" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "ðŸ” Searching for preview for PR #${PR_NUMBER} at commit ${PR_HEAD_SHA}"
        SERVICE_NAME=$(gcloud run services list \
          --region="${GCP_REGION}" \
          --project="${GCP_PROJECT}" \
          --filter="metadata.labels.pr-number=$PR_NUMBER AND metadata.labels.commit-sha=$PR_HEAD_SHA" \
          --format="value(metadata.name)" \
          --limit=1 \
          --quiet 2>/dev/null || echo "")

        if [ -z "$SERVICE_NAME" ]; then
          echo "âš ï¸  No service found"
          echo "deployed=false" >> "$GITHUB_OUTPUT"
          echo "service_url=" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        SERVICE_URL=$(gcloud run services describe "$SERVICE_NAME" \
          --platform managed \
          --region "${GCP_REGION}" \
          --project "${GCP_PROJECT}" \
          --format="value(status.url)" \
          --quiet 2>/dev/null || echo "")

        if [ -z "$SERVICE_URL" ]; then
          echo "âš ï¸  Found service $SERVICE_NAME but no URL was returned"
          echo "deployed=false" >> "$GITHUB_OUTPUT"
          echo "service_url=" >> "$GITHUB_OUTPUT"
          exit 0
        fi

        echo "âœ… Found deployed preview: $SERVICE_URL"
        echo "deployed=true" >> "$GITHUB_OUTPUT"
        echo "service_url=$SERVICE_URL" >> "$GITHUB_OUTPUT"

    - name: Run MCP smoke tests
      id: smoke_tests
      run: |
        echo "ðŸ”„ Running on GitHub-hosted fallback..."
        chmod +x scripts/mcp_smoke_test.sh
        if [ "${{ github.event_name }}" = "workflow_run" ]; then
          if [ "${{ steps.service_url.outputs.deployed }}" != "true" ]; then
            echo "::error::Could not find deployed preview for mock smoke tests"
            exit 1
          fi
          export MCP_SERVER_URL="${{ steps.service_url.outputs.service_url }}"
        elif [ "${{ github.event_name }}" = "pull_request" ]; then
          if [ "${{ steps.service_url.outputs.deployed }}" != "true" ]; then
            echo "::warning::Could not find deployed preview for mock smoke tests; skipping"
            exit 0
          fi
          export MCP_SERVER_URL="${{ steps.service_url.outputs.service_url }}"
        fi
        ./scripts/mcp_smoke_test.sh

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
      with:
        name: mcp-smoke-test-results-fallback
        path: |
          /tmp/your-project.com/test/*.log
          /tmp/your-project.com/test/smoke-test-results.json
          /tmp/your-project.com/test/mcp-requests-responses.json
        retention-days: 7

    - name: Read test results (fallback)
      id: test-results-fallback
      if: github.event_name == 'workflow_run' && steps.pr_ref.outputs.pr_number && always()
      run: |
        if [ -f /tmp/your-project.com/test/smoke-test-results.json ]; then
          if command -v jq >/dev/null 2>&1; then
            TEST_DETAILS=$(cat /tmp/your-project.com/test/smoke-test-results.json | jq -c '.test_details // []' 2>&1) || {
              echo "âš ï¸  Warning: jq parse failed, defaulting to empty array" >&2
              TEST_DETAILS="[]"
            }
            RESULT_SERVER_URL=$(jq -r '.server_url // ""' /tmp/your-project.com/test/smoke-test-results.json 2>/dev/null || echo "")
          else
            echo "âš ï¸  Warning: jq not found, defaulting to empty array" >&2
            TEST_DETAILS="[]"
            RESULT_SERVER_URL=""
          fi
          echo "test_details=$TEST_DETAILS" >> $GITHUB_OUTPUT
          echo "server_url=$RESULT_SERVER_URL" >> $GITHUB_OUTPUT
        else
          echo "test_details=[]" >> $GITHUB_OUTPUT
          echo "server_url=" >> $GITHUB_OUTPUT
        fi

    - name: Build workflow_run comment body (fallback)
      if: github.event_name == 'workflow_run' && steps.pr_ref.outputs.pr_number && steps.service_url.outputs.deployed == 'true' && always()
      id: smoke_comment_body
      run: |
        RESULT="${{ steps.smoke_tests.outcome }}"
        if [ -z "$RESULT" ]; then
          RESULT="failure"
        fi
        TEST_DETAILS='${{ steps.test-results-fallback.outputs.test_details }}'
        if [ "$TEST_DETAILS" = "[]" ] || [ -z "$TEST_DETAILS" ]; then
          TEST_DETAILS=""
        fi
        # Require deployed preview URL for reporting context
        DISPLAY_URL="${{ steps.service_url.outputs.service_url }}"
        if [ -z "$DISPLAY_URL" ]; then
          echo "::error::Missing deployed preview URL for MCP smoke test report"
          exit 1
        fi

        node scripts/mcp_smoke_comment.js \
          --result "$RESULT" \
          --mode "${{ env.TEST_MODE }}" \
          --service-url "$DISPLAY_URL" \
          ${TEST_DETAILS:+--items "$TEST_DETAILS"} \
          --run-id "${{ github.run_id }}" \
          --repo "${{ github.repository }}" \
          --server-url "${{ github.server_url }}" \
          --commit-sha "${{ steps.pr_ref.outputs.tested_sha }}" \
          > /tmp/mcp-smoke-comment-body-fallback.md

    - name: Post workflow_run comment (fallback)
      if: github.event_name == 'workflow_run' && steps.pr_ref.outputs.pr_number && steps.service_url.outputs.deployed == 'true' && always()
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const body = fs.readFileSync('/tmp/mcp-smoke-comment-body-fallback.md', 'utf8');

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: Number('${{ steps.pr_ref.outputs.pr_number }}'),
            body
          });

  preview-smoke-tests:
    name: MCP Smoke Tests [Preview E2E]
    if: (github.event_name == 'issue_comment' && github.event.issue.pull_request && startsWith(github.event.comment.body, '/smoke') && contains(fromJSON('["OWNER","MEMBER","COLLABORATOR"]'), github.event.comment.author_association)) || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    env:
      GCP_REGION: us-central1
      GCP_PROJECT: $GCP_PROJECT_ID
      MCP_TEST_TIMEOUT_MS: ${{ vars.MCP_TEST_TIMEOUT_MS || '120000' }}
      MCP_TEST_MAX_ATTEMPTS: ${{ vars.MCP_TEST_MAX_ATTEMPTS || '3' }}
      MCP_TEST_RETRY_DELAY_MS: ${{ vars.MCP_TEST_RETRY_DELAY_MS || '2000' }}
      STREAM_RESPONSE_SIGNING_SECRET: ${{ secrets.STREAM_RESPONSE_SIGNING_SECRET }}
      SMOKE_TOKEN: ${{ secrets.SMOKE_TOKEN }}

    steps:
      - name: Post acknowledgment comment
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸ”¥ **MCP Smoke Tests Started**\n\nRunning MCP smoke tests against deployed GCP preview server...\n\n[View workflow run â†’](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
            });

      - name: Get PR ref
        id: pr_ref
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          result-encoding: string
          script: |
            let prNumber;
            if (context.eventName === 'workflow_dispatch') {
              const rawInput = context.payload?.inputs?.pr_number;
              if (rawInput) {
                prNumber = Number(rawInput);
              }
            } else if (context.eventName === 'issue_comment') {
              if (!context.payload.issue?.pull_request) {
                core.setFailed('Could not determine PR from issue comment; comment is not on a pull request');
                return '';
              }
              prNumber = context.payload.issue.number;
            }

            if (!prNumber || Number.isNaN(prNumber)) {
              core.setFailed('Could not determine PR number for workflow trigger');
              return '';
            }

            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const headSha = pr.data.head.sha || '';
            // CRITICAL: Checkout must match the SHA used for service lookup to avoid version mismatch
            const headRef = headSha ? headSha : `refs/pull/${pr.data.number}/head`;
            core.setOutput('pr_number', String(pr.data.number));
            core.setOutput('head_sha', headSha);
            core.setOutput('head_ref', headRef);
            return headRef;

      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4.3.1  # v4.1.1
        with:
          ref: ${{ steps.pr_ref.outputs.result }}

      - name: Set up Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c  # v5.0.0
        with:
          python-version: '3.11'

      - name: Install smoke test dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r mvp_site/requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@55bd3a7c6e2ae7cf1877fd1ccb9d54c0503c457c  # v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@98ddc00a17442e89a24bbf282954a3b65ce6d200  # v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Capture PR metadata
        id: pr_number
        run: |
          set -euo pipefail
          PR_NUMBER="${{ steps.pr_ref.outputs.pr_number }}"
          PR_HEAD_SHA="${{ steps.pr_ref.outputs.head_sha }}"

          if [ -z "$PR_NUMBER" ]; then
            echo "::error::Could not resolve PR number from metadata."
            exit 1
          fi

          if [ -z "$PR_HEAD_SHA" ]; then
            echo "::error::Could not resolve PR head SHA from metadata."
            exit 1
          fi

          echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "head_sha=$PR_HEAD_SHA" >> "$GITHUB_OUTPUT"

      - name: Determine test mode
        id: test_config
        run: |
          # Determine test mode using script from PR branch (Option C: hybrid approach)
          # This allows PR changes to test mode logic to take effect immediately
          chmod +x scripts/determine-smoke-mode.sh
          TEST_MODE=$(scripts/determine-smoke-mode.sh "${{ github.event_name }}" "${{ github.event.inputs.test_mode || '' }}")
          echo "mode=$TEST_MODE" >> "$GITHUB_OUTPUT"

      - name: Determine deployed service URL
        id: service_url
        run: |
          set -euo pipefail

          PR_NUMBER="${{ steps.pr_number.outputs.number }}"
          PR_HEAD_SHA="${{ steps.pr_number.outputs.head_sha }}"

          # Query all services with both PR and commit labels (supports rotating server pool)
          echo "ðŸ” Searching for service with labels pr-number=$PR_NUMBER and commit-sha=$PR_HEAD_SHA"
          SERVICE_NAME=$(gcloud run services list \
            --region="${{ env.GCP_REGION }}" \
            --filter="metadata.labels.pr-number=$PR_NUMBER AND metadata.labels.commit-sha=$PR_HEAD_SHA" \
            --format="value(metadata.name)" \
            --limit=1 \
            --quiet 2>/dev/null || echo "")

          if [ -z "$SERVICE_NAME" ]; then
            echo "::error::No deployed preview found for PR #$PR_NUMBER at commit $PR_HEAD_SHA"
            echo "service_url=" >> "$GITHUB_OUTPUT"
            echo "deployed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "âœ… Found service: $SERVICE_NAME"

          # Get service URL
          SERVICE_URL=$(gcloud run services describe "$SERVICE_NAME" \
            --region="${{ env.GCP_REGION }}" \
            --format="value(status.url)" \
            --quiet 2>/dev/null || echo "")

          if [ -z "$SERVICE_URL" ]; then
            echo "::error::Service $SERVICE_NAME found but no URL available"
            echo "service_url=" >> "$GITHUB_OUTPUT"
            echo "deployed=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # URL resolved; log before exporting outputs for downstream steps
          echo "âœ… Service URL: $SERVICE_URL"
          echo "service_url=$SERVICE_URL" >> "$GITHUB_OUTPUT"
          echo "deployed=true" >> "$GITHUB_OUTPUT"

      - name: Post "no preview" comment
        if: github.event_name == 'issue_comment' && steps.service_url.outputs.deployed == 'false'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const headSha = `${{ steps.pr_number.outputs.head_sha }}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âš ï¸ **No Deployed Preview Found**\n\n` +
                `Cannot run MCP smoke tests - no deployed preview exists for PR #${context.issue.number}` +
                ` at commit \`${headSha}\`.\n\n` +
                'Please wait for the preview to deploy first, or trigger a new deployment.'
            });

      - name: Set up Node.js 20.x
        if: steps.service_url.outputs.deployed == 'true'
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8  # v4.0.2
        with:
          node-version: 20

      - name: Run MCP smoke tests
        if: steps.service_url.outputs.deployed == 'true'
        id: smoke_tests
        timeout-minutes: 25  # Extended for real mode: 3 providers x ~8min each
        env:
          MCP_SERVER_URL: ${{ steps.service_url.outputs.service_url }}
          MCP_TEST_MODE: ${{ steps.test_config.outputs.mode }}
        run: |
          set -euo pipefail

          echo "ðŸ§ª Running MCP smoke tests against deployed preview..."
          echo "Target: $MCP_SERVER_URL/mcp"

          set +e
          node scripts/mcp-smoke-tests.mjs
          EXIT_CODE=$?
          set -e

          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"

          if [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… MCP smoke tests passed"
          else
            echo "âŒ MCP smoke tests failed"
            exit $EXIT_CODE
          fi

      - name: Upload smoke test logs
        if: always() && steps.service_url.outputs.deployed == 'true'
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
        with:
          name: mcp-smoke-logs-pr-${{ steps.pr_number.outputs.number }}
          path: /tmp/your-project.com/*/smoke_tests/*.log
          retention-days: 14
          if-no-files-found: ignore

      - name: Upload smoke test results
        if: always() && steps.service_url.outputs.deployed == 'true'
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
        with:
          name: mcp-smoke-results-pr-${{ steps.pr_number.outputs.number }}
          path: /tmp/your-project.com/*/smoke_tests/test_results.json
          retention-days: 14
          if-no-files-found: ignore

      - name: Build smoke comment body
        if: always() && steps.pr_number.outputs.number && steps.service_url.outputs.deployed == 'true'
        id: smoke_comment_body
        run: |
          echo "âš™ï¸ Building smoke test comment body"
          RESULT="${{ steps.smoke_tests.outcome }}"
          SERVICE_URL="${{ steps.service_url.outputs.service_url }}"
          if [ -z "$SERVICE_URL" ]; then
            echo "::error::Could not resolve preview service URL for smoke test report"
            exit 1
          fi
          if [ -z "$RESULT" ]; then
            RESULT="failure"
          fi

          # Read per-test results from test_results.json written by mcp-smoke-tests.mjs
          RESULTS_JSON=$(find /tmp/your-project.com -name "test_results.json" 2>/dev/null | head -1)
          if [ -n "$RESULTS_JSON" ] && [ -f "$RESULTS_JSON" ]; then
            TEST_ITEMS=$(jq -c '.tests // []' "$RESULTS_JSON" 2>/dev/null || echo "[]")
          else
            TEST_ITEMS="[]"
          fi

          node scripts/mcp_smoke_comment.js \
            --result "$RESULT" \
            --mode "${{ steps.test_config.outputs.mode }}" \
            --service-url "$SERVICE_URL" \
            --run-id "${{ github.run_id }}" \
            --repo "${{ github.repository }}" \
            --server-url "${{ github.server_url }}" \
            --commit-sha "${{ steps.pr_number.outputs.head_sha }}" \
            ${TEST_ITEMS:+--items "$TEST_ITEMS"} \
            > /tmp/smoke-comment-body.md

          {
            echo "body<<EOF"
            cat /tmp/smoke-comment-body.md
            printf '\n'
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Post success comment
        if: steps.pr_number.outputs.number && steps.smoke_tests.outcome == 'success'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const body = ${{ toJson(steps.smoke_comment_body.outputs.body) }};
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr_number.outputs.number }},
              body: body
            });

      - name: Post failure comment
        if: steps.pr_number.outputs.number && failure()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7.0.1
        with:
          script: |
            const body = ${{ toJson(steps.smoke_comment_body.outputs.body) }};
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr_number.outputs.number }},
              body: body
            });
