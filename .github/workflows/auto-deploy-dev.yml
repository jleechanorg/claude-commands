# Auto-Deploy to Development Environment
# Automatically deploys mvp_site to Cloud Run when changes are pushed to main branch

name: Auto-Deploy Dev

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Development Environment
    runs-on: ubuntu-latest
    timeout-minutes: 45  # 2x typical deployment time (Cloud Build can take 15-20 min)

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@55bd3a7c6e2ae7cf1877fd1ccb9d54c0503c457c  # v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@98ddc00a17442e89a24bbf282954a3b65ce6d200  # v2

      - name: Configure gcloud CLI defaults
        run: |
          gcloud config set project ai-universe-2025
          gcloud config set run/region us-central1

      - name: Deploy to Cloud Run
        run: |
          chmod +x ./deploy.sh
          ./deploy.sh mvp_site
        timeout-minutes: 30  # 1.5x typical deployment time

      - name: Get deployment URL
        id: get-url
        run: |
          URL=$(gcloud run services describe mvp-site-app-dev \
            --region=us-central1 \
            --project=ai-universe-2025 \
            --format='value(status.url)')
          if [ -z "$URL" ]; then
            echo "âŒ Failed to retrieve deployment URL"
            exit 1
          fi
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Deployment URL: $URL"

      - name: Health check
        run: |
          HEALTH_URL="${{ steps.get-url.outputs.url }}/health"
          echo "Performing health check at ${HEALTH_URL}"
          MAX_RETRIES=10
          RETRY_COUNT=0
          SLEEP_DURATION=5

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Health check attempt $(($RETRY_COUNT + 1))/$MAX_RETRIES..."

            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || true)
            if [ "$STATUS" = "200" ]; then
              echo "âœ… Health check passed!"
              exit 0
            fi

            echo "Health check returned status $STATUS"
            RETRY_COUNT=$(($RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Health check failed, retrying in ${SLEEP_DURATION}s..."
              sleep $SLEEP_DURATION
            fi
          done

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Deployment summary
        if: always() && steps.get-url.outcome == 'success'
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Development" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** mvp-site-app-dev" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** us-central1" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** ai-universe-2025" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** ${{ steps.get-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Service Health](${{ steps.get-url.outputs.url }}/health)" >> $GITHUB_STEP_SUMMARY
          echo "- [Cloud Run Console](https://console.cloud.google.com/run/detail/us-central1/mvp-site-app-dev?project=ai-universe-2025)" >> $GITHUB_STEP_SUMMARY
          echo "- [Logs](https://console.cloud.google.com/logs/query?project=ai-universe-2025&query=resource.type%3D%22cloud_run_revision%22%0Aresource.labels.service_name%3D%22mvp-site-app-dev%22)" >> $GITHUB_STEP_SUMMARY
