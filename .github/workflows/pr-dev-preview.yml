name: Deploy PR Preview to GCP

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]
    paths:
      - 'mvp_site/**'
      - 'deploy.sh'
      - 'scripts/deploy_common.sh'
      - 'Dockerfile'
      - 'requirements.txt'
      - 'scripts/**'
      - '.github/workflows/pr-dev-preview.yml'

permissions:
  contents: read
  pull-requests: write

jobs:
  deploy-preview:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    env:
      GCP_REGION: us-central1
      GCP_PROJECT: worldarchitecture-ai
      CLOUDSDK_CORE_DISABLE_PROMPTS: "1"
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Get PR number
        id: pr_number
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "number=${{ github.event.number }}" >> "$GITHUB_OUTPUT"
          else
            # For push events, find PR number for this branch
            PR_NUMBER=$(gh pr list --repo ${{ github.repository }} --head "${{ github.ref_name }}" --json number --jq '.[0].number' || echo "")
            if [ -z "$PR_NUMBER" ]; then
              echo "‚ùå No PR found for branch ${{ github.ref_name }}"
              exit 1
            fi
            echo "number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@55bd3a7c6e2ae7cf1877fd1ccb9d54c0503c457c  # v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@98ddc00a17442e89a24bbf282954a3b65ce6d200  # v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Ensure required Google Cloud APIs are enabled
        run: |
          set -euo pipefail
          gcloud services enable \
            run.googleapis.com \
            cloudbuild.googleapis.com \
            artifactregistry.googleapis.com \
            --project="${{ env.GCP_PROJECT }}" \
            --quiet

      - name: Post build started comment
        run: |
          set -euo pipefail

          PR_NUMBER="${{ steps.pr_number.outputs.number }}"
          SERVICE_NAME="mvp-site-app-pr-$PR_NUMBER"
          COMMIT_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)

          gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body "## üöÄ Build Started

          **Commit:** [\`$COMMIT_SHORT\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          **Branch:** \`${{ github.head_ref }}\`
          **Service:** \`$SERVICE_NAME\`
          **Workflow:** [View Progress](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ### üîÑ Build Steps:
          - ‚úÖ Environment setup
          - üîÑ **Docker image build**
          - ‚è≥ Cloud Run deployment
          - ‚è≥ Health check verification

          *Estimated time: 5-8 minutes*

          ü§ñ *Auto-deployment in progress via GitHub Actions*"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Deploy PR Preview
        env:
          GITHUB_SHA: ${{ github.sha }}
        timeout-minutes: 20
        run: |
          set -euo pipefail

          PR_NUMBER="${{ steps.pr_number.outputs.number }}"
          SERVICE_NAME="mvp-site-app-pr-$PR_NUMBER"

          echo "üöÄ Deploying PR #$PR_NUMBER to GCP Cloud Run..."
          echo "Service name: $SERVICE_NAME"

          # Build and push Docker image
          IMAGE_TAG="gcr.io/${{ env.GCP_PROJECT }}/$SERVICE_NAME:$GITHUB_SHA"

          echo "Building Docker image: $IMAGE_TAG"
          gcloud builds submit \
            --tag "$IMAGE_TAG" \
            --project="${{ env.GCP_PROJECT }}" \
            --timeout=15m \
            --quiet \
            --suppress-logs \
            mvp_site/ || {
            echo "‚ö†Ô∏è Build command returned non-zero exit code, but build may still be running"
            echo "Checking if image was created..."
            sleep 30
          }

          # Deploy to Cloud Run
          echo "Deploying to Cloud Run service: $SERVICE_NAME"
          gcloud run deploy "$SERVICE_NAME" \
            --image "$IMAGE_TAG" \
            --region="${{ env.GCP_REGION }}" \
            --project="${{ env.GCP_PROJECT }}" \
            --platform=managed \
            --allow-unauthenticated \
            --set-env-vars="FLASK_ENV=production,ENVIRONMENT=preview" \
            --set-secrets="GEMINI_API_KEY=gemini-api-key:latest" \
            --memory=512Mi \
            --cpu=1 \
            --max-instances=2 \
            --timeout=300 \
            --quiet

      - name: Fetch deployed service URL
        if: success()
        id: service_url
        run: |
          set -euo pipefail

          PR_NUMBER="${{ steps.pr_number.outputs.number }}"
          SERVICE_NAME="mvp-site-app-pr-$PR_NUMBER"

          SERVICE_URL=$(gcloud run services describe "$SERVICE_NAME" \
            --region="${{ env.GCP_REGION }}" \
            --format="value(status.url)" \
            --quiet 2>/dev/null || echo "")

          if [ -z "$SERVICE_URL" ]; then
            echo "::warning::Service URL for $SERVICE_NAME could not be determined"
            echo "service_url=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "service_url=$SERVICE_URL" >> "$GITHUB_OUTPUT"
          echo "‚úÖ Deployed service available at $SERVICE_URL"

      - name: Wait for deployed service health
        if: success() && steps.service_url.outputs.service_url != ''
        env:
          HEALTH_CHECK_MAX_ATTEMPTS: ${{ vars.HEALTH_CHECK_MAX_ATTEMPTS || '12' }}
          HEALTH_CHECK_INTERVAL_SECONDS: ${{ vars.HEALTH_CHECK_INTERVAL_SECONDS || '5' }}
        run: |
          set -euo pipefail

          SERVICE_URL="${{ steps.service_url.outputs.service_url }}"
          echo "Waiting for service health at $SERVICE_URL/health"

          echo "Using HEALTH_CHECK_MAX_ATTEMPTS=${HEALTH_CHECK_MAX_ATTEMPTS}, HEALTH_CHECK_INTERVAL_SECONDS=${HEALTH_CHECK_INTERVAL_SECONDS}"

          for attempt in $(seq 1 "$HEALTH_CHECK_MAX_ATTEMPTS"); do
            if curl -fsS --connect-timeout 5 --max-time 10 "$SERVICE_URL/health" > /dev/null; then
              echo "‚úÖ Service responded healthy on attempt $attempt"
              exit 0
            fi

            echo "‚è≥ Health check attempt $attempt failed; retrying in ${HEALTH_CHECK_INTERVAL_SECONDS} seconds..."
            sleep "$HEALTH_CHECK_INTERVAL_SECONDS"
          done

          echo "Service failed to report healthy in expected time" >&2
          exit 1

      - name: Post deployment success comment
        if: success()
        run: |
          set -euo pipefail

          PR_NUMBER="${{ steps.pr_number.outputs.number }}"
          SERVICE_NAME="mvp-site-app-pr-$PR_NUMBER"
          COMMIT_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)

          SERVICE_URL="${{ steps.service_url.outputs.service_url }}"
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          GCP_CONSOLE_URL="https://console.cloud.google.com/run?project=${{ env.GCP_PROJECT }}"

          if [ -z "$SERVICE_URL" ]; then
            echo "‚ö†Ô∏è Could not retrieve service URL for $SERVICE_NAME"
            COMMENT="## ‚ö†Ô∏è Deployment Status Unknown"$'\n\n'"The deployment process completed, but the service URL could not be retrieved."$'\n\n'"### üìã Details:"$'\n'"- **Commit:** [\`$COMMIT_SHORT\`]($COMMIT_URL)"$'\n'"- **Service:** \`$SERVICE_NAME\`"$'\n'"- **Region:** \`${{ env.GCP_REGION }}\`"$'\n'"- **Workflow:** [View Details]($WORKFLOW_URL)"$'\n\n'"Please check the [Google Cloud Console]($GCP_CONSOLE_URL) for more details."$'\n\n'"ü§ñ *Auto-deployed via GitHub Actions*"
            gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body "$COMMENT"
          else
            COMMENT="## ‚úÖ Deployment Complete!"$'\n\n'"**üéâ Your PR preview is ready!**"$'\n\n'"### üîó Quick Access:"$'\n'"| Service | URL |"$'\n'"|---------|----|"$'\n'"| üåê **Preview App** | [$SERVICE_URL]($SERVICE_URL) |"$'\n'"| ü©∫ **Health Check** | [$SERVICE_URL/health]($SERVICE_URL/health) |"$'\n'"| üì° **MCP Endpoint** | [$SERVICE_URL/mcp]($SERVICE_URL/mcp) |"$'\n\n'"> ‚ÑπÔ∏è Use \`/smoke\` command to run MCP smoke tests against this preview."$'\n\n'"### üîÑ Completed Build Steps:"$'\n'"- ‚úÖ Environment setup"$'\n'"- ‚úÖ **Docker image build**"$'\n'"- ‚úÖ Cloud Run deployment"$'\n'"- ‚úÖ Health check verification"$'\n\n'"### üìã Deployment Details:"$'\n'"- **Commit:** [\`$COMMIT_SHORT\`]($COMMIT_URL)"$'\n'"- **Service:** \`$SERVICE_NAME\`"$'\n'"- **Region:** \`${{ env.GCP_REGION }}\`"$'\n'"- **Branch:** \`${{ github.head_ref }}\`"$'\n'"- **Workflow:** [View Details]($WORKFLOW_URL)"$'\n\n'"ü§ñ *Auto-deployed via GitHub Actions*"
            gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body "$COMMENT"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Post deployment failure comment
        if: failure()
        run: |
          set -euo pipefail

          PR_NUMBER="${{ steps.pr_number.outputs.number }}"
          SERVICE_NAME="mvp-site-app-pr-$PR_NUMBER"
          COMMIT_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)
          SERVICE_URL="${{ steps.service_url.outputs.service_url }}"
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          PREVIEW_URL="${SERVICE_URL:-Unavailable}"
          COMMENT="## ‚ùå Deployment Failed"$'\n\n'"The deployment process encountered an error and could not complete."$'\n\n'"### üìã Details:"$'\n'"- **Commit:** [\`$COMMIT_SHORT\`]($COMMIT_URL)"$'\n'"- **Service:** \`$SERVICE_NAME\`"$'\n'"- **Preview URL:** $PREVIEW_URL"$'\n'"- **Branch:** \`${{ github.head_ref }}\`"$'\n'"- **Workflow:** [View Logs]($WORKFLOW_URL)"$'\n\n'"### üîç Next Steps:"$'\n'"1. Check the [workflow logs]($WORKFLOW_URL) for details"$'\n'"2. Review any error messages in the deployment step"$'\n'"3. Push a new commit to retry the deployment"$'\n\n'"ü§ñ *Auto-deployment failed via GitHub Actions*"

          gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body "$COMMENT"
        env:
          GH_TOKEN: ${{ github.token }}
