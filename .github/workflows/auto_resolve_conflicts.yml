name: Auto-Resolve PR Conflicts

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # Fast check job - runs first, no checkout needed
  # gh CLI is pre-installed on ubuntu-latest, no installation required
  check-conflicts:
    runs-on: ubuntu-latest
    outputs:
      has-conflicts: ${{ steps.check.outputs.has-conflicts }}
      pr-number: ${{ steps.check.outputs.pr-number }}
    permissions:
      pull-requests: read
    steps:
      - name: Check if PR has merge conflicts
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT

          # Use GitHub API to check mergeable state (faster than checkout)
          MERGE_STATE=$(gh pr view $PR_NUMBER --repo ${{ github.repository }} --json mergeStateStatus --jq '.mergeStateStatus')
          echo "Merge state: $MERGE_STATE"

          if [ "$MERGE_STATE" = "DIRTY" ]; then
            echo "has-conflicts=true" >> $GITHUB_OUTPUT
            echo "üîÑ PR #$PR_NUMBER has conflicts - will attempt auto-resolution"
          else
            echo "has-conflicts=false" >> $GITHUB_OUTPUT
            echo "‚úÖ PR #$PR_NUMBER has no conflicts - skipping"
          fi

  # Heavy resolution job - only runs if conflicts detected
  auto-resolve-conflicts:
    needs: check-conflicts
    if: needs.check-conflicts.outputs.has-conflicts == 'true'
    runs-on: ubuntu-latest

    permissions:
      contents: write      # Required for git operations and pushing commits
      pull-requests: write # Required for gh pr commands (list, view, comment)

    steps:
    - name: Checkout code
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configure Git
      run: |
        git config user.name "Claude Auto-Resolver"
        git config user.email "claude@anthropic.com"

    # Note: gh CLI is pre-installed on ubuntu-latest runners - no installation needed

    - name: Auto-resolve conflicts
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_NUMBER: ${{ needs.check-conflicts.outputs.pr-number }}
      run: |
        echo "üîÑ Auto-resolving conflicts for PR #$PR_NUMBER"

        # Make script executable
        chmod +x scripts/auto_resolve_conflicts.sh

        # Run auto-resolution
        if ./scripts/auto_resolve_conflicts.sh "$PR_NUMBER"; then
          echo "‚úÖ Conflicts resolved successfully"
        else
          echo "‚ö†Ô∏è  Auto-resolution failed, manual intervention required"
          exit 1
        fi

    - name: Update PR with resolution status
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PR_NUMBER: ${{ needs.check-conflicts.outputs.pr-number }}
      run: |
        gh pr comment "$PR_NUMBER" --body "ü§ñ **Auto-Conflict Resolution**

        ‚úÖ Merge conflicts have been automatically resolved and pushed to this PR.

        **Changes made:**
        - Merged latest main branch changes
        - Auto-resolved common conflict patterns in learnings.md and CLAUDE.md
        - Preserved all valuable content from both branches

        The PR is now ready for review and should be mergeable.

        ---
        *Generated by Claude Auto-Resolver*"
