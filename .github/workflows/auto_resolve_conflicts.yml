name: Auto-Resolve PR Conflicts

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches-ignore:
      - main

jobs:
  auto-resolve-conflicts:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref != 'refs/heads/main')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure Git
      run: |
        git config user.name "Claude Auto-Resolver"
        git config user.email "claude@anthropic.com"
    
    - name: Install GitHub CLI
      run: |
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh
    
    - name: Check PR merge status
      id: check_conflicts
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          PR_NUMBER="${{ github.event.pull_request.number }}"
        else
          # For push events, find associated PR
          PR_NUMBER=$(gh pr list --head $(echo ${{ github.ref }} | sed 's/refs\/heads\///') --json number --jq '.[0].number' || echo "")
        fi
        
        if [ -z "$PR_NUMBER" ]; then
          echo "No PR found for this branch"
          exit 0
        fi
        
        echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        
        MERGE_STATE=$(gh pr view $PR_NUMBER --json mergeStateStatus --jq '.mergeStateStatus')
        echo "merge_state=$MERGE_STATE" >> $GITHUB_OUTPUT
        
        if [ "$MERGE_STATE" = "DIRTY" ]; then
          echo "conflicts=true" >> $GITHUB_OUTPUT
        else
          echo "conflicts=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Auto-resolve conflicts
      if: steps.check_conflicts.outputs.conflicts == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "üîÑ Auto-resolving conflicts for PR #${{ steps.check_conflicts.outputs.pr_number }}"
        
        # Make script executable
        chmod +x scripts/auto_resolve_conflicts.sh
        
        # Run auto-resolution
        if ./scripts/auto_resolve_conflicts.sh ${{ steps.check_conflicts.outputs.pr_number }}; then
          echo "‚úÖ Conflicts resolved successfully"
        else
          echo "‚ö†Ô∏è  Auto-resolution failed, manual intervention required"
          exit 1
        fi
    
    - name: Update PR with resolution status
      if: steps.check_conflicts.outputs.conflicts == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh pr comment ${{ steps.check_conflicts.outputs.pr_number }} --body "ü§ñ **Auto-Conflict Resolution**

‚úÖ Merge conflicts have been automatically resolved and pushed to this PR.

**Changes made:**
- Merged latest main branch changes
- Auto-resolved common conflict patterns in learnings.md and CLAUDE.md
- Preserved all valuable content from both branches

The PR is now ready for review and should be mergeable.

---
*Generated by Claude Auto-Resolver*"