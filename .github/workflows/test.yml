name: WorldArchitect Tests

# When to run the tests
on:
  push:
    branches: [ main, dev ]  # Run on pushes to these branches
  pull_request:
    branches: [ main ]       # Run on PRs targeting main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Get your code
    - name: Checkout repository
      uses: actions/checkout@v4

    # Step 2: Set up Python (same version as your project)
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # Step 3: Cache dependencies (speeds up future runs)
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # Step 4: Create virtual environment and install dependencies (required for vpython)
    - name: Install dependencies
      run: |
        # Create virtual environment that vpython expects
        python -m venv venv
        source venv/bin/activate

        # Upgrade pip and install resolver tools
        python -m pip install --upgrade pip setuptools wheel

        # Install requirements (dependency resolver will handle compatibility)
        pip install -r mvp_site/requirements.txt

        # Verify key dependencies are available
        python -c "import pydantic; print(f'Pydantic {pydantic.__version__} installed')"
        python -c "import sys; print(f'Python path: {sys.path}')"

        # Verify vpython works
        chmod +x vpython
        ./vpython --version

    # Step 5: Run tests directly with activated venv
    - name: Run test suite
      run: |
        # Activate the virtual environment
        source venv/bin/activate

        # Verify environment is correct
        echo "Current Python: $(which python3)"
        echo "Virtual env: $VIRTUAL_ENV"
        python3 -c "import pydantic; print(f'✅ Pydantic {pydantic.__version__} available')"

        # Navigate to mvp_site and run tests directly
        cd mvp_site

        # Set test environment variables
        export TESTING=true
        export MOCK_SERVICES_MODE=true

        echo "Running tests directly with activated virtual environment..."

        # Run tests using Python discovery (same pattern as run_tests.sh)
        test_count=0
        failed_count=0

        # Find and run all test files
        for test_file in $(find tests/ -name "test_*.py" -type f | sort); do
          if [[ "$test_file" == *"test_integration"* ]]; then
            echo "Skipping integration test: $test_file"
            continue
          fi

          test_count=$((test_count + 1))
          echo "Running: $test_file"

          if TESTING=true python3 "$test_file"; then
            echo "✅ PASS: $test_file"
          else
            echo "❌ FAIL: $test_file"
            failed_count=$((failed_count + 1))
          fi
          echo "----------------------------------------"
        done

        echo ""
        echo "========================================"
        if [ $failed_count -eq 0 ]; then
          echo "✅ ALL $test_count TESTS PASSED"
        else
          echo "❌ $failed_count/$test_count TESTS FAILED"
          exit 1
        fi
        echo "========================================"
      env:
        TESTING: true
        MOCK_SERVICES_MODE: true

    # Step 6: Upload test results (optional)
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()  # Run even if tests fail
      with:
        name: test-results
        path: |
          mvp_site/test-results/
          mvp_site/coverage.xml
          mvp_site/*.log
        retention-days: 30
        if-no-files-found: warn
