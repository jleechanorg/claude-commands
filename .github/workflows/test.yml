name: WorldArchitect Tests

# When to run the tests
on:
  push:
    branches: [ main, dev ]  # Run on pushes to these branches
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - 'roadmap/**'
      - '.github/ISSUE_TEMPLATE/**'
  pull_request:
    branches: [ main ]       # Run on PRs targeting main
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - 'roadmap/**'
      - '.github/ISSUE_TEMPLATE/**'

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Increased from 6min to handle slow dependency installs while keeping test timeout at 6min
    strategy:
      fail-fast: false  # Continue other jobs even if one fails
      matrix:
        test-group: [unit-tests, import-validation-delta]
        include:
          # Optimize for different test types
          - test-group: unit-tests
            cache-key: unit
            timeout-minutes: 5
          - test-group: import-validation-delta
            cache-key: validation
            timeout-minutes: 2

    steps:
    # Step 1: Get your code
    - name: Checkout repository
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
      with:
        submodules: recursive

    # Step 2: Set up Python (same version as your project)
    - name: Set up Python 3.11
      uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c  # v5.0.0
      with:
        python-version: '3.11'

    # Step 3: Enhanced caching (dependencies, venv, and build artifacts)
    - name: Cache pip dependencies and virtual environment
      uses: actions/cache@0400d5f644dc74513175e3cd8d07132dd4860809  # v4.2.4
      with:
        path: |
          ~/.cache/pip
          venv
        key: ${{ runner.os }}-python-3.11-${{ hashFiles('**/requirements.txt', 'mvp_site/requirements.txt') }}-${{ matrix.test-group }}
        restore-keys: |
          ${{ runner.os }}-python-3.11-${{ hashFiles('**/requirements.txt', 'mvp_site/requirements.txt') }}-
          ${{ runner.os }}-python-3.11-

    # Step 4: Create virtual environment and install dependencies (required for vpython)
    - name: Install dependencies
      run: |
        # Reuse cached venv when available; otherwise create it
        if [ -d venv ]; then
          echo "Reusing cached venv"
        else
          echo "Creating new venv"
          python -m venv venv
        fi
        source venv/bin/activate

        # Upgrade pip and install resolver tools with timeout
        timeout 300 python -m pip install --upgrade pip setuptools wheel

        # Install all requirements files in the project with timeouts
        # Core application requirements
        timeout 600 pip install -r mvp_site/requirements.txt

        # Install additional requirements for MCP servers and testing with individual timeouts
        find . -name "requirements.txt" -not -path "./venv/*" -not -path "./task-agent*" -not -path "./mvp_site/requirements.txt" | while read req_file; do
          echo "Installing $req_file (with 300s timeout)"
          timeout 300 pip install -r "$req_file" || echo "Warning: Failed to install $req_file (timeout or error)"
        done

        # Verify key dependencies are available with timeout
        timeout 60 python -c "import pydantic; print(f'Pydantic {pydantic.__version__} installed')"
        timeout 60 python -c "import sys; print(f'Python path: {sys.path}')"

        # Verify vpython works with timeout
        chmod +x vpython
        timeout 60 ./vpython --version

    # Step 5: Run test group based on matrix strategy
    - name: Run test group - ${{ matrix.test-group }}
      timeout-minutes: 6  # Step-level timeout optimized for 5-minute CI target
      run: |
        # Activate the virtual environment
        source venv/bin/activate

        # Verify environment is correct
        echo "Current Python: $(which python3)"
        echo "Virtual env: $VIRTUAL_ENV"
        python3 -c "import pydantic; print(f'âœ… Pydantic {pydantic.__version__} available')"

        # Set CI environment variables for GitHub Actions
        export TESTING=true
        export MOCK_SERVICES_MODE=true
        export FAST_TESTS=1
        export ENABLE_BROWSER_TESTS=0
        export ENABLE_BUILD_TESTS=0
        export ENABLE_NETWORK_TESTS=0
        export GITHUB_ACTIONS=true

        # Set Python path for proper module imports
        export PYTHONPATH="${PYTHONPATH}:${PWD}:${PWD}/mvp_site"

        # Run specific test group based on matrix
        chmod +x run_tests.sh
        case "${{ matrix.test-group }}" in
          "unit-tests")
            echo "ðŸš€ Running OPTIMIZED unit tests (5-minute CI target)..."
            # Optimized settings for 5-minute execution target
            export TEST_TIMEOUT=15
            export CI_TEST_LIMIT=30
            # Exclude integration tests that make real network calls but keep end2end tests
            ./run_tests.sh --unit --parallel --exclude-integration --exclude-mcp --include-end2end
            ;;
          "import-validation-delta")
            echo "ðŸ“‹ Running import validation..."
            ./scripts/validate_imports_delta.sh
            ;;
        esac

    # Step 6: Upload test results (optional)
    - name: Upload test results
      uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
      if: always()  # Run even if tests fail
      with:
        name: test-results-${{ matrix.test-group }}
        path: |
          mvp_site/test-results/
          /tmp/worldarchitectai/coverage/
          mvp_site/*.log
        retention-days: 30
        if-no-files-found: warn
