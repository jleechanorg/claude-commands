# Deploy to Production
# Manual trigger only - requires approval via protected environment

name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      confirm_production:
        description: 'Type "DEPLOY TO PRODUCTION" to confirm'
        required: true
        type: string

permissions:
  contents: read

jobs:
  validate-input:
    name: Validate Deployment Confirmation
    runs-on: ubuntu-latest
    outputs:
      confirmed: ${{ steps.check.outputs.confirmed }}
    steps:
      - name: Check confirmation
        id: check
        run: |
          if [ "${{ github.event.inputs.confirm_production }}" = "DEPLOY TO PRODUCTION" ]; then
            echo "confirmed=true" >> $GITHUB_OUTPUT
            echo "âœ… Production deployment confirmed"
          else
            echo "confirmed=false" >> $GITHUB_OUTPUT
            echo "âŒ Invalid confirmation. Expected: DEPLOY TO PRODUCTION"
            echo "âŒ Got: ${{ github.event.inputs.confirm_production }}"
            exit 1
          fi

  deploy-production:
    name: Deploy to Production Environment
    runs-on: ubuntu-latest
    needs: validate-input
    if: needs.validate-input.outputs.confirmed == 'true'
    timeout-minutes: 60  # Production deployments may take longer

    # ðŸš¨ PROTECTED ENVIRONMENT - Requires manual approval in GitHub UI
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4

      - name: Production deployment notice
        run: |
          echo "ðŸš¨ DEPLOYING TO PRODUCTION ðŸš¨"
          echo "Environment: production"
          echo "Service: mvp-site-app-stable"
          echo "Commit: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "âš ï¸  This deployment has been manually approved"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@55bd3a7c6e2ae7cf1877fd1ccb9d54c0503c457c  # v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@98ddc00a17442e89a24bbf282954a3b65ce6d200  # v2

      - name: Configure gcloud CLI defaults
        run: |
          gcloud config set project worldarchitecture-ai
          gcloud config set run/region us-central1

      - name: Verify GCP authentication
        run: |
          echo "ðŸ” Verifying GCP authentication..."
          gcloud auth list
          gcloud config list project
          echo "âœ… GCP authentication verified"

      - name: Deploy to Cloud Run (Production)
        env:
          GITHUB_ACTIONS: "true"
        run: |
          chmod +x ./deploy.sh
          echo "ðŸš¨ DEPLOYING TO PRODUCTION ðŸš¨"
          ./deploy.sh mvp_site stable
        timeout-minutes: 40  # Production build time

      - name: Get deployment URL
        id: get-url
        run: |
          URL=$(gcloud run services describe mvp-site-app-stable \
            --region=us-central1 \
            --project=worldarchitecture-ai \
            --format='value(status.url)')
          if [ -z "$URL" ]; then
            echo "âŒ Failed to retrieve deployment URL"
            exit 1
          fi
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "ðŸŒ Production URL: $URL"

      - name: Health check
        run: |
          HEALTH_URL="${{ steps.get-url.outputs.url }}/health"
          echo "ðŸ¥ Performing health check at ${HEALTH_URL}"
          MAX_RETRIES=15  # More retries for production
          RETRY_COUNT=0
          SLEEP_DURATION=10  # Longer wait between retries

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Health check attempt $(($RETRY_COUNT + 1))/$MAX_RETRIES..."

            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || true)
            if [ "$STATUS" = "200" ]; then
              echo "âœ… Production health check passed!"
              exit 0
            fi

            echo "Health check returned status $STATUS"
            RETRY_COUNT=$(($RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Health check failed, retrying in ${SLEEP_DURATION}s..."
              sleep $SLEEP_DURATION
            fi
          done

          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Production deployment summary
        if: success()
        run: |
          echo "## ðŸš€ Production Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **PRODUCTION DEPLOYMENT COMPLETED**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Service:** mvp-site-app-stable" >> $GITHUB_STEP_SUMMARY
          echo "**Region:** us-central1" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** worldarchitecture-ai" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** ${{ steps.get-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Service Health](${{ steps.get-url.outputs.url }}/health)" >> $GITHUB_STEP_SUMMARY
          echo "- [Cloud Run Console](https://console.cloud.google.com/run/detail/us-central1/mvp-site-app-stable?project=worldarchitecture-ai)" >> $GITHUB_STEP_SUMMARY
          echo "- [Logs](https://console.cloud.google.com/logs/query?project=worldarchitecture-ai&query=resource.type%3D%22cloud_run_revision%22%0Aresource.labels.service_name%3D%22mvp-site-app-stable%22)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Production Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "The service has been deployed to production and health checks passed." >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ Production Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** production" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Failed step:** Check workflow logs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **PRODUCTION WAS NOT UPDATED**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the workflow logs for details and retry after fixing the issue." >> $GITHUB_STEP_SUMMARY

      - name: Send failure email notification
        if: failure()
        uses: ./.github/actions/send-deploy-notification
        with:
          status: failure
          environment: production
          service_name: mvp-site-app-stable
          region: us-central1
          project: worldarchitecture-ai
          branch: ${{ github.ref_name }}
          commit_sha: ${{ github.sha }}
          deployment_url: ${{ steps.get-url.outputs.url }}
          workflow_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          email_user: ${{ secrets.EMAIL_USER }}
          email_password: ${{ secrets.EMAIL_APP_PASSWORD }}

      - name: Send success email notification
        if: success()
        uses: ./.github/actions/send-deploy-notification
        with:
          status: success
          environment: production
          service_name: mvp-site-app-stable
          region: us-central1
          project: worldarchitecture-ai
          branch: ${{ github.ref_name }}
          commit_sha: ${{ github.sha }}
          deployment_url: ${{ steps.get-url.outputs.url }}
          workflow_url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          email_user: ${{ secrets.EMAIL_USER }}
          email_password: ${{ secrets.EMAIL_APP_PASSWORD }}
