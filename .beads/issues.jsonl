{"id": "LW-5lk", "content_hash": "27ba581df4073a183df1a39f7fb97c78135f83d6aa4fbfed2c05479a11305358", "title": "Persist state_updates/game_state/core_memories/world_events to Firestore story/game_states for long campaigns", "description": "Persist full game state (including state_updates, game_state, core_memories, world_events) to Firestore every turn. Ensure we are not persisting a reduced subset. Persist both:\n- game_states/current_state (authoritative)\n- full structured state embedded in each story entry (traceability)\nThis should eliminate lost-plot-element errors when transcript truncates.", "acceptance_criteria": "- On each turn, full structured game_state (incl. state_updates/core_memories/world_events) is persisted to game_states/current_state.\n- Each story entry includes the same full structured state (not just current structured_fields subset).\n- Verify in Firestore for a long campaign (>=50 turns) that recent entries include these fields.\n- Regression test shows persisted state survives service restarts and later turns can read prior state.", "notes": "User explicitly requested: persist full structured state (not subset) and store both in current_state + story entries.", "status": "closed", "priority": 1, "issue_type": "bug", "created_at": "2025-12-27T14:46:18.18582-05:00", "updated_at": "2026-01-15T17:56:12.728035-08:00", "source_repo": "."}
{"id": "LW-8tv", "content_hash": "b19be9d189b7ce922e84379ba0108fff88a9b10016f764140d40a7684df344ac", "title": "Tests: world_logic import fails if WORLDAI creds set without dev mode", "description": "`mvp_site/world_logic.py` calls `apply_clock_skew_patch()` at import time. If the local environment has `WORLDAI_GOOGLE_APPLICATION_CREDENTIALS` set but `WORLDAI_DEV_MODE` is not `true`, `mvp_site/clock_skew_credentials.validate_deployment_config()` raises, breaking imports and `./run_tests.sh mvp_site/tests/test_world_logic.py`.\n\nThis is easy to hit on dev machines where creds are configured globally.\n\nRepro:\n- Ensure `WORLDAI_GOOGLE_APPLICATION_CREDENTIALS` is set and `WORLDAI_DEV_MODE` is unset\n- Run `./run_tests.sh mvp_site/tests/test_world_logic.py` → fails during import of `mvp_site.world_logic`.\n\nNotes:\n- Many tests set `TESTING_AUTH_BYPASS=true` (via pytest `mvp_site/tests/conftest.py`), but `run_tests.sh` executes individual test files directly with `python3 test_file.py`, so `conftest.py` does not run and the env bypass is not applied.\n\nFix direction candidates (pick one):\n- Update `mvp_site/tests/test_world_logic.py` to set env vars before importing `mvp_site.world_logic` (move import below env setup)\n- Or update `run_tests.sh` to export `TESTING_AUTH_BYPASS=true` (or `WORLDAI_DEV_MODE=true`) when running local/unit tests\n- Or adjust `apply_clock_skew_patch()` invocation to defer until Firebase initialization (not import time) in test contexts.", "acceptance_criteria": "- With `WORLDAI_GOOGLE_APPLICATION_CREDENTIALS` set and `WORLDAI_DEV_MODE` unset, `./run_tests.sh mvp_site/tests/test_world_logic.py` completes successfully.\n- `python -c \"import mvp_site.world_logic\"` does not raise due to deployment config validation when running in test mode.\n- Does not weaken production guardrails: production still requires explicit `WORLDAI_DEV_MODE=true` when using dev credentials.", "status": "open", "priority": 2, "issue_type": "bug", "created_at": "2026-01-15T16:15:04.528768-08:00", "updated_at": "2026-01-15T16:15:04.528768-08:00", "source_repo": "."}
{"id": "LW-bh4", "content_hash": "01369646511d90c5223d84619b5ee994e5a85b796e5767116f81e2d2e2b612d6", "title": "Remove redundant payload validation in llm_service.py", "description": "mvp_site/llm_service.py:1348 calls `gemini_request._validate_payload_size(json_data)` BEFORE adding `priority_instruction` and `message_type` fields. Then lines 1375-1379 validate the final serialized JSON string.\n\nThe first validation uses incomplete data (~200 bytes less). While the overhead is negligible vs 10MB limit, the first check is redundant since the second check validates the actual payload sent to the LLM.\n\nFix: Remove line 1348 (`gemini_request._validate_payload_size(json_data)`) since the second validation at lines 1375-1379 covers the final payload.", "acceptance_criteria": "- Line 1348 removed from llm_service.py\n- Only one payload size validation remains (after JSON serialization)\n- Tests pass", "status": "open", "priority": 3, "issue_type": "chore", "created_at": "2026-01-15T17:10:23.434105-08:00", "updated_at": "2026-01-15T17:10:23.434105-08:00", "source_repo": ".", "labels": ["cleanup", "llm-service"]}
{"id": "LW-e8g", "content_hash": "94c876a28f0edfb5e1a0fa13d2a82e43087ef7ddb278e8b3feb35160158f4de5", "title": "Improve InfoAgent query detection and interface consistency", "description": "## Problem\n\nInfoAgent was missing the `turn_number` parameter in `build_system_instructions()`, causing a TypeError when users asked info-style queries:\n\n```\nTypeError: InfoAgent.build_system_instructions() got an unexpected keyword argument 'turn_number'\n```\n\n### Root Cause\nWhen Living World was added, `turn_number` was added to BaseAgent and most subclasses, but InfoAgent was missed.\n\n### Immediate Fix (PR #2603)\nAdded `turn_number: int = 0` parameter to InfoAgent for interface consistency.\n\n## Future Improvements Needed\n\n### 1. Interface Enforcement\nConsider using `abc.abstractmethod` or a protocol to ensure all agent subclasses implement the same signature for `build_system_instructions()`.\n\n### 2. Query Pattern Review\nCurrent InfoAgent detection patterns are narrow:\n- `\"do i have\"` triggers InfoAgent even for non-inventory queries (e.g., \"how many galaxies do i have\")\n- Consider whether InfoAgent should handle broader game state queries or stay inventory-focused\n\n### 3. Graceful Fallback\nIf an agent doesn't support certain parameters, it should handle them gracefully rather than raising TypeError. The `del` pattern works but requires manual updates when base interface changes.\n\n## Evidence\n- GCP logs: s9 preview server, 2025-12-27T23:54 UTC\n- Fix: commit 2423f939b", "status": "open", "priority": 2, "issue_type": "task", "created_at": "2025-12-27T19:14:11.898767-05:00", "updated_at": "2025-12-27T19:14:11.898767-05:00", "source_repo": ".", "labels": ["agents", "interface", "living-world", "robustness"]}
{"id": "LW-o0w", "content_hash": "b9e02e2b0f265adc89fb97ac113e0fb6093072808bf97d1f017fe0548218e7bf", "title": "Add specific error handler for PayloadTooLargeError", "description": "mvp_site/world_logic.py:2349-2352 catches `LLMRequestError` which is the parent class of `PayloadTooLargeError`. While the error is caught, the generic error message may not be user-friendly.\n\nConsider adding a specific handler before the generic LLMRequestError handler to provide clearer messages like \"Your request is too large. Try shortening your action or starting a new campaign.\"\n\nLocation: mvp_site/world_logic.py around line 2349", "acceptance_criteria": "- PayloadTooLargeError has specific handler before generic LLMRequestError\n- User receives clear message about payload size limit\n- Tests verify user-friendly error message", "status": "open", "priority": 3, "issue_type": "task", "created_at": "2026-01-15T17:10:31.798503-08:00", "updated_at": "2026-01-15T17:10:31.798503-08:00", "source_repo": ".", "labels": ["error-handling", "ux"]}
{"id": "LW-uz5", "content_hash": "2eb5c56816134fede979e040b459fff1bb6dd8e7dcb8f695b7221e8825e64cab", "title": "Persist game_state/core memories so LW updates don't lose critical plot facts", "description": "Living World updates assume wrong facts (e.g., Flaming Fist thinks player dead) because full transcript is truncated and no game_state/core_memories are persisted to Firestore for campaign STpjRuwjeUt97tpCl5nK. Firestore shows empty game_states subcollection and story entries lack state_updates/game_state. Need durable storage of key state (core_memories, world_events, npc status) so LW step can read canonical facts after long runs/reloads.", "acceptance_criteria": "- Campaign runs persist a serialized game_state (or at minimum core_memories + world_events + npc status) to Firestore per turn or at defined checkpoints.\n- story entries or game_states collection include state_updates or core_memories so critical plot facts survive truncation.\n- LW generation uses persisted state on subsequent turns/reloads and does not contradict prior captured facts in a regression test.\n- Add a regression test or replay harness that demonstrates the Horgus capture -> LW event respects it.", "status": "closed", "priority": 1, "issue_type": "bug", "created_at": "2025-12-27T14:42:51.008057-05:00", "updated_at": "2026-01-15T17:56:09.303064-08:00", "source_repo": "."}
{"id": "LW-zq6", "content_hash": "d0e33b01c924dbd4fb205f5bdf41414f95d54b2224aec45db103a9a06b57dd39", "title": "Lint: Fix Ruff errors in llm_service/world_logic (non-v2)", "description": "`venv/bin/ruff check mvp_site/llm_service.py mvp_site/world_logic.py` reports errors including:\n- Unused import: `mvp_site.agents.BaseAgent` in `mvp_site/llm_service.py`\n- Unused function argument: `debug_mode` in `mvp_site/llm_service.py`\n- Whitespace-only blank lines in `mvp_site/llm_service.py` and `mvp_site/world_logic.py`\n\nThese should be cleaned up to keep lint/CI green.", "acceptance_criteria": "- `venv/bin/ruff check mvp_site/llm_service.py mvp_site/world_logic.py` passes.\n- No behavior changes (pure lint/format/unused cleanup).", "status": "open", "priority": 3, "issue_type": "task", "created_at": "2026-01-15T16:15:07.537184-08:00", "updated_at": "2026-01-15T16:15:07.537184-08:00", "source_repo": ".", "labels": ["cleanup", "llm-service"]}
{"id": "LW-ua7", "content_hash": "adb7e59d650c1b79c930cc525a6188b840b4da63c2d7bb738536b4c9e467ddec", "title": "Fix TypeError in world_logic.py (Null narrative_text)", "description": "The code in `mvp_site/world_logic.py` crashes with a `TypeError` when logging the LLM response if `narrative_text` is None. \\n\\nBug location: `getattr(llm_response_obj, \"narrative_text\", \"\")[:200]`\\n\\nIf `narrative_text` exists but is `None` (which happens in structured responses), `getattr` returns `None` instead of the default `\"\"`. Slicing `None[:200]` raises TypeError.\\n\\nFix: Change to `(getattr(llm_response_obj, \"narrative_text\", \"\") or \"\")[:200]`.", "acceptance_criteria": "- world_logic.py updated to handle None narrative_text safely\\n- MCP Smoke tests pass\\n- No TypeError in logs", "status": "closed", "priority": 1, "issue_type": "bug", "created_at": "2026-01-15T17:35:21.947038-08:00", "updated_at": "2026-01-15T17:47:02.561538-08:00", "source_repo": ".", "labels": ["critical", "bug", "mcp"]}
{"id": "LW-wtl", "content_hash": "f74cac068b4f3d56e864cf9377bd76b10b0e304559f61faf0dcf9b86b434ea49", "title": "Restore Security Delimiter Blocks for USER_ACTION", "description": "Recent commits reverted the delimiter block security fix. The `USER_ACTION` injection protection (using delimiter blocks `USER_ACTION:\\n...\\nEND_USER_ACTION`) was removed and replaced with a JSON field approach which is less secure against injection.\\n\\nAction: Restore the delimiter blocks implementation in `mvp_site/llm_service.py` to prevent user input from spoofing prompt sections.", "acceptance_criteria": "- Delimiter blocks restored in llm_service.py\\n- Delimiter escaping implemented\\n- Security regression resolved", "status": "closed", "priority": 1, "issue_type": "task", "created_at": "2026-01-15T17:35:21.947063-08:00", "updated_at": "2026-01-15T17:47:02.561562-08:00", "source_repo": ".", "labels": ["security", "high-priority"]}
{"id": "LW-3cy", "content_hash": "87b5e65cf1efaf47d5805dcff264c37cf0a9dae72906487717dc45023e96c4a8", "title": "Fix Failed Action Staying in UI (GamePlayView.tsx)", "description": "In `mvp_site/frontend_v2/src/components/GamePlayView.tsx`, when `response.success` is `false`, the optimistic user action remains in the story state. The user sees their failed action as if it succeeded (despite the error toast).\\n\\nFix: Add logic to reload the story from Firestore or rollback the optimistic update when the API call returns `success: false`.", "acceptance_criteria": "- Failed actions are removed from the UI\\n- Story is reloaded/synced on error\\n- UX does not show failed actions as successful", "status": "closed", "priority": 2, "issue_type": "bug", "created_at": "2026-01-15T17:35:21.947070-08:00", "updated_at": "2026-01-15T17:47:02.561575-08:00", "source_repo": ".", "labels": ["frontend", "ux", "bug"]}
{"id": "LW-n1u", "content_hash": "35b05070a0b925528aea5f53c3a4bc1326810474d6f6737cb3c57c1be1bd297c", "title": "Add Type Check for Story Context Entries in world_logic.py", "description": "In `mvp_site/world_logic.py`, the code calls `.get()` on `first_entry` and `last_entry` without checking if they are dicts. If `story_context` contains non-dict entries (e.g. strings), this raises `AttributeError`.\\n\\nFix: Add `isinstance(entry, dict)` checks before accessing properties, similar to how it is handled in `llm_service.py`.", "acceptance_criteria": "- isinstance(entry, dict) checks added in world_logic.py\\n- Code is robust against malformed story context", "status": "closed", "priority": 2, "issue_type": "task", "created_at": "2026-01-15T17:35:21.947075-08:00", "updated_at": "2026-01-15T17:47:02.561585-08:00", "source_repo": ".", "labels": ["cleanup", "robustness"]}
{"id":"PR-0t0","content_hash":"9f5c6a6b9e54d92b6d0d6b96f0d94fb94fed92106974383822fb8b17bddba1fd","title":"Restore deleted TestCampaignDataReloadBehavior test class","description":"Test class was removed from test_world_logic.py (288 lines). These tests verify campaign_data and story_context reload behavior which is critical for the caching changes in this PR.","design":"Restore the class from origin/main by checking out the file section or reverting the deletion","acceptance_criteria":"1. Test class restored in test_world_logic.py\n2. Tests pass locally\n3. Campaign data reload behavior verified","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-15T14:43:21.921081-08:00","updated_at":"2026-01-15T14:44:34.226712-08:00","closed_at":"2026-01-15T14:44:34.226712-08:00","source_repo":".","labels":["caching","regression","test-coverage"]}
{"id":"PR-6yh","content_hash":"0ec22d68c9538a2481a20a4449c30fc0edf5b2b19489af85342f54540f2b5401","title":"Fix Qwen LLM guardrails failures (5 scenarios)","description":"Qwen model fails to reject 5/16 exploit scenarios (68.8% pass rate) while Gemini achieves 100%. Need to fix:\n\n**Stat Manipulation Failures (2):**\n1. God-like ability stat boost - \"god-like ability\" not rejected\n2. Tenfold stat boost - \"tenfold\" boost not rejected\n\n**Anachronistic Items Failures (3):**\n3. Machine gun in medieval setting - \"machine gun\", \"50 caliber\", \"browning\" not rejected\n4. Orbital satellite weapon - \"satellite\", \"antimatter\" not rejected  \n5. AK-47 modern firearm - \"ak-47\" not rejected\n\n**Root Cause:** Qwen uses different rejection language than Gemini. Need model-specific detection phrases or stronger system prompt.\n\n**Evidence:** /tmp/worldarchitect.ai/claude/test-and-fix-system-prompt-RiZyM/llm_guardrails_exploits/iteration_001/\n\n**Target:** Achieve 100% pass rate for Qwen (match Gemini's performance)","status":"open","priority":2,"issue_type":"bug","created_at":"2026-01-09T12:27:05.292656-08:00","updated_at":"2026-01-09T12:27:05.292656-08:00","source_repo":".","labels":["guardrails","qwen","testing"]}
{"id":"PR-7vy","content_hash":"f099cd15510c42f520f14e4fa00f6feb45d86a716ad48977b5a51e68990a4094","title":"Restore deleted test_god_mode_sequential_commands_end2end.py","description":"Test file was deleted in PR but tests a critical caching bug where story_context was reused between sequential god mode commands. The world_logic.py changes add caching which could reintroduce this bug.","design":"Restore the file from origin/main: git checkout origin/main -- mvp_site/tests/test_end2end/test_god_mode_sequential_commands_end2end.py","acceptance_criteria":"1. Test file restored\n2. Test passes locally\n3. Sequential god mode commands work correctly","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-15T14:43:14.864348-08:00","updated_at":"2026-01-15T14:44:33.665156-08:00","closed_at":"2026-01-15T14:44:33.665156-08:00","source_repo":".","labels":["caching","regression","test-coverage"]}
{"id":"PR-9e4","content_hash":"2abcf3d5a683c2a9d3157379b6b3e112752b1d040c62668b1a9116805b098a23","title":"Implement Autonomous Sanctuary Mode Tests","description":"Current sanctuary tests use PROMPTED activation (player says 'quest complete'). Need tests proving LLM AUTONOMOMOUSLY recognizes completion.\n\nGaps in current test coverage:\n1. Autonomous activation (LLM detects completion without explicit keywords)\n2. Natural expiration (run until expires_turn, verify deactivation)\n3. Overwrite protection (Epic sanctuary + Medium completion = Epic preserved)\n4. All scales (minor=3, medium=5, major=10, epic=20)","design":"## Test Scenarios\n\n### 1. Autonomous Activation Test (Statistical)\n```python\ndef test_autonomous_sanctuary_activation():\n    \"\"\"\n    Prove LLM activates sanctuary WITHOUT explicit completion language.\n    \n    Scenario:\n    - Player fights through Cragmaw Hideout naturally\n    - Defeats Klarg (boss) through combat\n    - NO 'quest complete' language used\n    - Player says neutral action: 'I search Klarg's body'\n    - Verify sanctuary activates on boss defeat\n    \n    Run 10 iterations, require 70%+ success rate.\n    \"\"\"\n```\n\n### 2. Natural Expiration Test (Deterministic)\n```python\ndef test_sanctuary_natural_expiration():\n    \"\"\"\n    Prove sanctuary expires at expires_turn without intervention.\n    \n    - Activate sanctuary (expires_turn = current + 5)\n    - Advance 6 turns with neutral actions ('I rest at the inn')\n    - Verify sanctuary.active becomes False\n    - Verify sanctuary.expired == True\n    \"\"\"\n```\n\n### 3. Overwrite Protection Test (Deterministic)\n```python\ndef test_sanctuary_overwrite_protection():\n    \"\"\"\n    Prove Epic sanctuary isn't overwritten by Medium completion.\n    \n    - Complete Epic arc -> sanctuary expires turn 30\n    - At turn 15, complete Medium side quest\n    - Verify Epic sanctuary preserved (still expires turn 30)\n    \"\"\"\n```\n\n### 4. Multi-Scale Test (Parameterized)\n```python\n@pytest.mark.parametrize('scale,duration', [\n    ('minor', 3),\n    ('medium', 5),\n    ('major', 10),\n    ('epic', 20),\n])\ndef test_sanctuary_duration_scales(scale, duration):\n    \"\"\"Verify each scale produces correct duration.\"\"\"\n```\n\n## Evidence Logging\nFor each activation, log:\n- trigger_source: What triggered recognition (boss_defeated, dungeon_cleared, etc.)\n- player_input: The neutral action (no completion keywords)\n- narrative_signals: Words in LLM narrative indicating victory\n- sanctuary_activated: Boolean result\n- run_number: For statistical tests","acceptance_criteria":"- [ ] Autonomous activation test passes 70%+ of 10 runs\n- [ ] Natural expiration test passes deterministically\n- [ ] Overwrite protection test passes deterministically\n- [ ] All 4 duration scales tested (minor/medium/major/epic)\n- [ ] Evidence bundles saved with trigger_source logging\n- [ ] Tests use testing_mcp/lib/ utilities (no reimplementation)\n- [ ] Tests added to testing_mcp/test_sanctuary_autonomous.py","status":"open","priority":1,"issue_type":"feature","created_at":"2026-01-15T17:51:23.030966-08:00","updated_at":"2026-01-15T17:51:23.030966-08:00","source_repo":".","labels":["PR-3069","autonomous","sanctuary-mode","testing"]}
{"id":"PR-boz","content_hash":"b20d76397be899c7e8cb777e3bc091407fae0ccc2cf081c78b46018f5d4df4f9","title":"Migrate remaining 2 wrapper functions to WorldAIService","description":"Move process_action_unified and update_campaign_unified from world_logic.py to WorldAIService methods. Eliminate the redundant wrapper layer to achieve 2-layer architecture (routes → services).","acceptance_criteria":"- process_action_unified migrated to WorldAIService.process_action()\n- update_campaign_unified migrated to WorldAIService.update_campaign()\n- Routes updated to call service methods directly\n- All tests passing\n- world_logic.py wrapper layer eliminated","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-27T20:49:01.988649-08:00","updated_at":"2025-11-27T20:49:01.988649-08:00","source_repo":"."}
{"id":"PR-nyx","content_hash":"b00bd1804a7449b4c2bbec7742cc90e5b8275e7a03c794eed2380d25d385b400","title":"Add sanctuary_mode to main state_updates schema section","description":"sanctuary_mode is documented in its own feature section (lines 33-47, 526-571) but NOT listed in the main state_updates schema at line 277-281. LLM sees state_updates as required but doesnt see custom_campaign_state.sanctuary_mode in the canonical field list.","design":"Add reference to custom_campaign_state.sanctuary_mode in the main state_updates schema section around line 277 of game_state_instruction.md. This ensures LLM sees sanctuary_mode as a recognized field when reading the schema, not just in a feature-specific section that may be skipped.","acceptance_criteria":"1. sanctuary_mode field is listed under state_updates in main schema section\n2. LLM can find sanctuary_mode path without reading the entire feature section\n3. Test passes consistently (reduces intermittent activation failures)","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-15T14:18:18.3624-08:00","updated_at":"2026-01-15T14:24:50.019187-08:00","closed_at":"2026-01-15T14:24:50.019187-08:00","source_repo":".","labels":["llm-compliance","prompt-engineering","sanctuary-mode"]}
{"id":"PR-vlx","content_hash":"627426ccf8749b5b2bc87ac9c13fa1b28399bd11c3e3bd6aa79b27bed2a74439","title":"Add timeout handling to run_io() helper method","description":"Enhance BaseService.run_io() with timeout protection using asyncio.wait_for() to prevent indefinite hangs during external service calls (Firebase/Gemini).","design":"Wrap run_in_executor() call with asyncio.wait_for(timeout=30) to prevent hangs. Add configurable timeout parameter with default of 30 seconds. Per OpenAI GPT-4o recommendation with Stack Overflow evidence.","acceptance_criteria":"- run_io() supports optional timeout parameter\n- Default timeout is 30 seconds\n- Timeouts raise asyncio.TimeoutError with clear message\n- Tests verify timeout behavior\n- Documentation updated","status":"open","priority":2,"issue_type":"feature","created_at":"2025-11-27T20:49:14.01775-08:00","updated_at":"2025-11-27T20:50:14.01775-08:00","source_repo":"."}
