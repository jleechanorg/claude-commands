{"id": "LW-5lk", "content_hash": "27ba581df4073a183df1a39f7fb97c78135f83d6aa4fbfed2c05479a11305358", "title": "Persist state_updates/game_state/core_memories/world_events to Firestore story/game_states for long campaigns", "description": "Persist full game state (including state_updates, game_state, core_memories, world_events) to Firestore every turn. Ensure we are not persisting a reduced subset. Persist both:\n- game_states/current_state (authoritative)\n- full structured state embedded in each story entry (traceability)\nThis should eliminate lost-plot-element errors when transcript truncates.", "acceptance_criteria": "- On each turn, full structured game_state (incl. state_updates/core_memories/world_events) is persisted to game_states/current_state.\n- Each story entry includes the same full structured state (not just current structured_fields subset).\n- Verify in Firestore for a long campaign (>=50 turns) that recent entries include these fields.\n- Regression test shows persisted state survives service restarts and later turns can read prior state.", "notes": "User explicitly requested: persist full structured state (not subset) and store both in current_state + story entries.", "status": "closed", "priority": 1, "issue_type": "bug", "created_at": "2025-12-27T14:46:18.18582-05:00", "updated_at": "2026-01-15T17:56:12.728035-08:00", "source_repo": "."}
{"id": "LW-8tv", "content_hash": "b19be9d189b7ce922e84379ba0108fff88a9b10016f764140d40a7684df344ac", "title": "Tests: world_logic import fails if WORLDAI creds set without dev mode", "description": "`mvp_site/world_logic.py` calls `apply_clock_skew_patch()` at import time. If the local environment has `WORLDAI_GOOGLE_APPLICATION_CREDENTIALS` set but `WORLDAI_DEV_MODE` is not `true`, `mvp_site/clock_skew_credentials.validate_deployment_config()` raises, breaking imports and `./run_tests.sh mvp_site/tests/test_world_logic.py`.\n\nThis is easy to hit on dev machines where creds are configured globally.\n\nRepro:\n- Ensure `WORLDAI_GOOGLE_APPLICATION_CREDENTIALS` is set and `WORLDAI_DEV_MODE` is unset\n- Run `./run_tests.sh mvp_site/tests/test_world_logic.py` \u2192 fails during import of `mvp_site.world_logic`.\n\nNotes:\n- Many tests set `TESTING_AUTH_BYPASS=true` (via pytest `mvp_site/tests/conftest.py`), but `run_tests.sh` executes individual test files directly with `python3 test_file.py`, so `conftest.py` does not run and the env bypass is not applied.\n\nFix direction candidates (pick one):\n- Update `mvp_site/tests/test_world_logic.py` to set env vars before importing `mvp_site.world_logic` (move import below env setup)\n- Or update `run_tests.sh` to export `TESTING_AUTH_BYPASS=true` (or `WORLDAI_DEV_MODE=true`) when running local/unit tests\n- Or adjust `apply_clock_skew_patch()` invocation to defer until Firebase initialization (not import time) in test contexts.", "acceptance_criteria": "- With `WORLDAI_GOOGLE_APPLICATION_CREDENTIALS` set and `WORLDAI_DEV_MODE` unset, `./run_tests.sh mvp_site/tests/test_world_logic.py` completes successfully.\n- `python -c \"import mvp_site.world_logic\"` does not raise due to deployment config validation when running in test mode.\n- Does not weaken production guardrails: production still requires explicit `WORLDAI_DEV_MODE=true` when using dev credentials.", "status": "open", "priority": 2, "issue_type": "bug", "created_at": "2026-01-15T16:15:04.528768-08:00", "updated_at": "2026-01-15T16:15:04.528768-08:00", "source_repo": "."}
{"id": "LW-bh4", "content_hash": "01369646511d90c5223d84619b5ee994e5a85b796e5767116f81e2d2e2b612d6", "title": "Remove redundant payload validation in llm_service.py", "description": "mvp_site/llm_service.py:1348 calls `gemini_request._validate_payload_size(json_data)` BEFORE adding `priority_instruction` and `message_type` fields. Then lines 1375-1379 validate the final serialized JSON string.\n\nThe first validation uses incomplete data (~200 bytes less). While the overhead is negligible vs 10MB limit, the first check is redundant since the second check validates the actual payload sent to the LLM.\n\nFix: Remove line 1348 (`gemini_request._validate_payload_size(json_data)`) since the second validation at lines 1375-1379 covers the final payload.", "acceptance_criteria": "- Line 1348 removed from llm_service.py\n- Only one payload size validation remains (after JSON serialization)\n- Tests pass", "status": "open", "priority": 3, "issue_type": "chore", "created_at": "2026-01-15T17:10:23.434105-08:00", "updated_at": "2026-01-15T17:10:23.434105-08:00", "source_repo": ".", "labels": ["cleanup", "llm-service"]}
{"id": "LW-e8g", "content_hash": "94c876a28f0edfb5e1a0fa13d2a82e43087ef7ddb278e8b3feb35160158f4de5", "title": "Improve InfoAgent query detection and interface consistency", "description": "## Problem\n\nInfoAgent was missing the `turn_number` parameter in `build_system_instructions()`, causing a TypeError when users asked info-style queries:\n\n```\nTypeError: InfoAgent.build_system_instructions() got an unexpected keyword argument 'turn_number'\n```\n\n### Root Cause\nWhen Living World was added, `turn_number` was added to BaseAgent and most subclasses, but InfoAgent was missed.\n\n### Immediate Fix (PR #2603)\nAdded `turn_number: int = 0` parameter to InfoAgent for interface consistency.\n\n## Future Improvements Needed\n\n### 1. Interface Enforcement\nConsider using `abc.abstractmethod` or a protocol to ensure all agent subclasses implement the same signature for `build_system_instructions()`.\n\n### 2. Query Pattern Review\nCurrent InfoAgent detection patterns are narrow:\n- `\"do i have\"` triggers InfoAgent even for non-inventory queries (e.g., \"how many galaxies do i have\")\n- Consider whether InfoAgent should handle broader game state queries or stay inventory-focused\n\n### 3. Graceful Fallback\nIf an agent doesn't support certain parameters, it should handle them gracefully rather than raising TypeError. The `del` pattern works but requires manual updates when base interface changes.\n\n## Evidence\n- GCP logs: s9 preview server, 2025-12-27T23:54 UTC\n- Fix: commit 2423f939b", "status": "open", "priority": 2, "issue_type": "task", "created_at": "2025-12-27T19:14:11.898767-05:00", "updated_at": "2025-12-27T19:14:11.898767-05:00", "source_repo": ".", "labels": ["agents", "interface", "living-world", "robustness"]}
{"id": "LW-o0w", "content_hash": "b9e02e2b0f265adc89fb97ac113e0fb6093072808bf97d1f017fe0548218e7bf", "title": "Add specific error handler for PayloadTooLargeError", "description": "mvp_site/world_logic.py:2349-2352 catches `LLMRequestError` which is the parent class of `PayloadTooLargeError`. While the error is caught, the generic error message may not be user-friendly.\n\nConsider adding a specific handler before the generic LLMRequestError handler to provide clearer messages like \"Your request is too large. Try shortening your action or starting a new campaign.\"\n\nLocation: mvp_site/world_logic.py around line 2349", "acceptance_criteria": "- PayloadTooLargeError has specific handler before generic LLMRequestError\n- User receives clear message about payload size limit\n- Tests verify user-friendly error message", "status": "open", "priority": 3, "issue_type": "task", "created_at": "2026-01-15T17:10:31.798503-08:00", "updated_at": "2026-01-15T17:10:31.798503-08:00", "source_repo": ".", "labels": ["error-handling", "ux"]}
{"id": "LW-uz5", "content_hash": "2eb5c56816134fede979e040b459fff1bb6dd8e7dcb8f695b7221e8825e64cab", "title": "Persist game_state/core memories so LW updates don't lose critical plot facts", "description": "Living World updates assume wrong facts (e.g., Flaming Fist thinks player dead) because full transcript is truncated and no game_state/core_memories are persisted to Firestore for campaign STpjRuwjeUt97tpCl5nK. Firestore shows empty game_states subcollection and story entries lack state_updates/game_state. Need durable storage of key state (core_memories, world_events, npc status) so LW step can read canonical facts after long runs/reloads.", "acceptance_criteria": "- Campaign runs persist a serialized game_state (or at minimum core_memories + world_events + npc status) to Firestore per turn or at defined checkpoints.\n- story entries or game_states collection include state_updates or core_memories so critical plot facts survive truncation.\n- LW generation uses persisted state on subsequent turns/reloads and does not contradict prior captured facts in a regression test.\n- Add a regression test or replay harness that demonstrates the Horgus capture -> LW event respects it.", "status": "closed", "priority": 1, "issue_type": "bug", "created_at": "2025-12-27T14:42:51.008057-05:00", "updated_at": "2026-01-15T17:56:09.303064-08:00", "source_repo": "."}
{"id": "LW-zq6", "content_hash": "d0e33b01c924dbd4fb205f5bdf41414f95d54b2224aec45db103a9a06b57dd39", "title": "Lint: Fix Ruff errors in llm_service/world_logic (non-v2)", "description": "`venv/bin/ruff check mvp_site/llm_service.py mvp_site/world_logic.py` reports errors including:\n- Unused import: `mvp_site.agents.BaseAgent` in `mvp_site/llm_service.py`\n- Unused function argument: `debug_mode` in `mvp_site/llm_service.py`\n- Whitespace-only blank lines in `mvp_site/llm_service.py` and `mvp_site/world_logic.py`\n\nThese should be cleaned up to keep lint/CI green.", "acceptance_criteria": "- `venv/bin/ruff check mvp_site/llm_service.py mvp_site/world_logic.py` passes.\n- No behavior changes (pure lint/format/unused cleanup).", "status": "open", "priority": 3, "issue_type": "task", "created_at": "2026-01-15T16:15:07.537184-08:00", "updated_at": "2026-01-15T16:15:07.537184-08:00", "source_repo": "."}
{"id": "LW-ua7", "content_hash": "adb7e59d650c1b79c930cc525a6188b840b4da63c2d7bb738536b4c9e467ddec", "title": "Fix TypeError in world_logic.py (Null narrative_text)", "description": "The code in `mvp_site/world_logic.py` crashes with a `TypeError` when logging the LLM response if `narrative_text` is None. \\n\\nBug location: `getattr(llm_response_obj, \"narrative_text\", \"\")[:200]`\\n\\nIf `narrative_text` exists but is `None` (which happens in structured responses), `getattr` returns `None` instead of the default `\"\"`. Slicing `None[:200]` raises TypeError.\\n\\nFix: Change to `(getattr(llm_response_obj, \"narrative_text\", \"\") or \"\")[:200]`.", "acceptance_criteria": "- world_logic.py updated to handle None narrative_text safely\\n- MCP Smoke tests pass\\n- No TypeError in logs", "status": "closed", "priority": 1, "issue_type": "bug", "created_at": "2026-01-15T17:35:21.947038-08:00", "updated_at": "2026-01-15T17:47:02.561538-08:00", "source_repo": ".", "labels": ["critical", "bug", "mcp"]}
{"id": "LW-wtl", "content_hash": "f74cac068b4f3d56e864cf9377bd76b10b0e304559f61faf0dcf9b86b434ea49", "title": "Restore Security Delimiter Blocks for USER_ACTION", "description": "Recent commits reverted the delimiter block security fix. The `USER_ACTION` injection protection (using delimiter blocks `USER_ACTION:\\n...\\nEND_USER_ACTION`) was removed and replaced with a JSON field approach which is less secure against injection.\\n\\nAction: Restore the delimiter blocks implementation in `mvp_site/llm_service.py` to prevent user input from spoofing prompt sections.", "acceptance_criteria": "- Delimiter blocks restored in llm_service.py\\n- Delimiter escaping implemented\\n- Security regression resolved", "status": "closed", "priority": 1, "issue_type": "task", "created_at": "2026-01-15T17:35:21.947063-08:00", "updated_at": "2026-01-15T17:47:02.561562-08:00", "source_repo": ".", "labels": ["security", "high-priority"]}
{"id": "LW-3cy", "content_hash": "87b5e65cf1efaf47d5805dcff264c37cf0a9dae72906487717dc45023e96c4a8", "title": "Fix Failed Action Staying in UI (GamePlayView.tsx)", "description": "In `mvp_site/frontend_v2/src/components/GamePlayView.tsx`, when `response.success` is `false`, the optimistic user action remains in the story state. The user sees their failed action as if it succeeded (despite the error toast).\\n\\nFix: Add logic to reload the story from Firestore or rollback the optimistic update when the API call returns `success: false`.", "acceptance_criteria": "- Failed actions are removed from the UI\\n- Story is reloaded/synced on error\\n- UX does not show failed actions as successful", "status": "closed", "priority": 2, "issue_type": "bug", "created_at": "2026-01-15T17:35:21.947070-08:00", "updated_at": "2026-01-15T17:47:02.561575-08:00", "source_repo": ".", "labels": ["frontend", "ux", "bug"]}
{"id": "LW-n1u", "content_hash": "35b05070a0b925528aea5f53c3a4bc1326810474d6f6737cb3c57c1be1bd297c", "title": "Add Type Check for Story Context Entries in world_logic.py", "description": "In `mvp_site/world_logic.py`, the code calls `.get()` on `first_entry` and `last_entry` without checking if they are dicts. If `story_context` contains non-dict entries (e.g. strings), this raises `AttributeError`.\\n\\nFix: Add `isinstance(entry, dict)` checks before accessing properties, similar to how it is handled in `llm_service.py`.", "acceptance_criteria": "- isinstance(entry, dict) checks added in world_logic.py\\n- Code is robust against malformed story context", "status": "closed", "priority": 2, "issue_type": "task", "created_at": "2026-01-15T17:35:21.947075-08:00", "updated_at": "2026-01-15T17:47:02.561585-08:00", "source_repo": ".", "labels": ["cleanup", "robustness"]}
