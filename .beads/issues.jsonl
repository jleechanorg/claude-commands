{"id":"worktree_worker3-0go","content_hash":"179d3475697c525d2f5bf86b063013d1bb7723268502db14bf56b7d4c37f434c","title":"Delete pre-computed dice logic","description":"Remove the pre-computed dice code that never fully worked:\n- detect_action_type() from game_state.py\n- compute_combat_results() and helpers from game_state.py\n- Pattern constants (ATTACK_PATTERNS, etc.)\n- Pre-computed injection from llm_service.py\n- pre_computed_results instructions from prompts\n- test_precomputed_dice.py test file","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T10:18:18.366942-05:00","updated_at":"2025-12-11T10:18:18.366942-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-0go","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:18.367466-05:00","created_by":"daemon"},{"issue_id":"worktree_worker3-0go","depends_on_id":"worktree_worker3-bkl","type":"blocks","created_at":"2025-12-11T10:18:29.255255-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-1hz","content_hash":"28a38f304e79b4a12fbea1aa191db812ce1832f812362bf25410f17b464988da","title":"POLICY: No Silent Test Skipping - Tests Must Run or Mock","description":"**CRITICAL TESTING POLICY**\n\nTests must NEVER silently skip or short-circuit based on environment variables or missing dependencies. Every test must either:\n\n1. **RUN** - Execute with real or mocked dependencies\n2. **FAIL LOUDLY** - Raise clear assertion error if prerequisites missing\n3. **MOCK** - Use mock objects when real services unavailable\n\n**FORBIDDEN PATTERNS:**\n- `if not os.getenv(\"X\"): return` (silent skip)\n- Module-level imports that raise on missing env vars (blocks test collection)\n- `@unittest.skipIf/skipUnless` without CI-compatible fallback\n- Tests that pass trivially when env var is unset\n\n**REQUIRED PATTERNS:**\n- `TESTING=true` should enable mock mode for all external services\n- Test collection must NEVER fail due to env vars\n- All tests must run in CI without special env vars beyond TESTING=true\n\n**Why This Matters:**\n- CI passes falsely when tests are skipped\n- Bugs slip through because code paths never execute\n- Developers think tests pass when they actually didn't run","status":"open","priority":1,"issue_type":"chore","created_at":"2025-12-11T06:01:03.763015-05:00","updated_at":"2025-12-11T06:01:03.763015-05:00","source_repo":".","labels":["ci","policy","testing"]}
{"id":"worktree_worker3-21f","content_hash":"964f4ddd2a0c83fa5c3086d48e62995c7212174cc8ede416ef47ecb6de28169a","title":"Cerebras tool-loop responses missing headers/planning block (malformed JSON)","description":"Context: After PR #2353 we route Cerebras models (e.g., zai-glm-4.6) through tool loop. Logs (2025-12-12 11:30:51) show malformed/incomplete JSON returned: only narrative/entities/state_updates extracted; session_header and planning_block missing. Parser logs MALFORMED_JSON_DETECTED and PLANNING_BLOCK_MISSING; no fallback adds a block. This regressed from origin/main.\n\nImpact: Story responses lack session header/planning block; entity validation fails; users see missing headers.\n\nSuspected causes: model emits loose JSON with tool results; large prompt (~74k tokens) + tool loop; fallback for missing planning_block was removed.\n\nRequested fix:\n- Add defensive handling: if planning_block/session_header missing after parse, reprompt or inject minimal defaults.\n- Consider reducing prompt size or switching to a more reliable model; or tweak tool-loop prompts for Cerebras.\n- Confirm tool loop actually executes for zai-glm-4.6 and capture raw response samples for debugging.\n\nArtifacts: flask-server.log entries around 2025-12-12 11:30:46–51 for campaign VqqJLpABua9bvAG4ArTg.","notes":"Add mitigations: when Cerebras tool-loop responses are malformed and missing session_header/planning_block, reprompt or inject a minimal default instead of accepting partial JSON. Capture raw response for debugging. Restart server after constants changes to ensure tool-loop path is used.","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-12T11:59:12.909638-05:00","updated_at":"2025-12-12T12:15:07.578866-05:00","source_repo":"."}
{"id":"worktree_worker3-58b","content_hash":"a35c7ad5ea6d92317dc6bb84b29e0edeac372708800b1aba47b221b32b130a24","title":"Harden narrative/XP/time validation and fuzzy JSON extraction","description":"Summary of investigation findings:\n1) Narrative truncation: malformed JSON when narrative contains unescaped quotes; parser truncates mid-sentence. Need fuzzy extraction fallback to capture full narrative when strict parse fails or length is suspiciously short.\n2) Level/XP discrepancies: prompts in mechanics_system_instruction were vague (\"typically double\" XP); game_state blindly accepts LLM XP/level. Need to enforce D\u0026D 5e XP table in prompt and add validation in GameState (_validate_level_consistency) to warn on mismatches.\n3) Time tracking anomalies: GameState accepts backward time jumps. Add validate_time_monotonicity to detect/reject/warn when new timestamp \u003c previous.\n\nUpdated leveling approach:\n- Backend owns XP→level (and level→XP) using the fixed 5e table; LLM does not compute level. If LLM proposes mismatched XP/level, backend corrects or reprompts.\n- Prompt change: tell the LLM \"XP/level are authoritative from the system; do not change them. When you mention level or XP, use the provided values.\" LLM may propose \"apply level-up now\" flags, but backend applies the table and updates state.\n\nRequested work:\n- Add robust fallback extraction in narrative_response_schema.py for malformed JSON.\n- Update mechanics_system_instruction.md to include standard 5e cumulative XP table and remove ambiguous guidance; include the prompt text above about authoritative XP/level.\n- Implement GameState validation hooks: level/XP consistency (auto-correct or warn) and time monotonicity (warn/reject backwards time).\n","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-12T11:59:23.318533-05:00","updated_at":"2025-12-12T12:05:22.015439-05:00","source_repo":"."}
{"id":"worktree_worker3-620","content_hash":"c09fc720be1e157ac3a377253f4e092057ddf474de37775f8ba6e4513888605e","title":"Update llm_service.py to route by provider","description":"Modify _call_llm_api() to:\n1. Determine provider from model name\n2. Call appropriate provider's generate_content_with_tool_loop()\n3. Pass DICE_ROLL_TOOLS to all providers","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T10:18:19.024753-05:00","updated_at":"2025-12-11T10:18:19.024753-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-620","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:19.025281-05:00","created_by":"daemon"},{"issue_id":"worktree_worker3-620","depends_on_id":"worktree_worker3-8pt","type":"blocks","created_at":"2025-12-11T10:18:29.718478-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-8pt","content_hash":"c80486cbf421ca33c02e078f6d7c0e9721e4cdba6d974af6fe3dc64efe7af19f","title":"Add Gemini tool loop with phase separation","description":"Implement generate_content_with_tool_loop() for Gemini provider with special handling:\n- Phase 1: tools=ON, json_mode=OFF (function calling)\n- Phase 2: tools=OFF, json_mode=ON (structured output)\n\nThis works around Gemini API limitation that rejects tools + JSON mode together.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T10:18:17.738164-05:00","updated_at":"2025-12-11T10:18:17.738164-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-8pt","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:17.738798-05:00","created_by":"daemon"},{"issue_id":"worktree_worker3-8pt","depends_on_id":"worktree_worker3-bkl","type":"blocks","created_at":"2025-12-11T10:18:28.75882-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-8qz","content_hash":"0950fc2056e30f915891bc4dff6e0b32db63dfa99aebff2d4c6c827abe5954a7","title":"Smoke test tool loops for all providers","description":"Run smoke tests against:\n- Gemini (phase-separated tool loop)\n- Cerebras (unified tool loop)\n- OpenRouter (unified tool loop)\n\nVerify LLM can call roll_attack(), roll_dice(), roll_skill_check(), roll_saving_throw() and results appear in final JSON response.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T10:18:19.55518-05:00","updated_at":"2025-12-11T10:18:19.55518-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-8qz","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:19.555715-05:00","created_by":"daemon"},{"issue_id":"worktree_worker3-8qz","depends_on_id":"worktree_worker3-620","type":"blocks","created_at":"2025-12-11T10:18:30.196946-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-bkl","content_hash":"c0ac59ca6db9728010db5be820adf8a9ef43b7c9f892de0a23320435f172a4b2","title":"Revert commit 9b70c1ff9 (tool loop deletion)","description":"git revert 9b70c1ff9 to restore ~1,400 lines of tool loop infrastructure:\n- DICE_ROLL_TOOLS array\n- execute_dice_tool() function\n- generate_content_with_tool_loop() in cerebras/openrouter providers\n- process_tool_calls() in both providers\n- MODELS_WITH_TOOL_USE set\n- get_dice_roll_strategy() function","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T10:18:17.005724-05:00","updated_at":"2025-12-11T10:18:17.005724-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-bkl","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:17.006728-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-np8","content_hash":"e8a3b2c90e8f6fd780af685a5654046478519b0b835aceacedb88eae7dfcfd7b","title":"Unified Two-Phase Dice Architecture - Revert to Tool Loops","description":"Revert pre-computed dice approach back to LLM-driven tool loops. All providers use two-phase inference where LLM decides what dice to roll, server executes, LLM narrates result.\n\nKey insight: Gemini can use function calling, just not WITH JSON mode simultaneously. Solution: Phase 1 with tools (no JSON), Phase 2 with JSON (no tools).\n\nRoadmap: roadmap/unified_two_phase_dice_architecture.md","status":"open","priority":1,"issue_type":"feature","created_at":"2025-12-11T10:17:58.910614-05:00","updated_at":"2025-12-11T10:17:58.910614-05:00","source_repo":".","labels":["architecture","dice","pr-2353","tool-loops"]}
{"id":"worktree_worker3-sn2","content_hash":"72fbe03db9f8802c2cdaece718a871328c3b5f9580fa4e6de3706074529c9118","title":"BUG: clock_skew_credentials.py blocks test collection on import","description":"**Problem:**\n`world_logic.py` imports `clock_skew_credentials` and calls `apply_clock_skew_patch()` at module level (line 35). This triggers `validate_deployment_config()` which raises `ValueError` if `WORLDAI_GOOGLE_APPLICATION_CREDENTIALS` is set without `WORLDAI_DEV_MODE=true`.\n\n**Impact:**\n- Test collection fails for any test that imports `world_logic`\n- CI \"passes\" because CI doesn't have the env var - tests never run\n- Local devs with service account keys cannot run tests without setting extra env vars\n\n**Files Affected:**\n- `mvp_site/clock_skew_credentials.py:40-44` - The raising code\n- `mvp_site/world_logic.py:35` - Module-level call to `apply_clock_skew_patch()`\n- `mvp_site/tests/test_game_state.py:88` - Import fails here\n\n**Root Cause:**\nValidation logic runs at import time, not runtime. This is a design flaw - module imports should NEVER raise based on env vars.\n\n**Fix Required:**\n1. Make `validate_deployment_config()` return status, not raise\n2. OR defer validation until actual Firebase operation\n3. OR respect `TESTING=true` to skip validation entirely","acceptance_criteria":"- [ ] Tests can be collected without WORLDAI_DEV_MODE\n- [ ] TESTING=true bypasses clock skew validation\n- [ ] test_game_state.py runs in CI\n- [ ] Local devs can run tests with service account keys","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-11T06:01:18.00365-05:00","updated_at":"2025-12-11T06:03:03.560481-05:00","closed_at":"2025-12-11T06:03:03.560481-05:00","source_repo":".","labels":["bug","p0","testing"],"dependencies":[{"issue_id":"worktree_worker3-sn2","depends_on_id":"worktree_worker3-1hz","type":"related","created_at":"2025-12-11T06:01:23.566645-05:00","created_by":"daemon"}]}
