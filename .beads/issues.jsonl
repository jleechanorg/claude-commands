{"id":"worktree_worker3-0a2","content_hash":"19bee386e7bca0050d7bf7c712f1fbf0ec8408c75e3289aa7cddf392ac49e7ce","title":"Set DC expectations for high-stakes persuasion","description":"Multiple high-DC persuasion attempts failed (DC 18+), causing narrative frustration. Player invested heavily in roleplay quality but dice disagreed. Consider: showing approximate difficulty before commit, or providing partial success mechanics for near-misses.","status":"open","priority":3,"issue_type":"feature","created_at":"2025-12-31T21:37:43.944462-08:00","updated_at":"2025-12-31T21:37:43.944462-08:00","source_repo":".","labels":["dice","player-expectation","social","ux"]}
{"id":"worktree_worker3-0gb","content_hash":"34d8c76632e1cdd221de69236c960bf0d5da4886fd976425b0eb32cdf940d2e7","title":"Hash and include full server.log in evidence bundle","description":"Current evidence uses llm_http_log_excerpt.txt (rg grep of server.log). The full server.log is not hashed or signed, so evidence is not tamper-evident. External validator can't rule out edits.","acceptance_criteria":"- Full server.log included in bundle\\n- SHA256 hash of server.log in bundle\\n- Hash verifiable by external validator","status":"closed","priority":1,"issue_type":"task","assignee":"genesis","created_at":"2025-12-24T17:02:49.339974-05:00","updated_at":"2025-12-24T20:31:49.481298-05:00","closed_at":"2025-12-24T20:31:49.481298-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-0gb","depends_on_id":"worktree_worker3-2pc","type":"blocks","created_at":"2025-12-24T17:02:49.341022-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-0go","content_hash":"179d3475697c525d2f5bf86b063013d1bb7723268502db14bf56b7d4c37f434c","title":"Delete pre-computed dice logic","description":"Remove the pre-computed dice code that never fully worked:\n- detect_action_type() from game_state.py\n- compute_combat_results() and helpers from game_state.py\n- Pattern constants (ATTACK_PATTERNS, etc.)\n- Pre-computed injection from llm_service.py\n- pre_computed_results instructions from prompts\n- test_precomputed_dice.py test file","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T10:18:18.366942-05:00","updated_at":"2025-12-13T14:06:08.091765-05:00","closed_at":"2025-12-13T14:06:08.091765-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-0go","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:18.367466-05:00","created_by":"daemon"},{"issue_id":"worktree_worker3-0go","depends_on_id":"worktree_worker3-bkl","type":"blocks","created_at":"2025-12-11T10:18:29.255255-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-0ix","content_hash":"b87172daa3bd8b54ed5764e67a94cdf4716e391a08e9e2ac180aeec683206e6f","title":"Delete old tools-first flow (generate_content_with_tool_loop, process_tool_calls)","description":"**Context:** PR #2353 implemented a new JSON-first tool_requests architecture:\n- `generate_content_with_tool_requests()` in cerebras_provider.py:490-573 and openrouter_provider.py:362-445\n- First call is JSON mode (no tools), model uses `tool_requests` array field to request dice rolls\n- Only do second call if `tool_requests` present\n\n**Problem:** The OLD tools-first flow still exists and causes confusion:\n- `generate_content_with_tool_loop()` - sends tools param in first call, returns raw non-JSON if no tool_calls\n- `process_tool_calls()` - used by old flow, different signature than new `execute_tool_requests()`\n\n**Code to DELETE:**\n\n**cerebras_provider.py:**\n- `process_tool_calls()` at line 270-312 (~42 lines)\n- `generate_content_with_tool_loop()` at line 315-456 (~141 lines)\n\n**openrouter_provider.py:**\n- `process_tool_calls()` at line 163-205 (~42 lines)\n- `generate_content_with_tool_loop()` at line 208-328 (~120 lines)\n\n**gemini_provider.py:**\n- `process_tool_calls()` at line 188-220 (~32 lines)\n- `generate_content_with_tool_loop()` at line 223-307 (~84 lines)\n- NOTE: Gemini 2.x still needs tool loop (tools + JSON mode conflict), may need to keep or refactor\n\n**llm_service.py:**\n- Remove any routing to `generate_content_with_tool_loop()` for Cerebras/OpenRouter\n- Keep `generate_content_with_tool_requests()` routing\n\n**Tests to update:**\n- `test_code_execution_dice_rolls.py` - remove tests for old flow\n- `test_gemini_tool_loop_e2e.py` - keep if Gemini still needs tool loop\n\n**Estimated deletion:** ~400-500 lines of dead code\n\n**KEEP:**\n- `execute_tool_requests()` - new JSON-first helper\n- `generate_content_with_tool_requests()` - new JSON-first entry point\n- Gemini tool loop if still needed for 2.x compatibility","status":"closed","priority":2,"issue_type":"task","assignee":"code","created_at":"2025-12-13T14:21:29.080199-05:00","updated_at":"2025-12-13T14:43:19.350483-05:00","closed_at":"2025-12-13T14:43:19.350483-05:00","source_repo":".","labels":["cleanup","dead-code","pr-2353","tool-loops"]}
{"id":"worktree_worker3-0ju","content_hash":"cb73e690b281b8d3c33a565211b159191222c4455e69e02544d35bd72e75168a","title":"Clarify SRD licensing/attribution and data source provenance","description":"Ensure LICENSE-5E-SRD.md and SRD data attribution reflect actual source(s) of JSON files and required notices.","acceptance_criteria":"- Identify the exact SRD data source (WotC SRD 5.1 vs other dataset)\n- Update LICENSE-5E-SRD.md with any additional required notices/credits\n- Confirm compliance guidance in README or a dedicated licensing note if needed","status":"closed","priority":4,"issue_type":"chore","created_at":"2025-12-18T22:05:55.398287-08:00","updated_at":"2025-12-18T22:25:56.764049-08:00","closed_at":"2025-12-18T22:25:56.764049-08:00","source_repo":"."}
{"id":"worktree_worker3-18e","content_hash":"114d7bda25b6e3684d413047c35d7125c00898685591495a0aae10742f359d52","title":"Clarify stunned condition effects in UI","description":"Player attempted actions while stunned that weren't valid. The stunned condition should be more clearly communicated in the UI, showing which actions are blocked and why.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-31T21:37:42.123097-08:00","updated_at":"2025-12-31T21:37:42.123097-08:00","source_repo":".","labels":["conditions","player-confusion","ux"]}
{"id":"worktree_worker3-1fk","content_hash":"39a9a0a7d0b51494ba0279c1c137434163736039dd1e41ea4ac06eac794b271f","title":"Capture full system instruction per action (not just post-completion)","description":"system_instruction_excerpt_natural.txt is truncated (starts mid-word) and only captured after completion. Doesn't prove enforcement was active during key actions. Need full system instruction captured per action.","acceptance_criteria":"- Full system instruction captured per action (not just excerpt)\\n- Captured BEFORE completion occurs, not after\\n- Enforcement block visible in captured instruction\\n- Timestamped to correlate with action","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T17:02:50.597019-05:00","updated_at":"2025-12-24T20:31:50.440148-05:00","closed_at":"2025-12-24T20:31:50.440148-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-1fk","depends_on_id":"worktree_worker3-2pc","type":"blocks","created_at":"2025-12-24T17:02:50.597653-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-1hz","content_hash":"28a38f304e79b4a12fbea1aa191db812ce1832f812362bf25410f17b464988da","title":"POLICY: No Silent Test Skipping - Tests Must Run or Mock","description":"**CRITICAL TESTING POLICY**\n\nTests must NEVER silently skip or short-circuit based on environment variables or missing dependencies. Every test must either:\n\n1. **RUN** - Execute with real or mocked dependencies\n2. **FAIL LOUDLY** - Raise clear assertion error if prerequisites missing\n3. **MOCK** - Use mock objects when real services unavailable\n\n**FORBIDDEN PATTERNS:**\n- `if not os.getenv(\"X\"): return` (silent skip)\n- Module-level imports that raise on missing env vars (blocks test collection)\n- `@unittest.skipIf/skipUnless` without CI-compatible fallback\n- Tests that pass trivially when env var is unset\n\n**REQUIRED PATTERNS:**\n- `TESTING=true` should enable mock mode for all external services\n- Test collection must NEVER fail due to env vars\n- All tests must run in CI without special env vars beyond TESTING=true\n\n**Why This Matters:**\n- CI passes falsely when tests are skipped\n- Bugs slip through because code paths never execute\n- Developers think tests pass when they actually didn't run","status":"closed","priority":1,"issue_type":"chore","created_at":"2025-12-11T06:01:03.763015-05:00","updated_at":"2025-12-13T17:16:01.705337-05:00","closed_at":"2025-12-13T17:16:01.705337-05:00","source_repo":".","labels":["ci","policy","testing"]}
{"id":"worktree_worker3-1sw","content_hash":"06e6984c64629440ad60efa3d96b7965dc81cef2a8134f55d03bc49961c05d2f","title":"Delete unused game_state.py helpers and stray doc stub","description":"Per codex msg #116/117 - remove dead code:\n\n**game_state.py unused helpers:**\n- calculate_initiative (no callers/tests)\n- calculate_complication_chance / check_complication_triggers (no callers/tests)\n- calculate_death_save (no callers/tests)\n- calculate_hp_for_class (no callers/tests)\n\n**Stray doc stub:**\n- testing_llm/test_ai_development_workflow.md has calculate_damage stub - archive/delete\n\nKeeping: calculate_resource_depletion (exercised by tests)","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-13T15:10:54.027413-05:00","updated_at":"2025-12-13T15:12:34.009573-05:00","closed_at":"2025-12-13T15:12:34.009573-05:00","source_repo":".","labels":["cleanup","dead-code"]}
{"id":"worktree_worker3-1tg","content_hash":"ec99087e1413993babe1cff741977aab607ee9f1aa64670c4ee59731f7fa228b","title":"Implement RAG for Core Memories","description":"Core memories grow unbounded (810+ in one campaign). Currently ALL memories are sent to LLM every turn, consuming ~100K+ tokens for large campaigns. Need semantic retrieval to send only relevant memories per turn.","design":"## Problem\n- Core memories grow unbounded (observed: 810 memories in campaign tAE30bFvyfO0rUd9cgyv)\n- ALL memories sent to LLM every turn via `_get_static_prompt_parts()` in llm_service.py:4258\n- At 500 chars avg, 800 memories = ~100K tokens (half the context window)\n- Story history gets squeezed to almost nothing\n\n## Proposed Solution: Hybrid RAG + Summarization\n\n### Phase 1: RAG with Vector DB\n1. Store embeddings in Firestore (or separate vector store)\n2. On each turn, retrieve top-K relevant memories based on:\n   - Current narrative/action context\n   - Character mentions\n   - Location relevance\n3. Always include last N most recent memories (recency bias)\n\n### Phase 2: Hierarchical Summarization\n1. When memory count exceeds threshold (e.g., 100):\n   - Keep 50 most recent as-is\n   - Summarize older memories into \"epoch summaries\"\n2. Store both raw and summarized forms\n3. RAG searches both layers\n\n### Architecture\n```\nUser Action → Embed Context → Vector Search → Top-K Memories\n                                           ↓\n                    Recent Memories (last 20) + Relevant Memories (top 10)\n                                           ↓\n                              Inject into LLM prompt\n```\n\n### Key Files\n- mvp_site/llm_service.py:4258 - `_get_static_prompt_parts()` (memory injection)\n- mvp_site/preventive_guards.py:73 - `_ensure_core_memory()` (memory creation)\n- mvp_site/game_state.py - `custom_campaign_state.core_memories`\n\n### Dependencies\n- Embedding API (Gemini or OpenAI)\n- Vector storage (Firestore vector search or Pinecone/Chroma)\n\n### References\n- Harvard study: selective recall boosts agent performance 10%\n- LangChain memory patterns\n- Supermemory hybrid (facts + vectors)","acceptance_criteria":"1. Memory retrieval is semantic (not just recency-based)\n2. Token usage for memories capped at ~10K tokens regardless of total memory count\n3. No loss of critical plot details (e.g., Flaming Fist capture plan)\n4. Performance: \u003c500ms retrieval latency\n5. Backward compatible with existing campaigns","notes":"Pre-RAG work completed in PR #2687:\n- Token budget (20K) prevents context overflow\n- Deduplication (0.85 similarity) reduces noise\n- Truncation fix (500 chars) preserves plot details\n\nRAG still needed for semantic relevance when memory count is high.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-27T18:33:17.46012-05:00","updated_at":"2025-12-27T18:44:58.092725-05:00","source_repo":".","labels":["llm-context","memory","rag","scalability"]}
{"id":"worktree_worker3-21f","content_hash":"79da601df893377c445e034c08c899a4c4d979664d77dbebb6b0d3c6bfd4d1c2","title":"Cerebras tool-loop responses missing headers/planning block (malformed JSON)","description":"Context: After PR #2353, Cerebras models (e.g., zai-glm-4.6) sometimes return malformed/incomplete JSON; parser recovers only some fields, so session_header and planning_block go missing. Planning-block fallback was removed, so missing headers/blocks surface.\n\nUpdated requirements (per latest direction):\n- First inference call should mirror origin/main: plain JSON mode, with schema expectations (session_header, planning_block, etc.) and only optional tools available. The model should produce the full schema in the first call unless it explicitly needs tools.\n- Only perform a second call if the model returns tool_calls; then execute tools and send results in a follow-up JSON-mode call (tools disabled).\n- Do not rely on regex salvage for planning_block; rely on the schema. If the first/second response is missing session_header/planning_block, reprompt once with a short \"add missing fields\" request or inject a minimal default.\n- Make planning_block/session_header schema compliance primary; salvage is last resort.\n\nArtifacts: flask-server.log 2025-12-12 11:30:46–51 for campaign VqqJLpABua9bvAG4ArTg, provider cerebras/model zai-glm-4.6.\n\nRequested work:\n1) Adjust Cerebras (and other providers if needed) to a tool-on-demand flow (first call JSON sans tools; tools only if requested), aligning with origin/main behavior.\n2) Add a one-time reprompt/default insertion when session_header/planning_block is missing after the final response.\n3) Replace regex-based planning_block extraction with a robust/bracket-aware method if salvage is still kept as a last resort.\n","notes":"Add mitigations: when Cerebras tool-loop responses are malformed and missing session_header/planning_block, reprompt or inject a minimal default instead of accepting partial JSON. Capture raw response for debugging. Restart server after constants changes to ensure tool-loop path is used.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-12T11:59:12.909638-05:00","updated_at":"2025-12-13T14:06:03.95099-05:00","closed_at":"2025-12-13T14:06:03.95099-05:00","source_repo":"."}
{"id":"worktree_worker3-242","content_hash":"5bc4f953fdaf7543584651119251f66e0e19ce3234a11a44a786030b5c5b7bfa","title":"Avoid reroll risk when Phase 2 JSON invalid after tool execution","description":"In the JSON-first tool_requests flow, we execute tools and then ask for Phase 2 JSON with injected tool results. If Phase 2 comes back malformed JSON, llm_service's generic reprompt path can trigger a new provider call without reusing the original tool results, risking duplicate rolls or inconsistent narration.\n\nCurrent mitigation: provider_utils now retries Phase 2 when dice_rolls missing, but there's no dedicated retry for 'Phase 2 invalid JSON' that preserves the same tool results.\n\nGoal: If tools were executed and Phase 2 is invalid JSON, retry Phase 2 with the same tool_results_prompt/history (not a fresh tool execution), and ensure downstream reprompts do not cause rerolls.","acceptance_criteria":"- When tool_requests were executed and Phase 2 response is invalid JSON, the system retries Phase 2 using the same tool results/history.\n- No duplicate tool execution occurs due to parsing/validation reprompts.\n- Add a unit test simulating: Phase 1 -\u003e tool_requests executed -\u003e Phase 2 invalid JSON -\u003e retry -\u003e valid JSON.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-18T19:02:10.481039-08:00","updated_at":"2025-12-18T20:05:04.6502-08:00","closed_at":"2025-12-18T20:05:04.6502-08:00","source_repo":"."}
{"id":"worktree_worker3-2pc","content_hash":"d3fcdc2e04450d03993973a76e6e261a6995b9e8ed0f75267f838201c5ffee68","title":"Harden arc_milestones evidence bundle for external validation","description":"The v15 evidence bundle has gaps identified in skeptical review that prevent it from being airtight for external validation. This epic tracks the work to address all gaps.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-24T17:02:18.327855-05:00","updated_at":"2025-12-24T17:02:18.327855-05:00","source_repo":".","labels":["arc-milestones","evidence","validation"]}
{"id":"worktree_worker3-382","content_hash":"24c4e99703dbc1c639a898cd83fe0a310ecdd2fd48e449caf316ed7cb646399b","title":"Clarify _coerce_int_inner optional defaults doc/type","description":"_coerce_int_inner currently accepts default=None in practice, but the signature hints default:int=0. Add docstring/type clarification or an optional helper to avoid reviewer confusion about None handling, without changing behavior.","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-17T20:28:47.427617-08:00","updated_at":"2025-12-18T17:47:42.587387-08:00","closed_at":"2025-12-18T17:47:42.587387-08:00","source_repo":".","labels":["cleanup","docs","type-hint"]}
{"id":"worktree_worker3-38k","content_hash":"6bb65f684bf4b1e898c73a6aa3c406e1998666682b34f9178bf10eb204e3fad9","title":"Native tools forced on non-tool models returns 400","description":"After PR #2353 the providers force native tool-calling with tool_choice='required' for all Cerebras/OpenRouter models. CONFIRMED: All models DO support function calling (gpt-oss-120b, llama-3.3-70b). However, llama-3.3-70b on Cerebras has multi-turn limitation that causes 400 errors when tool_calls array included in assistant turn (Phase 2). Fix: Clear tool_calls from history before Phase 2 for llama-3.3-70b on Cerebras only.","notes":"WEB SEARCH CONFIRMED (2025-12-17):\n- gpt-oss-120b: FULLY supports function calling, tool use, structured outputs (TauBench tested)\n- llama-3.3-70b: DOES support function calling BUT Cerebras has specific limitation: \"Multi-turn tool calling is currently not supported with the llama-3.3-70b model. This model will error if you include a non-empty tool_calls array on an assistant turn.\"\n\nRoot cause: Phase 2 passes conversation history including tool_calls from Phase 1, triggering 400 on multi-turn for llama-3.3-70b only.\n\nFix strategy: Model-specific history sanitization before Phase 2 for llama-3.3-70b on Cerebras provider only.","status":"closed","priority":1,"issue_type":"bug","assignee":"code","created_at":"2025-12-17T01:44:14.174613-08:00","updated_at":"2025-12-18T17:45:52.209687-08:00","closed_at":"2025-12-18T17:45:52.209687-08:00","source_repo":".","labels":["P0","api-break","dice","pr-2353","regression"]}
{"id":"worktree_worker3-3f0","content_hash":"55da924c5da397eb88a59de038828e90772877ed1a42977ac4803ea51b967051","title":"Fix prompt examples to match engine ActionType + params","description":"game_engine_instruction.md uses unsupported action names and params (initiative/contested/encounter + actor_score/target_score). These commands will be rejected by ActionType.","acceptance_criteria":"- Update examples to use ActionType values: roll_initiative, contested_check, generate_encounter\n- Update contested_check params to actor_ability_score/target_ability_score (and correct proficiency key names)\n- Ensure all examples round‑trip with EngineCommand.from_dict() without errors","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-18T22:05:32.789172-08:00","updated_at":"2025-12-25T14:12:16.503366-05:00","closed_at":"2025-12-25T14:12:16.503366-05:00","source_repo":"."}
{"id":"worktree_worker3-3gt","content_hash":"1cbda028487c159ebd9f5d6c0497875848e71b8a490bca685305e54bcb3202a6","title":"Reconcile social-encounter fix commit hashes with deployed branch","description":"Evidence cites commit bd2a0ea34, while prior summary listed 9d7104ba1 / 5db1f7029 / 442e573e6. Verify which commits are in main/deployed branch, align evidence docs, and ensure the tested code matches the shipped version.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T02:48:01.466567-08:00","updated_at":"2025-12-17T21:07:09.962705-08:00","closed_at":"2025-12-17T21:07:09.962705-08:00","source_repo":"."}
{"id":"worktree_worker3-3w8","content_hash":"3f7c97c3f09aedb4f1baf7ba0fd20847befbf8f230696639329829d5fee14d7c","title":"Remove remaining tools-first codepaths","description":"Delete legacy tools-first codepaths and ensure all providers use JSON-first tool_requests or explicit two-phase JSON flow:\n- Remove/disable generate_content_with_tool_loop and process_tool_calls implementations in providers once JSON-first replacements are in place (Cerebras/OpenRouter already have replacements; Gemini still pending alignment).\n- Update llm_service routing to avoid tools-first paths entirely.\n- Cleanup tests/docs referencing tools-first flows.\n","notes":"## Status Check by c3 (2025-12-15)\n\n**Main Code - DONE ✅**\n- `generate_content_with_tool_loop` - DELETED from all providers\n- `process_tool_calls` - DELETED from all providers\n- All providers now use JSON-first `generate_content_with_tool_requests`\n- llm_service routing uses JSON-first paths only\n\n**Remaining Cleanup:**\n- `mvp_site/tests/CLAUDE.md` still references old `generate_content_with_tool_loop` function in examples (lines 260-303)\n- This doc should be updated to reflect the new JSON-first architecture\n\n**Minor Issue Found:**\n- `llm_service.py:1658` passes `tools=DICE_ROLL_TOOLS` to Gemini 3 path, but this param is **ignored** since `generate_content_with_code_execution` now delegates to `generate_content_with_tool_requests`\n- Should either remove the unused param or document why it's kept\n\n**Recommendation:** Close after doc update and unused param cleanup.","status":"closed","priority":1,"issue_type":"task","assignee":"c3","created_at":"2025-12-13T22:08:22.902854-08:00","updated_at":"2025-12-14T16:32:11.135188-08:00","closed_at":"2025-12-14T16:32:11.135188-08:00","source_repo":"."}
{"id":"worktree_worker3-4ds","content_hash":"e29ae79e87b3cca22004d21082c1600417d8f4c67aef9725f690dd6757ceaecf","title":"Provider/openrouter response_format + tool import hygiene","description":"Address lingering provider review items:\n- In openrouter_provider, avoid sending response_format together with tools if the API rejects that combo, or document compatibility; mirror Cerebras conditional behavior.\n- Move inline imports (execute_dice_tool) to module scope in providers (openrouter, cerebras, gemini) per code guidelines.\n- Ensure tool_requests execution uses correct arg keys (notation vs dice_notation) in tests to avoid masking bugs.\n","notes":"## Analysis by c2 (2025-12-14)\n\n**Items Addressed:**\n1. ✅ OpenRouter response_format + tools: Already fixed - conditional at lines 135-142\n2. ✅ Module-scope imports: Already done in all providers (gemini, cerebras, openrouter)\n3. ✅ dice_notation vs notation: Fixed in game_state.py:1159-1160 - now accepts both keys\n\n**Changes Made:**\n- game_state.py: `execute_dice_tool()` now accepts both `dice_notation` (prompt schema) and `notation` (legacy) for `roll_dice` tool\n\nAll tests pass (23/23 in test_code_execution_dice_rolls.py).","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-13T20:05:31.94329-05:00","updated_at":"2025-12-14T16:35:13.97857-08:00","closed_at":"2025-12-14T16:35:13.97857-08:00","source_repo":"."}
{"id":"worktree_worker3-4mo","content_hash":"aeece0a90f8a0e21334e2d630ded8954d7c34ec4c00b38569178b70079fbac43","title":"Add validation for expected_behavior fields in campaign balance multi-turn tests","description":"Multi-turn tests define expected_behavior (incremental_concessions, appropriate_resistance, progress_shown, hard_limit_maintained) but only partially validate them. Implement explicit checks or remove unused flags to avoid false positives and misleading test config.","acceptance_criteria":"- progress_shown results in a test failure when required and not found, or the flag is removed\n- hard_limit_maintained validation is enforced (no forbidden patterns across turns)\n- incremental_concessions and appropriate_resistance are either validated with documented heuristics or removed from test definitions","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-30T19:41:13.565151-05:00","updated_at":"2025-12-30T19:41:13.565151-05:00","source_repo":"."}
{"id":"worktree_worker3-4rl","content_hash":"14f39431f4c2c20317ade9bc5702a4d961dc66679529beea869fde8828f8e897","title":"PR #2353 change summary (pending merge)","description":"Summary of all changes vs origin/main for branch claude/refactor-llm-to-code-01Sr4NxrZzuzRJ2XDSVFPm9s:\n\n- game_state.py: Added D\u0026D mechanics/tool execution (execute_dice_tool), DICE_ROLL_TOOLS, deterministic calculators; pre-rolled generator (now unused). XP helpers unchanged.\n- constants.py: Reintroduced capability sets (MODELS_WITH_CODE_EXECUTION, TOOL_USE, PRECOMPUTE). Strategy function get_dice_roll_strategy. Updated context/output limits (e.g., llama-3.3-70b 128k ctx/65k out; gpt-oss-120b 131k/40k). Updated Gemini mappings/allow lists.\n- llm_service.py: Provider dispatch uses tools: Gemini3 -\u003e function-calling+JSON; Gemini2 -\u003e two-phase tools→JSON; OR/Cerebras -\u003e tool loop if whitelisted. Added dice-consistency patch to narrative. Pre-rolled comments remain but no injection. Uses DICE_ROLL_TOOLS.\n- Providers: gemini_provider added tool loop and “code_execution” path (actually function-calling). cerebras/openrouter providers restored tool loop/process_tool_calls and tool_call-aware wrappers.\n- json_utils.py: Added fallback extraction for session_header/planning_block on malformed JSON (regex-based, fragile for nesting).\n- Prompts: game_state_instruction switched to tool-based dice; “copy tool numbers exactly.”\n- Frontend: api.js/app.js better error messages; settings.html adds Gemini 2.5 option text.\n- Tests: dice and JSON tests revamped; test_game_state expanded; planning block integration tests updated; fake_llm added; pre_rolled assertions removed.\n- Misc: llm_request dropped pre_rolled_dice field; clock_skew TESTING bypass; minor scripts update.\n\nKnown risks/todos (tracked separately):\n- Tool entry should be tool-on-demand (first call plain JSON, second only if tool_calls) and robust planning_block/session_header fallback (beads 21f/519).\n- Regex salvage for planning_block is fragile.\n- XP/level validation still not enforced (bead 58b).\n\nClose this bead after PR merge to keep a record of scope for reviewers.","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-12T17:10:15.558893-05:00","updated_at":"2025-12-13T14:06:33.919247-05:00","closed_at":"2025-12-13T14:06:33.919247-05:00","source_repo":"."}
{"id":"worktree_worker3-519","content_hash":"7c96aeda6ed7dc55cfbb6f7a443e1dadf2c5f8065bcbd4306cfba42d973122a4","title":"Tool-on-demand LLM entrypoint (reduce malformed JSON, restore headers/blocks)","description":"Goal: Align with origin/main by making the first LLM call plain JSON (no tools) and only doing a second call if tool_calls are returned.\n\nProblem: Current tool-loop entrypoint (PR #2353) sends tool-enabled first calls for Cerebras/OR and Gemini 2.x. Some providers (e.g., Cerebras) return malformed/partial JSON with missing session_header/planning_block on non-dice turns. Fallback was removed, so headers/blocks go missing.\n\nProposed approach:\n1) First call: JSON mode, no tools; brief instruction tells the model to request tool calls if dice/skills/saves needed.\n2) If tool_calls present: execute tools, then second call JSON mode (tools disabled) with results to produce final structured response.\n3) If no tool_calls: use first response as final.\n4) Fallback: if session_header or planning_block missing after final response, reprompt once to add them. Keep malformed-JSON salvage as last resort.\n\nScope/files:\n- mvp_site/llm_service.py: adjust dispatch to tool-on-demand.\n- mvp_site/llm_providers/*: ensure plain JSON helper; tool loop only when tool_calls exist.\n- Prompts: instruct models to request tools when needed; no “tools always” assumption.\n\nAcceptance:\n- Non-dice turns complete in one call with session_header + planning_block present.\n- Dice turns complete in two calls with executed tool results and valid JSON.\n- Reduced malformed-JSON incidence for Cerebras/OR; missing headers/blocks covered by reprompt fallback.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T12:41:29.829537-05:00","updated_at":"2025-12-13T14:06:03.404255-05:00","closed_at":"2025-12-13T14:06:03.404255-05:00","source_repo":"."}
{"id":"worktree_worker3-58b","content_hash":"2f251d8df5680f8d9439915faf574650a5e0c23795341ac6d2ef3f9f3b20aad0","title":"Harden narrative/XP/time validation and fuzzy JSON extraction","description":"Summary of investigation findings:\n1) Narrative truncation: malformed JSON when narrative contains unescaped quotes; parser truncates mid-sentence. Need fuzzy extraction fallback to capture full narrative when strict parse fails or length is suspiciously short.\n2) Level/XP discrepancies: prompts in mechanics_system_instruction were vague (\"typically double\" XP); game_state blindly accepts LLM XP/level. Need to enforce D\u0026D 5e XP table in prompt and add validation in GameState (_validate_level_consistency) to warn on mismatches.\n3) Time tracking anomalies: GameState accepts backward time jumps. Add validate_time_monotonicity to detect/reject/warn when new timestamp \u003c previous.\n\nUpdated leveling approach:\n- Backend owns XP→level (and level→XP) using the fixed 5e table; LLM does not compute level. If LLM proposes mismatched XP/level, backend corrects or reprompts.\n- Prompt change: tell the LLM \"XP/level are authoritative from the system; do not change them. When you mention level or XP, use the provided values.\" LLM may propose \"apply level-up now\" flags, but backend applies the table and updates state.\n\nRequested work:\n- Add robust fallback extraction in narrative_response_schema.py for malformed JSON.\n- Update mechanics_system_instruction.md to include standard 5e cumulative XP table and remove ambiguous guidance; include the prompt text above about authoritative XP/level.\n- Implement GameState validation hooks: level/XP consistency (auto-correct or warn) and time monotonicity (warn/reject backwards time).\n","status":"closed","priority":3,"issue_type":"task","assignee":"c3","created_at":"2025-12-12T11:59:23.318533-05:00","updated_at":"2025-12-14T16:39:03.261108-08:00","closed_at":"2025-12-14T16:39:03.261108-08:00","source_repo":"."}
{"id":"worktree_worker3-5st","content_hash":"605c0fc0a84d9aef7f85126d46d103e935c6cd0cef60fc5675398e6e8ff9f2cb","title":"PR2353: Clean up Firestore mock client duplication / dead code","description":"`mvp_site/firestore_service.py` contains duplicate `_mock_firestore_client` definitions (second shadows first), plus `_IN_MEMORY_DB` appears unused while real singleton logic uses `_mock_client_singleton`.\n\nGoal: remove dead/duplicated code safely; ensure MOCK_SERVICES_MODE uses a singleton in-memory Firestore; keep tests passing and avoid state pollution.\n\nPR: #2353","notes":"Assigned to CodevFirestore. Status check: agent has urgent ACK/registration requests pending; no findings delivered yet.","status":"closed","priority":2,"issue_type":"task","assignee":"CodevFirestore","created_at":"2025-12-18T20:47:20.508676-08:00","updated_at":"2025-12-18T21:07:55.440083-08:00","closed_at":"2025-12-18T21:07:55.440083-08:00","source_repo":"."}
{"id":"worktree_worker3-620","content_hash":"c09fc720be1e157ac3a377253f4e092057ddf474de37775f8ba6e4513888605e","title":"Update llm_service.py to route by provider","description":"Modify _call_llm_api() to:\n1. Determine provider from model name\n2. Call appropriate provider's generate_content_with_tool_loop()\n3. Pass DICE_ROLL_TOOLS to all providers","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T10:18:19.024753-05:00","updated_at":"2025-12-13T14:06:05.865182-05:00","closed_at":"2025-12-13T14:06:05.865182-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-620","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:19.025281-05:00","created_by":"daemon"},{"issue_id":"worktree_worker3-620","depends_on_id":"worktree_worker3-8pt","type":"blocks","created_at":"2025-12-11T10:18:29.718478-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-67y","content_hash":"b6e572582cc638db3d9e4334397b405fecd17e56f6bee763a468897ffaa65e1e","title":"Unconditional two-phase dice flow doubles API calls","description":"Current routing in llm_service forces native_two_phase for Gemini 2.x default, Cerebras, and OpenRouter even when no tool calls are needed. Every turn now triggers two provider requests (Phase 1 tools + Phase 2 JSON), doubling latency/cost and rate-limit usage for all users by default. Add conditions/flags to keep single-call JSON flow when dice are not required or when models support tool_requests; only run two-phase when tools are requested or required.","notes":"Ping @code. Problem: two-phase dice flow is forced even when no dice/tool_calls are needed, doubling API calls, latency, and cost. Proposed mitigations: (1) gate two-phase on explicit dice need; (2) keep JSON-first tool_requests for Gemini 2.x; (3) if Phase-1 returns no tool_calls, reuse response and skip Phase-2; (4) add feature flag ENABLE_NATIVE_DICE_TOOLS default off; (5) cost/latency guard to fall back to single-call when over budget.","status":"closed","priority":2,"issue_type":"bug","assignee":"code","created_at":"2025-12-17T01:44:19.940202-08:00","updated_at":"2025-12-17T21:07:09.413813-08:00","closed_at":"2025-12-17T21:07:09.413813-08:00","source_repo":".","labels":["cost","dice","latency","performance","pr-2353"]}
{"id":"worktree_worker3-6lm","content_hash":"8313be06bac055a19d81b253b743bfe8752f630b9cb1a0941a6f78f32c73e92e","title":"Harden social encounter tests: preflight tool_config and fail clearly","description":"Add preflight checks in social encounter real API tests to ensure required tool_config is present; when missing, fail fast with a clear message to avoid misattributing LLM behavior to config gaps.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T02:47:57.063209-08:00","updated_at":"2025-12-18T17:45:52.16578-08:00","closed_at":"2025-12-18T17:45:52.16578-08:00","source_repo":"."}
{"id":"worktree_worker3-6tg","content_hash":"9146505a6b70a2475708cef1a8288d1afde9899e4790d58a0313709f32c444d9","title":"Open questions: dice roll count mismatch \u0026 empty-narrative root cause","description":"Track risks from latest MCP smoke evidence: (1) roll counter reports 1 while evidence shows attack+damage for OpenRouter defaultWorld; unclear expected counting; (2) prior defaultWorld empty narrative failure cause unknown; need root-cause and mitigation to prevent recurrence.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-17T02:35:21.62277-08:00","updated_at":"2025-12-17T02:35:21.62277-08:00","source_repo":"."}
{"id":"worktree_worker3-6ws","content_hash":"bdc758a034df0bbe91ff2de5ac1f5a6346ec0c2ef631696c0b39c3d1c07f4f5a","title":"Docs/test policy alignment and clock-skew safety","description":"Docs \u0026 policy fixes:\n- .claude/skills/end2end-testing.md: correct test file list/paths to match repo; remove references to missing files.\n- CLAUDE.md No Silent Test Skipping: change FAIL LOUDLY example from pytest.skip to pytest.fail/raise; soften enforcement language to reflect current automation.\n- narrative_system_instruction.md: wording on choice keys (snake_case vs god:option_1) to avoid inconsistency.\n- clock_skew_credentials.py: adjust TESTING guard so WORLDAI creds still require dev/test mode per review suggestion.\n","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-13T20:06:27.548302-05:00","updated_at":"2025-12-14T16:32:22.310981-08:00","closed_at":"2025-12-14T16:32:22.310981-08:00","source_repo":"."}
{"id":"worktree_worker3-7k2","content_hash":"864e3465dd2a8ebcbee49ec8945e9ba8c7e9708eda0fb15d303ca9a677975167","title":"Gemini 2.x AUTO tool mode risks skipping dice tools","description":"Commit 0c915737c changed Gemini native tool flow from function_calling_config mode 'ANY' to 'AUTO'. In AUTO the model can choose not to call dice/skill tools, breaking the requirement that server executes all dice rolls. Risk: silent fake/no dice rolls in combat/skill checks. Fix: revert to ANY or enforce tool usage for dice-critical paths.","status":"closed","priority":1,"issue_type":"bug","assignee":"code","created_at":"2025-12-17T20:26:54.593073-08:00","updated_at":"2025-12-17T20:32:26.233773-08:00","closed_at":"2025-12-17T20:32:26.233773-08:00","source_repo":".","labels":["dice","gemini","p0","pr-2353"]}
{"id":"worktree_worker3-82m","content_hash":"b73b4882cfda502f9e6f61d11ca3c9d27e6df8ecd26f7b90124df1dc7c999426","title":"Implement Native Two-Phase Tool Calling for All Non-Gemini Models","description":"Replace prompt-based tool_requests approach with native API tool calling for Cerebras/OpenRouter providers.\n\n## Problem\n- Current approach uses JSON schema with `tool_requests` field via prompt instructions\n- GLM-4.6 and other models ignore this because they're trained for native tool calling\n- API limitation: `tools` + `response_format` cannot be used together\n\n## Solution\nImplement true two-phase native tool calling:\n- Phase 1: `tools` parameter (no JSON schema) → get `tool_calls` in response\n- Phase 2: `response_format` parameter (no tools) → get structured JSON with results\n\n## Scope\n- Gemini 2.0/3.0: Keep single-phase code_execution (supports both together)\n- Gemini 2.5: Native two-phase\n- All Cerebras: Native two-phase  \n- All OpenRouter: Native two-phase","design":"## Architecture\n\n### Strategy Selection (constants.py)\n```python\ndef get_dice_roll_strategy(model_name, provider):\n    if model_name in {\"gemini-2.0-flash\", \"gemini-3-pro-preview\"}:\n        return \"code_execution\"  # Single phase\n    return \"native_two_phase\"  # All others\n```\n\n### Native Two-Phase Flow\n1. Phase 1: Call with `tools=DICE_ROLL_TOOLS`, no response_format\n2. Extract `tool_calls` from response.choices[0].message.tool_calls\n3. Execute tools using execute_dice_tool()\n4. Phase 2: Call with `response_format=JSON_SCHEMA`, include tool results as message\n\n### Files to Modify\n- constants.py: Simplify get_dice_roll_strategy()\n- cerebras_provider.py: Add generate_content_with_native_tools()\n- openrouter_provider.py: Add generate_content_with_native_tools()\n- gemini_provider.py: Add native_two_phase for 2.5\n- llm_service.py: Route to correct strategy","acceptance_criteria":"- [ ] All Cerebras models use native tool calling\n- [ ] All OpenRouter models use native tool calling\n- [ ] Gemini 2.0/3.0 keep single-phase code_execution\n- [ ] Gemini 2.5 uses native two-phase\n- [ ] GLM-4.6 produces dice rolls in combat\n- [ ] Smoke tests pass for all providers\n- [ ] No regression in existing functionality","notes":"Implementation complete. All providers updated to use native two-phase tool calling:\n- constants.py: Simplified get_dice_roll_strategy() to return only code_execution or native_two_phase\n- cerebras_provider.py: Added generate_content_with_native_tools()\n- openrouter_provider.py: Added generate_content_with_native_tools()  \n- gemini_provider.py: Added generate_content_with_native_tools() for Gemini 2.5\n- llm_service.py: Updated routing to use correct strategies\n- test_code_execution_dice_rolls.py: Updated tests for new architecture\n\n50 tests passing. Needs smoke test validation with live APIs to confirm GLM-4.6 produces dice rolls.","status":"in_progress","priority":1,"issue_type":"feature","assignee":"claude","created_at":"2025-12-16T22:14:10.97962-08:00","updated_at":"2025-12-16T22:29:11.578447-08:00","source_repo":".","labels":["architecture","dice-rolls","pr-2353","tool-calling"]}
{"id":"worktree_worker3-8f1","content_hash":"161b615a2253a8c08ceeee7ba8767328cfdebc86a11bcce13a9dfbe54aa9340f","title":"Phase 2 Skip Optimization - Redesign with Schema Validation","description":"Redesign Phase 2 skip optimization with proper schema validation and tool enforcement.\n\nCONTEXT: Initial optimization (0c915737c) reverted due to critical regressions:\n1. Schema bypass: Skipped Phase 2 without validating required fields (planning_block, session_header, dice_rolls)\n2. Tool mode regression: Changed mode='ANY' to mode='AUTO', allowing LLM to skip mandatory dice rolls\n\nGOAL: Achieve ~25-30% token reduction for narrative-only turns while maintaining:\n- Mandatory dice rolls (mode='ANY')\n- Schema compliance (all required fields)\n- No client-side KeyErrors or missing data","design":"## Approach: Schema-Validated Phase 2 Skip\n\n### Implementation Strategy\n1. Keep tool_config mode='ANY' (force tools, preserve dice authority)\n2. Add schema validation before Phase 2 skip\n3. Only skip Phase 2 when:\n   - No function_calls returned from Phase 1\n   - Phase 1 text is valid JSON\n   - All required fields present (narrative, planning_block, session_header, etc.)\n\n### Code Pattern\n```python\nif not function_calls:\n    try:\n        parsed = json.loads(phase1_text)\n        required_fields = ['narrative', 'planning_block', 'session_header']\n        \n        if all(field in parsed for field in required_fields):\n            logging_util.info(\"Phase 1 response schema-valid, skipping Phase 2\")\n            return response1\n    except (json.JSONDecodeError, KeyError):\n        logging_util.info(\"Phase 1 response invalid, proceeding to Phase 2\")\n        \n# Run Phase 2 for formatting and schema enforcement\nreturn run_phase2(...)\n```\n\n### Testing Requirements\n- Test Phase 2 skip with complete JSON (should skip)\n- Test Phase 2 skip with missing planning_block (should NOT skip)\n- Test Phase 2 skip with missing session_header (should NOT skip)\n- Test that dice rolls still forced in combat (mode='ANY' preserved)\n- Integration test: verify no KeyErrors in UI with optimization active","acceptance_criteria":"MUST:\n- [ ] mode='ANY' preserved for all providers (gemini, openrouter, cerebras)\n- [ ] Schema validation includes ALL required fields before Phase 2 skip\n- [ ] Tests verify missing fields force Phase 2 execution\n- [ ] Combat/skill checks still use server-executed dice\n- [ ] No KeyErrors in UI from missing fields\n\nSHOULD:\n- [ ] Achieve ~25-30% token reduction for narrative-only turns\n- [ ] Log when Phase 2 skipped vs executed for debugging\n- [ ] Add metrics to track Phase 2 skip rate\n\nMUST NOT:\n- [ ] Use mode='AUTO' (allows dice skip)\n- [ ] Skip Phase 2 without schema validation\n- [ ] Ship incomplete JSON to clients","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-17T20:31:40.112282-08:00","updated_at":"2025-12-17T20:31:40.112282-08:00","source_repo":"."}
{"id":"worktree_worker3-8gv","content_hash":"05838a4cdd4bea1e2dd6ff281ae018e5b2829373b83d058c7a50b47dd8233252","title":"NPC death state not persisting (Marcus elimination issue)","description":"NPC death state not persisting between turns. User kills Marcus but game still presents options to kill him.\n\nROOT CAUSE ANALYSIS (CONFIRMED):\n\n**TWO SEPARATE ISSUES:**\n\n1. **apply_automatic_combat_cleanup NOT called in main story flow**\n   - world_logic.py line 905: `update_state_with_changes` called\n   - NO `apply_automatic_combat_cleanup` call after it\n   - Cleanup only called in GOD_MODE flows (lines 1817, 1887)\n   - Result: combat_state HP=0 deaths are not synced to npc_data\n\n2. **cleanup_defeated_enemies DELETES instead of marking dead**\n   - game_state.py line 729: `del self.npc_data[enemy_name]`\n   - For generic enemies (goblins): deletion is correct\n   - For named NPCs (Marcus): need `status: [\"dead\"]` to persist\n   - Without status, LLM can't know NPC is dead\n\n**WHY THIS HAPPENS:**\n- npc_data EXCLUDED from LLM context (to save tokens - ~500/NPC)\n- entity_tracking_data is READ-ONLY trimmed data\n- LLM can't see death status → offers to kill dead NPCs\n\n**FIX REQUIRED:**\n1. Add `apply_automatic_combat_cleanup` call after line 905 in main story flow\n2. Modify cleanup to mark named NPCs as dead instead of deleting","acceptance_criteria":"- NPC deaths update npc_data.status = 'dead'\n- Dead NPCs not offered as targets in planning blocks\n- State persists across sessions","notes":"Traced to commit ded8efa84 which excluded npc_data from context. Cleanup function exists but is not called in main flow. This is a pre-existing bug on origin/main, not from PR #2353.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-17T01:43:36.616356-08:00","updated_at":"2025-12-18T17:57:52.44069-08:00","closed_at":"2025-12-18T17:57:52.44069-08:00","source_repo":".","labels":["bug","game-state","npc"]}
{"id":"worktree_worker3-8o0","content_hash":"4c9db48e07f02be422b48cd77f16dd15071bf1d87214a69cd3e696189f4e1f30","title":"Combat: Stale combat_summary reused in quick combat","description":"**Root Cause Analysis:**\n\nQuick combat execution shows `enemies_defeated` listing 3 goblins even though the action was a single goblin execution.\n\n**Evidence from raw_mcp_responses.jsonl:**\n```\nInput: \"I notice a wounded goblin trying to crawl away. I walk over and execute it with my sword\"\n\nLLM Output:\n{\n  \"combat_state\": {\n    \"in_combat\": false,\n    \"combat_phase\": \"ended\",\n    \"combat_summary\": {\n      \"enemies_defeated\": [\"npc_goblin_001\", \"npc_goblin_002\", \"npc_goblin_003\"],  // WRONG!\n      \"xp_awarded\": 50\n    }\n    // MISSING: combat_session_id!\n  }\n}\n```\n\n**Root Cause:**\n1. Quick combat did NOT generate a new `combat_session_id`\n2. Without a fresh session ID, the LLM confused this with the previous combat\n3. It carried over the `enemies_defeated` list from the prior session\n4. User asked to execute ONE goblin, but LLM listed THREE\n\n**Fix Required:**\n1. Prompt must require `combat_session_id` for ALL combat (including quick/single-turn)\n2. Each combat session must have fresh `enemies_defeated` starting empty\n3. Add validation: `enemies_defeated` count should match actual kills in THIS session\n\n**Related:** This also explains the HP state drift - the LLM is not treating each combat as isolated.","design":"**Solution Design:**\n\n1. Add to combat checklist:\n   - EVERY combat (including quick/single-turn) MUST have unique `combat_session_id`\n   - `combat_summary.enemies_defeated` = ONLY enemies killed in THIS session\n   \n2. Add validation rule:\n   - If `combat_session_id` is missing or reused, state_updates is INVALID\n   \n3. Prompt wording:\n   ```markdown\n   **Quick Combat / Single-Turn Combat:**\n   Even single-turn combat (execution, coup de grace) requires:\n   - [ ] Fresh `combat_session_id` (format: `combat_\u003ctimestamp\u003e_\u003ccontext\u003e`)\n   - [ ] `enemies_defeated` contains ONLY the target of THIS action\n   - [ ] `xp_awarded` for ONLY the killed enemy\n   ```","acceptance_criteria":"- Quick combat generates unique combat_session_id\n- enemies_defeated contains only enemies killed in current session\n- XP matches only the enemies actually killed\n- Test: Execute 1 goblin → enemies_defeated has exactly 1 entry","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-26T15:28:36.45412-05:00","updated_at":"2025-12-26T15:49:20.724512-05:00","closed_at":"2025-12-26T15:49:20.724512-05:00","source_repo":".","labels":["combat","pr-2553","state-management"]}
{"id":"worktree_worker3-8pt","content_hash":"c80486cbf421ca33c02e078f6d7c0e9721e4cdba6d974af6fe3dc64efe7af19f","title":"Add Gemini tool loop with phase separation","description":"Implement generate_content_with_tool_loop() for Gemini provider with special handling:\n- Phase 1: tools=ON, json_mode=OFF (function calling)\n- Phase 2: tools=OFF, json_mode=ON (structured output)\n\nThis works around Gemini API limitation that rejects tools + JSON mode together.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T10:18:17.738164-05:00","updated_at":"2025-12-13T14:06:06.971061-05:00","closed_at":"2025-12-13T14:06:06.971061-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-8pt","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:17.738798-05:00","created_by":"daemon"},{"issue_id":"worktree_worker3-8pt","depends_on_id":"worktree_worker3-bkl","type":"blocks","created_at":"2025-12-11T10:18:28.75882-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-8qz","content_hash":"0950fc2056e30f915891bc4dff6e0b32db63dfa99aebff2d4c6c827abe5954a7","title":"Smoke test tool loops for all providers","description":"Run smoke tests against:\n- Gemini (phase-separated tool loop)\n- Cerebras (unified tool loop)\n- OpenRouter (unified tool loop)\n\nVerify LLM can call roll_attack(), roll_dice(), roll_skill_check(), roll_saving_throw() and results appear in final JSON response.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T10:18:19.55518-05:00","updated_at":"2025-12-13T14:06:35.068691-05:00","closed_at":"2025-12-13T14:06:35.068691-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-8qz","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:19.555715-05:00","created_by":"daemon"},{"issue_id":"worktree_worker3-8qz","depends_on_id":"worktree_worker3-620","type":"blocks","created_at":"2025-12-11T10:18:30.196946-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-8zk","content_hash":"324ef098167547dcfc29b72f1a4dfc5175f126a75144b2647e1c8654b70a3b41","title":"Route Gemini 2.x through JSON-first tool_requests flow","description":"Prompt docs emphasize JSON-first tool_requests two-phase. llm_service currently routes Gemini 2.x to native tool-calling, which can ignore tool_requests if model follows prompt literally.","acceptance_criteria":"- llm_service routes Gemini 2.x (native_two_phase strategy) to gemini_provider.generate_content_with_tool_requests\n- Update/unit tests reflect new routing\n- End2end tests still pass","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-18T17:35:58.537481-08:00","updated_at":"2025-12-18T17:38:38.516315-08:00","closed_at":"2025-12-18T17:38:38.516315-08:00","source_repo":"."}
{"id":"worktree_worker3-9xp","content_hash":"818dcb5c06483789b2103ccbfa2af5e5655f27a7e34f8aa0aa26f06e8f5586fb","title":"Remove forced tool-calling; only call dice tools when needed","description":"We currently force at least one tool call in some provider flows (Gemini native tools uses FunctionCallingConfig(mode='ANY'); Cerebras/OpenRouter set tool_choice='required'). This adds latency/cost and can create unnecessary dice actions. Gemini 3 uses code_execution + JSON in a single call and does not need forced function tool calling for dice tools.\n\nScope:\n- Revisit/relax forced tool calling behavior across providers.\n- Ensure no-roll turns work without any tool call.\n- Preserve correctness for turns that do require rolls.\n\nNotes:\n- Gemini 3 path uses built-in code_execution (not server dice tools) and shouldn't require tool forcing.\n- If forced tool calling remains for Gemini 2.5 native tools, ensure model can choose declare_no_roll_needed reliably, or switch to a JSON-first tool_requests flow where no tool call is allowed when unnecessary.\n\nUpdate (2025-12-18): Gemini native tool calling no longer forces a function call (mode='AUTO' instead of 'ANY') and new unit tests cover no-roll path still returning JSON. Remaining: decide whether to relax OpenRouter/Cerebras tool_choice='required'.","acceptance_criteria":"- Gemini 3 (code_execution strategy) does not force any server dice tool call.\n- Gemini native_two_phase (2.x/2.5) does not force tool calls for prompts that do not require dice; tests cover this.\n- Cerebras/OpenRouter tool calling is not globally forced; tool calls are optional unless explicitly required by the prompt.\n- Add/adjust unit/integration tests to prevent regressions (e.g., a no-roll prompt produces zero tool calls and still returns valid JSON).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T14:28:12.372821-08:00","updated_at":"2025-12-18T17:43:26.618141-08:00","closed_at":"2025-12-18T17:43:26.618141-08:00","source_repo":"."}
{"id":"worktree_worker3-a08","content_hash":"3a79c5796e59a96c4615c0e9de2c017ab2e50aea27472bb81af8d6a84c850db8","title":"Frontend PII logging and system actor handling","description":"Fix frontend review items:\n- Remove or redact user email logging in mvp_site/frontend_v1/api.js fetchApi error path (PII leak).\n- Add explicit handling for 'system' actor in appendToStory or avoid using that actor to prevent mislabelled UI messages in app.js error handling.\n","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-13T20:06:08.567991-05:00","updated_at":"2025-12-14T16:32:17.316218-08:00","closed_at":"2025-12-14T16:32:17.316218-08:00","source_repo":"."}
{"id":"worktree_worker3-b3v","content_hash":"a9e91df810c93be80e57833fc210ea94a4ffaa117e4add5620ef7baa52989568","title":"Optimize Cerebras: Skip Phase 2 when no tool_calls with fallback","description":"Implement conditional Phase 2 skip for Cerebras to reduce latency when tools aren't needed, while maintaining schema enforcement as fallback.","design":"## Problem\nCurrent Cerebras implementation always runs Phase 2 for schema enforcement, even when Phase 1 returns no tool_calls and valid JSON text.\n\n## Solution\nConditionally skip Phase 2 when safe, with fallback to schema enforcement:\n\n```\nPhase 1 (tools + text generation)\n    ↓\nHas tool_calls? ─Yes→ Execute tools → Phase 2 (with schema)\n    │\n    No\n    ↓\nTry parse text as JSON\n    ↓\nValid + matches schema? ─Yes→ Use directly (skip Phase 2)\n    │\n    No\n    ↓\nPhase 2 (with schema enforcement)\n```\n\n## Benefits\n- Single-call for non-tool turns (majority of LLM calls)\n- Schema enforcement preserved as safety net\n- No risk of malformed JSON reaching game state\n\n## Implementation Notes\n- Add JSON schema validation utility\n- Track metrics: Phase 2 skip rate, fallback rate\n- Consider feature flag for gradual rollout","acceptance_criteria":"- [ ] Phase 1 text is parsed as JSON when no tool_calls\n- [ ] Schema validation runs on parsed JSON\n- [ ] Valid JSON skips Phase 2 call\n- [ ] Invalid JSON falls back to Phase 2\n- [ ] Metrics track skip/fallback rates\n- [ ] No regression in response quality\n- [ ] Latency improvement measured","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-17T11:08:44.123137-08:00","updated_at":"2025-12-17T21:07:08.863918-08:00","closed_at":"2025-12-17T21:07:08.863918-08:00","source_repo":"."}
{"id":"worktree_worker3-ber","content_hash":"58a12d571fc26f66342e29209fb9081924e91c952380a4ff7ab2396695e26ee1","title":"Consider removing tool_choice='required' from native tools flows","description":"OpenRouter/Cerebras generate_content sets tool_choice='required' when tools are passed. Even though llm_service routes those providers through JSON-first tool_requests, the native tools entrypoints remain and could force unnecessary tool calls if used.","acceptance_criteria":"- Decide whether to keep required vs auto\n- If changed, add tests to ensure combat still triggers dice when appropriate","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-18T17:36:15.649701-08:00","updated_at":"2025-12-18T17:40:38.117236-08:00","closed_at":"2025-12-18T17:40:38.117236-08:00","source_repo":"."}
{"id":"worktree_worker3-bkl","content_hash":"c0ac59ca6db9728010db5be820adf8a9ef43b7c9f892de0a23320435f172a4b2","title":"Revert commit 9b70c1ff9 (tool loop deletion)","description":"git revert 9b70c1ff9 to restore ~1,400 lines of tool loop infrastructure:\n- DICE_ROLL_TOOLS array\n- execute_dice_tool() function\n- generate_content_with_tool_loop() in cerebras/openrouter providers\n- process_tool_calls() in both providers\n- MODELS_WITH_TOOL_USE set\n- get_dice_roll_strategy() function","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T10:18:17.005724-05:00","updated_at":"2025-12-13T14:06:04.72984-05:00","closed_at":"2025-12-13T14:06:04.72984-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-bkl","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:17.006728-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-c1","content_hash":"65a3e81a0853305f1bc0136099a8ae233058ead6e78de4d1199e2e79b213bf52","title":"Performance: Two-phase optimization + conditional tool injection","description":"Optimize native two-phase flow to reduce unnecessary API calls and token usage.\n\n**Tasks:**\n1. Skip Phase 2 when Phase 1 returns no tool_calls AND text is valid JSON\n2. Make tool/schema injection conditional in llm_service.py ONLY\n3. Add heuristic: check prompt/user input for dice/skill/save keywords\n4. Add tests for reduced payload in non-dice turns\n\n**Impact:** Halves API calls for non-dice turns, reduces tokens/latency\n\n**Files (NO OVERLAP):**\n- mvp_site/llm_service.py ONLY\n- Tests related to llm_service.py\n\n**Note:** Provider-level changes moved to c2","status":"closed","priority":1,"issue_type":"task","assignee":"c1","created_at":"2025-12-17T12:20:45.968561-08:00","updated_at":"2025-12-17T21:01:18.281211-08:00","closed_at":"2025-12-17T21:01:18.281211-08:00","source_repo":".","labels":["optimization","performance","pr-2353"]}
{"id":"worktree_worker3-c2","content_hash":"2805139ddb7c21aded1f7fc65b6482f1a708dc84371643a6261c870800c528a8","title":"Provider Hygiene: Imports, validation, response_format compatibility","description":"Clean up ALL provider code to prevent crashes and improve maintainability.\n\n**Tasks:**\n1. Move all inline execute_dice_tool imports to module scope in cerebras_provider.py\n2. Add type checks/coercion in execute_tool_requests (all providers)\n3. Fix test arg key to `notation` in tool_request tests\n4. Make response_format conditional when tools present in openrouter_provider.py OR document compatibility\n5. Add validation for malformed tool_requests to prevent crashes\n6. Implement Phase 2 skip optimization when no tool_calls (provider level)\n\n**Impact:** Prevents crashes, improves code quality, performance gains\n\n**Files (NO OVERLAP):**\n- mvp_site/llm_providers/cerebras_provider.py\n- mvp_site/llm_providers/openrouter_provider.py\n- mvp_site/llm_providers/gemini_provider.py\n- Tests for provider functions\n\n**Note:** game_state.py moved to c3, llm_service.py assigned to c1","status":"closed","priority":1,"issue_type":"task","assignee":"c2","created_at":"2025-12-17T12:21:00.382163-08:00","updated_at":"2025-12-17T21:01:18.936899-08:00","closed_at":"2025-12-17T21:01:18.936899-08:00","source_repo":".","labels":["code-quality","pr-2353","validation"]}
{"id":"worktree_worker3-c3","content_hash":"0a13672f808aa1b31659876555b6de35f302c005ac59d18cc6a59363fd57b03b","title":"Dead Code Cleanup: Remove unused helpers and obsolete paths","description":"Remove unused code to reduce confusion and improve maintainability.\n\n**Tasks:**\n1. Remove unused game_state.py helpers:\n   - calculate_initiative\n   - calculate_complication_chance\n   - check_complication_triggers\n   - calculate_death_save\n   - calculate_hp_for_class\n2. Add validation to execute_tool_requests in game_state.py (type checks)\n3. Remove stray calculate_damage stub in testing_llm/test_ai_development_workflow.md\n4. Consolidate or remove redundant test files with sys.path hacks\n5. Clean up unused imports revealed by deletions\n\n**Impact:** Reduces confusion, smaller codebase, better validation\n\n**Files (NO OVERLAP):**\n- mvp_site/game_state.py ONLY (execute_tool_requests validation)\n- testing_llm/test_ai_development_workflow.md\n- Test files with sys.path hacks\n\n**Note:** Gemini provider dead code removal moved to c2 since c2 handles ALL providers","status":"closed","priority":2,"issue_type":"task","assignee":"c3","created_at":"2025-12-17T12:21:14.768442-08:00","updated_at":"2025-12-17T21:01:19.541694-08:00","closed_at":"2025-12-17T21:01:19.541694-08:00","source_repo":".","labels":["cleanup","code-quality","pr-2353"]}
{"id":"worktree_worker3-c4","content_hash":"824ff3dd7b47acb9b9ff515f1aa5b1c0e941c0c95955a263f9caec2bea0924c2","title":"Frontend/Docs Polish + clock_skew fix","description":"Polish frontend, docs, and fix local development blocker.\n\n**Tasks:**\n1. **clock_skew_credentials.py fix (BLOCKER):**\n   - Fix validate_deployment_config to allow TESTING=true to bypass guard\n   - OR keep guard and document WORLDAI_DEV_MODE requirement in local env\n   - Decision: Allow TESTING bypass for CI/local parity\n\n2. **Frontend PII cleanup:**\n   - Remove/redact user_email logging in mvp_site/static/js/api.js\n   - Handle 'system' actor in appendToStory or use different actor in app.js error path\n\n3. **Docs updates:**\n   - Update end2end-testing.md paths\n   - CLAUDE.md fail-loud example to pytest.fail\n   - Soften enforcement wording\n   - narrative_system_instruction choice-key wording\n\n4. **Optional minor:**\n   - Add bounds check in roll_dice to reject num_dice \u003c 1\n\n**Impact:** Unblocks local development, improves privacy, better docs\n\n**Files:**\n- mvp_site/util/clock_skew_credentials.py\n- mvp_site/static/js/api.js\n- mvp_site/static/js/app.js\n- docs/end2end-testing.md\n- CLAUDE.md\n\n**Related:** msg 151 from codev, bead 6ws, bead a08","status":"closed","priority":1,"issue_type":"task","assignee":"c4","created_at":"2025-12-17T12:21:33.260495-08:00","updated_at":"2025-12-17T21:01:20.187307-08:00","closed_at":"2025-12-17T21:01:20.187307-08:00","source_repo":".","labels":["blocker","docs","frontend","pr-2353"]}
{"id":"worktree_worker3-c9g","content_hash":"3fc3f15899d68e2c98ae002af891ba648efeaec0d8761cd39e2b31c29b8bf014","title":"Unify planning_block schema: Single source of truth in Python","description":"**Problem:** Two sources of truth for planning_block structure that are out of sync:\n1. `game_state_instruction.md` (lines 33-53, 72-75) - Detailed, correct\n2. `provider_utils.py:NARRATIVE_RESPONSE_SCHEMA` - Vague ({type: object})\n\nThe JSON schema only says `planning_block: {type: object, additionalProperties: true}` which allows empty `{}`. The LLM satisfies the schema constraint but ignores the prompt's detailed structure requirements.\n\n**Solution (Option B):** Single source in Python, generate prompt section\n\n1. Define full planning_block schema in `provider_utils.py`:\n```python\nPLANNING_BLOCK_SCHEMA = {\n    \"type\": \"object\",\n    \"properties\": {\n        \"thinking\": {\"type\": \"string\", \"description\": \"GM tactical analysis\"},\n        \"context\": {\"type\": \"string\", \"description\": \"Current scenario context\"},\n        \"choices\": {\n            \"type\": \"object\",\n            \"description\": \"Player choices with snake_case keys\",\n            \"additionalProperties\": {\n                \"type\": \"object\",\n                \"properties\": {\n                    \"text\": {\"type\": \"string\"},\n                    \"description\": {\"type\": \"string\"},\n                    \"risk_level\": {\"type\": \"string\"}\n                },\n                \"required\": [\"text\", \"description\"]\n            }\n        }\n    },\n    \"required\": [\"thinking\", \"choices\"]\n}\n```\n\n2. Add helper function to generate prompt-ready JSON example from schema\n3. Update `game_state_instruction.md` to reference or import from Python (or add sync comment)\n4. Consider using the schema for validation in `narrative_response_schema.py`\n\n**Files:**\n- `mvp_site/llm_providers/provider_utils.py` - Define detailed schema\n- `mvp_site/prompts/game_state_instruction.md` - Add sync reference\n- `mvp_site/narrative_response_schema.py` - May use schema for validation","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T17:10:06.787493-05:00","updated_at":"2025-12-12T17:18:51.746665-05:00","closed_at":"2025-12-12T17:18:51.746665-05:00","source_repo":".","labels":["architecture","planning-block","schema"]}
{"id":"worktree_worker3-cma","content_hash":"d370cb35f6c5b13130e1f0a37a6f151e8e097d23f5bb6ec3985220f15937f3ca","title":"Sanitize labeled modifier strings for injection prevention","description":"Labeled modifiers (e.g., '+2 STR') could be injection vectors if labels contain user input. Risk of log injection, XSS, or command injection in UI/backend.","acceptance_criteria":"- All modifier labels escaped before storage/rendering\n- Labels treated as untrusted data\n- No labels used in conditional logic","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-17T01:43:35.603188-08:00","updated_at":"2025-12-17T01:43:35.603188-08:00","source_repo":".","labels":["pr-2353","secondo-review","security"]}
{"id":"worktree_worker3-cwm","content_hash":"50d4addce59646ca0e0d007d2584c6e5e5280b45343a8be674b74a6cf74ef8ae","title":"Add end2end test skill to Claude skills directory","description":"Create a dedicated Claude skill file documenting the end2end test architecture, philosophy, and patterns. Currently this info is scattered across mvp_site/tests/README*.md but not in .claude/skills/.","design":"Create .claude/skills/end2end-testing.md with:\n1. Testing philosophy: Mock external APIs (Firestore, Gemini), NOT internal services\n2. Fake implementations: FakeFirestoreClient, FakeLLMResponse patterns\n3. Test file locations: test_end2end/, test_*_e2e.py\n4. Commands: /teste (mock), /tester (real), /4layer (TDD)\n5. Firestore nested collection structure\n6. Multi-phase function testing with side_effect","acceptance_criteria":"- Skill file created at .claude/skills/end2end-testing.md\n- Contains all E2E testing patterns from README_END2END_TESTS.md\n- Includes references to /teste, /tester, /4layer commands\n- Documents fake service implementation patterns","status":"closed","priority":2,"issue_type":"task","assignee":"claude","created_at":"2025-12-12T22:56:35.356329-05:00","updated_at":"2025-12-12T22:57:50.254195-05:00","closed_at":"2025-12-12T22:57:50.254195-05:00","source_repo":"."}
{"id":"worktree_worker3-czt","content_hash":"1782b983f0ea78b4745c8f1050e42011fd0426a473c5b4824eacb9bee3afe011","title":"PR2353: Remove user identifiers from INFO logs (privacy/compliance)","description":"CodeRabbit flagged INFO logs emitting `user_id` in `mvp_site/llm_service.py` allowlist paths.\n\nGoal: remove user_id from INFO logs (or downgrade to DEBUG with redaction) to reduce PII exposure.\n\nPR: #2353","notes":"Assigned to CodevPrivacy. Status check: agent has urgent ACK/registration requests pending; no findings delivered yet.","status":"closed","priority":1,"issue_type":"task","assignee":"CodevPrivacy","created_at":"2025-12-18T20:47:20.361654-08:00","updated_at":"2025-12-18T21:07:56.065344-08:00","closed_at":"2025-12-18T21:07:56.065344-08:00","source_repo":"."}
{"id":"worktree_worker3-d7r","content_hash":"a73cd05f6043aa130a8b9c91589f01a3ea5dbe03520b6fea6d74d7fce61a8466","title":"MOCK_SERVICES_MODE Firestore should persist across requests","description":"In MOCK_SERVICES_MODE, firestore_service.get_db returns a new _InMemoryFirestoreClient() each call, so campaigns created in one request are not visible in subsequent requests (e.g., create_campaign then process_action =\u003e Campaign not found).","acceptance_criteria":"- In MOCK_SERVICES_MODE, get_db returns a singleton in-memory client\n- Add a unit test ensuring create_campaign + process_action works in mock mode (or at least get_db identity is stable)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-18T17:36:07.776915-08:00","updated_at":"2025-12-18T17:39:48.497665-08:00","closed_at":"2025-12-18T17:39:48.497665-08:00","source_repo":"."}
{"id":"worktree_worker3-efg","content_hash":"baa5d6a5b5fe2c01dec23395d90b7d05a5ecf82c21a80475418447817d8e9010","title":"Run evidence test without WORLDAI_DEV_MODE for production claims","description":"Current evidence uses WORLDAI_DEV_MODE=true. If claim is about production behavior, this weakens the case. Need evidence run with production-like settings.","acceptance_criteria":"- Evidence bundle created with WORLDAI_DEV_MODE=false\\n- OR document what DEV_MODE enables and why it doesn't affect arc completion","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-24T17:02:51.805969-05:00","updated_at":"2025-12-24T17:02:51.805969-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-efg","depends_on_id":"worktree_worker3-2pc","type":"blocks","created_at":"2025-12-24T17:02:51.806501-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-f3z","content_hash":"5efc1ad1ffc58f0194d6029670d867886584fa10e4fa028431b7142683e02045","title":"Document prompt file changes during evidence run","description":"provenance_post.json shows mvp_site/prompts/game_state_instruction.md modified after the run, while clean in provenance_pre.json. Red flag for reproducibility. Need to explain why it changed (e.g., known auto-write step) with diff.","acceptance_criteria":"- Pre/post git diff of prompt files included in bundle\\n- Explanation documented for any changes\\n- OR run from clean repo state","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-24T17:02:51.209782-05:00","updated_at":"2025-12-24T17:02:51.209782-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-f3z","depends_on_id":"worktree_worker3-2pc","type":"blocks","created_at":"2025-12-24T17:02:51.210279-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-ft0","content_hash":"b122bd87073d27b0fcdada99c84f5124ef34a290dc4bed096fcedaca74f5508c","title":"Validate game state at tool execution time","description":"Risk of state desynchronization between Phase 1 (planning) and Phase 2 (execution). Game conditions like buffs/debuffs may change during the phase gap, making executed action invalid or exploitable.","acceptance_criteria":"- State validation occurs at execution time, not just planning\n- Detect state drift between phases\n- Reject execution if state materially changed","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-17T01:43:34.609453-08:00","updated_at":"2025-12-17T01:43:34.609453-08:00","source_repo":".","labels":["pr-2353","secondo-review","security"]}
{"id":"worktree_worker3-ftw","content_hash":"2367fb7697b0bf7c2b02155f58841b8c424b535dd77cbf24e5434c5fa17f0cd8","title":"Decide single-call strategy for Gemini 2.0 Flash","description":"Evaluate whether Gemini 2.0 Flash should use a single-call path (code_execution + JSON-like output without official schema) when no tool_calls are needed, to avoid the two-phase latency/cost. Define rules: when to allow single-call, what validation/reprompt to keep, and how to fall back to two-phase when tools/dice are required. Output a clear decision and implementation plan.","notes":"Scope: Decide if/when Gemini 2.0 Flash can run single-call (code_execution + JSON-like output, no official schema) to save latency/cost, and define fallback to two-phase when tools/dice are needed. Add guidelines for validation/reprompt.","status":"open","priority":2,"issue_type":"task","assignee":"code","created_at":"2025-12-17T02:41:51.386416-08:00","updated_at":"2025-12-17T02:41:58.983798-08:00","source_repo":".","labels":["architecture","gemini","performance","pr-2353"]}
{"id":"worktree_worker3-fxr","content_hash":"f00bd03ae2e5c844c7563b4934d1542b3d658643af2227ab2e7da8b0056f29a6","title":"Improve spell preparation UI/God Mode flow","description":"Player needed multiple God Mode exits to manage spell preparation. The flow between story mode and spell management was clunky. Consider: inline spell prep during level-up, clearer prepared spell display, less disruptive mode switching.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-31T21:37:43.217107-08:00","updated_at":"2025-12-31T21:37:43.217107-08:00","source_repo":".","labels":["god-mode","player-confusion","spells","ux"]}
{"id":"worktree_worker3-gv1","content_hash":"8b23a00e324c799de546e1d8455649db91d1673f9bbe878dc71554332d10047e","title":"Add timeout handling for two-phase tool calling","description":"Second opinion analysis identified risk of hung states in two-phase tool calling architecture. If coordinator fails between phases, clients may hang indefinitely.","acceptance_criteria":"- Transaction timeouts implemented for tool_requests phase\n- Idempotent rollback logic on timeout\n- Persistent transaction logs for recovery","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-17T01:43:33.834263-08:00","updated_at":"2025-12-17T01:43:33.834263-08:00","source_repo":".","labels":["pr-2353","secondo-review","security"]}
{"id":"worktree_worker3-hiq","content_hash":"d9e9ce7bc26f23ebbb16eabe6c0f35fbcd04a8a41f5c50a858249453f3651546","title":"Write E2E tests for JSON-first tool_requests flow (PR #2353)","description":"Add comprehensive E2E tests for the new generate_content_with_tool_requests() function in Cerebras and OpenRouter providers. Current tests mock the function itself rather than testing internal logic.","design":"Add tests to test_code_execution_dice_rolls.py:\n1. Path 1: No tool_requests in response - returns Phase 1 directly\n2. Path 2: tool_requests present - executes tools, Phase 2 call\n3. Path 3: Invalid JSON response - returns as-is\n4. Path 4: Tool execution errors - captured in results\n5. execute_tool_requests() helper tests\n\nMock external API (requests.post) with side_effect for sequential responses.\nDO NOT mock generate_content_with_tool_requests() - test internal logic.","acceptance_criteria":"- Tests added to test_code_execution_dice_rolls.py\n- Covers all 5 code paths in generate_content_with_tool_requests()\n- Uses side_effect for Phase 1 / Phase 2 mock responses\n- All tests pass: TESTING=true python3 -m pytest\n- Pushed to PR #2353","status":"closed","priority":2,"issue_type":"task","assignee":"claude","created_at":"2025-12-12T22:56:36.068789-05:00","updated_at":"2025-12-12T23:03:50.227133-05:00","closed_at":"2025-12-12T23:03:50.227133-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-hiq","depends_on_id":"worktree_worker3-cwm","type":"blocks","created_at":"2025-12-12T22:56:42.66083-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-i81","content_hash":"d28eeb1386789ff65175d3d8fb330d22cb92251d648d6d2c51bc25af3d9a1309","title":"Correct engine response example fields in prompt","description":"Prompt example uses critical/fumble fields but engine returns is_critical/is_fumble; could mislead model output expectations.","acceptance_criteria":"- Update game_engine_instruction.md response example to match DiceResult.to_dict() keys\n- Verify other examples align with protocol output schema","status":"closed","priority":3,"issue_type":"bug","created_at":"2025-12-18T22:05:49.940053-08:00","updated_at":"2025-12-25T14:12:17.069002-05:00","closed_at":"2025-12-25T14:12:17.069002-05:00","source_repo":"."}
{"id":"worktree_worker3-if1","content_hash":"c3dc771909900553730bf6b72b857f4fb32d1b20fe6c8df926c9dc5375bfa4b4","title":"Fix planning_block schema vs prompt mismatch (Phase 1 choices empty)","description":"`mvp_site/llm_providers/provider_utils.py`'s `NARRATIVE_RESPONSE_SCHEMA` sets `planning_block.choices.minProperties = 1`, but `mvp_site/prompts/game_state_instruction.md` Phase-1 combat example shows `\"choices\": {}` while awaiting dice. If any provider/model enforces the JSON schema, Phase 1 responses (or examples) can be invalid.\n\nDecide on one:\n- Relax schema to allow empty choices in Phase-1 (e.g., `minProperties` removed or conditional), OR\n- Update prompt/examples to always include at least one placeholder choice even in Phase-1, OR\n- Split schema by phase / add `awaiting_dice` flag and conditionally validate.\n","acceptance_criteria":"- Prompt examples and enforced JSON schema are consistent.\n- Phase-1 'awaiting dice' responses validate under the chosen schema.\n- Add/adjust a unit test to catch regression for empty choices in Phase 1.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T19:01:56.013568-08:00","updated_at":"2025-12-18T19:13:04.270236-08:00","closed_at":"2025-12-18T19:13:04.270236-08:00","source_repo":"."}
{"id":"worktree_worker3-j1d","content_hash":"10bbc1a4a84d815269632e81e2dfac512a1bf9ba745bebc0f8e41a3287fc1cb1","title":"E2E Evidence: Add SHA256 for all evidence files","description":"Currently only combat_agent_e2e_test.json is hashed. raw_mcp_responses.jsonl has no hash/signature, making it not tamper-evident.\n\nFix: Generate SHA256 for all evidence files in the bundle:\n- combat_agent_e2e_test.json ✓ (already done)\n- raw_mcp_responses.jsonl (missing)\n- app.log (if included)\n- provenance.json (if included)","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-26T15:28:37.582223-05:00","updated_at":"2025-12-26T15:32:55.642955-05:00","closed_at":"2025-12-26T15:32:55.642955-05:00","source_repo":".","labels":["evidence","security","testing"]}
{"id":"worktree_worker3-jp2","content_hash":"1d18c4fbf0dfdbbbabf156ad35104c3b6751bcc764e5ac4344aea16f969c6f41","title":"Gemini provider JSON-first alignment and cleanup","description":"Fix Gemini 2.x provider to align with JSON-first tool_requests flow and address review items:\n- Switch generate_content_with_tool_loop to JSON-first schema call (tools=None) + tool_requests execution + second JSON call; ensure Phase 2 passes built history as contents.\n- Handle tool messages properly; remove system_instruction types.Part misuse (pass string); add defensive tool validation; move inline imports (execute_dice_tool, json) to module scope.\n- Update docstrings to reflect two-phase behavior; remove sys.path hacks/new test file policy violations by relocating tests to existing files; clean unused imports/vars in Gemini tests.\n- Replace regex salvage in json_utils only if Gemini path can still emit malformed JSON (coordinate with planning_block task).\nTests: add/adjust Gemini E2E to cover non-dice turn schema compliance and history passing.\n","notes":"## Analysis by c2 (2025-12-14)\n\n**Items Already Addressed:**\n1. ✅ JSON-first tool_requests flow - `generate_content_with_tool_requests()` (lines 288-392)\n2. ✅ system_instruction passes string directly (line 124)\n3. ✅ Defensive tool validation in `execute_tool_requests()` (lines 206-228)\n4. ✅ Module-scope imports (json line 9, execute_dice_tool line 17)\n5. ✅ Two-phase docstrings (lines 296-314)\n6. ✅ Bracket-aware parsing in json_utils for malformed JSON safety net\n\n**Systemic Issues (Not Gemini-specific):**\n- sys.path hacks: Present in 133 test files codebase-wide\n- Test relocation would require larger refactoring effort\n\n**Recommendation:** Close jp2 as substantially complete. sys.path cleanup is a separate codebase-wide refactoring task.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-13T20:04:51.976245-05:00","updated_at":"2025-12-14T16:35:14.567079-08:00","closed_at":"2025-12-14T16:35:14.567079-08:00","source_repo":"."}
{"id":"worktree_worker3-m5p","content_hash":"c50faeb8431ca018cc8b966b21e7036394cc76d00bc760a60cff47eab8d7ba9e","title":"Schema bypass from Phase-2 skip optimization","description":"Commit 0c915737c skips Phase 2 whenever Phase 1 JSON parses, without any schema/required-field validation. This lets syntactically-valid but incomplete responses (missing planning_block, session_header, dice results, etc.) reach clients, reintroducing missing-field regressions. Restore validation: require schema/required fields before skipping; otherwise fall back to Phase 2.","status":"closed","priority":1,"issue_type":"bug","assignee":"code","created_at":"2025-12-17T20:26:48.865763-08:00","updated_at":"2025-12-17T20:32:26.828398-08:00","closed_at":"2025-12-17T20:32:26.828398-08:00","source_repo":".","labels":["p0","pr-2353","schema","validation"]}
{"id":"worktree_worker3-mpe","content_hash":"30253966063c531e4895af7f7a91581faa0e3762280327ffc0887db67eacdaef","title":"PR2353: Align tool_requests schema enum with implemented dice tools","description":"`mvp_site/llm_providers/provider_utils.py` NARRATIVE_RESPONSE_SCHEMA.tool_requests.tool.enum currently lists 4 tools, but `mvp_site/game_state.py` implements an additional tool `declare_no_roll_needed`.\n\nGoal: update schema enum (and any related docs/tests) so schema matches implementation and models can use declare_no_roll_needed without schema mismatch.\n\nPR: #2353","notes":"Assigned to CodevSchema. Status check: agent has urgent ACK/registration requests pending; no findings delivered yet.","status":"closed","priority":1,"issue_type":"task","assignee":"CodevSchema","created_at":"2025-12-18T20:47:20.575372-08:00","updated_at":"2025-12-18T21:07:54.819373-08:00","closed_at":"2025-12-18T21:07:54.819373-08:00","source_repo":"."}
{"id":"worktree_worker3-mvz","content_hash":"4c28ec683badaf7fda6b4a485f34af8066e9a1d96808ca625dc959608e29a05b","title":"Telegraph consequences for risky magic rituals","description":"Obsidian map ritual was catastrophic; player seemed surprised by severity of the backlash. When player attempts risky arcane actions, consider: warning about potential consequences, showing DC and stakes before commit, offering alternative safer approaches.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-31T21:37:44.453739-08:00","updated_at":"2025-12-31T21:37:44.453739-08:00","source_repo":".","labels":["consequences","magic","player-expectation","ux"]}
{"id":"worktree_worker3-n9h","content_hash":"970e9c63454cb0f62bffdea682fe548623863c63c55f101c9022bcc91c15aeb4","title":"Add resource exhaustion warnings","description":"Player used Divine Smite early, leaving no healing for later emergencies. Multiple near-death moments from aggressive positioning without resource awareness. Consider: low-resource warnings, \"you have X spell slots remaining\" after use, HP threshold alerts.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-31T21:37:45.055145-08:00","updated_at":"2025-12-31T21:37:45.055145-08:00","source_repo":".","labels":["combat","player-awareness","resources","ux"]}
{"id":"worktree_worker3-np8","content_hash":"e8a3b2c90e8f6fd780af685a5654046478519b0b835aceacedb88eae7dfcfd7b","title":"Unified Two-Phase Dice Architecture - Revert to Tool Loops","description":"Revert pre-computed dice approach back to LLM-driven tool loops. All providers use two-phase inference where LLM decides what dice to roll, server executes, LLM narrates result.\n\nKey insight: Gemini can use function calling, just not WITH JSON mode simultaneously. Solution: Phase 1 with tools (no JSON), Phase 2 with JSON (no tools).\n\nRoadmap: roadmap/unified_two_phase_dice_architecture.md","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-11T10:17:58.910614-05:00","updated_at":"2025-12-13T14:06:09.290726-05:00","closed_at":"2025-12-13T14:06:09.290726-05:00","source_repo":".","labels":["architecture","dice","pr-2353","tool-loops"]}
{"id":"worktree_worker3-pwm","content_hash":"8fc3db22f5eacbbf2dfc3b2c240913f48d12a8629d141a50d7dc7b3388b4e95d","title":"Ensure engine-processed narrative is used when structured_response exists","description":"When mechanics is enabled, narrative_text is rewritten with engine results but LLMResponse is created from structured_response without passing the updated narrative, so engine output is dropped.","acceptance_criteria":"- When engine processing occurs, pass updated narrative_text into LLMResponse.create_from_structured_response (initial_story + continue_story)\n- Add/adjust tests to cover structured_response path with engine blocks\n- Verify narrative returned to caller includes engine replacements","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-18T22:05:38.294916-08:00","updated_at":"2025-12-18T22:05:38.294916-08:00","source_repo":"."}
{"id":"worktree_worker3-qsu","content_hash":"b2e2dcde0887268db9adac91424a41f9cdba1919f53dc6f419f919fc0d09667c","title":"Document arc_milestones timestamp design (ISO vs in-game time)","description":"Arc milestone timestamps use real-world ISO times (2025-12-24) while world_time is 1492-DR. Need to confirm this is by design and document in PR to avoid \"timestamp mismatch\" confusion.","acceptance_criteria":"- Design decision documented: arc completion uses real-world timestamps, world_time uses in-game time\\n- Added to PR description or code comments","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-24T17:02:52.371131-05:00","updated_at":"2025-12-24T17:02:52.371131-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-qsu","depends_on_id":"worktree_worker3-2pc","type":"blocks","created_at":"2025-12-24T17:02:52.371663-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-rnh","content_hash":"3091ed3093fcee6eb19f5dc312b606e8cfed2c6b5554514cb8e9ed9c742c338e","title":"Align llm_integration formatter with actual engine response keys","description":"format_result_for_narrative expects damage_dealt/initiative_order/death_save_result, but engine returns damage/order/successes+failures. This can lead to missing or misleading inline output.","acceptance_criteria":"- Update formatter to handle current response schema (damage, order, death save fields)\n- Add tests for formatted output for attack, damage, initiative, death save\n- Remove or support legacy keys if needed","status":"closed","priority":2,"issue_type":"bug","assignee":"c3","created_at":"2025-12-18T22:05:44.880332-08:00","updated_at":"2025-12-18T22:24:51.658331-08:00","closed_at":"2025-12-18T22:24:51.658331-08:00","source_repo":"."}
{"id":"worktree_worker3-sn2","content_hash":"72fbe03db9f8802c2cdaece718a871328c3b5f9580fa4e6de3706074529c9118","title":"BUG: clock_skew_credentials.py blocks test collection on import","description":"**Problem:**\n`world_logic.py` imports `clock_skew_credentials` and calls `apply_clock_skew_patch()` at module level (line 35). This triggers `validate_deployment_config()` which raises `ValueError` if `WORLDAI_GOOGLE_APPLICATION_CREDENTIALS` is set without `WORLDAI_DEV_MODE=true`.\n\n**Impact:**\n- Test collection fails for any test that imports `world_logic`\n- CI \"passes\" because CI doesn't have the env var - tests never run\n- Local devs with service account keys cannot run tests without setting extra env vars\n\n**Files Affected:**\n- `mvp_site/clock_skew_credentials.py:40-44` - The raising code\n- `mvp_site/world_logic.py:35` - Module-level call to `apply_clock_skew_patch()`\n- `mvp_site/tests/test_game_state.py:88` - Import fails here\n\n**Root Cause:**\nValidation logic runs at import time, not runtime. This is a design flaw - module imports should NEVER raise based on env vars.\n\n**Fix Required:**\n1. Make `validate_deployment_config()` return status, not raise\n2. OR defer validation until actual Firebase operation\n3. OR respect `TESTING=true` to skip validation entirely","acceptance_criteria":"- [ ] Tests can be collected without WORLDAI_DEV_MODE\n- [ ] TESTING=true bypasses clock skew validation\n- [ ] test_game_state.py runs in CI\n- [ ] Local devs can run tests with service account keys","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-11T06:01:18.00365-05:00","updated_at":"2025-12-11T06:03:03.560481-05:00","closed_at":"2025-12-11T06:03:03.560481-05:00","source_repo":".","labels":["bug","p0","testing"],"dependencies":[{"issue_id":"worktree_worker3-sn2","depends_on_id":"worktree_worker3-1hz","type":"related","created_at":"2025-12-11T06:01:23.566645-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-tey","content_hash":"a17032f8cf6b52845cb1a0362921f6da05e93d1c525e747999a041c879cfa0e9","title":"PR2353: Fix Cerebras/OpenRouter model lists + token tables (gpt-oss-120b etc.)","description":"Cursor flagged that `gpt-oss-120b` is documented/used in UI but missing or inconsistent across:\n- `mvp_site/constants.py` `ALLOWED_CEREBRAS_MODELS`\n- `MODEL_CONTEXT_WINDOW_TOKENS` and `MODEL_MAX_OUTPUT_TOKENS`\n- `mvp_site/templates/settings.html` options\n\nGoal: either remove invalid UI options OR add model consistently to allowed list + token tables. Ensure infer_provider/model selection behaves correctly and no silent fallback.\n\nPR: #2353","notes":"Assigned to CodevModels. Status check: agent has urgent ACK/registration requests pending; no findings delivered yet.","status":"closed","priority":1,"issue_type":"task","assignee":"CodevModels","created_at":"2025-12-18T20:47:20.430604-08:00","updated_at":"2025-12-18T21:07:54.229349-08:00","closed_at":"2025-12-18T21:07:54.229349-08:00","source_repo":"."}
{"id":"worktree_worker3-tj8","content_hash":"b4931eff2145a8ff17f850c7ff85ce17657d3a1bf792d6518132c548c04b23fc","title":"Highlight GWM risk/reward trade-off","description":"Player seemed unaware that Great Weapon Master's -5/+10 trade-off was optional. Multiple misses occurred because they always used GWM when a standard attack would have hit. Consider: tooltip on attack options, reminder when GWM causes a miss that would have hit otherwise.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-31T21:37:42.661967-08:00","updated_at":"2025-12-31T21:37:42.661967-08:00","source_repo":".","labels":["combat","feats","player-confusion","ux"]}
{"id":"worktree_worker3-tsh","content_hash":"af8066831d277d53df38f0b532d2e08c814dd8fbc0196e6312267c34e63289cd","title":"Capture raw JSON responses per action in evidence","description":"Current arc_completion_natural.json is synthesized report (script output). No raw process_action responses or debug payloads included. External reviewer can't independently verify \"no OOC/GOD_MODE\" or confirm structured JSON came directly from the model.","acceptance_criteria":"- Raw JSON response from each process_action saved\\n- Raw JSON from get_campaign_state saved\\n- Each response hashed individually\\n- Reviewer can verify no GOD_MODE commands in payloads","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T17:02:50.020656-05:00","updated_at":"2025-12-24T20:31:49.956308-05:00","closed_at":"2025-12-24T20:31:49.956308-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-tsh","depends_on_id":"worktree_worker3-2pc","type":"blocks","created_at":"2025-12-24T17:02:50.021219-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-tuh","content_hash":"e1393408a4ffff56a4df4317600aec4a5384bd0cd0da0bb9302280602583a538","title":"Persist state_updates/game_state/core_memories/world_events to Firestore story/game_states for long campaigns","description":"Persist full game state (including state_updates, game_state, core_memories, world_events) to Firestore every turn. Ensure we are not persisting a reduced subset. Persist both:\n- game_states/current_state (authoritative)\n- full structured state embedded in each story entry (traceability)\nThis should eliminate lost-plot-element errors when transcript truncates.","acceptance_criteria":"- On each turn, full structured game_state (incl. state_updates/core_memories/world_events) is persisted to game_states/current_state.\n- Each story entry includes the same full structured state (not just current structured_fields subset).\n- Verify in Firestore for a long campaign (\u003e=50 turns) that recent entries include these fields.\n- Regression test shows persisted state survives service restarts and later turns can read prior state.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-27T17:37:33.010561-05:00","updated_at":"2025-12-27T17:40:08.671169-05:00","closed_at":"2025-12-27T17:40:08.671169-05:00","source_repo":"."}
{"id":"worktree_worker3-xke","content_hash":"56ada47896328be9002b8ee33573423ed6a86cb26d1221c43e6ce4ac70b3f496","title":"Add social encounter E2E tests for Intimidation/Deception and wire into CI","description":"Extend social encounter real API tests to cover Intimidation and Deception roll_skill_check calls, and enable these tests in CI/nightly so regressions are caught automatically.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T02:47:53.396259-08:00","updated_at":"2025-12-17T21:31:39.837868-08:00","closed_at":"2025-12-17T21:31:39.837868-08:00","source_repo":"."}
{"id":"worktree_worker3-xzu","content_hash":"adb07521e2eec99b1b96373071bf4a9e3f4b7604ec353850a8419200c891293d","title":"Combat: Defeated enemies not removed from combatants dict","description":"After combat ends (in_combat: false), get_campaign_state shows enemies remaining in combatants dict with HP \u003e 0, even though they're listed in enemies_defeated.\n\nEvidence: /tmp/combat_xp_e2e_run_20251226173347_full/\n- combat_state.combatants still contains npc_goblin_002 (hp: 7), npc_goblin_003 (hp: 7)\n- combat_summary.enemies_defeated lists all 3 goblins\n\nServer-side cleanup should either:\n1. Set hp_current: 0 for defeated enemies, OR\n2. Remove defeated enemies from combatants dict\n\nCurrently neither happens, causing state inconsistency.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-26T15:28:37.030105-05:00","updated_at":"2025-12-26T15:42:44.907403-05:00","closed_at":"2025-12-26T15:42:44.907403-05:00","source_repo":".","labels":["cleanup","combat","pr-2553","state-management"]}
{"id":"worktree_worker3-z74","content_hash":"fbdd4ec929ddb67afce3ebbe39859b67b0006eec177182e531d6720560fdbe5a","title":"Fix combat prompt schema to stay name-keyed (remove id-based initiative guidance)","description":"User does NOT want combat state migration. New combat prompt docs currently show initiative_order entries with `id` and note that ids must match combatants keys. Backend expects name-keyed combatants and matches initiative entries by `name`, dropping ids during normalization. This mismatch can leave defeated enemies stuck in initiative_order and break cleanup. Update prompt examples/notes to use name keys only and clarify that initiative_order[].name must match combatants dict keys. Files: mvp_site/prompts/combat_system_instruction.md, mvp_site/prompts/game_state_instruction.md.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-24T10:51:15.216297-05:00","updated_at":"2025-12-24T16:58:17.373368-05:00","closed_at":"2025-12-24T16:58:17.373368-05:00","source_repo":"."}
{"id":"worktree_worker3-zpb","content_hash":"d2e81c7f68836805ec98255703a50bf35d85f1f33acc091a5d52a1ae149caf93","title":"RewardsAgent: Process XP/level-ups for non-combat encounters","description":"## Problem\n\nCombatAgent only triggers when `combat_state.in_combat = true`, but many narrative encounters deserve XP rewards:\n- Successful heists/thievery\n- Social manipulation victories (Persuasion/Deception rolls)\n- Completing story objectives\n- Defeating enemies through non-combat means (soul harvesting, poison, traps)\n- Escaping dangerous situations\n\nCurrently, users must manually request XP in \"God Mode\" for these achievements.\n\n**Additionally**, combat rewards sometimes don't trigger even when combat ends properly.\n\n## Evidence\n\n**Campaign: Nocturne bg3 after**\n- Player stole from noble Horgus, framed another person, escaped\n- Had to manually request: \"give it to me and a bunch of exp for the narrative events\"\n- Then manually request: \"process my level up\"\n\n**Campaign: Sariel killer**\n- Combat ended but rewards didn't process (investigating)\n\n## Goal: Unified Rewards Processing\n\n**Share code between CombatAgent and RewardsAgent:**\n1. RewardsAgent handles ALL reward processing (combat + non-combat)\n2. CombatAgent triggers RewardsAgent at combat end\n3. Single code path for XP, loot, level-up processing\n4. Consistent archival pattern for both combat_history and encounter_history\n\n## Implementation Pattern\n\n```python\nclass RewardsAgent(BaseAgent):\n    \"\"\"Triggers when rewards are pending from any source\"\"\"\n    \n    @classmethod\n    def matches_game_state(cls, game_state):\n        # Check for pending rewards (combat or encounter)\n        if game_state.get_rewards_pending():\n            return True\n        # Check for completed combat needing reward processing\n        combat_state = game_state.get_combat_state()\n        if (combat_state.get(\"combat_phase\") == \"ended\" \n            and combat_state.get(\"combat_summary\")):\n            return True\n        # Check for completed encounters\n        encounter_state = game_state.get_encounter_state()\n        return encounter_state.get(\"encounter_completed\", False)\n```\n\n## Acceptance Criteria\n\n- [ ] RewardsAgent processes combat end rewards (shared with CombatAgent)\n- [ ] Non-combat encounters automatically process XP when completed\n- [ ] Level-ups are offered when XP threshold reached\n- [ ] Single code path for all reward processing\n- [ ] encounter_history and combat_history use same archival pattern","design":"## Design: RewardsAgent (Unified Rewards Processing)\n\n### Core Goal\n**Share code with CombatAgent** - RewardsAgent should handle ALL reward processing, including combat end rewards. CombatAgent triggers RewardsAgent at combat end rather than processing rewards itself.\n\n### Architecture Options\n\n**Option A: RewardsAgent triggers at combat end**\n```\nCombatAgent (combat_phase: active) → combat ends → RewardsAgent activates\n                                                    ↓\n                                            Process XP, loot, level-up\n```\n\n**Option B: Shared RewardsProcessor utility**\n```\nCombatAgent ──────┐\n                  ├──→ RewardsProcessor.process_rewards()\nRewardsAgent ─────┘\n```\n\n### Trigger Mechanism\nLike CombatAgent checks `in_combat`, RewardsAgent checks for pending rewards:\n\n1. **Combat end**: `combat_phase == \"ended\"` AND `combat_summary.xp_awarded`\n2. **Encounter end**: `encounter_state.encounter_completed == true`\n3. **Milestone**: `rewards_pending` exists in game_state\n\n### Agent Selection Priority\n1. GodModeAgent (explicit override)\n2. CombatAgent (in_combat = true, combat_phase = active)\n3. **RewardsAgent** (rewards pending from combat OR encounter) ← NEW\n4. StoryModeAgent (default)\n\n### State Schema\n\n```python\n# Unified rewards_pending (used by both combat and non-combat)\nrewards_pending: {\n    \"source\": \"combat\" | \"encounter\" | \"quest\" | \"milestone\",\n    \"source_id\": str,  # combat_session_id or encounter_id\n    \"xp\": int,\n    \"gold\": int,\n    \"items\": [...],\n    \"level_up_available\": bool\n}\n\n# encounter_state (new, mirrors combat_state pattern)\nencounter_state: {\n    \"encounter_active\": bool,\n    \"encounter_id\": str,\n    \"encounter_type\": \"heist\" | \"social\" | \"stealth\" | \"puzzle\" | \"quest\",\n    \"difficulty\": \"easy\" | \"medium\" | \"hard\" | \"deadly\",\n    \"participants\": [...],\n    \"encounter_completed\": bool,\n    \"encounter_summary\": {...}  # Like combat_summary\n}\n```\n\n### Prompt Focus\n- XP calculation rules (CR-to-XP for defeated, milestone XP for objectives)\n- Level-up processing and spell/feature selection\n- Loot distribution\n- State cleanup after rewards processed\n\n### Archival Pattern (Same as Combat)\nAt next action START in `_prepare_game_state()`:\n1. Check if `rewards_pending` exists\n2. Archive to `rewards_history[]`\n3. Clear `rewards_pending`\n4. Process level-up if threshold reached","acceptance_criteria":"- Non-combat encounters automatically process XP when completed\n- Level-ups are offered when XP threshold reached  \n- Works alongside CombatAgent (combat still uses existing flow)\n- Narrative kill/defeat triggers reward processing\n- encounter_history archives completed encounters","notes":"## Investigation: Sariel Killer Campaign\n\n### What Happened\nCombat with 3 \"Ghost\" operators:\n- Multiple attack rolls: `1d20+8 = 11, 11, 12, 23, 22, 26, 22` (hits and misses)\n- Damage rolls: `17, 15, 7` damage dealt\n- Result: \"three ghosts neutralized, zero casualties\"\n- Player continued to interrogate wounded guard\n\n### What's Missing\n- **NO `in_combat = true`** was ever set\n- **NO initiative order** tracked\n- **NO combat_summary** generated\n- **NO XP awarded** for defeating 3 elite operators\n- **NO level-up check** triggered\n\n### Root Cause\nThe LLM handled combat narratively (rolling dice, describing attacks) but never entered the formal combat system. This happens when:\n1. Combat starts as a \"surprise\" or \"ambush\" scenario\n2. The LLM treats it as an action sequence rather than formal combat\n3. There's no trigger to set `in_combat = true`\n\n### Implications for RewardsAgent\n\nRewardsAgent should detect \"narrative combat\" by looking for:\n1. **Attack roll patterns**: Multiple `1d20+X vs AC` rolls in recent turns\n2. **Damage rolls**: `XdY + Z` damage dealt\n3. **Defeat language**: \"neutralized\", \"eliminated\", \"killed\", \"defeated\"\n4. **Enemy count**: NPCs that were combatants are now dead/incapacitated\n\nThis is separate from formal combat but still deserves XP rewards.\n\n### Proposed Detection Logic\n\n```python\ndef detect_narrative_combat_completion(game_state, recent_turns):\n    \"\"\"Detect informal combat that should trigger rewards.\"\"\"\n    indicators = {\n        \"attack_rolls\": count_attack_rolls(recent_turns),\n        \"damage_dealt\": sum_damage_rolls(recent_turns),\n        \"enemies_defeated\": extract_defeated_enemies(recent_turns),\n        \"combat_keywords\": has_combat_completion_keywords(recent_turns)\n    }\n    \n    if (indicators[\"attack_rolls\"] \u003e= 3 \n        and indicators[\"enemies_defeated\"] \n        and indicators[\"combat_keywords\"]):\n        return True\n    return False\n```","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-26T22:44:08.372316-05:00","updated_at":"2025-12-26T22:49:03.865996-05:00","source_repo":".","labels":["agent","non-combat","rewards","xp"]}
{"id":"worktree_worker4-0gb","content_hash":"f3d5d71e858c6cd7465f6ee45dae4997b747875077a442dbc7c0bbc61167780d","title":"Hash and include full server.log in evidence bundle","description":"Current evidence uses llm_http_log_excerpt.txt (rg grep of server.log). The full server.log is not hashed or signed, so evidence is not tamper-evident. External validator can't rule out edits.","acceptance_criteria":"- Full server.log included in bundle\\n- SHA256 hash of server.log in bundle\\n- Hash verifiable by external validator","status":"closed","priority":1,"issue_type":"task","assignee":"genesis","created_at":"2025-12-24T17:02:49.339974-05:00","updated_at":"2025-12-24T20:31:49.481298-05:00","closed_at":"2025-12-24T20:31:49.481298-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker4-0gb","depends_on_id":"worktree_worker4-2pc","type":"blocks","created_at":"2025-12-24T17:02:49.341022-05:00","created_by":"daemon"}]}
{"id":"worktree_worker4-0go","content_hash":"1180fb0cc6055aaa22a45cadd46f1191a5aec28a98ffd0626e046452da5b42ac","title":"Delete pre-computed dice logic","description":"Remove the pre-computed dice code that never fully worked:\n- detect_action_type() from game_state.py\n- compute_combat_results() and helpers from game_state.py\n- Pattern constants (ATTACK_PATTERNS, etc.)\n- Pre-computed injection from llm_service.py\n- pre_computed_results instructions from prompts\n- test_precomputed_dice.py test file","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T10:18:18.366942-05:00","updated_at":"2025-12-13T14:06:08.091765-05:00","closed_at":"2025-12-13T14:06:08.091765-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker4-0go","depends_on_id":"worktree_worker4-np8","type":"blocks","created_at":"2025-12-11T10:18:18.367466-05:00","created_by":"daemon"},{"issue_id":"worktree_worker4-0go","depends_on_id":"worktree_worker4-bkl","type":"blocks","created_at":"2025-12-11T10:18:29.255255-05:00","created_by":"daemon"}]}
{"id":"worktree_worker4-0ix","content_hash":"680d8c0527128c1b4782c4dc2527c678a282b41cc37e012015e742db8939468d","title":"Delete old tools-first flow (generate_content_with_tool_loop, process_tool_calls)","description":"**Context:** PR #2353 implemented a new JSON-first tool_requests architecture:\n- `generate_content_with_tool_requests()` in cerebras_provider.py:490-573 and openrouter_provider.py:362-445\n- First call is JSON mode (no tools), model uses `tool_requests` array field to request dice rolls\n- Only do second call if `tool_requests` present\n\n**Problem:** The OLD tools-first flow still exists and causes confusion:\n- `generate_content_with_tool_loop()` - sends tools param in first call, returns raw non-JSON if no tool_calls\n- `process_tool_calls()` - used by old flow, different signature than new `execute_tool_requests()`\n\n**Code to DELETE:**\n\n**cerebras_provider.py:**\n- `process_tool_calls()` at line 270-312 (~42 lines)\n- `generate_content_with_tool_loop()` at line 315-456 (~141 lines)\n\n**openrouter_provider.py:**\n- `process_tool_calls()` at line 163-205 (~42 lines)\n- `generate_content_with_tool_loop()` at line 208-328 (~120 lines)\n\n**gemini_provider.py:**\n- `process_tool_calls()` at line 188-220 (~32 lines)\n- `generate_content_with_tool_loop()` at line 223-307 (~84 lines)\n- NOTE: Gemini 2.x still needs tool loop (tools + JSON mode conflict), may need to keep or refactor\n\n**llm_service.py:**\n- Remove any routing to `generate_content_with_tool_loop()` for Cerebras/OpenRouter\n- Keep `generate_content_with_tool_requests()` routing\n\n**Tests to update:**\n- `test_code_execution_dice_rolls.py` - remove tests for old flow\n- `test_gemini_tool_loop_e2e.py` - keep if Gemini still needs tool loop\n\n**Estimated deletion:** ~400-500 lines of dead code\n\n**KEEP:**\n- `execute_tool_requests()` - new JSON-first helper\n- `generate_content_with_tool_requests()` - new JSON-first entry point\n- Gemini tool loop if still needed for 2.x compatibility","status":"closed","priority":2,"issue_type":"task","assignee":"code","created_at":"2025-12-13T14:21:29.080199-05:00","updated_at":"2025-12-13T14:43:19.350483-05:00","closed_at":"2025-12-13T14:43:19.350483-05:00","source_repo":".","labels":["cleanup","dead-code","pr-2353","tool-loops"]}
{"id":"worktree_worker4-0ju","content_hash":"681af2c0f627a55696282f3a211821bae4351c327caaff3904cf3a02c338970d","title":"Clarify SRD licensing/attribution and data source provenance","description":"Ensure LICENSE-5E-SRD.md and SRD data attribution reflect actual source(s) of JSON files and required notices.","acceptance_criteria":"- Identify the exact SRD data source (WotC SRD 5.1 vs other dataset)\n- Update LICENSE-5E-SRD.md with any additional required notices/credits\n- Confirm compliance guidance in README or a dedicated licensing note if needed","status":"closed","priority":4,"issue_type":"chore","created_at":"2025-12-18T22:05:55.398287-08:00","updated_at":"2025-12-18T22:25:56.764049-08:00","closed_at":"2025-12-18T22:25:56.764049-08:00","source_repo":"."}
{"id":"worktree_worker4-1fk","content_hash":"88de2baf08ef72cb476a0a96ae1921257d2b6313530c0900f50413c0e3e0b2be","title":"Capture full system instruction per action (not just post-completion)","description":"system_instruction_excerpt_natural.txt is truncated (starts mid-word) and only captured after completion. Doesn't prove enforcement was active during key actions. Need full system instruction captured per action.","acceptance_criteria":"- Full system instruction captured per action (not just excerpt)\\n- Captured BEFORE completion occurs, not after\\n- Enforcement block visible in captured instruction\\n- Timestamped to correlate with action","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T17:02:50.597019-05:00","updated_at":"2025-12-24T20:31:50.440148-05:00","closed_at":"2025-12-24T20:31:50.440148-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker4-1fk","depends_on_id":"worktree_worker4-2pc","type":"blocks","created_at":"2025-12-24T17:02:50.597653-05:00","created_by":"daemon"}]}
{"id":"worktree_worker4-1hz","content_hash":"ecb086ffa3000caf6c4934402836b6a5ea93c5eb4654b74d2ab0855176ab43be","title":"POLICY: No Silent Test Skipping - Tests Must Run or Mock","description":"**CRITICAL TESTING POLICY**\n\nTests must NEVER silently skip or short-circuit based on environment variables or missing dependencies. Every test must either:\n\n1. **RUN** - Execute with real or mocked dependencies\n2. **FAIL LOUDLY** - Raise clear assertion error if prerequisites missing\n3. **MOCK** - Use mock objects when real services unavailable\n\n**FORBIDDEN PATTERNS:**\n- `if not os.getenv(\"X\"): return` (silent skip)\n- Module-level imports that raise on missing env vars (blocks test collection)\n- `@unittest.skipIf/skipUnless` without CI-compatible fallback\n- Tests that pass trivially when env var is unset\n\n**REQUIRED PATTERNS:**\n- `TESTING=true` should enable mock mode for all external services\n- Test collection must NEVER fail due to env vars\n- All tests must run in CI without special env vars beyond TESTING=true\n\n**Why This Matters:**\n- CI passes falsely when tests are skipped\n- Bugs slip through because code paths never execute\n- Developers think tests pass when they actually didn't run","status":"closed","priority":1,"issue_type":"chore","created_at":"2025-12-11T06:01:03.763015-05:00","updated_at":"2025-12-13T17:16:01.705337-05:00","closed_at":"2025-12-13T17:16:01.705337-05:00","source_repo":".","labels":["ci","policy","testing"]}
{"id":"worktree_worker4-1sw","content_hash":"c12e6a06a3c2a711079f685d7c67c0cdb069fa2bfb5d24fc470ad7a815176c3c","title":"Delete unused game_state.py helpers and stray doc stub","description":"Per codex msg #116/117 - remove dead code:\n\n**game_state.py unused helpers:**\n- calculate_initiative (no callers/tests)\n- calculate_complication_chance / check_complication_triggers (no callers/tests)\n- calculate_death_save (no callers/tests)\n- calculate_hp_for_class (no callers/tests)\n\n**Stray doc stub:**\n- testing_llm/test_ai_development_workflow.md has calculate_damage stub - archive/delete\n\nKeeping: calculate_resource_depletion (exercised by tests)","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-13T15:10:54.027413-05:00","updated_at":"2025-12-13T15:12:34.009573-05:00","closed_at":"2025-12-13T15:12:34.009573-05:00","source_repo":".","labels":["cleanup","dead-code"]}
{"id":"worktree_worker4-21f","content_hash":"834a51ac419663e65f638236a16792f34b62f36ff2716e17012331f5e4923837","title":"Cerebras tool-loop responses missing headers/planning block (malformed JSON)","description":"Context: After PR #2353, Cerebras models (e.g., zai-glm-4.6) sometimes return malformed/incomplete JSON; parser recovers only some fields, so session_header and planning_block go missing. Planning-block fallback was removed, so missing headers/blocks surface.\n\nUpdated requirements (per latest direction):\n- First inference call should mirror origin/main: plain JSON mode, with schema expectations (session_header, planning_block, etc.) and only optional tools available. The model should produce the full schema in the first call unless it explicitly needs tools.\n- Only perform a second call if the model returns tool_calls; then execute tools and send results in a follow-up JSON-mode call (tools disabled).\n- Do not rely on regex salvage for planning_block; rely on the schema. If the first/second response is missing session_header/planning_block, reprompt once with a short \"add missing fields\" request or inject a minimal default.\n- Make planning_block/session_header schema compliance primary; salvage is last resort.\n\nArtifacts: flask-server.log 2025-12-12 11:30:46–51 for campaign VqqJLpABua9bvAG4ArTg, provider cerebras/model zai-glm-4.6.\n\nRequested work:\n1) Adjust Cerebras (and other providers if needed) to a tool-on-demand flow (first call JSON sans tools; tools only if requested), aligning with origin/main behavior.\n2) Add a one-time reprompt/default insertion when session_header/planning_block is missing after the final response.\n3) Replace regex-based planning_block extraction with a robust/bracket-aware method if salvage is still kept as a last resort.\n","notes":"Add mitigations: when Cerebras tool-loop responses are malformed and missing session_header/planning_block, reprompt or inject a minimal default instead of accepting partial JSON. Capture raw response for debugging. Restart server after constants changes to ensure tool-loop path is used.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-12T11:59:12.909638-05:00","updated_at":"2025-12-13T14:06:03.95099-05:00","closed_at":"2025-12-13T14:06:03.95099-05:00","source_repo":"."}
{"id":"worktree_worker4-242","content_hash":"cd87892e33242f015fc6b8a96f368d354826d72209c1c6d4db54e9568d65e2a1","title":"Avoid reroll risk when Phase 2 JSON invalid after tool execution","description":"In the JSON-first tool_requests flow, we execute tools and then ask for Phase 2 JSON with injected tool results. If Phase 2 comes back malformed JSON, llm_service's generic reprompt path can trigger a new provider call without reusing the original tool results, risking duplicate rolls or inconsistent narration.\n\nCurrent mitigation: provider_utils now retries Phase 2 when dice_rolls missing, but there's no dedicated retry for 'Phase 2 invalid JSON' that preserves the same tool results.\n\nGoal: If tools were executed and Phase 2 is invalid JSON, retry Phase 2 with the same tool_results_prompt/history (not a fresh tool execution), and ensure downstream reprompts do not cause rerolls.","acceptance_criteria":"- When tool_requests were executed and Phase 2 response is invalid JSON, the system retries Phase 2 using the same tool results/history.\n- No duplicate tool execution occurs due to parsing/validation reprompts.\n- Add a unit test simulating: Phase 1 -\u003e tool_requests executed -\u003e Phase 2 invalid JSON -\u003e retry -\u003e valid JSON.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-18T19:02:10.481039-08:00","updated_at":"2025-12-18T20:05:04.6502-08:00","closed_at":"2025-12-18T20:05:04.6502-08:00","source_repo":"."}
{"id":"worktree_worker4-2ar","content_hash":"da4e136148b96debf310172545d30b50823e5aea7e0db097704ec3d0e1f2382b","title":"Time monotonicity validation uses mutated reference, fails to detect backward time","description":"Observed in new validation flow added to process_action_unified, GOD_MODE_SET, and GOD_MODE_UPDATE_STATE. Code captures `original_world_time` as a reference to `current_game_state.to_dict()['world_data']['world_time']` then passes the same dict into `update_state_with_changes`, which mutates it in place. As a result `original_world_time` is mutated to the new time before `validate_game_state_updates` runs, so comparisons see identical values and backward time regressions are never flagged. This leaves the temporal regression defect unfixed despite added validation.\n\nRisk: High — timeline regressions still silently persist; user-facing stories can move time backwards without warning. Affects all API paths updated in this PR.\n\nSuggested fix:\n- Deep copy world_time (or full world_data) before merging changes so `original_world_time` remains the pre-update snapshot.\n- Add regression test that simulates world_time moving backwards and asserts a warning/flag is produced.\n\nFiles/lines: mvp_site/world_logic.py:896-912, 1801-1820, 1872-1892.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-16T20:39:06.795703-08:00","updated_at":"2025-12-16T20:43:19.412408-08:00","closed_at":"2025-12-16T20:43:19.412408-08:00","source_repo":"."}
{"id":"worktree_worker4-2pc","content_hash":"d3fcdc2e04450d03993973a76e6e261a6995b9e8ed0f75267f838201c5ffee68","title":"Harden arc_milestones evidence bundle for external validation","description":"The v15 evidence bundle has gaps identified in skeptical review that prevent it from being airtight for external validation. This epic tracks the work to address all gaps.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-24T17:02:18.327855-05:00","updated_at":"2025-12-24T17:02:18.327855-05:00","source_repo":".","labels":["arc-milestones","evidence","validation"]}
{"id":"worktree_worker4-382","content_hash":"51dab7aa7324869514e056532faef2a87bc5dd20c3d5c9591f5c2623f26bb532","title":"Clarify _coerce_int_inner optional defaults doc/type","description":"_coerce_int_inner currently accepts default=None in practice, but the signature hints default:int=0. Add docstring/type clarification or an optional helper to avoid reviewer confusion about None handling, without changing behavior.","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-17T20:28:47.427617-08:00","updated_at":"2025-12-18T17:47:42.587387-08:00","closed_at":"2025-12-18T17:47:42.587387-08:00","source_repo":".","labels":["cleanup","docs","type-hint"]}
{"id":"worktree_worker4-38k","content_hash":"bf2ea79728fbc1108df16d77c6e763805a187a3a564617e0b648c554d39ce00c","title":"Native tools forced on non-tool models returns 400","description":"After PR #2353 the providers force native tool-calling with tool_choice='required' for all Cerebras/OpenRouter models. CONFIRMED: All models DO support function calling (gpt-oss-120b, llama-3.3-70b). However, llama-3.3-70b on Cerebras has multi-turn limitation that causes 400 errors when tool_calls array included in assistant turn (Phase 2). Fix: Clear tool_calls from history before Phase 2 for llama-3.3-70b on Cerebras only.","notes":"WEB SEARCH CONFIRMED (2025-12-17):\n- gpt-oss-120b: FULLY supports function calling, tool use, structured outputs (TauBench tested)\n- llama-3.3-70b: DOES support function calling BUT Cerebras has specific limitation: \"Multi-turn tool calling is currently not supported with the llama-3.3-70b model. This model will error if you include a non-empty tool_calls array on an assistant turn.\"\n\nRoot cause: Phase 2 passes conversation history including tool_calls from Phase 1, triggering 400 on multi-turn for llama-3.3-70b only.\n\nFix strategy: Model-specific history sanitization before Phase 2 for llama-3.3-70b on Cerebras provider only.","status":"closed","priority":1,"issue_type":"bug","assignee":"code","created_at":"2025-12-17T01:44:14.174613-08:00","updated_at":"2025-12-18T17:45:52.209687-08:00","closed_at":"2025-12-18T17:45:52.209687-08:00","source_repo":".","labels":["P0","api-break","dice","pr-2353","regression"]}
{"id":"worktree_worker4-3f0","content_hash":"016358e93a9ccabd8f7000a89f5c2dc625704a6990184704b6d2a4c3e0244117","title":"Fix prompt examples to match engine ActionType + params","description":"game_engine_instruction.md uses unsupported action names and params (initiative/contested/encounter + actor_score/target_score). These commands will be rejected by ActionType.","acceptance_criteria":"- Update examples to use ActionType values: roll_initiative, contested_check, generate_encounter\n- Update contested_check params to actor_ability_score/target_ability_score (and correct proficiency key names)\n- Ensure all examples round‑trip with EngineCommand.from_dict() without errors","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-18T22:05:32.789172-08:00","updated_at":"2025-12-25T14:12:16.503366-05:00","closed_at":"2025-12-25T14:12:16.503366-05:00","source_repo":"."}
{"id":"worktree_worker4-3gt","content_hash":"ad4acedb88ca224208e047c7d9b31b5b3c8ac8c192291a0ba48b56e7fa6ee142","title":"Reconcile social-encounter fix commit hashes with deployed branch","description":"Evidence cites commit bd2a0ea34, while prior summary listed 9d7104ba1 / 5db1f7029 / 442e573e6. Verify which commits are in main/deployed branch, align evidence docs, and ensure the tested code matches the shipped version.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T02:48:01.466567-08:00","updated_at":"2025-12-17T21:07:09.962705-08:00","closed_at":"2025-12-17T21:07:09.962705-08:00","source_repo":"."}
{"id":"worktree_worker4-3w8","content_hash":"8a95aef451cb4f46cf194fc14ed052c8210a734262c91767c94c2460ba41590f","title":"Remove remaining tools-first codepaths","description":"Delete legacy tools-first codepaths and ensure all providers use JSON-first tool_requests or explicit two-phase JSON flow:\n- Remove/disable generate_content_with_tool_loop and process_tool_calls implementations in providers once JSON-first replacements are in place (Cerebras/OpenRouter already have replacements; Gemini still pending alignment).\n- Update llm_service routing to avoid tools-first paths entirely.\n- Cleanup tests/docs referencing tools-first flows.\n","notes":"## Status Check by c3 (2025-12-15)\n\n**Main Code - DONE ✅**\n- `generate_content_with_tool_loop` - DELETED from all providers\n- `process_tool_calls` - DELETED from all providers\n- All providers now use JSON-first `generate_content_with_tool_requests`\n- llm_service routing uses JSON-first paths only\n\n**Remaining Cleanup:**\n- `mvp_site/tests/CLAUDE.md` still references old `generate_content_with_tool_loop` function in examples (lines 260-303)\n- This doc should be updated to reflect the new JSON-first architecture\n\n**Minor Issue Found:**\n- `llm_service.py:1658` passes `tools=DICE_ROLL_TOOLS` to Gemini 3 path, but this param is **ignored** since `generate_content_with_code_execution` now delegates to `generate_content_with_tool_requests`\n- Should either remove the unused param or document why it's kept\n\n**Recommendation:** Close after doc update and unused param cleanup.","status":"closed","priority":1,"issue_type":"task","assignee":"c3","created_at":"2025-12-13T22:08:22.902854-08:00","updated_at":"2025-12-14T16:32:11.135188-08:00","closed_at":"2025-12-14T16:32:11.135188-08:00","source_repo":"."}
{"id":"worktree_worker4-4ds","content_hash":"d9e806388146141202fb4a4a6a40d54b56e5fadd9776f30c2185cf653e7a0720","title":"Provider/openrouter response_format + tool import hygiene","description":"Address lingering provider review items:\n- In openrouter_provider, avoid sending response_format together with tools if the API rejects that combo, or document compatibility; mirror Cerebras conditional behavior.\n- Move inline imports (execute_dice_tool) to module scope in providers (openrouter, cerebras, gemini) per code guidelines.\n- Ensure tool_requests execution uses correct arg keys (notation vs dice_notation) in tests to avoid masking bugs.\n","notes":"## Analysis by c2 (2025-12-14)\n\n**Items Addressed:**\n1. ✅ OpenRouter response_format + tools: Already fixed - conditional at lines 135-142\n2. ✅ Module-scope imports: Already done in all providers (gemini, cerebras, openrouter)\n3. ✅ dice_notation vs notation: Fixed in game_state.py:1159-1160 - now accepts both keys\n\n**Changes Made:**\n- game_state.py: `execute_dice_tool()` now accepts both `dice_notation` (prompt schema) and `notation` (legacy) for `roll_dice` tool\n\nAll tests pass (23/23 in test_code_execution_dice_rolls.py).","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-13T20:05:31.94329-05:00","updated_at":"2025-12-14T16:35:13.97857-08:00","closed_at":"2025-12-14T16:35:13.97857-08:00","source_repo":"."}
{"id":"worktree_worker4-4rl","content_hash":"5daa4e7b1bf6f820bc51bd38ca8ec2721f43bc6494d430665a198ff868c63413","title":"PR #2353 change summary (pending merge)","description":"Summary of all changes vs origin/main for branch claude/refactor-llm-to-code-01Sr4NxrZzuzRJ2XDSVFPm9s:\n\n- game_state.py: Added D\u0026D mechanics/tool execution (execute_dice_tool), DICE_ROLL_TOOLS, deterministic calculators; pre-rolled generator (now unused). XP helpers unchanged.\n- constants.py: Reintroduced capability sets (MODELS_WITH_CODE_EXECUTION, TOOL_USE, PRECOMPUTE). Strategy function get_dice_roll_strategy. Updated context/output limits (e.g., llama-3.3-70b 128k ctx/65k out; gpt-oss-120b 131k/40k). Updated Gemini mappings/allow lists.\n- llm_service.py: Provider dispatch uses tools: Gemini3 -\u003e function-calling+JSON; Gemini2 -\u003e two-phase tools→JSON; OR/Cerebras -\u003e tool loop if whitelisted. Added dice-consistency patch to narrative. Pre-rolled comments remain but no injection. Uses DICE_ROLL_TOOLS.\n- Providers: gemini_provider added tool loop and “code_execution” path (actually function-calling). cerebras/openrouter providers restored tool loop/process_tool_calls and tool_call-aware wrappers.\n- json_utils.py: Added fallback extraction for session_header/planning_block on malformed JSON (regex-based, fragile for nesting).\n- Prompts: game_state_instruction switched to tool-based dice; “copy tool numbers exactly.”\n- Frontend: api.js/app.js better error messages; settings.html adds Gemini 2.5 option text.\n- Tests: dice and JSON tests revamped; test_game_state expanded; planning block integration tests updated; fake_llm added; pre_rolled assertions removed.\n- Misc: llm_request dropped pre_rolled_dice field; clock_skew TESTING bypass; minor scripts update.\n\nKnown risks/todos (tracked separately):\n- Tool entry should be tool-on-demand (first call plain JSON, second only if tool_calls) and robust planning_block/session_header fallback (beads 21f/519).\n- Regex salvage for planning_block is fragile.\n- XP/level validation still not enforced (bead 58b).\n\nClose this bead after PR merge to keep a record of scope for reviewers.","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-12T17:10:15.558893-05:00","updated_at":"2025-12-13T14:06:33.919247-05:00","closed_at":"2025-12-13T14:06:33.919247-05:00","source_repo":"."}
{"id":"worktree_worker4-4wk","content_hash":"bd729708718559f45ccf0d94d16d9aa370a5755a592128ebc1b78a85c5ae77ff","title":"LLM fails to recognize legendary deeds (Level 4 vs Level 12 kill)","description":"When a Level 4 character kills a Level 12 enemy (Malakor, Continental Tier 3 threat), the LLM should automatically recognize this as a legendary deed and trigger reputation/fame mechanics.\n\nOBSERVED BEHAVIOR:\n- XP was awarded (but initially under-calculated)\n- No automatic legendary status recognition\n- No team legendary nickname assigned\n- No permanent bonuses (morale, persuasion) applied\n- Reputation/relationship mechanics not triggered\n\nEXPECTED BEHAVIOR:\n- Automatic recognition of disproportionate victory (8-level gap)\n- Award legendary nickname to team/character\n- Apply permanent bonuses:\n  * Morale boost for all team members\n  * Persuasion/Intimidation bonuses\n  * Reputation/fame increase (use existing reputation mechanics)\n  * Relationship trust bonuses with allies\n- Generate narrative consequences (word spreads, rivals fear you, etc.)\n\nEVIDENCE:\nTranscript: /Users/jleechan/Downloads/Dragon knight (3).txt\n- Level 4 Paladin (Arion) + Imperial Anvil team\n- Killed Level 12 Sorcerer (Malakor \"Argent Tongue\")\n- Continental Tier 3 threat eliminated\n- Player explicitly requested: \"A level 4 killed a level 12. This should make my team legendary.\"","design":"## Root Cause Analysis\n\nThe LLM lacks explicit instructions to:\n1. **Detect disproportionate victories** (level gap ≥6 should trigger legendary status)\n2. **Apply reputation/fame mechanics automatically** (not just when player requests)\n3. **Award permanent bonuses** for extraordinary achievements\n\n## Proposed Solution\n\n### 1. Add Legendary Deed Detection to ESSENTIALS\nUpdate `narrative_system_instruction.md` with:\n```\n🏆 LEGENDARY DEED PROTOCOL:\nWhen player achieves disproportionate victory (level gap ≥6), IMMEDIATELY:\n1. FIRST set in state_updates:\n   • reputation.legendary_deeds: [{ deed: \"...\", level_gap: N, date: \"...\" }]\n   • reputation.public: +30 (regional fame)\n   • relationships.\u003callies\u003e.trust_level: +2 (inspired by feat)\n   • custom_campaign_state.legendary_nickname: \"The [Epic Title]\"\n2. THEN narrate legendary status, word spreading, rivals fearing you\n3. Apply permanent bonuses:\n   • Advantage on Intimidation vs lower-level threats\n   • +2 to Persuasion when reputation precedes you\n   • Team morale boost (describe in narrative)\n\nTRIGGERS: Level gap ≥6, defeating boss/named enemy, impossible odds victory\n```\n\n### 2. Update RewardsAgent to Check for Legendary Deeds\nAfter XP calculation, check if:\n- `player_level - enemy_level \u003e= 6` (underdog victory)\n- OR `enemy_level - player_level \u003e= 6` (legendary kill)\n\nIf true, add `legendary_deed_detected: true` to game state for LLM to process.\n\n### 3. Create Legendary Deed Mechanics in rewards_agent.py\n```python\ndef detect_legendary_deed(combat_summary, player_level):\n    enemies_defeated = combat_summary.get(\"enemies_defeated\", [])\n    for enemy in enemies_defeated:\n        enemy_level = enemy.get(\"level\", 1)\n        level_gap = abs(player_level - enemy_level)\n        if level_gap \u003e= 6:\n            return {\n                \"legendary_deed\": True,\n                \"deed_type\": \"underdog_victory\" if player_level \u003c enemy_level else \"overwhelming_dominance\",\n                \"level_gap\": level_gap,\n                \"enemy_name\": enemy.get(\"name\"),\n                \"enemy_level\": enemy_level,\n            }\n    return None\n```","acceptance_criteria":"## Acceptance Criteria\n\n1. **Automatic Detection**: When Level 4 kills Level 12 (or similar gap ≥6), LLM automatically recognizes legendary deed WITHOUT player prompting\n2. **Legendary Nickname**: Team/character receives epic nickname (e.g., \"The Shadow-Slayers\", \"The Giant-Fellers\")\n3. **Permanent Bonuses Applied**:\n   - Reputation +30 (regional fame)\n   - Relationships +2 trust with allies\n   - Persuasion/Intimidation bonuses in narrative\n4. **Narrative Consequences**: Word spreads, rivals fear you, new opportunities/threats emerge\n5. **Test Reproduction**: Create test that triggers legendary deed and verifies all mechanics fire\n\n## Test Scenarios\n\n1. Level 4 vs Level 12 enemy (underdog victory)\n2. Level 10 vs Level 3 enemy (overwhelming dominance - should NOT trigger legendary)\n3. Multiple enemies defeated, one has ≥6 level gap\n4. Verify reputation update persists in game state\n5. Verify legendary_deeds array stores deed metadata","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-31T00:21:06.434008-05:00","updated_at":"2025-12-31T00:21:06.434008-05:00","source_repo":"."}
{"id":"worktree_worker4-519","content_hash":"a05344d97ba7a12053dc23a33744a50e728f184c1d6245b9e3cd32314815f3bf","title":"Tool-on-demand LLM entrypoint (reduce malformed JSON, restore headers/blocks)","description":"Goal: Align with origin/main by making the first LLM call plain JSON (no tools) and only doing a second call if tool_calls are returned.\n\nProblem: Current tool-loop entrypoint (PR #2353) sends tool-enabled first calls for Cerebras/OR and Gemini 2.x. Some providers (e.g., Cerebras) return malformed/partial JSON with missing session_header/planning_block on non-dice turns. Fallback was removed, so headers/blocks go missing.\n\nProposed approach:\n1) First call: JSON mode, no tools; brief instruction tells the model to request tool calls if dice/skills/saves needed.\n2) If tool_calls present: execute tools, then second call JSON mode (tools disabled) with results to produce final structured response.\n3) If no tool_calls: use first response as final.\n4) Fallback: if session_header or planning_block missing after final response, reprompt once to add them. Keep malformed-JSON salvage as last resort.\n\nScope/files:\n- mvp_site/llm_service.py: adjust dispatch to tool-on-demand.\n- mvp_site/llm_providers/*: ensure plain JSON helper; tool loop only when tool_calls exist.\n- Prompts: instruct models to request tools when needed; no “tools always” assumption.\n\nAcceptance:\n- Non-dice turns complete in one call with session_header + planning_block present.\n- Dice turns complete in two calls with executed tool results and valid JSON.\n- Reduced malformed-JSON incidence for Cerebras/OR; missing headers/blocks covered by reprompt fallback.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T12:41:29.829537-05:00","updated_at":"2025-12-13T14:06:03.404255-05:00","closed_at":"2025-12-13T14:06:03.404255-05:00","source_repo":"."}
{"id":"worktree_worker4-58b","content_hash":"dd4109d8f4de739c16e48e5e732a56d21cffa7ee0014bd85b6aca3bc4b826ed7","title":"Harden narrative/XP/time validation and fuzzy JSON extraction","description":"Summary of investigation findings:\n1) Narrative truncation: malformed JSON when narrative contains unescaped quotes; parser truncates mid-sentence. Need fuzzy extraction fallback to capture full narrative when strict parse fails or length is suspiciously short.\n2) Level/XP discrepancies: prompts in mechanics_system_instruction were vague (\"typically double\" XP); game_state blindly accepts LLM XP/level. Need to enforce D\u0026D 5e XP table in prompt and add validation in GameState (_validate_level_consistency) to warn on mismatches.\n3) Time tracking anomalies: GameState accepts backward time jumps. Add validate_time_monotonicity to detect/reject/warn when new timestamp \u003c previous.\n\nUpdated leveling approach:\n- Backend owns XP→level (and level→XP) using the fixed 5e table; LLM does not compute level. If LLM proposes mismatched XP/level, backend corrects or reprompts.\n- Prompt change: tell the LLM \"XP/level are authoritative from the system; do not change them. When you mention level or XP, use the provided values.\" LLM may propose \"apply level-up now\" flags, but backend applies the table and updates state.\n\nRequested work:\n- Add robust fallback extraction in narrative_response_schema.py for malformed JSON.\n- Update mechanics_system_instruction.md to include standard 5e cumulative XP table and remove ambiguous guidance; include the prompt text above about authoritative XP/level.\n- Implement GameState validation hooks: level/XP consistency (auto-correct or warn) and time monotonicity (warn/reject backwards time).\n","status":"closed","priority":3,"issue_type":"task","assignee":"c3","created_at":"2025-12-12T11:59:23.318533-05:00","updated_at":"2025-12-14T16:39:03.261108-08:00","closed_at":"2025-12-14T16:39:03.261108-08:00","source_repo":"."}
{"id":"worktree_worker4-5lk","content_hash":"48e3bc1d70057f2890c479d332ff732b21e311442a49e047e0ed16ed4d067048","title":"Persist state_updates/game_state/core_memories/world_events to Firestore story/game_states for long campaigns","description":"Audit across 34 campaigns (\u003e=50 recent entries) shows no story entries contain state_updates/game_state/core_memories/world_events. game_states subcollection is empty for STpjRuwjeUt97tpCl5nK and likely others. This implies critical state is in-memory only, causing LW to forget earlier plot facts when transcript truncates.","acceptance_criteria":"- Story write path persists state_updates and/or full game_state to Firestore per turn (or at least core_memories + world_events + npc status).\n- Backfill/restore for existing campaigns is optional but document a migration path.\n- A regression test verifies LW respects a persisted fact across \u003e200 turns (no contradiction).\n- Confirm Firestore records contain the fields for new turns.","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-27T14:46:18.18582-05:00","updated_at":"2025-12-27T14:46:18.18582-05:00","source_repo":"."}
{"id":"worktree_worker4-5st","content_hash":"39e4edc532added61aa199c3321433b4cdf516721178c67f3654d874666034e9","title":"PR2353: Clean up Firestore mock client duplication / dead code","description":"`mvp_site/firestore_service.py` contains duplicate `_mock_firestore_client` definitions (second shadows first), plus `_IN_MEMORY_DB` appears unused while real singleton logic uses `_mock_client_singleton`.\n\nGoal: remove dead/duplicated code safely; ensure MOCK_SERVICES_MODE uses a singleton in-memory Firestore; keep tests passing and avoid state pollution.\n\nPR: #2353","notes":"Assigned to CodevFirestore. Status check: agent has urgent ACK/registration requests pending; no findings delivered yet.","status":"closed","priority":2,"issue_type":"task","assignee":"CodevFirestore","created_at":"2025-12-18T20:47:20.508676-08:00","updated_at":"2025-12-18T21:07:55.440083-08:00","closed_at":"2025-12-18T21:07:55.440083-08:00","source_repo":"."}
{"id":"worktree_worker4-620","content_hash":"d8aa98c3e54f9622a877bbc8089e788cb13cab5e2d4885eebb5fefadf0ae8fca","title":"Update llm_service.py to route by provider","description":"Modify _call_llm_api() to:\n1. Determine provider from model name\n2. Call appropriate provider's generate_content_with_tool_loop()\n3. Pass DICE_ROLL_TOOLS to all providers","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T10:18:19.024753-05:00","updated_at":"2025-12-13T14:06:05.865182-05:00","closed_at":"2025-12-13T14:06:05.865182-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker4-620","depends_on_id":"worktree_worker4-np8","type":"blocks","created_at":"2025-12-11T10:18:19.025281-05:00","created_by":"daemon"},{"issue_id":"worktree_worker4-620","depends_on_id":"worktree_worker4-8pt","type":"blocks","created_at":"2025-12-11T10:18:29.718478-05:00","created_by":"daemon"}]}
{"id":"worktree_worker4-67y","content_hash":"63c492d86ba70aad78389caf9ccd15ed207f1b7379b8fe9b372fe85236389582","title":"Unconditional two-phase dice flow doubles API calls","description":"Current routing in llm_service forces native_two_phase for Gemini 2.x default, Cerebras, and OpenRouter even when no tool calls are needed. Every turn now triggers two provider requests (Phase 1 tools + Phase 2 JSON), doubling latency/cost and rate-limit usage for all users by default. Add conditions/flags to keep single-call JSON flow when dice are not required or when models support tool_requests; only run two-phase when tools are requested or required.","notes":"Ping @code. Problem: two-phase dice flow is forced even when no dice/tool_calls are needed, doubling API calls, latency, and cost. Proposed mitigations: (1) gate two-phase on explicit dice need; (2) keep JSON-first tool_requests for Gemini 2.x; (3) if Phase-1 returns no tool_calls, reuse response and skip Phase-2; (4) add feature flag ENABLE_NATIVE_DICE_TOOLS default off; (5) cost/latency guard to fall back to single-call when over budget.","status":"closed","priority":2,"issue_type":"bug","assignee":"code","created_at":"2025-12-17T01:44:19.940202-08:00","updated_at":"2025-12-17T21:07:09.413813-08:00","closed_at":"2025-12-17T21:07:09.413813-08:00","source_repo":".","labels":["cost","dice","latency","performance","pr-2353"]}
{"id":"worktree_worker4-6lm","content_hash":"7f04263d02343d7dc0c88cee9fd287c7e3807c7fc8dbf721492b845614e7f112","title":"Harden social encounter tests: preflight tool_config and fail clearly","description":"Add preflight checks in social encounter real API tests to ensure required tool_config is present; when missing, fail fast with a clear message to avoid misattributing LLM behavior to config gaps.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T02:47:57.063209-08:00","updated_at":"2025-12-18T17:45:52.16578-08:00","closed_at":"2025-12-18T17:45:52.16578-08:00","source_repo":"."}
{"id":"worktree_worker4-6on","content_hash":"9bac54d641549a53e9892cfb33d802d376a6bd8e85498afa6431c3716ea76c29","title":"Create compressible entity summaries at multiple detail levels","description":"Generate entity summaries at 3 compression levels during campaign creation:\n- Full: Complete backstory, relationships, speech patterns (500 tokens)\n- Medium: Key traits, current goal, player relationship (200 tokens)\n- Minimal: Name, role, one-liner (50 tokens)\n\nSelect level based on available token budget and entity importance score.\n\nRequires changes to entity data model and entity_preloader.py.","status":"open","priority":3,"issue_type":"feature","created_at":"2025-12-07T23:13:16.396242-05:00","updated_at":"2025-12-07T23:13:16.396242-05:00","source_repo":".","labels":["architecture","context-budget","entity-tracking"],"dependencies":[{"issue_id":"worktree_worker4-6on","depends_on_id":"worktree_worker4-a76","type":"blocks","created_at":"2025-12-07T23:13:27.51776-05:00","created_by":"daemon"}]}
{"id":"worktree_worker4-6tg","content_hash":"9146505a6b70a2475708cef1a8288d1afde9899e4790d58a0313709f32c444d9","title":"Open questions: dice roll count mismatch \u0026 empty-narrative root cause","description":"Track risks from latest MCP smoke evidence: (1) roll counter reports 1 while evidence shows attack+damage for OpenRouter defaultWorld; unclear expected counting; (2) prior defaultWorld empty narrative failure cause unknown; need root-cause and mitigation to prevent recurrence.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-17T02:35:21.62277-08:00","updated_at":"2025-12-17T02:35:21.62277-08:00","source_repo":"."}
{"id":"worktree_worker4-6ws","content_hash":"0ea74e4e60a7f8119282d2b69ca8f1051ba16f8cd69ad410ba4e3dc38b935020","title":"Docs/test policy alignment and clock-skew safety","description":"Docs \u0026 policy fixes:\n- .claude/skills/end2end-testing.md: correct test file list/paths to match repo; remove references to missing files.\n- CLAUDE.md No Silent Test Skipping: change FAIL LOUDLY example from pytest.skip to pytest.fail/raise; soften enforcement language to reflect current automation.\n- narrative_system_instruction.md: wording on choice keys (snake_case vs god:option_1) to avoid inconsistency.\n- clock_skew_credentials.py: adjust TESTING guard so WORLDAI creds still require dev/test mode per review suggestion.\n","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-13T20:06:27.548302-05:00","updated_at":"2025-12-14T16:32:22.310981-08:00","closed_at":"2025-12-14T16:32:22.310981-08:00","source_repo":"."}
{"id":"worktree_worker4-78a","content_hash":"baf96f41f2c49d813ad8a79c2075eeb3cbcbccefb6663ba47c2dbd94abd72bb1","title":"Test auth bypass (X-Test-Bypass-Auth) removed breaks CI","description":"Removed X-Test-Bypass-Auth in mvp_site/main.py Lines 334-335, 331-382 breaks test suite. CI/CD cannot run tests.","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-01T00:21:45.843348-08:00","updated_at":"2025-12-01T00:21:45.843348-08:00","source_repo":".","labels":["P0","blocks-testing","pr-2082"]}
{"id":"worktree_worker4-79n","content_hash":"d8e3064fe38da61f2a5ca6f7506144b3c6fe9c05a5b86c2d8908a977d9a4d9df","title":"Unify user settings defaults in one place","description":"main.py and world_logic.py both set default LLM provider/model values. Create a single source (e.g., world_logic.get_user_settings_unified) and have main.py delegate to avoid drift.","status":"closed","priority":3,"issue_type":"chore","assignee":"Cerebras","created_at":"2025-11-30T22:32:52.81325-08:00","updated_at":"2025-12-01T00:21:50.006342-08:00","closed_at":"2025-12-01T00:21:50.006342-08:00","source_repo":"."}
{"id":"worktree_worker4-7k2","content_hash":"e604d58351ff80e11f31010415447a7e9f49a6bcb71ccef8c02b96eead19e6de","title":"Gemini 2.x AUTO tool mode risks skipping dice tools","description":"Commit 0c915737c changed Gemini native tool flow from function_calling_config mode 'ANY' to 'AUTO'. In AUTO the model can choose not to call dice/skill tools, breaking the requirement that server executes all dice rolls. Risk: silent fake/no dice rolls in combat/skill checks. Fix: revert to ANY or enforce tool usage for dice-critical paths.","status":"closed","priority":1,"issue_type":"bug","assignee":"code","created_at":"2025-12-17T20:26:54.593073-08:00","updated_at":"2025-12-17T20:32:26.233773-08:00","closed_at":"2025-12-17T20:32:26.233773-08:00","source_repo":".","labels":["dice","gemini","p0","pr-2353"]}
{"id":"worktree_worker4-7wz","content_hash":"c0a2938106955b30fe68330be98491f7ce016719426aefad29da8689011b8476","title":"Rate limiter IP spoofing vulnerability - uses load balancer IP","description":"mvp_site/main.py Lines 235-236, 246-253 uses load balancer IP instead of client IP. All users share one rate limit bucket causing global DoS. Fix: Use X-Forwarded-For with ProxyFix.","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-01T00:21:45.844193-08:00","updated_at":"2025-12-01T00:21:45.844193-08:00","source_repo":".","labels":["P0","pr-2082","security"]}
{"id":"worktree_worker4-7y4","content_hash":"872bc7a73ca6d6142cec00467235c0be0093ec51aca2b41b023f6ec76245b04e","title":"Refactor duplicate MCP HTTP handlers into single handler","description":"mvp_site/mcp_api.py defines both DualMCPHandler and MCPHandler with overlapping /health and /mcp logic. Consolidate into one handler class to reduce maintenance risk.","status":"closed","priority":3,"issue_type":"chore","assignee":"c1","created_at":"2025-11-30T22:32:48.55523-08:00","updated_at":"2025-12-01T00:21:45.850224-08:00","closed_at":"2025-12-01T00:21:45.850224-08:00","source_repo":"."}
{"id":"worktree_worker4-82m","content_hash":"b73b4882cfda502f9e6f61d11ca3c9d27e6df8ecd26f7b90124df1dc7c999426","title":"Implement Native Two-Phase Tool Calling for All Non-Gemini Models","description":"Replace prompt-based tool_requests approach with native API tool calling for Cerebras/OpenRouter providers.\n\n## Problem\n- Current approach uses JSON schema with `tool_requests` field via prompt instructions\n- GLM-4.6 and other models ignore this because they're trained for native tool calling\n- API limitation: `tools` + `response_format` cannot be used together\n\n## Solution\nImplement true two-phase native tool calling:\n- Phase 1: `tools` parameter (no JSON schema) → get `tool_calls` in response\n- Phase 2: `response_format` parameter (no tools) → get structured JSON with results\n\n## Scope\n- Gemini 2.0/3.0: Keep single-phase code_execution (supports both together)\n- Gemini 2.5: Native two-phase\n- All Cerebras: Native two-phase  \n- All OpenRouter: Native two-phase","design":"## Architecture\n\n### Strategy Selection (constants.py)\n```python\ndef get_dice_roll_strategy(model_name, provider):\n    if model_name in {\"gemini-2.0-flash\", \"gemini-3-pro-preview\"}:\n        return \"code_execution\"  # Single phase\n    return \"native_two_phase\"  # All others\n```\n\n### Native Two-Phase Flow\n1. Phase 1: Call with `tools=DICE_ROLL_TOOLS`, no response_format\n2. Extract `tool_calls` from response.choices[0].message.tool_calls\n3. Execute tools using execute_dice_tool()\n4. Phase 2: Call with `response_format=JSON_SCHEMA`, include tool results as message\n\n### Files to Modify\n- constants.py: Simplify get_dice_roll_strategy()\n- cerebras_provider.py: Add generate_content_with_native_tools()\n- openrouter_provider.py: Add generate_content_with_native_tools()\n- gemini_provider.py: Add native_two_phase for 2.5\n- llm_service.py: Route to correct strategy","acceptance_criteria":"- [ ] All Cerebras models use native tool calling\n- [ ] All OpenRouter models use native tool calling\n- [ ] Gemini 2.0/3.0 keep single-phase code_execution\n- [ ] Gemini 2.5 uses native two-phase\n- [ ] GLM-4.6 produces dice rolls in combat\n- [ ] Smoke tests pass for all providers\n- [ ] No regression in existing functionality","notes":"Implementation complete. All providers updated to use native two-phase tool calling:\n- constants.py: Simplified get_dice_roll_strategy() to return only code_execution or native_two_phase\n- cerebras_provider.py: Added generate_content_with_native_tools()\n- openrouter_provider.py: Added generate_content_with_native_tools()  \n- gemini_provider.py: Added generate_content_with_native_tools() for Gemini 2.5\n- llm_service.py: Updated routing to use correct strategies\n- test_code_execution_dice_rolls.py: Updated tests for new architecture\n\n50 tests passing. Needs smoke test validation with live APIs to confirm GLM-4.6 produces dice rolls.","status":"in_progress","priority":1,"issue_type":"feature","assignee":"claude","created_at":"2025-12-16T22:14:10.97962-08:00","updated_at":"2025-12-16T22:29:11.578447-08:00","source_repo":".","labels":["architecture","dice-rolls","pr-2353","tool-calling"]}
{"id":"worktree_worker4-8f1","content_hash":"161b615a2253a8c08ceeee7ba8767328cfdebc86a11bcce13a9dfbe54aa9340f","title":"Phase 2 Skip Optimization - Redesign with Schema Validation","description":"Redesign Phase 2 skip optimization with proper schema validation and tool enforcement.\n\nCONTEXT: Initial optimization (0c915737c) reverted due to critical regressions:\n1. Schema bypass: Skipped Phase 2 without validating required fields (planning_block, session_header, dice_rolls)\n2. Tool mode regression: Changed mode='ANY' to mode='AUTO', allowing LLM to skip mandatory dice rolls\n\nGOAL: Achieve ~25-30% token reduction for narrative-only turns while maintaining:\n- Mandatory dice rolls (mode='ANY')\n- Schema compliance (all required fields)\n- No client-side KeyErrors or missing data","design":"## Approach: Schema-Validated Phase 2 Skip\n\n### Implementation Strategy\n1. Keep tool_config mode='ANY' (force tools, preserve dice authority)\n2. Add schema validation before Phase 2 skip\n3. Only skip Phase 2 when:\n   - No function_calls returned from Phase 1\n   - Phase 1 text is valid JSON\n   - All required fields present (narrative, planning_block, session_header, etc.)\n\n### Code Pattern\n```python\nif not function_calls:\n    try:\n        parsed = json.loads(phase1_text)\n        required_fields = ['narrative', 'planning_block', 'session_header']\n        \n        if all(field in parsed for field in required_fields):\n            logging_util.info(\"Phase 1 response schema-valid, skipping Phase 2\")\n            return response1\n    except (json.JSONDecodeError, KeyError):\n        logging_util.info(\"Phase 1 response invalid, proceeding to Phase 2\")\n        \n# Run Phase 2 for formatting and schema enforcement\nreturn run_phase2(...)\n```\n\n### Testing Requirements\n- Test Phase 2 skip with complete JSON (should skip)\n- Test Phase 2 skip with missing planning_block (should NOT skip)\n- Test Phase 2 skip with missing session_header (should NOT skip)\n- Test that dice rolls still forced in combat (mode='ANY' preserved)\n- Integration test: verify no KeyErrors in UI with optimization active","acceptance_criteria":"MUST:\n- [ ] mode='ANY' preserved for all providers (gemini, openrouter, cerebras)\n- [ ] Schema validation includes ALL required fields before Phase 2 skip\n- [ ] Tests verify missing fields force Phase 2 execution\n- [ ] Combat/skill checks still use server-executed dice\n- [ ] No KeyErrors in UI from missing fields\n\nSHOULD:\n- [ ] Achieve ~25-30% token reduction for narrative-only turns\n- [ ] Log when Phase 2 skipped vs executed for debugging\n- [ ] Add metrics to track Phase 2 skip rate\n\nMUST NOT:\n- [ ] Use mode='AUTO' (allows dice skip)\n- [ ] Skip Phase 2 without schema validation\n- [ ] Ship incomplete JSON to clients","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-17T20:31:40.112282-08:00","updated_at":"2025-12-17T20:31:40.112282-08:00","source_repo":"."}
{"id":"worktree_worker4-8gv","content_hash":"d4d0f3d05e704282654d0917668349a17a6071d8682cb9a5c50e4fe7a0a4c3eb","title":"NPC death state not persisting (Marcus elimination issue)","description":"NPC death state not persisting between turns. User kills Marcus but game still presents options to kill him.\n\nROOT CAUSE ANALYSIS (CONFIRMED):\n\n**TWO SEPARATE ISSUES:**\n\n1. **apply_automatic_combat_cleanup NOT called in main story flow**\n   - world_logic.py line 905: `update_state_with_changes` called\n   - NO `apply_automatic_combat_cleanup` call after it\n   - Cleanup only called in GOD_MODE flows (lines 1817, 1887)\n   - Result: combat_state HP=0 deaths are not synced to npc_data\n\n2. **cleanup_defeated_enemies DELETES instead of marking dead**\n   - game_state.py line 729: `del self.npc_data[enemy_name]`\n   - For generic enemies (goblins): deletion is correct\n   - For named NPCs (Marcus): need `status: [\"dead\"]` to persist\n   - Without status, LLM can't know NPC is dead\n\n**WHY THIS HAPPENS:**\n- npc_data EXCLUDED from LLM context (to save tokens - ~500/NPC)\n- entity_tracking_data is READ-ONLY trimmed data\n- LLM can't see death status → offers to kill dead NPCs\n\n**FIX REQUIRED:**\n1. Add `apply_automatic_combat_cleanup` call after line 905 in main story flow\n2. Modify cleanup to mark named NPCs as dead instead of deleting","acceptance_criteria":"- NPC deaths update npc_data.status = 'dead'\n- Dead NPCs not offered as targets in planning blocks\n- State persists across sessions","notes":"Traced to commit ded8efa84 which excluded npc_data from context. Cleanup function exists but is not called in main flow. This is a pre-existing bug on origin/main, not from PR #2353.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-17T01:43:36.616356-08:00","updated_at":"2025-12-18T17:57:52.44069-08:00","closed_at":"2025-12-18T17:57:52.44069-08:00","source_repo":".","labels":["bug","game-state","npc"]}
{"id":"worktree_worker4-8k9","content_hash":"d20e526e3efa12f718099764f2e45f99ce5d2f80cf82b9809dbed62f342838ad","title":"Flask-Limiter dependency missing from requirements.txt","description":"flask_limiter imported in mvp_site/main.py Line 79 but not in requirements.txt. Deployment will fail with ImportError.","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-01T00:21:45.844663-08:00","updated_at":"2025-12-01T00:21:45.844663-08:00","source_repo":".","labels":["P0","blocks-deployment","pr-2082"]}
{"id":"worktree_worker4-8o0","content_hash":"28462cede462e532a6770b8e765cc31240a88a2fb3f974073a1517ef0c8e0820","title":"Combat: Stale combat_summary reused in quick combat","description":"**Root Cause Analysis:**\n\nQuick combat execution shows `enemies_defeated` listing 3 goblins even though the action was a single goblin execution.\n\n**Evidence from raw_mcp_responses.jsonl:**\n```\nInput: \"I notice a wounded goblin trying to crawl away. I walk over and execute it with my sword\"\n\nLLM Output:\n{\n  \"combat_state\": {\n    \"in_combat\": false,\n    \"combat_phase\": \"ended\",\n    \"combat_summary\": {\n      \"enemies_defeated\": [\"npc_goblin_001\", \"npc_goblin_002\", \"npc_goblin_003\"],  // WRONG!\n      \"xp_awarded\": 50\n    }\n    // MISSING: combat_session_id!\n  }\n}\n```\n\n**Root Cause:**\n1. Quick combat did NOT generate a new `combat_session_id`\n2. Without a fresh session ID, the LLM confused this with the previous combat\n3. It carried over the `enemies_defeated` list from the prior session\n4. User asked to execute ONE goblin, but LLM listed THREE\n\n**Fix Required:**\n1. Prompt must require `combat_session_id` for ALL combat (including quick/single-turn)\n2. Each combat session must have fresh `enemies_defeated` starting empty\n3. Add validation: `enemies_defeated` count should match actual kills in THIS session\n\n**Related:** This also explains the HP state drift - the LLM is not treating each combat as isolated.","design":"**Solution Design:**\n\n1. Add to combat checklist:\n   - EVERY combat (including quick/single-turn) MUST have unique `combat_session_id`\n   - `combat_summary.enemies_defeated` = ONLY enemies killed in THIS session\n   \n2. Add validation rule:\n   - If `combat_session_id` is missing or reused, state_updates is INVALID\n   \n3. Prompt wording:\n   ```markdown\n   **Quick Combat / Single-Turn Combat:**\n   Even single-turn combat (execution, coup de grace) requires:\n   - [ ] Fresh `combat_session_id` (format: `combat_\u003ctimestamp\u003e_\u003ccontext\u003e`)\n   - [ ] `enemies_defeated` contains ONLY the target of THIS action\n   - [ ] `xp_awarded` for ONLY the killed enemy\n   ```","acceptance_criteria":"- Quick combat generates unique combat_session_id\n- enemies_defeated contains only enemies killed in current session\n- XP matches only the enemies actually killed\n- Test: Execute 1 goblin → enemies_defeated has exactly 1 entry","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-26T15:28:36.45412-05:00","updated_at":"2025-12-26T15:49:20.724512-05:00","closed_at":"2025-12-26T15:49:20.724512-05:00","source_repo":".","labels":["combat","pr-2553","state-management"]}
{"id":"worktree_worker4-8pt","content_hash":"0aad9418d3db4271ba641f1687e25bf8ae66fe10dd5dbcee26bf7465d0e04185","title":"Add Gemini tool loop with phase separation","description":"Implement generate_content_with_tool_loop() for Gemini provider with special handling:\n- Phase 1: tools=ON, json_mode=OFF (function calling)\n- Phase 2: tools=OFF, json_mode=ON (structured output)\n\nThis works around Gemini API limitation that rejects tools + JSON mode together.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T10:18:17.738164-05:00","updated_at":"2025-12-13T14:06:06.971061-05:00","closed_at":"2025-12-13T14:06:06.971061-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker4-8pt","depends_on_id":"worktree_worker4-np8","type":"blocks","created_at":"2025-12-11T10:18:17.738798-05:00","created_by":"daemon"},{"issue_id":"worktree_worker4-8pt","depends_on_id":"worktree_worker4-bkl","type":"blocks","created_at":"2025-12-11T10:18:28.75882-05:00","created_by":"daemon"}]}
{"id":"worktree_worker4-8qz","content_hash":"02189e5f8526bfc23977507c4d5d16809f32f8c31ed1ea90823870f16d0cb2dc","title":"Smoke test tool loops for all providers","description":"Run smoke tests against:\n- Gemini (phase-separated tool loop)\n- Cerebras (unified tool loop)\n- OpenRouter (unified tool loop)\n\nVerify LLM can call roll_attack(), roll_dice(), roll_skill_check(), roll_saving_throw() and results appear in final JSON response.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T10:18:19.55518-05:00","updated_at":"2025-12-13T14:06:35.068691-05:00","closed_at":"2025-12-13T14:06:35.068691-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker4-8qz","depends_on_id":"worktree_worker4-np8","type":"blocks","created_at":"2025-12-11T10:18:19.555715-05:00","created_by":"daemon"},{"issue_id":"worktree_worker4-8qz","depends_on_id":"worktree_worker4-620","type":"blocks","created_at":"2025-12-11T10:18:30.196946-05:00","created_by":"daemon"}]}
{"id":"worktree_worker4-8zk","content_hash":"abb1a71a0b19ec2fda5db93c9435cb926d550cc4155245f7eb1c2d2a1ade3fba","title":"Route Gemini 2.x through JSON-first tool_requests flow","description":"Prompt docs emphasize JSON-first tool_requests two-phase. llm_service currently routes Gemini 2.x to native tool-calling, which can ignore tool_requests if model follows prompt literally.","acceptance_criteria":"- llm_service routes Gemini 2.x (native_two_phase strategy) to gemini_provider.generate_content_with_tool_requests\n- Update/unit tests reflect new routing\n- End2end tests still pass","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-18T17:35:58.537481-08:00","updated_at":"2025-12-18T17:38:38.516315-08:00","closed_at":"2025-12-18T17:38:38.516315-08:00","source_repo":"."}
{"id":"worktree_worker4-9u7","content_hash":"458c8a856c72c924d062f5ae0c77b09d2a3e667e13ecd4e843c7fb95b14eae03","title":"Multiple validation error types support (V2 feature)","description":"mvp_site/validation_recovery.py Lines 105-126 only extracts ONE HP error type. Current design intentional - handles one error type per response. Future enhancement to support multiple different error types.","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-01T00:21:45.845173-08:00","updated_at":"2025-12-01T00:21:45.845173-08:00","closed_at":"2025-11-23T15:59:09.608643-08:00","source_repo":".","labels":["P3","future","pr-2082"]}
{"id":"worktree_worker4-9xp","content_hash":"4f0587efd8f2e067edeb9215d1d5240691aa198cd9e1cfb5a42665da056b5fa1","title":"Remove forced tool-calling; only call dice tools when needed","description":"We currently force at least one tool call in some provider flows (Gemini native tools uses FunctionCallingConfig(mode='ANY'); Cerebras/OpenRouter set tool_choice='required'). This adds latency/cost and can create unnecessary dice actions. Gemini 3 uses code_execution + JSON in a single call and does not need forced function tool calling for dice tools.\n\nScope:\n- Revisit/relax forced tool calling behavior across providers.\n- Ensure no-roll turns work without any tool call.\n- Preserve correctness for turns that do require rolls.\n\nNotes:\n- Gemini 3 path uses built-in code_execution (not server dice tools) and shouldn't require tool forcing.\n- If forced tool calling remains for Gemini 2.5 native tools, ensure model can choose declare_no_roll_needed reliably, or switch to a JSON-first tool_requests flow where no tool call is allowed when unnecessary.\n\nUpdate (2025-12-18): Gemini native tool calling no longer forces a function call (mode='AUTO' instead of 'ANY') and new unit tests cover no-roll path still returning JSON. Remaining: decide whether to relax OpenRouter/Cerebras tool_choice='required'.","acceptance_criteria":"- Gemini 3 (code_execution strategy) does not force any server dice tool call.\n- Gemini native_two_phase (2.x/2.5) does not force tool calls for prompts that do not require dice; tests cover this.\n- Cerebras/OpenRouter tool calling is not globally forced; tool calls are optional unless explicitly required by the prompt.\n- Add/adjust unit/integration tests to prevent regressions (e.g., a no-roll prompt produces zero tool calls and still returns valid JSON).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T14:28:12.372821-08:00","updated_at":"2025-12-18T17:43:26.618141-08:00","closed_at":"2025-12-18T17:43:26.618141-08:00","source_repo":"."}
{"id":"worktree_worker4-a08","content_hash":"ec0b0e750e49743daf9c467cae77e7bf04e9e4e159efe018614e4cc64c76d50b","title":"Frontend PII logging and system actor handling","description":"Fix frontend review items:\n- Remove or redact user email logging in mvp_site/frontend_v1/api.js fetchApi error path (PII leak).\n- Add explicit handling for 'system' actor in appendToStory or avoid using that actor to prevent mislabelled UI messages in app.js error handling.\n","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-13T20:06:08.567991-05:00","updated_at":"2025-12-14T16:32:17.316218-08:00","closed_at":"2025-12-14T16:32:17.316218-08:00","source_repo":"."}
{"id":"worktree_worker4-a2c","content_hash":"fe9ed8e999400536d002a6567eaf47232070c3af0ad9d9bc1765d4f02f239d6f","title":"S1 outage \u0026 PR #2327 merge readiness","description":"Track S1 preview 404 outage and merge readiness for PR #2327. Steps: restore S1 availability, rerun mature campaign VqqJLpABua9bvAG4ArTg with the fix; capture narrative and token logs; if S1 stays down, document local proof and risk for merge decision.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-08T23:26:44.363042-05:00","updated_at":"2025-12-08T23:29:58.912143-05:00","closed_at":"2025-12-08T23:29:58.912143-05:00","source_repo":".","labels":["context-budget","infra","release"]}
{"id":"worktree_worker4-a76","content_hash":"af04726d4974e39aa3037cacbacbddede1861562c46a7498088c075fcf5b4578","title":"Add entity_tracking token measurement logging","description":"Add logging to measure actual entity_tracking_data token count before API call. This is needed to validate the hypothesis that entity_tracking exceeds its 10,500 token reserve.\n\nAdd after line 3342 in llm_service.py:\n```python\nentity_tracking_tokens = estimate_tokens(json.dumps(entity_tracking_data))\nlogging_util.info(f\"ENTITY_TRACKING_SIZE: {entity_tracking_tokens}tk (reserve: {ENTITY_TRACKING_TOKEN_RESERVE}tk)\")\n```\n\nThis is a prerequisite for all other entity truncation work.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-07T23:13:15.268259-05:00","updated_at":"2025-12-08T23:41:10.171336-05:00","closed_at":"2025-12-08T23:41:10.171336-05:00","source_repo":".","labels":["context-budget","logging","quick-win"]}
{"id":"worktree_worker4-at8","content_hash":"35b992506789000d3173df0ee602b17daae3ce9439cfe139f9f6ee9464a078f8","title":"XP duplication: Combat XP granted multiple times in same encounter","description":"Combat XP is being awarded multiple times for the same encounter, causing players to receive duplicate rewards.\n\nOBSERVED BEHAVIOR:\n- Combat encounter starts at 200 XP\n- Step 2 (combat start): 400 XP (+200 granted)\n- Step 3 (combat end): 600 XP (+200 granted AGAIN)\n- Same combat encounter awards 200 XP twice\n\nEVIDENCE:\n- Test: test_rewards_missed_repro.py\n- Evidence: /tmp/worktree_worker4/rewards_missed/rewards_missed_repro/20251231_014005/\n- Raw logs show: xp_gained: 200 appears in multiple steps\n- XP progression: 200 → 400 → 600 (should be 200 → 400)\n\nEXPECTED BEHAVIOR:\n- Combat XP should be awarded ONCE per encounter\n- XP progression: 200 → 400 (one grant of 200 XP)\n- Subsequent steps in same encounter should NOT re-award XP\n\nROOT CAUSE HYPOTHESIS:\nRewardsAgent may be triggering multiple times:\n1. During combat (when enemies defeated mid-combat)\n2. At combat end (when combat_phase='ended')\n\nOR server-side enforcement is awarding XP independent of LLM combat_summary.","design":"## Investigation Plan\n\n### 1. Check RewardsAgent Trigger Conditions\nVerify when RewardsAgent.matches_game_state() returns True:\n```python\n# mvp_site/agents.py lines 796-807\nif (\n    combat_state.get(\"combat_phase\") in constants.COMBAT_FINISHED_PHASES\n    and combat_state.get(\"combat_summary\")\n    and not combat_state.get(\"rewards_processed\", False)\n):\n    return True  # Should trigger ONCE\n```\n\n**Questions:**\n- Is combat_phase transitioning through multiple COMBAT_FINISHED_PHASES?\n- Is rewards_processed being reset between steps?\n- Is combat_summary being set mid-combat (step 2) and at end (step 3)?\n\n### 2. Check Server-Side XP Logic\nSearch for XP award mechanisms outside RewardsAgent:\n```bash\ngrep -r \"experience.*current\" mvp_site/\ngrep -r \"xp.*award\" mvp_site/\ngrep -r \"combat_history\" mvp_site/\n```\n\n### 3. Add XP Deduplication\n```python\n# In RewardsAgent or server logic\ndef should_award_xp(combat_summary, combat_history):\n    # Check if this combat_session_id already in combat_history\n    session_id = combat_summary.get(\"combat_session_id\")\n    for past_combat in combat_history:\n        if past_combat.get(\"combat_session_id\") == session_id:\n            if past_combat.get(\"xp_awarded\"):\n                log(\"XP already awarded for session {session_id}, skipping\")\n                return False\n    return True\n```\n\n## Proposed Solution\n\n### Option 1: Single XP Award (Defensive)\nOnly award XP when combat_phase transitions to 'ended' AND combat_summary exists:\n```python\ndef matches_game_state(self, game_state):\n    combat_state = game_state.get(\"combat_state\", {})\n    \n    # MUST have combat_summary (not just phase='ended')\n    if not combat_state.get(\"combat_summary\"):\n        return False\n    \n    # MUST be in finished phase\n    if combat_state.get(\"combat_phase\") not in constants.COMBAT_FINISHED_PHASES:\n        return False\n    \n    # MUST NOT have already processed\n    if combat_state.get(\"rewards_processed\", False):\n        return False\n    \n    return True\n```\n\n### Option 2: Deduplication by Session ID\nTrack which combat sessions have awarded XP:\n```python\n# Add to combat_summary\n{\n    \"combat_session_id\": \"combat_20251231_forest\",\n    \"xp_awarded\": 200,\n    \"already_awarded\": False  # NEW field\n}\n\n# In RewardsAgent\nif combat_summary.get(\"already_awarded\"):\n    return False  # Skip duplicate award\n```","acceptance_criteria":"## Acceptance Criteria\n\n1. **Single XP Award**: Combat encounter awards XP exactly ONCE, not multiple times\n2. **XP Deduplication**: If RewardsAgent triggers multiple times, check for duplicate awards\n3. **Test Coverage**: Add test verifying XP progression across steps:\n   ```python\n   xp_history = [200, 400]  # ✅ Single grant\n   # NOT: [200, 400, 600]   # ❌ Duplicate grant\n   ```\n4. **Combat History Validation**: combat_history contains ONE entry per encounter\n5. **Session ID Tracking**: combat_session_id used to prevent duplicates\n\n## Test Scenario\n\n```python\ndef test_xp_no_duplication():\n    # Create campaign at 200 XP\n    # Start combat → NO XP change (200)\n    # Defeat enemy → Award 200 XP (400)\n    # End combat → NO additional XP (400)\n    \n    assert xp_history == [200, 200, 400, 400]  # Only ONE increase\n    assert combat_history.length == 1  # Only ONE entry\n```","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-31T01:20:42.000522-08:00","updated_at":"2025-12-31T01:20:42.000522-08:00","source_repo":"."}
{"id":"worktree_worker4-b3v","content_hash":"62cc7cbdb0a20489546c1ffbad621b3c792b276688296a17bf5776962599b3f2","title":"Optimize Cerebras: Skip Phase 2 when no tool_calls with fallback","description":"Implement conditional Phase 2 skip for Cerebras to reduce latency when tools aren't needed, while maintaining schema enforcement as fallback.","design":"## Problem\nCurrent Cerebras implementation always runs Phase 2 for schema enforcement, even when Phase 1 returns no tool_calls and valid JSON text.\n\n## Solution\nConditionally skip Phase 2 when safe, with fallback to schema enforcement:\n\n```\nPhase 1 (tools + text generation)\n    ↓\nHas tool_calls? ─Yes→ Execute tools → Phase 2 (with schema)\n    │\n    No\n    ↓\nTry parse text as JSON\n    ↓\nValid + matches schema? ─Yes→ Use directly (skip Phase 2)\n    │\n    No\n    ↓\nPhase 2 (with schema enforcement)\n```\n\n## Benefits\n- Single-call for non-tool turns (majority of LLM calls)\n- Schema enforcement preserved as safety net\n- No risk of malformed JSON reaching game state\n\n## Implementation Notes\n- Add JSON schema validation utility\n- Track metrics: Phase 2 skip rate, fallback rate\n- Consider feature flag for gradual rollout","acceptance_criteria":"- [ ] Phase 1 text is parsed as JSON when no tool_calls\n- [ ] Schema validation runs on parsed JSON\n- [ ] Valid JSON skips Phase 2 call\n- [ ] Invalid JSON falls back to Phase 2\n- [ ] Metrics track skip/fallback rates\n- [ ] No regression in response quality\n- [ ] Latency improvement measured","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-17T11:08:44.123137-08:00","updated_at":"2025-12-17T21:07:08.863918-08:00","closed_at":"2025-12-17T21:07:08.863918-08:00","source_repo":"."}
{"id":"worktree_worker4-ber","content_hash":"b570e87dceb69b48bc9477d69b00bc6ebfdc800e9266591a69b5dea570c8aa2f","title":"Consider removing tool_choice='required' from native tools flows","description":"OpenRouter/Cerebras generate_content sets tool_choice='required' when tools are passed. Even though llm_service routes those providers through JSON-first tool_requests, the native tools entrypoints remain and could force unnecessary tool calls if used.","acceptance_criteria":"- Decide whether to keep required vs auto\n- If changed, add tests to ensure combat still triggers dice when appropriate","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-18T17:36:15.649701-08:00","updated_at":"2025-12-18T17:40:38.117236-08:00","closed_at":"2025-12-18T17:40:38.117236-08:00","source_repo":"."}
{"id":"worktree_worker4-bev","content_hash":"1a9baf91998cb562513860b71c509f7bbeaa36452b3c23c5884ae92a51b02031","title":"Add pacing guidance for aftermath scenes / breathing room","description":"Player feedback: After resolving major issues, the DM keeps pushing urgency with no window for social interaction. Found 6+ instances of \"no time\" language pushing pace.\n\nExample from campaign aK8GPGCrhcfw0tCyp7wX:\n- \"Time is a luxury you no longer possess\"\n- \"There is no time for grief\"\n\nNeed to add prompt guidance for \"aftermath scenes\" - after major resolutions, allow a beat for social interaction/downtime before introducing the next problem.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-27T17:20:18.985762-05:00","updated_at":"2025-12-27T17:20:18.985762-05:00","source_repo":".","labels":["player-feedback","prompts","ux"]}
{"id":"worktree_worker4-bkl","content_hash":"599c7677fd4bb538712672da7950356f0784ba88567a24799483e054f309698a","title":"Revert commit 9b70c1ff9 (tool loop deletion)","description":"git revert 9b70c1ff9 to restore ~1,400 lines of tool loop infrastructure:\n- DICE_ROLL_TOOLS array\n- execute_dice_tool() function\n- generate_content_with_tool_loop() in cerebras/openrouter providers\n- process_tool_calls() in both providers\n- MODELS_WITH_TOOL_USE set\n- get_dice_roll_strategy() function","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T10:18:17.005724-05:00","updated_at":"2025-12-13T14:06:04.72984-05:00","closed_at":"2025-12-13T14:06:04.72984-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker4-bkl","depends_on_id":"worktree_worker4-np8","type":"blocks","created_at":"2025-12-11T10:18:17.006728-05:00","created_by":"daemon"}]}
{"id":"worktree_worker4-c1","content_hash":"cb4bbbe3657d1b99805a42bd6f767fcf0e1e194b6833788c5d85dd9944bc3d44","title":"Performance: Two-phase optimization + conditional tool injection","description":"Optimize native two-phase flow to reduce unnecessary API calls and token usage.\n\n**Tasks:**\n1. Skip Phase 2 when Phase 1 returns no tool_calls AND text is valid JSON\n2. Make tool/schema injection conditional in llm_service.py ONLY\n3. Add heuristic: check prompt/user input for dice/skill/save keywords\n4. Add tests for reduced payload in non-dice turns\n\n**Impact:** Halves API calls for non-dice turns, reduces tokens/latency\n\n**Files (NO OVERLAP):**\n- mvp_site/llm_service.py ONLY\n- Tests related to llm_service.py\n\n**Note:** Provider-level changes moved to c2","status":"closed","priority":1,"issue_type":"task","assignee":"c1","created_at":"2025-12-17T12:20:45.968561-08:00","updated_at":"2025-12-17T21:01:18.281211-08:00","closed_at":"2025-12-17T21:01:18.281211-08:00","source_repo":".","labels":["optimization","performance","pr-2353"]}
{"id":"worktree_worker4-c2","content_hash":"89aa8cd2581f3c70b63b320e1c5ac7e84a46fccebb628fb9603b125e40f078c5","title":"Provider Hygiene: Imports, validation, response_format compatibility","description":"Clean up ALL provider code to prevent crashes and improve maintainability.\n\n**Tasks:**\n1. Move all inline execute_dice_tool imports to module scope in cerebras_provider.py\n2. Add type checks/coercion in execute_tool_requests (all providers)\n3. Fix test arg key to `notation` in tool_request tests\n4. Make response_format conditional when tools present in openrouter_provider.py OR document compatibility\n5. Add validation for malformed tool_requests to prevent crashes\n6. Implement Phase 2 skip optimization when no tool_calls (provider level)\n\n**Impact:** Prevents crashes, improves code quality, performance gains\n\n**Files (NO OVERLAP):**\n- mvp_site/llm_providers/cerebras_provider.py\n- mvp_site/llm_providers/openrouter_provider.py\n- mvp_site/llm_providers/gemini_provider.py\n- Tests for provider functions\n\n**Note:** game_state.py moved to c3, llm_service.py assigned to c1","status":"closed","priority":1,"issue_type":"task","assignee":"c2","created_at":"2025-12-17T12:21:00.382163-08:00","updated_at":"2025-12-17T21:01:18.936899-08:00","closed_at":"2025-12-17T21:01:18.936899-08:00","source_repo":".","labels":["code-quality","pr-2353","validation"]}
{"id":"worktree_worker4-c3","content_hash":"3d7c0368db6a82bda58692b4bf707156f8bf3675f97b03967ff87645df8c591d","title":"Dead Code Cleanup: Remove unused helpers and obsolete paths","description":"Remove unused code to reduce confusion and improve maintainability.\n\n**Tasks:**\n1. Remove unused game_state.py helpers:\n   - calculate_initiative\n   - calculate_complication_chance\n   - check_complication_triggers\n   - calculate_death_save\n   - calculate_hp_for_class\n2. Add validation to execute_tool_requests in game_state.py (type checks)\n3. Remove stray calculate_damage stub in testing_llm/test_ai_development_workflow.md\n4. Consolidate or remove redundant test files with sys.path hacks\n5. Clean up unused imports revealed by deletions\n\n**Impact:** Reduces confusion, smaller codebase, better validation\n\n**Files (NO OVERLAP):**\n- mvp_site/game_state.py ONLY (execute_tool_requests validation)\n- testing_llm/test_ai_development_workflow.md\n- Test files with sys.path hacks\n\n**Note:** Gemini provider dead code removal moved to c2 since c2 handles ALL providers","status":"closed","priority":2,"issue_type":"task","assignee":"c3","created_at":"2025-12-17T12:21:14.768442-08:00","updated_at":"2025-12-17T21:01:19.541694-08:00","closed_at":"2025-12-17T21:01:19.541694-08:00","source_repo":".","labels":["cleanup","code-quality","pr-2353"]}
{"id":"worktree_worker4-c4","content_hash":"1f51102b35c11dc452059d32dfd52c859025fb7a6d24e80fe060d8b907c6a871","title":"Frontend/Docs Polish + clock_skew fix","description":"Polish frontend, docs, and fix local development blocker.\n\n**Tasks:**\n1. **clock_skew_credentials.py fix (BLOCKER):**\n   - Fix validate_deployment_config to allow TESTING=true to bypass guard\n   - OR keep guard and document WORLDAI_DEV_MODE requirement in local env\n   - Decision: Allow TESTING bypass for CI/local parity\n\n2. **Frontend PII cleanup:**\n   - Remove/redact user_email logging in mvp_site/static/js/api.js\n   - Handle 'system' actor in appendToStory or use different actor in app.js error path\n\n3. **Docs updates:**\n   - Update end2end-testing.md paths\n   - CLAUDE.md fail-loud example to pytest.fail\n   - Soften enforcement wording\n   - narrative_system_instruction choice-key wording\n\n4. **Optional minor:**\n   - Add bounds check in roll_dice to reject num_dice \u003c 1\n\n**Impact:** Unblocks local development, improves privacy, better docs\n\n**Files:**\n- mvp_site/util/clock_skew_credentials.py\n- mvp_site/static/js/api.js\n- mvp_site/static/js/app.js\n- docs/end2end-testing.md\n- CLAUDE.md\n\n**Related:** msg 151 from codev, bead 6ws, bead a08","status":"closed","priority":1,"issue_type":"task","assignee":"c4","created_at":"2025-12-17T12:21:33.260495-08:00","updated_at":"2025-12-17T21:01:20.187307-08:00","closed_at":"2025-12-17T21:01:20.187307-08:00","source_repo":".","labels":["blocker","docs","frontend","pr-2353"]}
{"id":"worktree_worker4-c9g","content_hash":"b113323dfac3e04d78424bf7af0afd28b605a1cbfd7cf8651a9a72fe27d8aaac","title":"Unify planning_block schema: Single source of truth in Python","description":"**Problem:** Two sources of truth for planning_block structure that are out of sync:\n1. `game_state_instruction.md` (lines 33-53, 72-75) - Detailed, correct\n2. `provider_utils.py:NARRATIVE_RESPONSE_SCHEMA` - Vague ({type: object})\n\nThe JSON schema only says `planning_block: {type: object, additionalProperties: true}` which allows empty `{}`. The LLM satisfies the schema constraint but ignores the prompt's detailed structure requirements.\n\n**Solution (Option B):** Single source in Python, generate prompt section\n\n1. Define full planning_block schema in `provider_utils.py`:\n```python\nPLANNING_BLOCK_SCHEMA = {\n    \"type\": \"object\",\n    \"properties\": {\n        \"thinking\": {\"type\": \"string\", \"description\": \"GM tactical analysis\"},\n        \"context\": {\"type\": \"string\", \"description\": \"Current scenario context\"},\n        \"choices\": {\n            \"type\": \"object\",\n            \"description\": \"Player choices with snake_case keys\",\n            \"additionalProperties\": {\n                \"type\": \"object\",\n                \"properties\": {\n                    \"text\": {\"type\": \"string\"},\n                    \"description\": {\"type\": \"string\"},\n                    \"risk_level\": {\"type\": \"string\"}\n                },\n                \"required\": [\"text\", \"description\"]\n            }\n        }\n    },\n    \"required\": [\"thinking\", \"choices\"]\n}\n```\n\n2. Add helper function to generate prompt-ready JSON example from schema\n3. Update `game_state_instruction.md` to reference or import from Python (or add sync comment)\n4. Consider using the schema for validation in `narrative_response_schema.py`\n\n**Files:**\n- `mvp_site/llm_providers/provider_utils.py` - Define detailed schema\n- `mvp_site/prompts/game_state_instruction.md` - Add sync reference\n- `mvp_site/narrative_response_schema.py` - May use schema for validation","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T17:10:06.787493-05:00","updated_at":"2025-12-12T17:18:51.746665-05:00","closed_at":"2025-12-12T17:18:51.746665-05:00","source_repo":".","labels":["architecture","planning-block","schema"]}
{"id":"worktree_worker4-cho","content_hash":"47fb45242cea0c8895e3ddccff93938f526a199c4be9eb01568c5cedf29b0236","title":"Optimize dual-pass entity generation for cost efficiency","description":"The dual-pass entity generation system triggers 2 extra LLM API calls (~118k tokens, ~11 seconds) for marginal benefit (recovering 1 entity). Pass 1 often produces worse results than the original response. Need to either: raise the trigger threshold, skip Pass 1, use original response as base, or remove the feature entirely.","design":"Options:\nA) Skip Pass 1 entirely - go direct to entity injection\nB) Raise trigger threshold from 66% to 50%\nC) Use original response as base instead of regenerating\nD) Remove dual-pass feature entirely\n\nFiles: mvp_site/dual_pass_generator.py, mvp_site/llm_service.py (lines 2530-2560), mvp_site/entity_validator.py\n\nPrompt file: ~/Downloads/fix-dual-pass-efficiency.md","acceptance_criteria":"1. Reduce unnecessary API calls when entity coverage \u003e60%\n2. Pass 1 should not produce worse results than original\n3. Add metrics logging for dual-pass effectiveness\n4. Unit tests for threshold changes","status":"open","priority":2,"issue_type":"task","created_at":"2025-11-30T19:14:36.361775-08:00","updated_at":"2025-11-30T19:14:36.361775-08:00","source_repo":".","labels":["cost-reduction","llm","optimization"]}
{"id":"worktree_worker4-clg","content_hash":"13a32a19e2b6f00f6d092f2c15d47ff6d22ea6fd617db4be3a34aafa140a1895","title":"Remove dead full_prompt code in continue_story","description":"The `full_prompt` variable built at lines 3319-3327 in llm_service.py is never used. The actual API call uses LLMRequest instead.\n\nThis dead code:\n1. Wastes CPU cycles building unused string\n2. Confuses maintainers about what's actually sent\n3. Includes timeline_log which caused the wrong hypothesis\n\nDelete lines 3319-3327 and any related dead code.","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-07T23:13:17.262877-05:00","updated_at":"2025-12-08T23:41:09.682402-05:00","closed_at":"2025-12-08T23:41:09.682402-05:00","source_repo":".","labels":["cleanup","tech-debt"]}
{"id":"worktree_worker4-cma","content_hash":"d370cb35f6c5b13130e1f0a37a6f151e8e097d23f5bb6ec3985220f15937f3ca","title":"Sanitize labeled modifier strings for injection prevention","description":"Labeled modifiers (e.g., '+2 STR') could be injection vectors if labels contain user input. Risk of log injection, XSS, or command injection in UI/backend.","acceptance_criteria":"- All modifier labels escaped before storage/rendering\n- Labels treated as untrusted data\n- No labels used in conditional logic","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-17T01:43:35.603188-08:00","updated_at":"2025-12-17T01:43:35.603188-08:00","source_repo":".","labels":["pr-2353","secondo-review","security"]}
{"id":"worktree_worker4-cwm","content_hash":"98ed4afa37cae2aee2885e39a135d1a6968d5049483fcbe5457b567e88ce42ee","title":"Add end2end test skill to Claude skills directory","description":"Create a dedicated Claude skill file documenting the end2end test architecture, philosophy, and patterns. Currently this info is scattered across mvp_site/tests/README*.md but not in .claude/skills/.","design":"Create .claude/skills/end2end-testing.md with:\n1. Testing philosophy: Mock external APIs (Firestore, Gemini), NOT internal services\n2. Fake implementations: FakeFirestoreClient, FakeLLMResponse patterns\n3. Test file locations: test_end2end/, test_*_e2e.py\n4. Commands: /teste (mock), /tester (real), /4layer (TDD)\n5. Firestore nested collection structure\n6. Multi-phase function testing with side_effect","acceptance_criteria":"- Skill file created at .claude/skills/end2end-testing.md\n- Contains all E2E testing patterns from README_END2END_TESTS.md\n- Includes references to /teste, /tester, /4layer commands\n- Documents fake service implementation patterns","status":"closed","priority":2,"issue_type":"task","assignee":"claude","created_at":"2025-12-12T22:56:35.356329-05:00","updated_at":"2025-12-12T22:57:50.254195-05:00","closed_at":"2025-12-12T22:57:50.254195-05:00","source_repo":"."}
{"id":"worktree_worker4-czt","content_hash":"dd63cbce3562c049846541000a0202d2a683e861d046afc5cb58073dae3f5883","title":"PR2353: Remove user identifiers from INFO logs (privacy/compliance)","description":"CodeRabbit flagged INFO logs emitting `user_id` in `mvp_site/llm_service.py` allowlist paths.\n\nGoal: remove user_id from INFO logs (or downgrade to DEBUG with redaction) to reduce PII exposure.\n\nPR: #2353","notes":"Assigned to CodevPrivacy. Status check: agent has urgent ACK/registration requests pending; no findings delivered yet.","status":"closed","priority":1,"issue_type":"task","assignee":"CodevPrivacy","created_at":"2025-12-18T20:47:20.361654-08:00","updated_at":"2025-12-18T21:07:56.065344-08:00","closed_at":"2025-12-18T21:07:56.065344-08:00","source_repo":"."}
{"id":"worktree_worker4-d7r","content_hash":"f41974a5758e4e897dfff91e2ecc6c44063fee9931d345c08b612b9448edf1ec","title":"MOCK_SERVICES_MODE Firestore should persist across requests","description":"In MOCK_SERVICES_MODE, firestore_service.get_db returns a new _InMemoryFirestoreClient() each call, so campaigns created in one request are not visible in subsequent requests (e.g., create_campaign then process_action =\u003e Campaign not found).","acceptance_criteria":"- In MOCK_SERVICES_MODE, get_db returns a singleton in-memory client\n- Add a unit test ensuring create_campaign + process_action works in mock mode (or at least get_db identity is stable)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-18T17:36:07.776915-08:00","updated_at":"2025-12-18T17:39:48.497665-08:00","closed_at":"2025-12-18T17:39:48.497665-08:00","source_repo":"."}
{"id":"worktree_worker4-ds0","content_hash":"fcfef211a75743d2e61d82b15ec39d7d97dd8cfd082ed05dbbb8a0e4b67c1dfe","title":"Ensure choices referencing distant locations are narratively motivated","description":"Player feedback: Choices sometimes reference distant locations/NPCs without narrative motivation.\n\nBad example: At home keep, option says \"Ask the village elder about rumors\" (why would player think of that?)\nGood example: At home keep, NPC mentions news from village → option to \"Ask about the village news\"\n\nNeed prompt guidance: Choices referencing locations/NPCs not present should be triggered by something in the current scene (a letter, memory, NPC mention, etc.).","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-27T17:20:19.48578-05:00","updated_at":"2025-12-27T17:20:19.48578-05:00","source_repo":".","labels":["player-feedback","prompts","ux"]}
{"id":"worktree_worker4-e1f","content_hash":"74e36c4ccadbac5ad07970af5d567a6f4108fc0cc8ff814278c26c4cbb5e5f73","title":"Fix Gemini native tools Phase-2 prompt to preserve conversation context","description":"In `mvp_site/llm_providers/gemini_provider.py`, `generate_content_with_native_tools` builds Phase-2 prompt contents as `[base_prompt, tool_results_prompt]` (strings). This drops the model’s Phase-1 response and tool-call context, so Phase-2 doesn’t see its own decisions. Cursor flagged this; it can break Gemini 2.x native_two_phase outputs when tools are used. Fix by preserving structured conversation history (user -\u003e model tool calls -\u003e tool results) rather than stringifying.","acceptance_criteria":"Phase-2 prompt preserves the model’s Phase-1 response and tool call context; Gemini native_two_phase produces consistent JSON when tools are used. Add or update tests to cover the Phase-2 history preservation if feasible.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-30T21:35:52.900686-05:00","updated_at":"2025-12-30T21:58:08.283111-05:00","closed_at":"2025-12-30T21:58:08.283111-05:00","source_repo":"."}
{"id":"worktree_worker4-efg","content_hash":"baa5d6a5b5fe2c01dec23395d90b7d05a5ecf82c21a80475418447817d8e9010","title":"Run evidence test without WORLDAI_DEV_MODE for production claims","description":"Current evidence uses WORLDAI_DEV_MODE=true. If claim is about production behavior, this weakens the case. Need evidence run with production-like settings.","acceptance_criteria":"- Evidence bundle created with WORLDAI_DEV_MODE=false\\n- OR document what DEV_MODE enables and why it doesn't affect arc completion","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-24T17:02:51.805969-05:00","updated_at":"2025-12-24T17:02:51.805969-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker4-efg","depends_on_id":"worktree_worker4-2pc","type":"blocks","created_at":"2025-12-24T17:02:51.806501-05:00","created_by":"daemon"}]}
{"id":"worktree_worker4-f3z","content_hash":"5efc1ad1ffc58f0194d6029670d867886584fa10e4fa028431b7142683e02045","title":"Document prompt file changes during evidence run","description":"provenance_post.json shows mvp_site/prompts/game_state_instruction.md modified after the run, while clean in provenance_pre.json. Red flag for reproducibility. Need to explain why it changed (e.g., known auto-write step) with diff.","acceptance_criteria":"- Pre/post git diff of prompt files included in bundle\\n- Explanation documented for any changes\\n- OR run from clean repo state","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-24T17:02:51.209782-05:00","updated_at":"2025-12-24T17:02:51.209782-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker4-f3z","depends_on_id":"worktree_worker4-2pc","type":"blocks","created_at":"2025-12-24T17:02:51.210279-05:00","created_by":"daemon"}]}
{"id":"worktree_worker4-fsr","content_hash":"13bd91906ae1bc04156e494033562c9f527fb73a50737560f15f81fe7571f43b","title":"Add response_json_schema to Gemini provider for structured output enforcement","description":"Gemini provider currently only uses response_mime_type: \"application/json\" which guarantees valid JSON syntax but does NOT enforce schema structure. Add response_json_schema parameter to enforce NarrativeResponse schema like we did for Cerebras in PR #2377.","design":"File: mvp_site/llm_providers/gemini_provider.py\n\nCurrent (line 62-67):\n```python\ngeneration_config_params = {\n    \"max_output_tokens\": json_mode_max_output_tokens,\n    \"temperature\": temperature,\n    \"safety_settings\": safety_settings,\n    \"response_mime_type\": \"application/json\",\n}\n```\n\nTarget:\n```python\ngeneration_config_params = {\n    \"max_output_tokens\": json_mode_max_output_tokens,\n    \"temperature\": temperature,\n    \"safety_settings\": safety_settings,\n    \"response_mime_type\": \"application/json\",\n    \"response_json_schema\": NARRATIVE_RESPONSE_SCHEMA,  # Add schema\n}\n```\n\nReference: https://ai.google.dev/gemini-api/docs/structured-output","acceptance_criteria":"- [ ] Add NARRATIVE_RESPONSE_SCHEMA constant matching Cerebras schema\n- [ ] Add response_json_schema to generation_config_params\n- [ ] Write TDD tests for schema enforcement\n- [ ] Verify Gemini still works with schema (no API errors)\n- [ ] Monitor for reduced planning_block failures","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-10T01:51:33.747212-05:00","updated_at":"2025-12-10T02:11:39.468712-05:00","closed_at":"2025-12-10T02:11:39.468712-05:00","source_repo":".","labels":["gemini","json-schema","llm-provider"]}
{"id":"worktree_worker4-ft0","content_hash":"b122bd87073d27b0fcdada99c84f5124ef34a290dc4bed096fcedaca74f5508c","title":"Validate game state at tool execution time","description":"Risk of state desynchronization between Phase 1 (planning) and Phase 2 (execution). Game conditions like buffs/debuffs may change during the phase gap, making executed action invalid or exploitable.","acceptance_criteria":"- State validation occurs at execution time, not just planning\n- Detect state drift between phases\n- Reject execution if state materially changed","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-17T01:43:34.609453-08:00","updated_at":"2025-12-17T01:43:34.609453-08:00","source_repo":".","labels":["pr-2353","secondo-review","security"]}
{"id":"worktree_worker4-ftw","content_hash":"2367fb7697b0bf7c2b02155f58841b8c424b535dd77cbf24e5434c5fa17f0cd8","title":"Decide single-call strategy for Gemini 2.0 Flash","description":"Evaluate whether Gemini 2.0 Flash should use a single-call path (code_execution + JSON-like output without official schema) when no tool_calls are needed, to avoid the two-phase latency/cost. Define rules: when to allow single-call, what validation/reprompt to keep, and how to fall back to two-phase when tools/dice are required. Output a clear decision and implementation plan.","notes":"Scope: Decide if/when Gemini 2.0 Flash can run single-call (code_execution + JSON-like output, no official schema) to save latency/cost, and define fallback to two-phase when tools/dice are needed. Add guidelines for validation/reprompt.","status":"open","priority":2,"issue_type":"task","assignee":"code","created_at":"2025-12-17T02:41:51.386416-08:00","updated_at":"2025-12-17T02:41:58.983798-08:00","source_repo":".","labels":["architecture","gemini","performance","pr-2353"]}
{"id":"worktree_worker4-gv1","content_hash":"8b23a00e324c799de546e1d8455649db91d1673f9bbe878dc71554332d10047e","title":"Add timeout handling for two-phase tool calling","description":"Second opinion analysis identified risk of hung states in two-phase tool calling architecture. If coordinator fails between phases, clients may hang indefinitely.","acceptance_criteria":"- Transaction timeouts implemented for tool_requests phase\n- Idempotent rollback logic on timeout\n- Persistent transaction logs for recovery","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-17T01:43:33.834263-08:00","updated_at":"2025-12-17T01:43:33.834263-08:00","source_repo":".","labels":["pr-2353","secondo-review","security"]}
{"id":"worktree_worker4-hiq","content_hash":"2c613689a4b8c82fa3bbc260e34908d5c6d56959067a066c7ac7ff7a5dd81db9","title":"Write E2E tests for JSON-first tool_requests flow (PR #2353)","description":"Add comprehensive E2E tests for the new generate_content_with_tool_requests() function in Cerebras and OpenRouter providers. Current tests mock the function itself rather than testing internal logic.","design":"Add tests to test_code_execution_dice_rolls.py:\n1. Path 1: No tool_requests in response - returns Phase 1 directly\n2. Path 2: tool_requests present - executes tools, Phase 2 call\n3. Path 3: Invalid JSON response - returns as-is\n4. Path 4: Tool execution errors - captured in results\n5. execute_tool_requests() helper tests\n\nMock external API (requests.post) with side_effect for sequential responses.\nDO NOT mock generate_content_with_tool_requests() - test internal logic.","acceptance_criteria":"- Tests added to test_code_execution_dice_rolls.py\n- Covers all 5 code paths in generate_content_with_tool_requests()\n- Uses side_effect for Phase 1 / Phase 2 mock responses\n- All tests pass: TESTING=true python3 -m pytest\n- Pushed to PR #2353","status":"closed","priority":2,"issue_type":"task","assignee":"claude","created_at":"2025-12-12T22:56:36.068789-05:00","updated_at":"2025-12-12T23:03:50.227133-05:00","closed_at":"2025-12-12T23:03:50.227133-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker4-hiq","depends_on_id":"worktree_worker4-cwm","type":"blocks","created_at":"2025-12-12T22:56:42.66083-05:00","created_by":"daemon"}]}
{"id":"worktree_worker4-i81","content_hash":"d0486bff980bc1cff8fde1b2f4d4edf5a43acc796ff03fd066040353dee93c96","title":"Correct engine response example fields in prompt","description":"Prompt example uses critical/fumble fields but engine returns is_critical/is_fumble; could mislead model output expectations.","acceptance_criteria":"- Update game_engine_instruction.md response example to match DiceResult.to_dict() keys\n- Verify other examples align with protocol output schema","status":"closed","priority":3,"issue_type":"bug","created_at":"2025-12-18T22:05:49.940053-08:00","updated_at":"2025-12-25T14:12:17.069002-05:00","closed_at":"2025-12-25T14:12:17.069002-05:00","source_repo":"."}
{"id":"worktree_worker4-if1","content_hash":"584e42ffa73ebfd072f57168bf6d1ef63f1c7425932b7c2c7e5bdc37bb2b1ee1","title":"Fix planning_block schema vs prompt mismatch (Phase 1 choices empty)","description":"`mvp_site/llm_providers/provider_utils.py`'s `NARRATIVE_RESPONSE_SCHEMA` sets `planning_block.choices.minProperties = 1`, but `mvp_site/prompts/game_state_instruction.md` Phase-1 combat example shows `\"choices\": {}` while awaiting dice. If any provider/model enforces the JSON schema, Phase 1 responses (or examples) can be invalid.\n\nDecide on one:\n- Relax schema to allow empty choices in Phase-1 (e.g., `minProperties` removed or conditional), OR\n- Update prompt/examples to always include at least one placeholder choice even in Phase-1, OR\n- Split schema by phase / add `awaiting_dice` flag and conditionally validate.\n","acceptance_criteria":"- Prompt examples and enforced JSON schema are consistent.\n- Phase-1 'awaiting dice' responses validate under the chosen schema.\n- Add/adjust a unit test to catch regression for empty choices in Phase 1.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T19:01:56.013568-08:00","updated_at":"2025-12-18T19:13:04.270236-08:00","closed_at":"2025-12-18T19:13:04.270236-08:00","source_repo":"."}
{"id":"worktree_worker4-ii5","content_hash":"215c1d2cae128fd8da7a52817036a963303a5eaa58282d8612583a3b473baa50","title":"Update RCA/docs to reflect story_history metadata as root cause","description":"Revise investigation docs (context_overflow* and timeline_log_claims) to correct the root cause: story_history metadata bloat, not entity tracking or timeline_log. Remove/replace the 4x entity reserve claim, summarize real measurements (story_history ~70K -\u003e ~26K; entity_tracking ~47), and note current mitigation (ESSENTIAL_STORY_FIELDS stripping, npc_data excluded).","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-08T23:27:51.916027-05:00","updated_at":"2025-12-08T23:35:14.564125-05:00","closed_at":"2025-12-08T23:35:14.564125-05:00","source_repo":".","labels":["context-budget","docs","rca"]}
{"id":"worktree_worker4-j1d","content_hash":"95005c812c2bf40cf4b6eb400d9b96a19ac0f8c16adba8d28287b00b60137cbb","title":"E2E Evidence: Add SHA256 for all evidence files","description":"Currently only combat_agent_e2e_test.json is hashed. raw_mcp_responses.jsonl has no hash/signature, making it not tamper-evident.\n\nFix: Generate SHA256 for all evidence files in the bundle:\n- combat_agent_e2e_test.json ✓ (already done)\n- raw_mcp_responses.jsonl (missing)\n- app.log (if included)\n- provenance.json (if included)","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-26T15:28:37.582223-05:00","updated_at":"2025-12-26T15:32:55.642955-05:00","closed_at":"2025-12-26T15:32:55.642955-05:00","source_repo":".","labels":["evidence","security","testing"]}
{"id":"worktree_worker4-jp2","content_hash":"f777e8e0167edcc3ede1dd10faee3f7baee428f59076b04993b9bf9c8fd9442b","title":"Gemini provider JSON-first alignment and cleanup","description":"Fix Gemini 2.x provider to align with JSON-first tool_requests flow and address review items:\n- Switch generate_content_with_tool_loop to JSON-first schema call (tools=None) + tool_requests execution + second JSON call; ensure Phase 2 passes built history as contents.\n- Handle tool messages properly; remove system_instruction types.Part misuse (pass string); add defensive tool validation; move inline imports (execute_dice_tool, json) to module scope.\n- Update docstrings to reflect two-phase behavior; remove sys.path hacks/new test file policy violations by relocating tests to existing files; clean unused imports/vars in Gemini tests.\n- Replace regex salvage in json_utils only if Gemini path can still emit malformed JSON (coordinate with planning_block task).\nTests: add/adjust Gemini E2E to cover non-dice turn schema compliance and history passing.\n","notes":"## Analysis by c2 (2025-12-14)\n\n**Items Already Addressed:**\n1. ✅ JSON-first tool_requests flow - `generate_content_with_tool_requests()` (lines 288-392)\n2. ✅ system_instruction passes string directly (line 124)\n3. ✅ Defensive tool validation in `execute_tool_requests()` (lines 206-228)\n4. ✅ Module-scope imports (json line 9, execute_dice_tool line 17)\n5. ✅ Two-phase docstrings (lines 296-314)\n6. ✅ Bracket-aware parsing in json_utils for malformed JSON safety net\n\n**Systemic Issues (Not Gemini-specific):**\n- sys.path hacks: Present in 133 test files codebase-wide\n- Test relocation would require larger refactoring effort\n\n**Recommendation:** Close jp2 as substantially complete. sys.path cleanup is a separate codebase-wide refactoring task.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-13T20:04:51.976245-05:00","updated_at":"2025-12-14T16:35:14.567079-08:00","closed_at":"2025-12-14T16:35:14.567079-08:00","source_repo":"."}
{"id":"worktree_worker4-jqy","content_hash":"4390a39d73be649752981a54c255c2b984c9dd9c64ea7ab3c7a5865982b40372","title":"Add XSS security warning to god mode documentation","description":"Example code in docs/god_mode_validation_recovery.md Lines 58-74 and docs/god_mode_implementation_complete.md Lines 173-189 uses innerHTML without sanitization. Add disclaimer about using textContent/DOMPurify in production.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-01T00:21:45.845625-08:00","updated_at":"2025-12-01T00:21:45.845625-08:00","source_repo":".","labels":["P2","documentation","pr-2082"]}
{"id":"worktree_worker4-kln","content_hash":"ecc6e5dfff0899cf893e5af1f95d3ef629a004b755ec792d4645cf62258abcc5","title":"Inline re import violation in validation_recovery.py","description":"import re inside method at mvp_site/validation_recovery.py Line 69-70 violates CLAUDE.md standards. Must move to module level.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-01T00:21:45.846045-08:00","updated_at":"2025-12-01T00:21:45.846045-08:00","closed_at":"2025-11-23T15:59:06.173342-08:00","source_repo":".","labels":["P1","pr-2082","standards"]}
{"id":"worktree_worker4-l7u","content_hash":"3c70a031b0f40f0ec8d334373105363cc1ca472a1730efd069da5c7214d43c2b","title":"Add canonical item IDs to player inventory/equipment schema","description":"Introduce stable item identifiers (e.g., item_id + optional instance_id) in player_character_data equipment/resources so validation can use IDs instead of names. Update prompts/schemas and tests to enforce ID usage.","acceptance_criteria":"- Item schema includes item_id (and instance_id if needed) for weapons/armor/consumables\n- player_character_data.equipment and resources.consumables use item_id for validation/matching\n- game_state_instruction.md updated to require ID-based inventory validation\n- Inventory validation test updated to prefer IDs and fail when IDs are missing or mismatch\n- Backward compatibility: name-only items still tolerated or migrated without breaking existing saves","notes":"**Evaluation (2025-12-28):**\n\nVALID but LOW PRIORITY - Current name-based validation works (10/10 tests pass in PR #2684).\n\n**Why not now:**\n1. LLMs work with natural language, not IDs\n2. Would require schema migration for all existing campaigns  \n3. Current approach catches cheats via narrative analysis + cheat indicators\n4. No immediate bugs or failures from name-based matching\n\n**When to revisit:**\n- If false positives/negatives become a pattern\n- When building item database/compendium feature\n- If implementing strict combat log parsing\n\nKeep as future enhancement, not current blocker.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-28T01:46:09.149145-05:00","updated_at":"2025-12-28T01:47:35.972163-05:00","source_repo":"."}
{"id":"worktree_worker4-m5p","content_hash":"a89679dc4652626e1e59d825bb87fff604eec3dcf60f78b3130160eadf79051c","title":"Schema bypass from Phase-2 skip optimization","description":"Commit 0c915737c skips Phase 2 whenever Phase 1 JSON parses, without any schema/required-field validation. This lets syntactically-valid but incomplete responses (missing planning_block, session_header, dice results, etc.) reach clients, reintroducing missing-field regressions. Restore validation: require schema/required fields before skipping; otherwise fall back to Phase 2.","status":"closed","priority":1,"issue_type":"bug","assignee":"code","created_at":"2025-12-17T20:26:48.865763-08:00","updated_at":"2025-12-17T20:32:26.828398-08:00","closed_at":"2025-12-17T20:32:26.828398-08:00","source_repo":".","labels":["p0","pr-2353","schema","validation"]}
{"id":"worktree_worker4-mpe","content_hash":"a3fadb5b2ae6f19ca756684ac7a8a1e03aca17e1e40fc21e8fcaf6551ed45fca","title":"PR2353: Align tool_requests schema enum with implemented dice tools","description":"`mvp_site/llm_providers/provider_utils.py` NARRATIVE_RESPONSE_SCHEMA.tool_requests.tool.enum currently lists 4 tools, but `mvp_site/game_state.py` implements an additional tool `declare_no_roll_needed`.\n\nGoal: update schema enum (and any related docs/tests) so schema matches implementation and models can use declare_no_roll_needed without schema mismatch.\n\nPR: #2353","notes":"Assigned to CodevSchema. Status check: agent has urgent ACK/registration requests pending; no findings delivered yet.","status":"closed","priority":1,"issue_type":"task","assignee":"CodevSchema","created_at":"2025-12-18T20:47:20.575372-08:00","updated_at":"2025-12-18T21:07:54.819373-08:00","closed_at":"2025-12-18T21:07:54.819373-08:00","source_repo":"."}
{"id":"worktree_worker4-ms2","content_hash":"927bccbd07c23cb84f7488357dfd9b07e18a81fd0fbb22a94f2d8fd782861f6e","title":"Document rate limiter memory storage limitation","description":"memory:// storage at mvp_site/main.py Lines 235-236 not suitable for multi-worker production. Add comment explaining dev-only limitation.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-01T00:21:45.846505-08:00","updated_at":"2025-12-01T00:21:45.846505-08:00","source_repo":".","labels":["P2","documentation","pr-2082"]}
{"id":"worktree_worker4-np8","content_hash":"94066c5b1d304d0c8d9ed75794b94e6c81a948e8a660839ec4a76c08f089ad25","title":"Unified Two-Phase Dice Architecture - Revert to Tool Loops","description":"Revert pre-computed dice approach back to LLM-driven tool loops. All providers use two-phase inference where LLM decides what dice to roll, server executes, LLM narrates result.\n\nKey insight: Gemini can use function calling, just not WITH JSON mode simultaneously. Solution: Phase 1 with tools (no JSON), Phase 2 with JSON (no tools).\n\nRoadmap: roadmap/unified_two_phase_dice_architecture.md","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-11T10:17:58.910614-05:00","updated_at":"2025-12-13T14:06:09.290726-05:00","closed_at":"2025-12-13T14:06:09.290726-05:00","source_repo":".","labels":["architecture","dice","pr-2353","tool-loops"]}
{"id":"worktree_worker4-od8","content_hash":"ca19735c308129187d30efeed5097356bea43fdd7df7d88e79626bfdfcf5f947","title":"Implement tiered entity importance system","description":"Create a scoring system to prioritize entities by relevance:\n- +10 if mentioned in player's current input\n- +5 if appeared in last 3 turns  \n- +3 if in current location\n- +1 if in active quest\n\nOnly include top N entities in entity_tracking_data based on score.\n\nThis is a medium-sized refactor affecting entity_preloader.py and llm_service.py.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-07T23:13:15.870699-05:00","updated_at":"2025-12-07T23:13:15.870699-05:00","source_repo":".","labels":["architecture","context-budget","entity-tracking"],"dependencies":[{"issue_id":"worktree_worker4-od8","depends_on_id":"worktree_worker4-a76","type":"blocks","created_at":"2025-12-07T23:13:26.924903-05:00","created_by":"daemon"}]}
{"id":"worktree_worker4-pwm","content_hash":"8fc3db22f5eacbbf2dfc3b2c240913f48d12a8629d141a50d7dc7b3388b4e95d","title":"Ensure engine-processed narrative is used when structured_response exists","description":"When mechanics is enabled, narrative_text is rewritten with engine results but LLMResponse is created from structured_response without passing the updated narrative, so engine output is dropped.","acceptance_criteria":"- When engine processing occurs, pass updated narrative_text into LLMResponse.create_from_structured_response (initial_story + continue_story)\n- Add/adjust tests to cover structured_response path with engine blocks\n- Verify narrative returned to caller includes engine replacements","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-18T22:05:38.294916-08:00","updated_at":"2025-12-18T22:05:38.294916-08:00","source_repo":"."}
{"id":"worktree_worker4-qsu","content_hash":"b2e2dcde0887268db9adac91424a41f9cdba1919f53dc6f419f919fc0d09667c","title":"Document arc_milestones timestamp design (ISO vs in-game time)","description":"Arc milestone timestamps use real-world ISO times (2025-12-24) while world_time is 1492-DR. Need to confirm this is by design and document in PR to avoid \"timestamp mismatch\" confusion.","acceptance_criteria":"- Design decision documented: arc completion uses real-world timestamps, world_time uses in-game time\\n- Added to PR description or code comments","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-24T17:02:52.371131-05:00","updated_at":"2025-12-24T17:02:52.371131-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker4-qsu","depends_on_id":"worktree_worker4-2pc","type":"blocks","created_at":"2025-12-24T17:02:52.371663-05:00","created_by":"daemon"}]}
{"id":"worktree_worker4-rnh","content_hash":"d978531102ec10d860188513f42214ba6c93a159337cf6b8856e9674ab34f9f6","title":"Align llm_integration formatter with actual engine response keys","description":"format_result_for_narrative expects damage_dealt/initiative_order/death_save_result, but engine returns damage/order/successes+failures. This can lead to missing or misleading inline output.","acceptance_criteria":"- Update formatter to handle current response schema (damage, order, death save fields)\n- Add tests for formatted output for attack, damage, initiative, death save\n- Remove or support legacy keys if needed","status":"closed","priority":2,"issue_type":"bug","assignee":"c3","created_at":"2025-12-18T22:05:44.880332-08:00","updated_at":"2025-12-18T22:24:51.658331-08:00","closed_at":"2025-12-18T22:24:51.658331-08:00","source_repo":"."}
{"id":"worktree_worker4-rys","content_hash":"0970327054deaee612b5e730debe8824ed6726426049eecd0299eca5dbebd07b","title":"Evaluate PR #2384 and cherry-pick decision","description":"Review PR https://github.com/jleechanorg/worldarchitect.ai/pull/2384 (schema enforcement, provider fixes) and decide whether to cherry-pick onto fix/cerebras-json-schema. Summarize benefits/risks and action taken.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-10T03:23:01.195448-05:00","updated_at":"2025-12-10T03:24:28.701628-05:00","closed_at":"2025-12-10T03:24:28.701628-05:00","source_repo":".","labels":["decision","pr-2384","structured-output"]}
{"id":"worktree_worker4-sn2","content_hash":"d3dbb63e2c11ead660ed4ca6c389da10cc7b2f07475da446fb148483a3472451","title":"BUG: clock_skew_credentials.py blocks test collection on import","description":"**Problem:**\n`world_logic.py` imports `clock_skew_credentials` and calls `apply_clock_skew_patch()` at module level (line 35). This triggers `validate_deployment_config()` which raises `ValueError` if `WORLDAI_GOOGLE_APPLICATION_CREDENTIALS` is set without `WORLDAI_DEV_MODE=true`.\n\n**Impact:**\n- Test collection fails for any test that imports `world_logic`\n- CI \"passes\" because CI doesn't have the env var - tests never run\n- Local devs with service account keys cannot run tests without setting extra env vars\n\n**Files Affected:**\n- `mvp_site/clock_skew_credentials.py:40-44` - The raising code\n- `mvp_site/world_logic.py:35` - Module-level call to `apply_clock_skew_patch()`\n- `mvp_site/tests/test_game_state.py:88` - Import fails here\n\n**Root Cause:**\nValidation logic runs at import time, not runtime. This is a design flaw - module imports should NEVER raise based on env vars.\n\n**Fix Required:**\n1. Make `validate_deployment_config()` return status, not raise\n2. OR defer validation until actual Firebase operation\n3. OR respect `TESTING=true` to skip validation entirely","acceptance_criteria":"- [ ] Tests can be collected without WORLDAI_DEV_MODE\n- [ ] TESTING=true bypasses clock skew validation\n- [ ] test_game_state.py runs in CI\n- [ ] Local devs can run tests with service account keys","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-11T06:01:18.00365-05:00","updated_at":"2025-12-11T06:03:03.560481-05:00","closed_at":"2025-12-11T06:03:03.560481-05:00","source_repo":".","labels":["bug","p0","testing"],"dependencies":[{"issue_id":"worktree_worker4-sn2","depends_on_id":"worktree_worker4-1hz","type":"related","created_at":"2025-12-11T06:01:23.566645-05:00","created_by":"daemon"}]}
{"id":"worktree_worker4-tey","content_hash":"d681b3a07082d38f40389bcd9474ea9d153c45c7159d649e5789fcb2c9ecc0de","title":"PR2353: Fix Cerebras/OpenRouter model lists + token tables (gpt-oss-120b etc.)","description":"Cursor flagged that `gpt-oss-120b` is documented/used in UI but missing or inconsistent across:\n- `mvp_site/constants.py` `ALLOWED_CEREBRAS_MODELS`\n- `MODEL_CONTEXT_WINDOW_TOKENS` and `MODEL_MAX_OUTPUT_TOKENS`\n- `mvp_site/templates/settings.html` options\n\nGoal: either remove invalid UI options OR add model consistently to allowed list + token tables. Ensure infer_provider/model selection behaves correctly and no silent fallback.\n\nPR: #2353","notes":"Assigned to CodevModels. Status check: agent has urgent ACK/registration requests pending; no findings delivered yet.","status":"closed","priority":1,"issue_type":"task","assignee":"CodevModels","created_at":"2025-12-18T20:47:20.430604-08:00","updated_at":"2025-12-18T21:07:54.229349-08:00","closed_at":"2025-12-18T21:07:54.229349-08:00","source_repo":"."}
{"id":"worktree_worker4-thg","content_hash":"774950eb3f021eed94654080309e5592d62161f43334909a4c8145c91b3c46a6","title":"Investigate Cerebras empty narrative / {\"type\":\"object\"} responses","description":"Reproduce and debug the Cerebras (zai-glm-4.6) empty narrative issue where raw response is {\"type\":\"object\"}. Determine if parsing, provider bug, or prompt change with stripped story_history. Try provider swap (Gemini) for comparison, capture raw response bodies, and propose mitigation (fallback provider or response validation).","notes":"Partial finding: Empty `{\"type\":\"object\"}` responses are TRANSIENT.\n\nEvidence:\n- Same campaign (VqqJL) tested twice on S1\n- First test (02:37 UTC): narrative_len=0, raw_response=`{\"type\":\"object\"}`\n- Second test (04:28 UTC): narrative_len=1876 ✅\n\nThis is NOT a code bug - it's intermittent Cerebras API behavior. Consider:\n1. Adding retry logic on empty/malformed responses\n2. Response validation before accepting\n3. Fallback to Gemini if response is garbage\n\nKeep open to implement mitigation.","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-08T23:28:00.495572-05:00","updated_at":"2025-12-08T23:29:59.875629-05:00","source_repo":".","labels":["cerebras","llm-response","regression"]}
{"id":"worktree_worker4-tsh","content_hash":"5874a28fac498e3bac6867877592da7f0d52b3f52c1b85d2059a998d205e5766","title":"Capture raw JSON responses per action in evidence","description":"Current arc_completion_natural.json is synthesized report (script output). No raw process_action responses or debug payloads included. External reviewer can't independently verify \"no OOC/GOD_MODE\" or confirm structured JSON came directly from the model.","acceptance_criteria":"- Raw JSON response from each process_action saved\\n- Raw JSON from get_campaign_state saved\\n- Each response hashed individually\\n- Reviewer can verify no GOD_MODE commands in payloads","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T17:02:50.020656-05:00","updated_at":"2025-12-24T20:31:49.956308-05:00","closed_at":"2025-12-24T20:31:49.956308-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker4-tsh","depends_on_id":"worktree_worker4-2pc","type":"blocks","created_at":"2025-12-24T17:02:50.021219-05:00","created_by":"daemon"}]}
{"id":"worktree_worker4-uz5","content_hash":"2eb5c56816134fede979e040b459fff1bb6dd8e7dcb8f695b7221e8825e64cab","title":"Persist game_state/core memories so LW updates don't lose critical plot facts","description":"Living World updates assume wrong facts (e.g., Flaming Fist thinks player dead) because full transcript is truncated and no game_state/core_memories are persisted to Firestore for campaign STpjRuwjeUt97tpCl5nK. Firestore shows empty game_states subcollection and story entries lack state_updates/game_state. Need durable storage of key state (core_memories, world_events, npc status) so LW step can read canonical facts after long runs/reloads.","acceptance_criteria":"- Campaign runs persist a serialized game_state (or at minimum core_memories + world_events + npc status) to Firestore per turn or at defined checkpoints.\n- story entries or game_states collection include state_updates or core_memories so critical plot facts survive truncation.\n- LW generation uses persisted state on subsequent turns/reloads and does not contradict prior captured facts in a regression test.\n- Add a regression test or replay harness that demonstrates the Horgus capture -\u003e LW event respects it.","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-27T14:42:51.008057-05:00","updated_at":"2025-12-27T14:42:51.008057-05:00","source_repo":"."}
{"id":"worktree_worker4-vdz","content_hash":"f01a584de551e46355d79e6b117358cf73fb41488c05468fc499b09e8f5186ed","title":"Unsafe type conversion in validation_recovery.py crashes recovery","description":"Direct int() casts without try/except at mvp_site/validation_recovery.py Lines 116-156 will crash on invalid types. Add try/except for defensive conversion.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-01T00:21:45.846924-08:00","updated_at":"2025-12-01T00:21:45.846924-08:00","closed_at":"2025-11-23T15:59:07.890132-08:00","source_repo":".","labels":["P1","crashes","pr-2082"]}
{"id":"worktree_worker4-xke","content_hash":"ac78420064167907f7bd83d86c70be23f834eb1bf7af01154c9291c1a0d94c55","title":"Add social encounter E2E tests for Intimidation/Deception and wire into CI","description":"Extend social encounter real API tests to cover Intimidation and Deception roll_skill_check calls, and enable these tests in CI/nightly so regressions are caught automatically.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T02:47:53.396259-08:00","updated_at":"2025-12-17T21:31:39.837868-08:00","closed_at":"2025-12-17T21:31:39.837868-08:00","source_repo":"."}
{"id":"worktree_worker4-xzu","content_hash":"c7db9cf237b6ff7f9826c7d3a129baed739857ea9c646b5f73e3590607ca9e47","title":"Combat: Defeated enemies not removed from combatants dict","description":"After combat ends (in_combat: false), get_campaign_state shows enemies remaining in combatants dict with HP \u003e 0, even though they're listed in enemies_defeated.\n\nEvidence: /tmp/combat_xp_e2e_run_20251226173347_full/\n- combat_state.combatants still contains npc_goblin_002 (hp: 7), npc_goblin_003 (hp: 7)\n- combat_summary.enemies_defeated lists all 3 goblins\n\nServer-side cleanup should either:\n1. Set hp_current: 0 for defeated enemies, OR\n2. Remove defeated enemies from combatants dict\n\nCurrently neither happens, causing state inconsistency.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-26T15:28:37.030105-05:00","updated_at":"2025-12-26T15:42:44.907403-05:00","closed_at":"2025-12-26T15:42:44.907403-05:00","source_repo":".","labels":["cleanup","combat","pr-2553","state-management"]}
{"id":"worktree_worker4-z5h","content_hash":"fb268bc69b8f7deb89048e44b851b0909673b9e75f1c717b1f92e642326d20e4","title":"Verify context fix \u0026 narrative on VqqJL campaign (dev vs s1)","description":"Reproduce the mature campaign VqqJLpABua9bvAG4ArTg turn on both dev and s1 with the latest context-stripping code. Capture actual request payload token breakdowns (story_history, entity_tracking, game_state, total) and provider raw responses. Confirm non-empty narrative/choices with the same provider. Clarify whether npc_data is excluded in the request or re-added later. Confirm dev deploy is the same commit as s1.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-08T23:26:39.762707-05:00","updated_at":"2025-12-08T23:29:59.403891-05:00","closed_at":"2025-12-08T23:29:59.403891-05:00","source_repo":".","labels":["context-budget","entity-tracking","regression"]}
{"id":"worktree_worker4-z74","content_hash":"96c0906d5e50f7f2f57e33aa74e2f0ffec34868ef0e35e84ba2f03a67e6bc173","title":"Fix combat prompt schema to stay name-keyed (remove id-based initiative guidance)","description":"User does NOT want combat state migration. New combat prompt docs currently show initiative_order entries with `id` and note that ids must match combatants keys. Backend expects name-keyed combatants and matches initiative entries by `name`, dropping ids during normalization. This mismatch can leave defeated enemies stuck in initiative_order and break cleanup. Update prompt examples/notes to use name keys only and clarify that initiative_order[].name must match combatants dict keys. Files: mvp_site/prompts/combat_system_instruction.md, mvp_site/prompts/game_state_instruction.md.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-24T10:51:15.216297-05:00","updated_at":"2025-12-24T16:58:17.373368-05:00","closed_at":"2025-12-24T16:58:17.373368-05:00","source_repo":"."}
{"id":"worktree_worker4-zca","content_hash":"928e8f023cae49fa1b29b50e01181d66a272671ded7c2dde83e8c6ee87213b6f","title":"Instrument and capture request payloads for budget checks","description":"Add or run instrumentation to persist per-run token breakdowns and serialized LLMRequest payloads for targeted campaigns (including VqqJL) across dev and s1. Goal: attach actual request bodies and token counts (story_history, entity_tracking, game_state, total) to beads, not just log excerpts. Provide a repeatable script/command to gather these snapshots.","notes":"**COMPLETED: S1 payload captured and documented**\n\n**Artifact:** `/tmp/worldarchitect.ai/continue_camp5/s1_payload_capture.json`\n\n**Content summary:**\n```json\n{\n  \"success\": true,\n  \"narrative_len\": 1531,\n  \"sequence_id\": 138,\n  \"planning_choices\": [\"depart_immediately\", \"examine_equipment_closer\", ...]\n}\n```\n\n**Repeatable command:**\n```bash\ncurl -s -X POST https://mvp-site-app-s1-754683067800.us-central1.run.app/mcp \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"jsonrpc\":\"2.0\",\"id\":1,\"method\":\"tools/call\",\"params\":{\"name\":\"process_action\",\"arguments\":{\"campaign_id\":\"VqqJLpABua9bvAG4ArTg\",\"user_id\":\"vnLp2G3m21PJL6kxcuAqmWSOtm73\",\"user_input\":\"What do I see?\"}}}'\n```\n\n**Token breakdown from logs:**\n```\nENTITY_TRACKING_SIZE: 47tk (reserve was 10500tk)\nGAME_STATE_BREAKDOWN: npc_data=162tk (EXCLUDED), world_data=77tk, player_data=109tk\nLLMREQUEST_PAYLOAD: story_history=26684tk, total_payload=30776tk\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-08T23:27:56.214509-05:00","updated_at":"2025-12-09T09:50:18.473082-05:00","closed_at":"2025-12-08T23:35:14.062806-05:00","source_repo":".","labels":["context-budget","instrumentation","observability"]}
{"id":"worktree_worker4-zpb","content_hash":"6f30a4246fe80e6b3ca8642529dc13cf62deaafa5f382bac546c0c266b90d211","title":"RewardsAgent: Process XP/level-ups for non-combat encounters","description":"## Problem\n\nCombatAgent only triggers when `combat_state.in_combat = true`, but many narrative encounters deserve XP rewards:\n- Successful heists/thievery\n- Social manipulation victories (Persuasion/Deception rolls)\n- Completing story objectives\n- Defeating enemies through non-combat means (soul harvesting, poison, traps)\n- Escaping dangerous situations\n\nCurrently, users must manually request XP in \"God Mode\" for these achievements.\n\n**Additionally**, combat rewards sometimes don't trigger even when combat ends properly.\n\n## Evidence\n\n**Campaign: Nocturne bg3 after**\n- Player stole from noble Horgus, framed another person, escaped\n- Had to manually request: \"give it to me and a bunch of exp for the narrative events\"\n- Then manually request: \"process my level up\"\n\n**Campaign: Sariel killer**\n- Combat ended but rewards didn't process (investigating)\n\n## Goal: Unified Rewards Processing\n\n**Share code between CombatAgent and RewardsAgent:**\n1. RewardsAgent handles ALL reward processing (combat + non-combat)\n2. CombatAgent triggers RewardsAgent at combat end\n3. Single code path for XP, loot, level-up processing\n4. Consistent archival pattern for both combat_history and encounter_history\n\n## Implementation Pattern\n\n```python\nclass RewardsAgent(BaseAgent):\n    \"\"\"Triggers when rewards are pending from any source\"\"\"\n    \n    @classmethod\n    def matches_game_state(cls, game_state):\n        # Check for pending rewards (combat or encounter)\n        if game_state.get_rewards_pending():\n            return True\n        # Check for completed combat needing reward processing\n        combat_state = game_state.get_combat_state()\n        if (combat_state.get(\"combat_phase\") == \"ended\" \n            and combat_state.get(\"combat_summary\")):\n            return True\n        # Check for completed encounters\n        encounter_state = game_state.get_encounter_state()\n        return encounter_state.get(\"encounter_completed\", False)\n```\n\n## Acceptance Criteria\n\n- [ ] RewardsAgent processes combat end rewards (shared with CombatAgent)\n- [ ] Non-combat encounters automatically process XP when completed\n- [ ] Level-ups are offered when XP threshold reached\n- [ ] Single code path for all reward processing\n- [ ] encounter_history and combat_history use same archival pattern","design":"## Design: RewardsAgent (Unified Rewards Processing)\n\n### Core Goal\n**Share code with CombatAgent** - RewardsAgent should handle ALL reward processing, including combat end rewards. CombatAgent triggers RewardsAgent at combat end rather than processing rewards itself.\n\n### Architecture Options\n\n**Option A: RewardsAgent triggers at combat end**\n```\nCombatAgent (combat_phase: active) → combat ends → RewardsAgent activates\n                                                    ↓\n                                            Process XP, loot, level-up\n```\n\n**Option B: Shared RewardsProcessor utility**\n```\nCombatAgent ──────┐\n                  ├──→ RewardsProcessor.process_rewards()\nRewardsAgent ─────┘\n```\n\n### Trigger Mechanism\nLike CombatAgent checks `in_combat`, RewardsAgent checks for pending rewards:\n\n1. **Combat end**: `combat_phase == \"ended\"` AND `combat_summary.xp_awarded`\n2. **Encounter end**: `encounter_state.encounter_completed == true`\n3. **Milestone**: `rewards_pending` exists in game_state\n\n### Agent Selection Priority\n1. GodModeAgent (explicit override)\n2. CombatAgent (in_combat = true, combat_phase = active)\n3. **RewardsAgent** (rewards pending from combat OR encounter) ← NEW\n4. StoryModeAgent (default)\n\n### State Schema\n\n```python\n# Unified rewards_pending (used by both combat and non-combat)\nrewards_pending: {\n    \"source\": \"combat\" | \"encounter\" | \"quest\" | \"milestone\",\n    \"source_id\": str,  # combat_session_id or encounter_id\n    \"xp\": int,\n    \"gold\": int,\n    \"items\": [...],\n    \"level_up_available\": bool\n}\n\n# encounter_state (new, mirrors combat_state pattern)\nencounter_state: {\n    \"encounter_active\": bool,\n    \"encounter_id\": str,\n    \"encounter_type\": \"heist\" | \"social\" | \"stealth\" | \"puzzle\" | \"quest\",\n    \"difficulty\": \"easy\" | \"medium\" | \"hard\" | \"deadly\",\n    \"participants\": [...],\n    \"encounter_completed\": bool,\n    \"encounter_summary\": {...}  # Like combat_summary\n}\n```\n\n### Prompt Focus\n- XP calculation rules (CR-to-XP for defeated, milestone XP for objectives)\n- Level-up processing and spell/feature selection\n- Loot distribution\n- State cleanup after rewards processed\n\n### Archival Pattern (Same as Combat)\nAt next action START in `_prepare_game_state()`:\n1. Check if `rewards_pending` exists\n2. Archive to `rewards_history[]`\n3. Clear `rewards_pending`\n4. Process level-up if threshold reached","acceptance_criteria":"- Non-combat encounters automatically process XP when completed\n- Level-ups are offered when XP threshold reached  \n- Works alongside CombatAgent (combat still uses existing flow)\n- Narrative kill/defeat triggers reward processing\n- encounter_history archives completed encounters","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-26T22:44:08.372316-05:00","updated_at":"2025-12-26T22:48:09.415702-05:00","source_repo":".","labels":["agent","non-combat","rewards","xp"]}
