{"id":"worktree_worker2-3gc","content_hash":"9cf95aacfa1d8e27e9af55a90e5aadaef14ce78afe3deb727e5b7b41ee53f2c1","title":"Finished combat phase lists inconsistent across enforcement and agent triggers","description":"finished_phases differ between RewardsAgent/GameState and server enforcement. RewardsAgent/GameState include {ended, concluding, concluded, finished, complete, completed, resolved, victory}, but _enforce_rewards_processed_flag uses only (ended, finished, resolved, complete, victory). If LLM sets phase like concluded/completed, enforcement won't set rewards_processed, risking duplicate processing or cleanup mismatches. See mvp_site/world_logic.py and mvp_site/agents.py/game_state.py.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-28T13:32:09.932832-05:00","updated_at":"2025-12-28T17:52:47.160195-05:00","closed_at":"2025-12-28T17:52:47.160195-05:00","source_repo":"."}
{"id":"worktree_worker2-3uk","content_hash":"422931876ad801dae78031680dd48782bd157846061419a5a34e33a88481e403","title":"Connect REQUIRED_PROMPTS to PromptBuilder (single source of truth)","description":"Each agent class defines REQUIRED_PROMPTS in agents.py, but PromptBuilder in agent_prompts.py hard-codes the same prompts separately. This violates DRY.\n\nExample of duplication:\n- agents.py StoryModeAgent.REQUIRED_PROMPTS lists: master_directive, game_state, planning_protocol, dnd_srd\n- agent_prompts.py build_core_system_instructions() manually loads the same prompts\n\nProposed solution:\n- PromptBuilder should read from agent's REQUIRED_PROMPTS\n- Add build_instructions_for_agent(agent: BaseAgent) method\n- Agent classes become single source of truth for their prompt requirements\n\nImpact: Eliminates duplicate definitions, prevents desync bugs","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-03T22:35:16.735171-08:00","updated_at":"2026-01-03T22:35:16.735171-08:00","source_repo":".","labels":["centralization","high-effort","refactor"]}
{"id":"worktree_worker2-3v5","content_hash":"6604b3e09cd99ae778913589810e76a8700131fd80c85fc0c486ce185d59a8f7","title":"Unify mode builder methods into single generic builder","description":"Replace 6 duplicate build_*_mode_instructions() methods in agent_prompts.py with a single generic builder.\n\nCurrently there are 6 nearly identical methods (lines 359-546):\n- build_core_system_instructions\n- build_god_mode_instructions\n- build_info_mode_instructions\n- build_combat_mode_instructions\n- build_rewards_mode_instructions\n- build_think_mode_instructions\n\nAll follow the same pattern of appending prompt files to a list.\n\nProposed solution:\n```python\ndef build_mode_instructions(self, prompt_types: list[str], include_debug: bool = False) -\u003e list[str]:\n    parts = []\n    for prompt_type in prompt_types:\n        parts.append(_load_instruction_file(prompt_type))\n    if include_debug:\n        parts.append(_build_debug_instructions())\n    return parts\n```\n\nImpact: Reduces ~150 LOC, single point of maintenance","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-03T22:35:16.187395-08:00","updated_at":"2026-01-03T22:35:16.187395-08:00","source_repo":".","labels":["centralization","high-effort","refactor"]}
{"id":"worktree_worker2-a01","content_hash":"fa03676c2d3f1d8616d835c97f641fc719043ef1ea547848487f09e2c5dca2fe","title":"Remove manual planning_protocol additions (5 places)","description":"planning_protocol is manually added at 5 different places in agent_prompts.py:\n- Line 377 (build_core_system_instructions)\n- Line 434 (build_info_mode_instructions)\n- Line 471 (build_combat_mode_instructions)\n- Line 507 (build_rewards_mode_instructions)\n- Line 536 (build_think_mode_instructions)\n\nThis is a symptom of the broader duplication issue.\n\nDepends on: Unified mode builder implementation\n\nOnce REQUIRED_PROMPTS drives the builder, planning_protocol will be loaded automatically when it's in the agent's requirements.\n\nImpact: No more forgetting to add planning_protocol to new modes","status":"open","priority":3,"issue_type":"chore","created_at":"2026-01-03T22:35:18.894719-08:00","updated_at":"2026-01-03T22:35:18.894719-08:00","source_repo":".","labels":["centralization","low-effort","refactor"]}
{"id":"worktree_worker2-b1a","content_hash":"ea9105c8e92ec8cc85f7d3b8044fbdb0673db4bc4a85d428f2d9bb73f4018c62","title":"Add PROMPT_ORDER configuration to agent classes","description":"Each mode has a specific loading order (master directive MUST be first). This order is currently implicit in code across multiple methods.\n\nProposed solution:\nAdd explicit PROMPT_ORDER list to each agent class:\n```python\nclass CombatAgent(BaseAgent):\n    PROMPT_ORDER = [\n        constants.PROMPT_TYPE_MASTER_DIRECTIVE,  # 1st: authority\n        constants.PROMPT_TYPE_GAME_STATE,         # 2nd: schema\n        constants.PROMPT_TYPE_COMBAT,             # 3rd: mode-specific\n        ...\n    ]\n    INCLUDE_DEBUG = True\n```\n\nThe generic builder then uses this order.\n\nImpact: Explicit, documented ordering; easier to modify per-agent","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T22:35:17.273614-08:00","updated_at":"2026-01-03T22:35:17.273614-08:00","source_repo":".","labels":["centralization","medium-effort","refactor"]}
{"id":"worktree_worker2-bv9","content_hash":"5ef2128a688f44b7a4a03f358b44db65009d8a645c7150947a5ce9d456e3213e","title":"Fix LLM prompts to produce visible XP/level-up feedback","description":"Server-side level-up detection and combat turn processing work correctly, but LLM output doesn't always produce user-visible feedback.\n\n## Problems Identified\n\n1. **combat_summary missing**: LLM not generating combat_summary block with XP earned\n2. **No explicit XP text**: Narrative doesn't say \"You earned X XP!\" \n3. **Silent level-up**: Level increases without visible notification in narrative\n4. **Text prompts missing**: LLM uses structured planning_block but doesn't include \"Level up now/later?\" text\n\n## Evidence\n\n- combat_rewards_level_up: `combat_summary.present: false`, `level_up_detection.in_narrative: false`\n- narrative_xp_level_up: Level 4→5 silently, no rewards_pending shown\n- level_up_planning_block: `has_level_up_message: false`, `has_choice_prompt: false`\n\n## Root Cause\n\nPrompt instructions don't strictly require these outputs. LLM follows instructions loosely.","acceptance_criteria":"- [ ] combat_summary block generated after combat with XP earned\n- [ ] Narrative includes explicit \"You earned X XP\" or similar text\n- [ ] Level-up triggers visible notification in narrative (not silent)\n- [ ] Planning block includes text prompt for level-up choice\n- [ ] All test assertions pass with stricter criteria","status":"closed","priority":1,"issue_type":"bug","assignee":"claude","created_at":"2025-12-31T22:20:02.338634-08:00","updated_at":"2025-12-31T22:25:36.957433-08:00","closed_at":"2025-12-31T22:25:36.957433-08:00","source_repo":".","labels":["combat","level-up","llm-prompts","ux"]}
{"id":"worktree_worker2-cf9","content_hash":"4f325b5433956319daf0f325a0a358d87e0b4f18f5b6b70173fdc574b0ef9eee","title":"Centralize mode detection functions in constants.py","description":"is_think_mode() is already in constants.py, but GodModeAgent.matches_input() and InfoAgent detection logic are scattered in agents.py.\n\nCurrently:\n- constants.is_think_mode() - centralized ✓\n- GodModeAgent.matches_input() - inline in agents.py\n- InfoAgent pattern matching - INFO_QUERY_PATTERNS in agents.py\n- STORY_ACTION_VERBS - in agents.py\n\nProposed solution:\nMove all mode detection to constants.py:\n```python\n# constants.py\ndef is_god_mode(user_input: str) -\u003e bool:\n    return user_input.strip().upper().startswith(\"GOD MODE:\")\n\ndef is_info_query(user_input: str) -\u003e bool:\n    # Move INFO_QUERY_PATTERNS logic here\n    ...\n```\n\nImpact: Single location for all mode detection logic","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-03T22:35:17.829377-08:00","updated_at":"2026-01-03T22:35:17.829377-08:00","source_repo":".","labels":["centralization","low-effort","refactor"]}
{"id":"worktree_worker2-chu","content_hash":"ecf01102816b1f2a708e6f0bdab76ff4790970f1f5b3cc1ba707c6b1f0b622a2","title":"Reduce duplication between GOD_MODE_UPDATE_STATE and unified flow warnings/corrections","description":"Current code duplicates XP extraction + post-combat warning logic in world_logic (unified flow) and _handle_update_state_command. This risks drift and inconsistent behavior. Evaluate refactoring into a shared helper and ensure response schema consistency for GOD_MODE_UPDATE_STATE.","acceptance_criteria":"- A shared helper handles XP extraction + post-combat warning detection used by both paths\n- GOD_MODE_UPDATE_STATE response includes corrections/warnings consistently with unified flow\n- No behavior regressions in god mode validation tests","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-30T00:37:05.410663-05:00","updated_at":"2025-12-30T01:04:54.230407-05:00","closed_at":"2025-12-30T01:04:54.230407-05:00","source_repo":"."}
{"id":"worktree_worker2-dsq","content_hash":"61925bb8c084a0964fa739d2b554c35e67d006c1bd33ca7764b08298c60e3004","title":"RewardsAgent follow-up drops rewards_box (structured response not merged)","description":"When RewardsAgent follow-up runs in world_logic, only narrative text is appended to the original response. The structured response from rewards_response_obj (including rewards_box) is never merged into the unified response or stored structured_fields. This can cause API/Firestore to omit rewards_box even though rewards were generated. See mvp_site/world_logic.py around follow-up (REWARDS_FOLLOWUP) and structured_response extraction near response build.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-28T13:31:52.161357-05:00","updated_at":"2025-12-28T17:52:46.694158-05:00","closed_at":"2025-12-28T17:52:46.694158-05:00","source_repo":"."}
{"id":"worktree_worker2-ix3","content_hash":"a265f0c9baef8dbc64fd55490d6a75c87de894abc66ea4b342c64170c016ebe3","title":"Clean up unused parameter deletion pattern in agents","description":"All 6 agent classes delete the same unused parameters in build_system_instructions():\n\n```python\n# Lines 395-396, 506-508, 655-657, 765-767, 896-897\ndel selected_prompts, use_default_world, include_continuation_reminder, turn_number\ndel llm_requested_sections\n```\n\nThis is a code smell - the interface is too broad.\n\nOptions:\n1. Use **kwargs pattern for fixed-prompt agents\n2. Create FixedPromptAgent base class that ignores user selections\n3. Split interface: build_dynamic_instructions() vs build_fixed_instructions()\n\nImpact: Cleaner code, better type hints, self-documenting API","status":"open","priority":3,"issue_type":"chore","created_at":"2026-01-03T22:35:18.366132-08:00","updated_at":"2026-01-03T22:35:18.366132-08:00","source_repo":".","labels":["code-quality","low-effort","refactor"]}
{"id":"worktree_worker2-rqp","content_hash":"710b336be2044a052fa138b5d7005358a38c5fc7d1907dd40b9d8e4023700c57","title":"Encounter rewards can be marked processed without RewardsAgent trigger","description":"_enforce_rewards_processed_flag sets encounter_state.rewards_processed when encounter_summary.xp_awarded exists even if encounter_completed is false. RewardsAgent matches only when encounter_completed == true, so rewards can be marked processed and RewardsAgent never runs, losing user-visible rewards. See mvp_site/world_logic.py encounter enforcement and mvp_site/agents.py RewardsAgent.matches_game_state.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-28T13:32:01.158943-05:00","updated_at":"2025-12-28T17:52:46.219086-05:00","closed_at":"2025-12-28T17:52:46.219086-05:00","source_repo":"."}
{"id":"worktree_worker2-ulv","content_hash":"d795a05274feca9c5bde385a41d4702075c9f6f761df03aadb5c115ee27a5427","title":"RewardsAgent rewards output inconsistent (2/4 E2E fail; rewards_box/rewards_processed missing)","description":"E2E rewards test in /tmp/worktree_worker2/claude_implement-rewards-agent-ChnfS/rewards_e2e/20251228_020823/ shows 2/4 failures: combat end rewards_processed false despite combat_summary.xp_awarded, narrative kill returns empty narrative and rewards_processed false. Recent changes: rewards_box added to JSON schema and prompts; rewards_box optional; RewardsAgent prompt stack trimmed (no DND SRD/mechanics). Need root-cause analysis: state cleanup timing, schema enforcement, prompt clarity, and provider JSON-mode behavior. Goal: ensure rewards are user-visible and rewards_processed set even with format variations, without retries/validation.","notes":"Updated validation shows original 2/4 failure may be fixed, but new/adjacent issues remain: rewards are not user-visible (rewards_check.has_rewards_box=false in all scenarios, narrative indicators mostly 0), XP mismatches vs claims (e.g., scenario1 xp_awarded=150 not 50), and evidence capture is incomplete (server_logs.txt has 0 lines, rewards_e2e metadata missing origin/main + diff + server PID/port/env). Latest bundles checked: /tmp/worktree_worker2/claude_implement-rewards-agent-ChnfS/rewards_e2e/20251228_035005 and /20251228_032615. evidence.json has data under scenarios.*.steps; claims should reference those paths.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-28T02:22:06.70204-05:00","updated_at":"2025-12-28T17:52:47.637663-05:00","closed_at":"2025-12-28T17:52:47.637663-05:00","source_repo":"."}
{"id":"worktree_worker2-zjr","content_hash":"f83884974dd4586324ce064534ce8ebd1e8508df15de1b0b84f7474b19f9d021","title":"Centralize Planning Block Schema and Remove Duplication","description":"Centralize the planning_block schema and validation code to remove duplication across prompt files. Keep triggers separate (Think Mode = explicit THINK: prefix, Unprompted = LLM discretion).\n\n## Goal (Option A - Centralize Only)\n\n1. Single `PLANNING_BLOCK_SCHEMA` constant\n2. Single `planning_protocol.md` for structure rules\n3. Clean up unused function arguments\n4. **Keep triggers unchanged** - no merging of Think Mode and unprompted planning\n\n## NOT Doing (Removed from Scope)\n\n- ~~LLM-initiated enhanced planning~~ (keep unprompted at LLM discretion)\n- ~~Merge triggers~~ (Think Mode stays explicit)\n- ~~Intent field for time handling~~ (mode-based detection unchanged)\n\n## Files to Change\n\n- `narrative_response_schema.py` - Add PLANNING_BLOCK_SCHEMA\n- `prompts/planning_protocol.md` - New file, single source of structure rules\n- `think_mode_instruction.md` - Reference protocol, remove duplicate rules\n- `game_state_instruction.md` - Reference protocol, remove duplicate rules\n- `llm_service.py` - Clean up unused args","design":"## Architecture\n\n### Phase 1: Centralize Schema\n- Create `PLANNING_BLOCK_SCHEMA` in `narrative_response_schema.py`\n- All validation references this single definition\n\n### Phase 2: Unify Prompts\n- Create `planning_protocol.md` as the single source of planning rules\n- Update `think_mode_instruction.md` to reference it\n- Update `game_state_instruction.md` to reference it\n\n### Phase 3: Remove Unused Code\n- Clean up `_validate_and_enforce_planning_block` signature\n- Remove truly dead code paths\n- Consolidate detection logic\n\n### Phase 4: Always-On Planning\n- Remove requirement for THINK: prefix\n- LLM generates planning_block when appropriate\n- Frontend handles planning_block in any response","acceptance_criteria":"- [ ] Single `PLANNING_BLOCK_SCHEMA` definition\n- [ ] Single `planning_protocol.md` referenced by prompts\n- [ ] No duplicated planning rules across files\n- [ ] Unused function arguments removed\n- [ ] Tests pass\n- [ ] Triggers unchanged (Think Mode = explicit, Unprompted = LLM discretion)","notes":"## Progress (2026-01-04)\n\n### Phase 4 Groundwork Complete\n- `get_agent_for_input()` now accepts `mode` parameter\n- API clients can use `mode: \"think\"` without THINK: prefix\n- Frontend `think:return_story` handler fixed (sanitized ID comparison)\n\n### Bug Found \u0026 Fixed\n- `llm_validator.py` was missing `import re` (would cause NameError at runtime)\n\n### Roadmap Updated with Review Feedback\n- Added `intent` field (\"think\" | \"story\") to distinguish time handling\n- Renamed Phase 4: \"Unified Planning Features\" (not \"Always-On\")\n- Added dynamic schema injection via PromptBuilder\n- Added trigger guidelines (when/when-not)\n- Required think:return_story for spontaneous enhanced blocks\n- **Critical fix**: Time handling based on intent, NOT presence of planning_block\n\n### Commits\n- `3bbe919fb` - Fix Return to Story handler and API mode support\n- `8ac6484ef` - Add missing re import to llm_validator.py  \n- `cbc2f978a` - Incorporate review feedback into roadmap","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-03T18:49:55.810987-08:00","updated_at":"2026-01-03T19:36:08.455318-08:00","closed_at":"2026-01-03T19:36:08.455318-08:00","source_repo":".","labels":["centralization","refactor","think-mode"]}
