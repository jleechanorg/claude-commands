{"id": "BD-8k9", "content_hash": "b27344e80c924b8587ae573329145ac01d7b4edd5f060b8ead06a1d3ec75cbcf", "title": "Flask-Limiter dependency missing from requirements.txt", "description": "flask_limiter imported in mvp_site/main.py Line 79 but not in requirements.txt. Deployment will fail with ImportError.", "status": "open", "priority": 1, "issue_type": "bug", "created_at": "2025-11-23T13:26:07.763756-08:00", "updated_at": "2025-11-23T13:26:07.763756-08:00", "closed_at": null, "source_repo": ".", "labels": ["P0", "blocks-deployment", "pr-2082"]}
{"id": "BD-78a", "content_hash": "18ef41050f0d7872868ed8fa297701ebaf1854a445f361678c2d85a69c2c9ab0", "title": "Test auth bypass (X-Test-Bypass-Auth) removed breaks CI", "description": "Removed X-Test-Bypass-Auth in mvp_site/main.py Lines 334-335, 331-382 breaks test suite. CI/CD cannot run tests.", "status": "open", "priority": 1, "issue_type": "bug", "created_at": "2025-11-23T13:26:08.902485-08:00", "updated_at": "2025-11-23T13:26:08.902485-08:00", "closed_at": null, "source_repo": ".", "labels": ["P0", "blocks-testing", "pr-2082"]}
{"id": "BD-7wz", "content_hash": "b6fb29f5e19887cfd0ed957745ee05ce8e62d0cb0ae5e323e2ddd272cad82738", "title": "Rate limiter IP spoofing vulnerability - uses load balancer IP", "description": "mvp_site/main.py Lines 235-236, 246-253 uses load balancer IP instead of client IP. All users share one rate limit bucket causing global DoS. Fix: Use X-Forwarded-For with ProxyFix.", "status": "open", "priority": 1, "issue_type": "bug", "created_at": "2025-11-23T13:26:10.035154-08:00", "updated_at": "2025-11-23T13:26:10.035154-08:00", "closed_at": null, "source_repo": ".", "labels": ["P0", "pr-2082", "security"]}
{"id": "BD-kln", "content_hash": "c2e0782aff0a92f9ed9741840b6441eab087d9e012c9e25c04699e3a3cc04025", "title": "Inline re import violation in validation_recovery.py", "description": "import re inside method at mvp_site/validation_recovery.py Line 69-70 violates CLAUDE.md standards. Must move to module level.", "status": "closed", "priority": 1, "issue_type": "bug", "created_at": "2025-11-23T13:26:11.388033-08:00", "updated_at": "2025-11-23T15:59:06.173342-08:00", "closed_at": "2025-11-23T15:59:06.173342-08:00", "source_repo": ".", "labels": ["P1", "pr-2082", "standards"]}
{"id": "BD-vdz", "content_hash": "9799cbc3d78fd4956e48ce468a8a7efca48aa7f5f86708e106b837f022d6b7e5", "title": "Unsafe type conversion in validation_recovery.py crashes recovery", "description": "Direct int() casts without try/except at mvp_site/validation_recovery.py Lines 116-156 will crash on invalid types. Add try/except for defensive conversion.", "status": "closed", "priority": 1, "issue_type": "bug", "created_at": "2025-11-23T13:26:12.562354-08:00", "updated_at": "2025-11-23T15:59:07.890132-08:00", "closed_at": "2025-11-23T15:59:07.890132-08:00", "source_repo": ".", "labels": ["P1", "crashes", "pr-2082"]}
{"id": "BD-jqy", "content_hash": "d1a23c7fb106e2fd9ee09f90ba199a4c5eb9934c92d69d389e93ae902079aa24", "title": "Add XSS security warning to god mode documentation", "description": "Example code in docs/god_mode_validation_recovery.md Lines 58-74 and docs/god_mode_implementation_complete.md Lines 173-189 uses innerHTML without sanitization. Add disclaimer about using textContent/DOMPurify in production.", "status": "open", "priority": 2, "issue_type": "task", "created_at": "2025-11-23T13:26:13.782779-08:00", "updated_at": "2025-11-23T13:26:13.782779-08:00", "closed_at": null, "source_repo": ".", "labels": ["P2", "documentation", "pr-2082"]}
{"id": "BD-ms2", "content_hash": "6d95b2281dd5ddeb971280b3129083de5321b70fccbf7c5bb2c6f4116736960b", "title": "Document rate limiter memory storage limitation", "description": "memory:// storage at mvp_site/main.py Lines 235-236 not suitable for multi-worker production. Add comment explaining dev-only limitation.", "status": "open", "priority": 2, "issue_type": "task", "created_at": "2025-11-23T13:26:15.043282-08:00", "updated_at": "2025-11-23T13:26:15.043282-08:00", "closed_at": null, "source_repo": ".", "labels": ["P2", "documentation", "pr-2082"]}
{"id": "BD-9u7", "content_hash": "e774a8b3c0b75b1b9932b8e15e1f4f5a766f1fce3a3f15c8a4f7f6f417b3fe6b", "title": "Multiple validation error types support (V2 feature)", "description": "mvp_site/validation_recovery.py Lines 105-126 only extracts ONE HP error type. Current design intentional - handles one error type per response. Future enhancement to support multiple different error types.", "status": "closed", "priority": 3, "issue_type": "feature", "created_at": "2025-11-23T13:26:16.459718-08:00", "updated_at": "2025-11-23T15:59:09.608643-08:00", "closed_at": "2025-11-23T15:59:09.608643-08:00", "source_repo": ".", "labels": ["P3", "future", "pr-2082"]}
{"id": "worktree_worker4-7y4", "content_hash": "aa18ffd68db182998aa3a45a3f7991f5fd5fb5d57f7755288abc00d374bb7aaf", "title": "Refactor duplicate MCP HTTP handlers into single handler", "description": "mvp_site/mcp_api.py defines both DualMCPHandler and MCPHandler with overlapping /health and /mcp logic. Consolidate into one handler class to reduce maintenance risk.", "status": "open", "priority": 3, "issue_type": "chore", "created_at": "2025-11-30T22:32:48.55523-08:00", "updated_at": "2025-11-30T22:32:48.55523-08:00", "source_repo": "."}
{"id": "worktree_worker4-79n", "content_hash": "991ce18e500f95d38531d4f01529e5a5a7b4714e2e0c238c65df184cf6c9334c", "title": "Unify user settings defaults in one place", "description": "main.py and world_logic.py both set default LLM provider/model values. Create a single source (e.g., world_logic.get_user_settings_unified) and have main.py delegate to avoid drift.", "status": "open", "priority": 3, "issue_type": "chore", "created_at": "2025-11-30T22:32:52.81325-08:00", "updated_at": "2025-11-30T22:32:52.81325-08:00", "source_repo": "."}
{"id":"worktree_timeline-l45","content_hash":"7ac8c77a8ca82339f1abe5f61cb97b99bd92c680b91951ef23418028462b65b0","title":"LLM Context Usage Architecture - World State Sent Once, Not Duplicated","description":"Documentation of how context is structured in LLM requests. Game state is sent once per request as a separate field, not duplicated in each story entry. Story history contains lean entries (actor + text only).","design":"## Context Usage Architecture\n\n**Question**: Are we sending the world state to the LLM once or copying it for every story mode entry?\n\n**Answer**: World state is sent ONCE per LLM request, not duplicated per story entry.\n\n### Architecture Overview\n\nLocated in `mvp_site/llm_service.py:2553-2569`:\n\n```python\ngemini_request = LLMRequest.build_story_continuation(\n    user_action=user_input,\n    game_state=current_game_state.to_dict(),  # ‚Üê Sent ONCE\n    story_history=truncated_story_context,     # ‚Üê Separate list of entries\n    checkpoint_block=checkpoint_block,\n    core_memories=core_memories_summary.split(\"\\n\"),\n    sequence_ids=sequence_id_list_string.split(\", \"),\n    entity_tracking=entity_tracking_data,\n    selected_prompts=selected_prompts or [],\n    use_default_world=use_default_world,\n)\n```\n\n### Structured Separation (mvp_site/llm_request.py:59-62)\n\n```python\n@dataclass\nclass LLMRequest:\n    # Core fields\n    user_action: str\n    game_mode: str\n    user_id: str\n    \n    # Separate structured fields (NOT duplicated)\n    game_state: dict[str, Any]              # ‚Üê Single snapshot\n    story_history: list[dict[str, Any]]     # ‚Üê Lean entries only\n    entity_tracking: dict[str, Any]\n    \n    # Context fields\n    checkpoint_block: str\n    core_memories: list[str]\n    sequence_ids: list[str]\n```\n\n### Token Budget Breakdown\n\n**Logging Location**: `mvp_site/llm_service.py:2412-2416`\n\n```python\nlogging_util.info(\n    f\"üìä CONTEXT BREAKDOWN: system_instruction={system_instruction_tokens}tk, \"\n    f\"checkpoint={checkpoint_tokens}tk, core_memories={core_memories_tokens}tk, \"\n    f\"seq_ids={seq_ids_tokens}tk, game_state={game_state_tokens}tk\"\n)\n```\n\n**Budget Calculation**: `mvp_site/llm_service.py:2452-2457`\n\n```python\nlogging_util.info(\n    f\"üìä BUDGET: model_limit={_get_context_window_tokens(model_to_use)}tk, \"\n    f\"safe_budget={safe_token_budget}tk, scaffold={scaffold_tokens}tk, \"\n    f\"output_reserve={output_token_reserve}tk, story_budget={available_story_tokens}tk, \"\n    f\"actual_story={story_tokens}tk {'‚ö†Ô∏è OVER' if story_tokens \u003e available_story_tokens else '‚úÖ OK'}\"\n)\n```\n\n### Token Components\n\n1. **System Instruction**: Varies by selected prompts (includes master directive, DnD rules, etc.)\n2. **Checkpoint Block**: Small summary of recent state\n3. **Core Memories**: Key facts that persist across sessions\n4. **Sequence IDs**: Tiny reference list of story entry IDs\n5. **Game State**: Complete world snapshot (sent ONCE, not per entry)\n6. **Story History**: Truncated if needed, lean entries (just actor + text)\n\n### Story Entry Structure\n\nEach entry in `story_history` contains:\n```python\n{\n    \"actor\": \"user\" | \"gemini\",\n    \"text\": \"narrative content\",\n    \"seq_id\": 123  # Sequence number\n}\n```\n\n**NO world state duplication** - each entry is lean (just actor, text, seq_id).\n\n### Budget Management (mvp_site/llm_service.py:2392-2466)\n\n1. **Calculate scaffold tokens** (everything except story):\n   - System instruction\n   - Checkpoint block\n   - Core memories\n   - Sequence IDs\n   - Game state (single copy)\n\n2. **Calculate available story budget**:\n   ```python\n   safe_token_budget = model_context_window * safety_ratio\n   output_reserve = 2500 (normal) or 4000 (combat)\n   available_story_tokens = safe_budget - output_reserve - scaffold_tokens\n   ```\n\n3. **Truncate story if needed**:\n   - If story_tokens \u003e available_story_tokens\n   - Truncation removes OLDEST entries first\n   - Keeps most recent context for continuity\n\n### Why This Design is Optimal\n\n- **No duplication**: Game state counted once in token budget\n- **Lean story entries**: Each entry is minimal (actor + text only)\n- **Intelligent truncation**: When budget exceeded, oldest story entries removed\n- **Complete state**: Game state always sent in full (not truncated)\n- **Structured data**: LLM receives JSON with clear field separation\n\n### Related Files\n\n- **mvp_site/llm_service.py**: Main LLM request builder (lines 2286-2582)\n- **mvp_site/llm_request.py**: LLMRequest dataclass definition (lines 46-150)\n- **mvp_site/token_utils.py**: Token estimation utilities\n- **mvp_site/tests/test_context_budgeting.py**: Budget calculation tests\n- **mvp_site/tests/test_context_truncation.py**: Truncation logic tests","acceptance_criteria":"- [ ] Verify game_state is sent once per request (not per story entry)\n- [ ] Confirm story_history entries are lean (actor + text only)\n- [ ] Validate token budget calculation includes game_state once\n- [ ] Check truncation logic preserves game_state while removing old story entries\n- [ ] Verify logging shows context breakdown correctly","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-01T13:06:57.49846-08:00","updated_at":"2025-12-01T13:06:57.49846-08:00","source_repo":"."}
