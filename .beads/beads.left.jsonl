{"id":"worktree_worker3-0go","content_hash":"179d3475697c525d2f5bf86b063013d1bb7723268502db14bf56b7d4c37f434c","title":"Delete pre-computed dice logic","description":"Remove the pre-computed dice code that never fully worked:\n- detect_action_type() from game_state.py\n- compute_combat_results() and helpers from game_state.py\n- Pattern constants (ATTACK_PATTERNS, etc.)\n- Pre-computed injection from llm_service.py\n- pre_computed_results instructions from prompts\n- test_precomputed_dice.py test file","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T10:18:18.366942-05:00","updated_at":"2025-12-11T10:18:18.366942-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-0go","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:18.367466-05:00","created_by":"daemon"},{"issue_id":"worktree_worker3-0go","depends_on_id":"worktree_worker3-bkl","type":"blocks","created_at":"2025-12-11T10:18:29.255255-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-1hz","content_hash":"28a38f304e79b4a12fbea1aa191db812ce1832f812362bf25410f17b464988da","title":"POLICY: No Silent Test Skipping - Tests Must Run or Mock","description":"**CRITICAL TESTING POLICY**\n\nTests must NEVER silently skip or short-circuit based on environment variables or missing dependencies. Every test must either:\n\n1. **RUN** - Execute with real or mocked dependencies\n2. **FAIL LOUDLY** - Raise clear assertion error if prerequisites missing\n3. **MOCK** - Use mock objects when real services unavailable\n\n**FORBIDDEN PATTERNS:**\n- `if not os.getenv(\"X\"): return` (silent skip)\n- Module-level imports that raise on missing env vars (blocks test collection)\n- `@unittest.skipIf/skipUnless` without CI-compatible fallback\n- Tests that pass trivially when env var is unset\n\n**REQUIRED PATTERNS:**\n- `TESTING=true` should enable mock mode for all external services\n- Test collection must NEVER fail due to env vars\n- All tests must run in CI without special env vars beyond TESTING=true\n\n**Why This Matters:**\n- CI passes falsely when tests are skipped\n- Bugs slip through because code paths never execute\n- Developers think tests pass when they actually didn't run","status":"open","priority":1,"issue_type":"chore","created_at":"2025-12-11T06:01:03.763015-05:00","updated_at":"2025-12-11T06:01:03.763015-05:00","source_repo":".","labels":["ci","policy","testing"]}
{"id":"worktree_worker3-21f","content_hash":"79da601df893377c445e034c08c899a4c4d979664d77dbebb6b0d3c6bfd4d1c2","title":"Cerebras tool-loop responses missing headers/planning block (malformed JSON)","description":"Context: After PR #2353, Cerebras models (e.g., zai-glm-4.6) sometimes return malformed/incomplete JSON; parser recovers only some fields, so session_header and planning_block go missing. Planning-block fallback was removed, so missing headers/blocks surface.\n\nUpdated requirements (per latest direction):\n- First inference call should mirror origin/main: plain JSON mode, with schema expectations (session_header, planning_block, etc.) and only optional tools available. The model should produce the full schema in the first call unless it explicitly needs tools.\n- Only perform a second call if the model returns tool_calls; then execute tools and send results in a follow-up JSON-mode call (tools disabled).\n- Do not rely on regex salvage for planning_block; rely on the schema. If the first/second response is missing session_header/planning_block, reprompt once with a short \"add missing fields\" request or inject a minimal default.\n- Make planning_block/session_header schema compliance primary; salvage is last resort.\n\nArtifacts: flask-server.log 2025-12-12 11:30:46–51 for campaign VqqJLpABua9bvAG4ArTg, provider cerebras/model zai-glm-4.6.\n\nRequested work:\n1) Adjust Cerebras (and other providers if needed) to a tool-on-demand flow (first call JSON sans tools; tools only if requested), aligning with origin/main behavior.\n2) Add a one-time reprompt/default insertion when session_header/planning_block is missing after the final response.\n3) Replace regex-based planning_block extraction with a robust/bracket-aware method if salvage is still kept as a last resort.\n","notes":"Add mitigations: when Cerebras tool-loop responses are malformed and missing session_header/planning_block, reprompt or inject a minimal default instead of accepting partial JSON. Capture raw response for debugging. Restart server after constants changes to ensure tool-loop path is used.","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-12T11:59:12.909638-05:00","updated_at":"2025-12-12T17:07:08.661154-05:00","source_repo":"."}
{"id":"worktree_worker3-4rl","content_hash":"14f39431f4c2c20317ade9bc5702a4d961dc66679529beea869fde8828f8e897","title":"PR #2353 change summary (pending merge)","description":"Summary of all changes vs origin/main for branch claude/refactor-llm-to-code-01Sr4NxrZzuzRJ2XDSVFPm9s:\n\n- game_state.py: Added D\u0026D mechanics/tool execution (execute_dice_tool), DICE_ROLL_TOOLS, deterministic calculators; pre-rolled generator (now unused). XP helpers unchanged.\n- constants.py: Reintroduced capability sets (MODELS_WITH_CODE_EXECUTION, TOOL_USE, PRECOMPUTE). Strategy function get_dice_roll_strategy. Updated context/output limits (e.g., llama-3.3-70b 128k ctx/65k out; gpt-oss-120b 131k/40k). Updated Gemini mappings/allow lists.\n- llm_service.py: Provider dispatch uses tools: Gemini3 -\u003e function-calling+JSON; Gemini2 -\u003e two-phase tools→JSON; OR/Cerebras -\u003e tool loop if whitelisted. Added dice-consistency patch to narrative. Pre-rolled comments remain but no injection. Uses DICE_ROLL_TOOLS.\n- Providers: gemini_provider added tool loop and “code_execution” path (actually function-calling). cerebras/openrouter providers restored tool loop/process_tool_calls and tool_call-aware wrappers.\n- json_utils.py: Added fallback extraction for session_header/planning_block on malformed JSON (regex-based, fragile for nesting).\n- Prompts: game_state_instruction switched to tool-based dice; “copy tool numbers exactly.”\n- Frontend: api.js/app.js better error messages; settings.html adds Gemini 2.5 option text.\n- Tests: dice and JSON tests revamped; test_game_state expanded; planning block integration tests updated; fake_llm added; pre_rolled assertions removed.\n- Misc: llm_request dropped pre_rolled_dice field; clock_skew TESTING bypass; minor scripts update.\n\nKnown risks/todos (tracked separately):\n- Tool entry should be tool-on-demand (first call plain JSON, second only if tool_calls) and robust planning_block/session_header fallback (beads 21f/519).\n- Regex salvage for planning_block is fragile.\n- XP/level validation still not enforced (bead 58b).\n\nClose this bead after PR merge to keep a record of scope for reviewers.","status":"open","priority":4,"issue_type":"task","created_at":"2025-12-12T17:10:15.558893-05:00","updated_at":"2025-12-12T17:10:15.558893-05:00","source_repo":"."}
{"id":"worktree_worker3-519","content_hash":"7c96aeda6ed7dc55cfbb6f7a443e1dadf2c5f8065bcbd4306cfba42d973122a4","title":"Tool-on-demand LLM entrypoint (reduce malformed JSON, restore headers/blocks)","description":"Goal: Align with origin/main by making the first LLM call plain JSON (no tools) and only doing a second call if tool_calls are returned.\n\nProblem: Current tool-loop entrypoint (PR #2353) sends tool-enabled first calls for Cerebras/OR and Gemini 2.x. Some providers (e.g., Cerebras) return malformed/partial JSON with missing session_header/planning_block on non-dice turns. Fallback was removed, so headers/blocks go missing.\n\nProposed approach:\n1) First call: JSON mode, no tools; brief instruction tells the model to request tool calls if dice/skills/saves needed.\n2) If tool_calls present: execute tools, then second call JSON mode (tools disabled) with results to produce final structured response.\n3) If no tool_calls: use first response as final.\n4) Fallback: if session_header or planning_block missing after final response, reprompt once to add them. Keep malformed-JSON salvage as last resort.\n\nScope/files:\n- mvp_site/llm_service.py: adjust dispatch to tool-on-demand.\n- mvp_site/llm_providers/*: ensure plain JSON helper; tool loop only when tool_calls exist.\n- Prompts: instruct models to request tools when needed; no “tools always” assumption.\n\nAcceptance:\n- Non-dice turns complete in one call with session_header + planning_block present.\n- Dice turns complete in two calls with executed tool results and valid JSON.\n- Reduced malformed-JSON incidence for Cerebras/OR; missing headers/blocks covered by reprompt fallback.\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-12T12:41:29.829537-05:00","updated_at":"2025-12-12T12:41:29.829537-05:00","source_repo":"."}
{"id":"worktree_worker3-58b","content_hash":"a35c7ad5ea6d92317dc6bb84b29e0edeac372708800b1aba47b221b32b130a24","title":"Harden narrative/XP/time validation and fuzzy JSON extraction","description":"Summary of investigation findings:\n1) Narrative truncation: malformed JSON when narrative contains unescaped quotes; parser truncates mid-sentence. Need fuzzy extraction fallback to capture full narrative when strict parse fails or length is suspiciously short.\n2) Level/XP discrepancies: prompts in mechanics_system_instruction were vague (\"typically double\" XP); game_state blindly accepts LLM XP/level. Need to enforce D\u0026D 5e XP table in prompt and add validation in GameState (_validate_level_consistency) to warn on mismatches.\n3) Time tracking anomalies: GameState accepts backward time jumps. Add validate_time_monotonicity to detect/reject/warn when new timestamp \u003c previous.\n\nUpdated leveling approach:\n- Backend owns XP→level (and level→XP) using the fixed 5e table; LLM does not compute level. If LLM proposes mismatched XP/level, backend corrects or reprompts.\n- Prompt change: tell the LLM \"XP/level are authoritative from the system; do not change them. When you mention level or XP, use the provided values.\" LLM may propose \"apply level-up now\" flags, but backend applies the table and updates state.\n\nRequested work:\n- Add robust fallback extraction in narrative_response_schema.py for malformed JSON.\n- Update mechanics_system_instruction.md to include standard 5e cumulative XP table and remove ambiguous guidance; include the prompt text above about authoritative XP/level.\n- Implement GameState validation hooks: level/XP consistency (auto-correct or warn) and time monotonicity (warn/reject backwards time).\n","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-12T11:59:23.318533-05:00","updated_at":"2025-12-12T12:05:22.015439-05:00","source_repo":"."}
{"id":"worktree_worker3-620","content_hash":"c09fc720be1e157ac3a377253f4e092057ddf474de37775f8ba6e4513888605e","title":"Update llm_service.py to route by provider","description":"Modify _call_llm_api() to:\n1. Determine provider from model name\n2. Call appropriate provider's generate_content_with_tool_loop()\n3. Pass DICE_ROLL_TOOLS to all providers","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T10:18:19.024753-05:00","updated_at":"2025-12-11T10:18:19.024753-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-620","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:19.025281-05:00","created_by":"daemon"},{"issue_id":"worktree_worker3-620","depends_on_id":"worktree_worker3-8pt","type":"blocks","created_at":"2025-12-11T10:18:29.718478-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-8pt","content_hash":"c80486cbf421ca33c02e078f6d7c0e9721e4cdba6d974af6fe3dc64efe7af19f","title":"Add Gemini tool loop with phase separation","description":"Implement generate_content_with_tool_loop() for Gemini provider with special handling:\n- Phase 1: tools=ON, json_mode=OFF (function calling)\n- Phase 2: tools=OFF, json_mode=ON (structured output)\n\nThis works around Gemini API limitation that rejects tools + JSON mode together.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T10:18:17.738164-05:00","updated_at":"2025-12-11T10:18:17.738164-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-8pt","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:17.738798-05:00","created_by":"daemon"},{"issue_id":"worktree_worker3-8pt","depends_on_id":"worktree_worker3-bkl","type":"blocks","created_at":"2025-12-11T10:18:28.75882-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-8qz","content_hash":"0950fc2056e30f915891bc4dff6e0b32db63dfa99aebff2d4c6c827abe5954a7","title":"Smoke test tool loops for all providers","description":"Run smoke tests against:\n- Gemini (phase-separated tool loop)\n- Cerebras (unified tool loop)\n- OpenRouter (unified tool loop)\n\nVerify LLM can call roll_attack(), roll_dice(), roll_skill_check(), roll_saving_throw() and results appear in final JSON response.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T10:18:19.55518-05:00","updated_at":"2025-12-11T10:18:19.55518-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-8qz","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:19.555715-05:00","created_by":"daemon"},{"issue_id":"worktree_worker3-8qz","depends_on_id":"worktree_worker3-620","type":"blocks","created_at":"2025-12-11T10:18:30.196946-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-bkl","content_hash":"c0ac59ca6db9728010db5be820adf8a9ef43b7c9f892de0a23320435f172a4b2","title":"Revert commit 9b70c1ff9 (tool loop deletion)","description":"git revert 9b70c1ff9 to restore ~1,400 lines of tool loop infrastructure:\n- DICE_ROLL_TOOLS array\n- execute_dice_tool() function\n- generate_content_with_tool_loop() in cerebras/openrouter providers\n- process_tool_calls() in both providers\n- MODELS_WITH_TOOL_USE set\n- get_dice_roll_strategy() function","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-11T10:18:17.005724-05:00","updated_at":"2025-12-11T10:18:17.005724-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-bkl","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:17.006728-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-c9g","content_hash":"3fc3f15899d68e2c98ae002af891ba648efeaec0d8761cd39e2b31c29b8bf014","title":"Unify planning_block schema: Single source of truth in Python","description":"**Problem:** Two sources of truth for planning_block structure that are out of sync:\n1. `game_state_instruction.md` (lines 33-53, 72-75) - Detailed, correct\n2. `provider_utils.py:NARRATIVE_RESPONSE_SCHEMA` - Vague ({type: object})\n\nThe JSON schema only says `planning_block: {type: object, additionalProperties: true}` which allows empty `{}`. The LLM satisfies the schema constraint but ignores the prompt's detailed structure requirements.\n\n**Solution (Option B):** Single source in Python, generate prompt section\n\n1. Define full planning_block schema in `provider_utils.py`:\n```python\nPLANNING_BLOCK_SCHEMA = {\n    \"type\": \"object\",\n    \"properties\": {\n        \"thinking\": {\"type\": \"string\", \"description\": \"GM tactical analysis\"},\n        \"context\": {\"type\": \"string\", \"description\": \"Current scenario context\"},\n        \"choices\": {\n            \"type\": \"object\",\n            \"description\": \"Player choices with snake_case keys\",\n            \"additionalProperties\": {\n                \"type\": \"object\",\n                \"properties\": {\n                    \"text\": {\"type\": \"string\"},\n                    \"description\": {\"type\": \"string\"},\n                    \"risk_level\": {\"type\": \"string\"}\n                },\n                \"required\": [\"text\", \"description\"]\n            }\n        }\n    },\n    \"required\": [\"thinking\", \"choices\"]\n}\n```\n\n2. Add helper function to generate prompt-ready JSON example from schema\n3. Update `game_state_instruction.md` to reference or import from Python (or add sync comment)\n4. Consider using the schema for validation in `narrative_response_schema.py`\n\n**Files:**\n- `mvp_site/llm_providers/provider_utils.py` - Define detailed schema\n- `mvp_site/prompts/game_state_instruction.md` - Add sync reference\n- `mvp_site/narrative_response_schema.py` - May use schema for validation","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T17:10:06.787493-05:00","updated_at":"2025-12-12T17:18:51.746665-05:00","closed_at":"2025-12-12T17:18:51.746665-05:00","source_repo":".","labels":["architecture","planning-block","schema"]}
{"id":"worktree_worker3-cwm","content_hash":"50d4addce59646ca0e0d007d2584c6e5e5280b45343a8be674b74a6cf74ef8ae","title":"Add end2end test skill to Claude skills directory","description":"Create a dedicated Claude skill file documenting the end2end test architecture, philosophy, and patterns. Currently this info is scattered across mvp_site/tests/README*.md but not in .claude/skills/.","design":"Create .claude/skills/end2end-testing.md with:\n1. Testing philosophy: Mock external APIs (Firestore, Gemini), NOT internal services\n2. Fake implementations: FakeFirestoreClient, FakeLLMResponse patterns\n3. Test file locations: test_end2end/, test_*_e2e.py\n4. Commands: /teste (mock), /tester (real), /4layer (TDD)\n5. Firestore nested collection structure\n6. Multi-phase function testing with side_effect","acceptance_criteria":"- Skill file created at .claude/skills/end2end-testing.md\n- Contains all E2E testing patterns from README_END2END_TESTS.md\n- Includes references to /teste, /tester, /4layer commands\n- Documents fake service implementation patterns","status":"in_progress","priority":2,"issue_type":"task","assignee":"claude","created_at":"2025-12-12T22:56:35.356329-05:00","updated_at":"2025-12-12T22:56:53.800059-05:00","source_repo":"."}
{"id":"worktree_worker3-hiq","content_hash":"211fd7cd9af21eae92f5998594a7f6b8d369bb8459061a64ba7f6adfb918ee4f","title":"Write E2E tests for JSON-first tool_requests flow (PR #2353)","description":"Add comprehensive E2E tests for the new generate_content_with_tool_requests() function in Cerebras and OpenRouter providers. Current tests mock the function itself rather than testing internal logic.","design":"Add tests to test_code_execution_dice_rolls.py:\n1. Path 1: No tool_requests in response - returns Phase 1 directly\n2. Path 2: tool_requests present - executes tools, Phase 2 call\n3. Path 3: Invalid JSON response - returns as-is\n4. Path 4: Tool execution errors - captured in results\n5. execute_tool_requests() helper tests\n\nMock external API (requests.post) with side_effect for sequential responses.\nDO NOT mock generate_content_with_tool_requests() - test internal logic.","acceptance_criteria":"- Tests added to test_code_execution_dice_rolls.py\n- Covers all 5 code paths in generate_content_with_tool_requests()\n- Uses side_effect for Phase 1 / Phase 2 mock responses\n- All tests pass: TESTING=true python3 -m pytest\n- Pushed to PR #2353","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-12T22:56:36.068789-05:00","updated_at":"2025-12-12T22:56:36.068789-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-hiq","depends_on_id":"worktree_worker3-cwm","type":"blocks","created_at":"2025-12-12T22:56:42.66083-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-np8","content_hash":"e8a3b2c90e8f6fd780af685a5654046478519b0b835aceacedb88eae7dfcfd7b","title":"Unified Two-Phase Dice Architecture - Revert to Tool Loops","description":"Revert pre-computed dice approach back to LLM-driven tool loops. All providers use two-phase inference where LLM decides what dice to roll, server executes, LLM narrates result.\n\nKey insight: Gemini can use function calling, just not WITH JSON mode simultaneously. Solution: Phase 1 with tools (no JSON), Phase 2 with JSON (no tools).\n\nRoadmap: roadmap/unified_two_phase_dice_architecture.md","status":"open","priority":1,"issue_type":"feature","created_at":"2025-12-11T10:17:58.910614-05:00","updated_at":"2025-12-11T10:17:58.910614-05:00","source_repo":".","labels":["architecture","dice","pr-2353","tool-loops"]}
{"id":"worktree_worker3-sn2","content_hash":"72fbe03db9f8802c2cdaece718a871328c3b5f9580fa4e6de3706074529c9118","title":"BUG: clock_skew_credentials.py blocks test collection on import","description":"**Problem:**\n`world_logic.py` imports `clock_skew_credentials` and calls `apply_clock_skew_patch()` at module level (line 35). This triggers `validate_deployment_config()` which raises `ValueError` if `WORLDAI_GOOGLE_APPLICATION_CREDENTIALS` is set without `WORLDAI_DEV_MODE=true`.\n\n**Impact:**\n- Test collection fails for any test that imports `world_logic`\n- CI \"passes\" because CI doesn't have the env var - tests never run\n- Local devs with service account keys cannot run tests without setting extra env vars\n\n**Files Affected:**\n- `mvp_site/clock_skew_credentials.py:40-44` - The raising code\n- `mvp_site/world_logic.py:35` - Module-level call to `apply_clock_skew_patch()`\n- `mvp_site/tests/test_game_state.py:88` - Import fails here\n\n**Root Cause:**\nValidation logic runs at import time, not runtime. This is a design flaw - module imports should NEVER raise based on env vars.\n\n**Fix Required:**\n1. Make `validate_deployment_config()` return status, not raise\n2. OR defer validation until actual Firebase operation\n3. OR respect `TESTING=true` to skip validation entirely","acceptance_criteria":"- [ ] Tests can be collected without WORLDAI_DEV_MODE\n- [ ] TESTING=true bypasses clock skew validation\n- [ ] test_game_state.py runs in CI\n- [ ] Local devs can run tests with service account keys","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-11T06:01:18.00365-05:00","updated_at":"2025-12-11T06:03:03.560481-05:00","closed_at":"2025-12-11T06:03:03.560481-05:00","source_repo":".","labels":["bug","p0","testing"],"dependencies":[{"issue_id":"worktree_worker3-sn2","depends_on_id":"worktree_worker3-1hz","type":"related","created_at":"2025-12-11T06:01:23.566645-05:00","created_by":"daemon"}]}
