{"id":"LW-26y","content_hash":"09d39288556d7dd698573ce5e46864ae72dbe535976a59142026c73372c78dea","title":"Refactor god objects: llm_service.py and world_logic.py","description":"Both llm_service.py (4349 lines) and world_logic.py (4425 lines) are god objects that do too much. They should be split into smaller, focused modules for maintainability.\n\nThis is a long-term refactoring initiative - not urgent but important for codebase health.","status":"open","priority":3,"issue_type":"epic","created_at":"2026-01-15T20:24:44.73532-08:00","updated_at":"2026-01-15T20:24:44.73532-08:00","source_repo":".","labels":["long-term","refactoring","tech-debt"]}
{"id":"LW-5lk","content_hash":"27ba581df4073a183df1a39f7fb97c78135f83d6aa4fbfed2c05479a11305358","title":"Persist state_updates/game_state/core_memories/world_events to Firestore story/game_states for long campaigns","description":"Persist full game state (including state_updates, game_state, core_memories, world_events) to Firestore every turn. Ensure we are not persisting a reduced subset. Persist both:\n- game_states/current_state (authoritative)\n- full structured state embedded in each story entry (traceability)\nThis should eliminate lost-plot-element errors when transcript truncates.","acceptance_criteria":"- On each turn, full structured game_state (incl. state_updates/core_memories/world_events) is persisted to game_states/current_state.\n- Each story entry includes the same full structured state (not just current structured_fields subset).\n- Verify in Firestore for a long campaign (\u003e=50 turns) that recent entries include these fields.\n- Regression test shows persisted state survives service restarts and later turns can read prior state.","notes":"User explicitly requested: persist full structured state (not subset) and store both in current_state + story entries.","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-27T14:46:18.18582-05:00","updated_at":"2025-12-27T16:00:41.191897-05:00","source_repo":"."}
{"id":"LW-8tv","content_hash":"b19be9d189b7ce922e84379ba0108fff88a9b10016f764140d40a7684df344ac","title":"Tests: world_logic import fails if WORLDAI creds set without dev mode","description":"`mvp_site/world_logic.py` calls `apply_clock_skew_patch()` at import time. If the local environment has `WORLDAI_GOOGLE_APPLICATION_CREDENTIALS` set but `WORLDAI_DEV_MODE` is not `true`, `mvp_site/clock_skew_credentials.validate_deployment_config()` raises, breaking imports and `./run_tests.sh mvp_site/tests/test_world_logic.py`.\n\nThis is easy to hit on dev machines where creds are configured globally.\n\nRepro:\n- Ensure `WORLDAI_GOOGLE_APPLICATION_CREDENTIALS` is set and `WORLDAI_DEV_MODE` is unset\n- Run `./run_tests.sh mvp_site/tests/test_world_logic.py` → fails during import of `mvp_site.world_logic`.\n\nNotes:\n- Many tests set `TESTING_AUTH_BYPASS=true` (via pytest `mvp_site/tests/conftest.py`), but `run_tests.sh` executes individual test files directly with `python3 test_file.py`, so `conftest.py` does not run and the env bypass is not applied.\n\nFix direction candidates (pick one):\n- Update `mvp_site/tests/test_world_logic.py` to set env vars before importing `mvp_site.world_logic` (move import below env setup)\n- Or update `run_tests.sh` to export `TESTING_AUTH_BYPASS=true` (or `WORLDAI_DEV_MODE=true`) when running local/unit tests\n- Or adjust `apply_clock_skew_patch()` invocation to defer until Firebase initialization (not import time) in test contexts.","acceptance_criteria":"- With `WORLDAI_GOOGLE_APPLICATION_CREDENTIALS` set and `WORLDAI_DEV_MODE` unset, `./run_tests.sh mvp_site/tests/test_world_logic.py` completes successfully.\n- `python -c \"import mvp_site.world_logic\"` does not raise due to deployment config validation when running in test mode.\n- Does not weaken production guardrails: production still requires explicit `WORLDAI_DEV_MODE=true` when using dev credentials.","status":"open","priority":2,"issue_type":"bug","created_at":"2026-01-15T16:15:04.528768-08:00","updated_at":"2026-01-15T16:15:04.528768-08:00","source_repo":"."}
{"id":"LW-bh4","content_hash":"01369646511d90c5223d84619b5ee994e5a85b796e5767116f81e2d2e2b612d6","title":"Remove redundant payload validation in llm_service.py","description":"mvp_site/llm_service.py:1348 calls `gemini_request._validate_payload_size(json_data)` BEFORE adding `priority_instruction` and `message_type` fields. Then lines 1375-1379 validate the final serialized JSON string.\n\nThe first validation uses incomplete data (~200 bytes less). While the overhead is negligible vs 10MB limit, the first check is redundant since the second check validates the actual payload sent to the LLM.\n\nFix: Remove line 1348 (`gemini_request._validate_payload_size(json_data)`) since the second validation at lines 1375-1379 covers the final payload.","acceptance_criteria":"- Line 1348 removed from llm_service.py\n- Only one payload size validation remains (after JSON serialization)\n- Tests pass","status":"closed","priority":3,"issue_type":"chore","created_at":"2026-01-15T17:10:23.434105-08:00","updated_at":"2026-01-15T17:12:49.105398-08:00","closed_at":"2026-01-15T17:12:49.105398-08:00","source_repo":".","labels":["cleanup","llm-service"]}
{"id":"LW-e8g","content_hash":"94c876a28f0edfb5e1a0fa13d2a82e43087ef7ddb278e8b3feb35160158f4de5","title":"Improve InfoAgent query detection and interface consistency","description":"## Problem\n\nInfoAgent was missing the `turn_number` parameter in `build_system_instructions()`, causing a TypeError when users asked info-style queries:\n\n```\nTypeError: InfoAgent.build_system_instructions() got an unexpected keyword argument 'turn_number'\n```\n\n### Root Cause\nWhen Living World was added, `turn_number` was added to BaseAgent and most subclasses, but InfoAgent was missed.\n\n### Immediate Fix (PR #2603)\nAdded `turn_number: int = 0` parameter to InfoAgent for interface consistency.\n\n## Future Improvements Needed\n\n### 1. Interface Enforcement\nConsider using `abc.abstractmethod` or a protocol to ensure all agent subclasses implement the same signature for `build_system_instructions()`.\n\n### 2. Query Pattern Review\nCurrent InfoAgent detection patterns are narrow:\n- `\"do i have\"` triggers InfoAgent even for non-inventory queries (e.g., \"how many galaxies do i have\")\n- Consider whether InfoAgent should handle broader game state queries or stay inventory-focused\n\n### 3. Graceful Fallback\nIf an agent doesn't support certain parameters, it should handle them gracefully rather than raising TypeError. The `del` pattern works but requires manual updates when base interface changes.\n\n## Evidence\n- GCP logs: s9 preview server, 2025-12-27T23:54 UTC\n- Fix: commit 2423f939b","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-27T19:14:11.898767-05:00","updated_at":"2025-12-27T19:14:11.898767-05:00","source_repo":".","labels":["agents","interface","living-world","robustness"]}
{"id":"LW-o0w","content_hash":"b9e02e2b0f265adc89fb97ac113e0fb6093072808bf97d1f017fe0548218e7bf","title":"Add specific error handler for PayloadTooLargeError","description":"mvp_site/world_logic.py:2349-2352 catches `LLMRequestError` which is the parent class of `PayloadTooLargeError`. While the error is caught, the generic error message may not be user-friendly.\n\nConsider adding a specific handler before the generic LLMRequestError handler to provide clearer messages like \"Your request is too large. Try shortening your action or starting a new campaign.\"\n\nLocation: mvp_site/world_logic.py around line 2349","acceptance_criteria":"- PayloadTooLargeError has specific handler before generic LLMRequestError\n- User receives clear message about payload size limit\n- Tests verify user-friendly error message","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-15T17:10:31.798503-08:00","updated_at":"2026-01-15T17:12:50.231446-08:00","closed_at":"2026-01-15T17:12:50.231446-08:00","source_repo":".","labels":["error-handling","ux"]}
{"id":"LW-rvt","content_hash":"0599f26f40f87c036d103fb9cf9daa1d50c0bb68d05a770ac851d9eed37354f9","title":"Extract llm_service.py into focused modules","description":"llm_service.py is 4349 lines - a god object handling:\n- LLM request building\n- Response parsing\n- Provider management\n- Token counting\n- Agent orchestration\n\nShould be split into focused modules.","design":"Proposed structure:\nmvp_site/llm/\n├── request_builder.py      # LLMRequest construction, priority_instruction\n├── response_parser.py      # Response parsing, NarrativeResponse\n├── token_counter.py        # Token estimation and counting\n├── providers/              # Already partially extracted\n└── service.py              # Orchestration only (thin layer)\n\nApproach:\n1. Extract one module at a time\n2. Keep backward-compatible imports in llm_service.py\n3. Deprecate old imports over time","acceptance_criteria":"- llm_service.py reduced to \u003c1000 lines\n- Each extracted module is \u003c500 lines\n- All tests pass\n- No breaking changes to public API","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-15T20:24:53.947623-08:00","updated_at":"2026-01-15T20:24:53.947623-08:00","source_repo":".","labels":["llm-service","refactoring"],"dependencies":[{"issue_id":"LW-rvt","depends_on_id":"LW-26y","type":"blocks","created_at":"2026-01-15T20:24:53.948709-08:00","created_by":"daemon"}]}
{"id":"LW-ttl","content_hash":"1fc855528ea7a5e6c2aca4fc076ffa67aa0bb61bd88f00ca785c53f25ddacaeb","title":"Add logging for empty story data cases in GamePlayView","description":"In mvp_site/frontend_v2/src/components/GamePlayView.tsx, the error handling path cleans up optimistic entries and shows a toast when story data is empty, but does not log this case for debugging.\n\nThe empty data case could indicate:\n- Server returned empty response\n- Network issues\n- Data parsing failures\n\nAdding logging would help investigate root causes when users report this error.\n\nLocation: mvp_site/frontend_v2/src/components/GamePlayView.tsx around the empty story data handling","acceptance_criteria":"- Empty story data cases are logged with relevant context (campaign_id, action attempted)\n- Log includes timestamp for correlation with server logs\n- Does not expose PII in logs","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-15T17:11:58.768516-08:00","updated_at":"2026-01-15T17:12:51.231914-08:00","closed_at":"2026-01-15T17:12:51.231914-08:00","source_repo":".","labels":["debugging","frontend","logging"]}
{"id":"LW-uz5","content_hash":"2eb5c56816134fede979e040b459fff1bb6dd8e7dcb8f695b7221e8825e64cab","title":"Persist game_state/core memories so LW updates don't lose critical plot facts","description":"Living World updates assume wrong facts (e.g., Flaming Fist thinks player dead) because full transcript is truncated and no game_state/core_memories are persisted to Firestore for campaign STpjRuwjeUt97tpCl5nK. Firestore shows empty game_states subcollection and story entries lack state_updates/game_state. Need durable storage of key state (core_memories, world_events, npc status) so LW step can read canonical facts after long runs/reloads.","acceptance_criteria":"- Campaign runs persist a serialized game_state (or at minimum core_memories + world_events + npc status) to Firestore per turn or at defined checkpoints.\n- story entries or game_states collection include state_updates or core_memories so critical plot facts survive truncation.\n- LW generation uses persisted state on subsequent turns/reloads and does not contradict prior captured facts in a regression test.\n- Add a regression test or replay harness that demonstrates the Horgus capture -\u003e LW event respects it.","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-27T14:42:51.008057-05:00","updated_at":"2025-12-27T14:42:51.008057-05:00","source_repo":"."}
{"id":"LW-zq6","content_hash":"d0e33b01c924dbd4fb205f5bdf41414f95d54b2224aec45db103a9a06b57dd39","title":"Lint: Fix Ruff errors in llm_service/world_logic (non-v2)","description":"`venv/bin/ruff check mvp_site/llm_service.py mvp_site/world_logic.py` reports errors including:\n- Unused import: `mvp_site.agents.BaseAgent` in `mvp_site/llm_service.py`\n- Unused function argument: `debug_mode` in `mvp_site/llm_service.py`\n- Whitespace-only blank lines in `mvp_site/llm_service.py` and `mvp_site/world_logic.py`\n\nThese should be cleaned up to keep lint/CI green.","acceptance_criteria":"- `venv/bin/ruff check mvp_site/llm_service.py mvp_site/world_logic.py` passes.\n- No behavior changes (pure lint/format/unused cleanup).","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-15T16:15:07.537184-08:00","updated_at":"2026-01-15T16:15:07.537184-08:00","source_repo":"."}
