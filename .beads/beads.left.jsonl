{"id":"worktree_worker3-0go","content_hash":"179d3475697c525d2f5bf86b063013d1bb7723268502db14bf56b7d4c37f434c","title":"Delete pre-computed dice logic","description":"Remove the pre-computed dice code that never fully worked:\n- detect_action_type() from game_state.py\n- compute_combat_results() and helpers from game_state.py\n- Pattern constants (ATTACK_PATTERNS, etc.)\n- Pre-computed injection from llm_service.py\n- pre_computed_results instructions from prompts\n- test_precomputed_dice.py test file","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T10:18:18.366942-05:00","updated_at":"2025-12-13T14:06:08.091765-05:00","closed_at":"2025-12-13T14:06:08.091765-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-0go","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:18.367466-05:00","created_by":"daemon"},{"issue_id":"worktree_worker3-0go","depends_on_id":"worktree_worker3-bkl","type":"blocks","created_at":"2025-12-11T10:18:29.255255-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-0ix","content_hash":"b87172daa3bd8b54ed5764e67a94cdf4716e391a08e9e2ac180aeec683206e6f","title":"Delete old tools-first flow (generate_content_with_tool_loop, process_tool_calls)","description":"**Context:** PR #2353 implemented a new JSON-first tool_requests architecture:\n- `generate_content_with_tool_requests()` in cerebras_provider.py:490-573 and openrouter_provider.py:362-445\n- First call is JSON mode (no tools), model uses `tool_requests` array field to request dice rolls\n- Only do second call if `tool_requests` present\n\n**Problem:** The OLD tools-first flow still exists and causes confusion:\n- `generate_content_with_tool_loop()` - sends tools param in first call, returns raw non-JSON if no tool_calls\n- `process_tool_calls()` - used by old flow, different signature than new `execute_tool_requests()`\n\n**Code to DELETE:**\n\n**cerebras_provider.py:**\n- `process_tool_calls()` at line 270-312 (~42 lines)\n- `generate_content_with_tool_loop()` at line 315-456 (~141 lines)\n\n**openrouter_provider.py:**\n- `process_tool_calls()` at line 163-205 (~42 lines)\n- `generate_content_with_tool_loop()` at line 208-328 (~120 lines)\n\n**gemini_provider.py:**\n- `process_tool_calls()` at line 188-220 (~32 lines)\n- `generate_content_with_tool_loop()` at line 223-307 (~84 lines)\n- NOTE: Gemini 2.x still needs tool loop (tools + JSON mode conflict), may need to keep or refactor\n\n**llm_service.py:**\n- Remove any routing to `generate_content_with_tool_loop()` for Cerebras/OpenRouter\n- Keep `generate_content_with_tool_requests()` routing\n\n**Tests to update:**\n- `test_code_execution_dice_rolls.py` - remove tests for old flow\n- `test_gemini_tool_loop_e2e.py` - keep if Gemini still needs tool loop\n\n**Estimated deletion:** ~400-500 lines of dead code\n\n**KEEP:**\n- `execute_tool_requests()` - new JSON-first helper\n- `generate_content_with_tool_requests()` - new JSON-first entry point\n- Gemini tool loop if still needed for 2.x compatibility","status":"closed","priority":2,"issue_type":"task","assignee":"code","created_at":"2025-12-13T14:21:29.080199-05:00","updated_at":"2025-12-13T14:43:19.350483-05:00","closed_at":"2025-12-13T14:43:19.350483-05:00","source_repo":".","labels":["cleanup","dead-code","pr-2353","tool-loops"]}
{"id":"worktree_worker3-1hz","content_hash":"28a38f304e79b4a12fbea1aa191db812ce1832f812362bf25410f17b464988da","title":"POLICY: No Silent Test Skipping - Tests Must Run or Mock","description":"**CRITICAL TESTING POLICY**\n\nTests must NEVER silently skip or short-circuit based on environment variables or missing dependencies. Every test must either:\n\n1. **RUN** - Execute with real or mocked dependencies\n2. **FAIL LOUDLY** - Raise clear assertion error if prerequisites missing\n3. **MOCK** - Use mock objects when real services unavailable\n\n**FORBIDDEN PATTERNS:**\n- `if not os.getenv(\"X\"): return` (silent skip)\n- Module-level imports that raise on missing env vars (blocks test collection)\n- `@unittest.skipIf/skipUnless` without CI-compatible fallback\n- Tests that pass trivially when env var is unset\n\n**REQUIRED PATTERNS:**\n- `TESTING=true` should enable mock mode for all external services\n- Test collection must NEVER fail due to env vars\n- All tests must run in CI without special env vars beyond TESTING=true\n\n**Why This Matters:**\n- CI passes falsely when tests are skipped\n- Bugs slip through because code paths never execute\n- Developers think tests pass when they actually didn't run","status":"closed","priority":1,"issue_type":"chore","created_at":"2025-12-11T06:01:03.763015-05:00","updated_at":"2025-12-13T17:16:01.705337-05:00","closed_at":"2025-12-13T17:16:01.705337-05:00","source_repo":".","labels":["ci","policy","testing"]}
{"id":"worktree_worker3-1sw","content_hash":"06e6984c64629440ad60efa3d96b7965dc81cef2a8134f55d03bc49961c05d2f","title":"Delete unused game_state.py helpers and stray doc stub","description":"Per codex msg #116/117 - remove dead code:\n\n**game_state.py unused helpers:**\n- calculate_initiative (no callers/tests)\n- calculate_complication_chance / check_complication_triggers (no callers/tests)\n- calculate_death_save (no callers/tests)\n- calculate_hp_for_class (no callers/tests)\n\n**Stray doc stub:**\n- testing_llm/test_ai_development_workflow.md has calculate_damage stub - archive/delete\n\nKeeping: calculate_resource_depletion (exercised by tests)","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-12-13T15:10:54.027413-05:00","updated_at":"2025-12-13T15:12:34.009573-05:00","closed_at":"2025-12-13T15:12:34.009573-05:00","source_repo":".","labels":["cleanup","dead-code"]}
{"id":"worktree_worker3-21f","content_hash":"79da601df893377c445e034c08c899a4c4d979664d77dbebb6b0d3c6bfd4d1c2","title":"Cerebras tool-loop responses missing headers/planning block (malformed JSON)","description":"Context: After PR #2353, Cerebras models (e.g., zai-glm-4.6) sometimes return malformed/incomplete JSON; parser recovers only some fields, so session_header and planning_block go missing. Planning-block fallback was removed, so missing headers/blocks surface.\n\nUpdated requirements (per latest direction):\n- First inference call should mirror origin/main: plain JSON mode, with schema expectations (session_header, planning_block, etc.) and only optional tools available. The model should produce the full schema in the first call unless it explicitly needs tools.\n- Only perform a second call if the model returns tool_calls; then execute tools and send results in a follow-up JSON-mode call (tools disabled).\n- Do not rely on regex salvage for planning_block; rely on the schema. If the first/second response is missing session_header/planning_block, reprompt once with a short \"add missing fields\" request or inject a minimal default.\n- Make planning_block/session_header schema compliance primary; salvage is last resort.\n\nArtifacts: flask-server.log 2025-12-12 11:30:46–51 for campaign VqqJLpABua9bvAG4ArTg, provider cerebras/model zai-glm-4.6.\n\nRequested work:\n1) Adjust Cerebras (and other providers if needed) to a tool-on-demand flow (first call JSON sans tools; tools only if requested), aligning with origin/main behavior.\n2) Add a one-time reprompt/default insertion when session_header/planning_block is missing after the final response.\n3) Replace regex-based planning_block extraction with a robust/bracket-aware method if salvage is still kept as a last resort.\n","notes":"Add mitigations: when Cerebras tool-loop responses are malformed and missing session_header/planning_block, reprompt or inject a minimal default instead of accepting partial JSON. Capture raw response for debugging. Restart server after constants changes to ensure tool-loop path is used.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-12T11:59:12.909638-05:00","updated_at":"2025-12-13T14:06:03.95099-05:00","closed_at":"2025-12-13T14:06:03.95099-05:00","source_repo":"."}
{"id":"worktree_worker3-382","content_hash":"24c4e99703dbc1c639a898cd83fe0a310ecdd2fd48e449caf316ed7cb646399b","title":"Clarify _coerce_int_inner optional defaults doc/type","description":"_coerce_int_inner currently accepts default=None in practice, but the signature hints default:int=0. Add docstring/type clarification or an optional helper to avoid reviewer confusion about None handling, without changing behavior.","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-17T20:28:47.427617-08:00","updated_at":"2025-12-18T17:47:42.587387-08:00","closed_at":"2025-12-18T17:47:42.587387-08:00","source_repo":".","labels":["cleanup","docs","type-hint"]}
{"id":"worktree_worker3-38k","content_hash":"6bb65f684bf4b1e898c73a6aa3c406e1998666682b34f9178bf10eb204e3fad9","title":"Native tools forced on non-tool models returns 400","description":"After PR #2353 the providers force native tool-calling with tool_choice='required' for all Cerebras/OpenRouter models. CONFIRMED: All models DO support function calling (gpt-oss-120b, llama-3.3-70b). However, llama-3.3-70b on Cerebras has multi-turn limitation that causes 400 errors when tool_calls array included in assistant turn (Phase 2). Fix: Clear tool_calls from history before Phase 2 for llama-3.3-70b on Cerebras only.","notes":"WEB SEARCH CONFIRMED (2025-12-17):\n- gpt-oss-120b: FULLY supports function calling, tool use, structured outputs (TauBench tested)\n- llama-3.3-70b: DOES support function calling BUT Cerebras has specific limitation: \"Multi-turn tool calling is currently not supported with the llama-3.3-70b model. This model will error if you include a non-empty tool_calls array on an assistant turn.\"\n\nRoot cause: Phase 2 passes conversation history including tool_calls from Phase 1, triggering 400 on multi-turn for llama-3.3-70b only.\n\nFix strategy: Model-specific history sanitization before Phase 2 for llama-3.3-70b on Cerebras provider only.","status":"closed","priority":1,"issue_type":"bug","assignee":"code","created_at":"2025-12-17T01:44:14.174613-08:00","updated_at":"2025-12-18T17:45:52.209687-08:00","closed_at":"2025-12-18T17:45:52.209687-08:00","source_repo":".","labels":["P0","api-break","dice","pr-2353","regression"]}
{"id":"worktree_worker3-3gt","content_hash":"1cbda028487c159ebd9f5d6c0497875848e71b8a490bca685305e54bcb3202a6","title":"Reconcile social-encounter fix commit hashes with deployed branch","description":"Evidence cites commit bd2a0ea34, while prior summary listed 9d7104ba1 / 5db1f7029 / 442e573e6. Verify which commits are in main/deployed branch, align evidence docs, and ensure the tested code matches the shipped version.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-17T02:48:01.466567-08:00","updated_at":"2025-12-17T21:07:09.962705-08:00","closed_at":"2025-12-17T21:07:09.962705-08:00","source_repo":"."}
{"id":"worktree_worker3-3w8","content_hash":"3f7c97c3f09aedb4f1baf7ba0fd20847befbf8f230696639329829d5fee14d7c","title":"Remove remaining tools-first codepaths","description":"Delete legacy tools-first codepaths and ensure all providers use JSON-first tool_requests or explicit two-phase JSON flow:\n- Remove/disable generate_content_with_tool_loop and process_tool_calls implementations in providers once JSON-first replacements are in place (Cerebras/OpenRouter already have replacements; Gemini still pending alignment).\n- Update llm_service routing to avoid tools-first paths entirely.\n- Cleanup tests/docs referencing tools-first flows.\n","notes":"## Status Check by c3 (2025-12-15)\n\n**Main Code - DONE ✅**\n- `generate_content_with_tool_loop` - DELETED from all providers\n- `process_tool_calls` - DELETED from all providers\n- All providers now use JSON-first `generate_content_with_tool_requests`\n- llm_service routing uses JSON-first paths only\n\n**Remaining Cleanup:**\n- `mvp_site/tests/CLAUDE.md` still references old `generate_content_with_tool_loop` function in examples (lines 260-303)\n- This doc should be updated to reflect the new JSON-first architecture\n\n**Minor Issue Found:**\n- `llm_service.py:1658` passes `tools=DICE_ROLL_TOOLS` to Gemini 3 path, but this param is **ignored** since `generate_content_with_code_execution` now delegates to `generate_content_with_tool_requests`\n- Should either remove the unused param or document why it's kept\n\n**Recommendation:** Close after doc update and unused param cleanup.","status":"closed","priority":1,"issue_type":"task","assignee":"c3","created_at":"2025-12-13T22:08:22.902854-08:00","updated_at":"2025-12-14T16:32:11.135188-08:00","closed_at":"2025-12-14T16:32:11.135188-08:00","source_repo":"."}
{"id":"worktree_worker3-4ds","content_hash":"e29ae79e87b3cca22004d21082c1600417d8f4c67aef9725f690dd6757ceaecf","title":"Provider/openrouter response_format + tool import hygiene","description":"Address lingering provider review items:\n- In openrouter_provider, avoid sending response_format together with tools if the API rejects that combo, or document compatibility; mirror Cerebras conditional behavior.\n- Move inline imports (execute_dice_tool) to module scope in providers (openrouter, cerebras, gemini) per code guidelines.\n- Ensure tool_requests execution uses correct arg keys (notation vs dice_notation) in tests to avoid masking bugs.\n","notes":"## Analysis by c2 (2025-12-14)\n\n**Items Addressed:**\n1. ✅ OpenRouter response_format + tools: Already fixed - conditional at lines 135-142\n2. ✅ Module-scope imports: Already done in all providers (gemini, cerebras, openrouter)\n3. ✅ dice_notation vs notation: Fixed in game_state.py:1159-1160 - now accepts both keys\n\n**Changes Made:**\n- game_state.py: `execute_dice_tool()` now accepts both `dice_notation` (prompt schema) and `notation` (legacy) for `roll_dice` tool\n\nAll tests pass (23/23 in test_code_execution_dice_rolls.py).","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-13T20:05:31.94329-05:00","updated_at":"2025-12-14T16:35:13.97857-08:00","closed_at":"2025-12-14T16:35:13.97857-08:00","source_repo":"."}
{"id":"worktree_worker3-4rl","content_hash":"14f39431f4c2c20317ade9bc5702a4d961dc66679529beea869fde8828f8e897","title":"PR #2353 change summary (pending merge)","description":"Summary of all changes vs origin/main for branch claude/refactor-llm-to-code-01Sr4NxrZzuzRJ2XDSVFPm9s:\n\n- game_state.py: Added D\u0026D mechanics/tool execution (execute_dice_tool), DICE_ROLL_TOOLS, deterministic calculators; pre-rolled generator (now unused). XP helpers unchanged.\n- constants.py: Reintroduced capability sets (MODELS_WITH_CODE_EXECUTION, TOOL_USE, PRECOMPUTE). Strategy function get_dice_roll_strategy. Updated context/output limits (e.g., llama-3.3-70b 128k ctx/65k out; gpt-oss-120b 131k/40k). Updated Gemini mappings/allow lists.\n- llm_service.py: Provider dispatch uses tools: Gemini3 -\u003e function-calling+JSON; Gemini2 -\u003e two-phase tools→JSON; OR/Cerebras -\u003e tool loop if whitelisted. Added dice-consistency patch to narrative. Pre-rolled comments remain but no injection. Uses DICE_ROLL_TOOLS.\n- Providers: gemini_provider added tool loop and “code_execution” path (actually function-calling). cerebras/openrouter providers restored tool loop/process_tool_calls and tool_call-aware wrappers.\n- json_utils.py: Added fallback extraction for session_header/planning_block on malformed JSON (regex-based, fragile for nesting).\n- Prompts: game_state_instruction switched to tool-based dice; “copy tool numbers exactly.”\n- Frontend: api.js/app.js better error messages; settings.html adds Gemini 2.5 option text.\n- Tests: dice and JSON tests revamped; test_game_state expanded; planning block integration tests updated; fake_llm added; pre_rolled assertions removed.\n- Misc: llm_request dropped pre_rolled_dice field; clock_skew TESTING bypass; minor scripts update.\n\nKnown risks/todos (tracked separately):\n- Tool entry should be tool-on-demand (first call plain JSON, second only if tool_calls) and robust planning_block/session_header fallback (beads 21f/519).\n- Regex salvage for planning_block is fragile.\n- XP/level validation still not enforced (bead 58b).\n\nClose this bead after PR merge to keep a record of scope for reviewers.","status":"closed","priority":4,"issue_type":"task","created_at":"2025-12-12T17:10:15.558893-05:00","updated_at":"2025-12-13T14:06:33.919247-05:00","closed_at":"2025-12-13T14:06:33.919247-05:00","source_repo":"."}
{"id":"worktree_worker3-519","content_hash":"7c96aeda6ed7dc55cfbb6f7a443e1dadf2c5f8065bcbd4306cfba42d973122a4","title":"Tool-on-demand LLM entrypoint (reduce malformed JSON, restore headers/blocks)","description":"Goal: Align with origin/main by making the first LLM call plain JSON (no tools) and only doing a second call if tool_calls are returned.\n\nProblem: Current tool-loop entrypoint (PR #2353) sends tool-enabled first calls for Cerebras/OR and Gemini 2.x. Some providers (e.g., Cerebras) return malformed/partial JSON with missing session_header/planning_block on non-dice turns. Fallback was removed, so headers/blocks go missing.\n\nProposed approach:\n1) First call: JSON mode, no tools; brief instruction tells the model to request tool calls if dice/skills/saves needed.\n2) If tool_calls present: execute tools, then second call JSON mode (tools disabled) with results to produce final structured response.\n3) If no tool_calls: use first response as final.\n4) Fallback: if session_header or planning_block missing after final response, reprompt once to add them. Keep malformed-JSON salvage as last resort.\n\nScope/files:\n- mvp_site/llm_service.py: adjust dispatch to tool-on-demand.\n- mvp_site/llm_providers/*: ensure plain JSON helper; tool loop only when tool_calls exist.\n- Prompts: instruct models to request tools when needed; no “tools always” assumption.\n\nAcceptance:\n- Non-dice turns complete in one call with session_header + planning_block present.\n- Dice turns complete in two calls with executed tool results and valid JSON.\n- Reduced malformed-JSON incidence for Cerebras/OR; missing headers/blocks covered by reprompt fallback.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T12:41:29.829537-05:00","updated_at":"2025-12-13T14:06:03.404255-05:00","closed_at":"2025-12-13T14:06:03.404255-05:00","source_repo":"."}
{"id":"worktree_worker3-58b","content_hash":"2f251d8df5680f8d9439915faf574650a5e0c23795341ac6d2ef3f9f3b20aad0","title":"Harden narrative/XP/time validation and fuzzy JSON extraction","description":"Summary of investigation findings:\n1) Narrative truncation: malformed JSON when narrative contains unescaped quotes; parser truncates mid-sentence. Need fuzzy extraction fallback to capture full narrative when strict parse fails or length is suspiciously short.\n2) Level/XP discrepancies: prompts in mechanics_system_instruction were vague (\"typically double\" XP); game_state blindly accepts LLM XP/level. Need to enforce D\u0026D 5e XP table in prompt and add validation in GameState (_validate_level_consistency) to warn on mismatches.\n3) Time tracking anomalies: GameState accepts backward time jumps. Add validate_time_monotonicity to detect/reject/warn when new timestamp \u003c previous.\n\nUpdated leveling approach:\n- Backend owns XP→level (and level→XP) using the fixed 5e table; LLM does not compute level. If LLM proposes mismatched XP/level, backend corrects or reprompts.\n- Prompt change: tell the LLM \"XP/level are authoritative from the system; do not change them. When you mention level or XP, use the provided values.\" LLM may propose \"apply level-up now\" flags, but backend applies the table and updates state.\n\nRequested work:\n- Add robust fallback extraction in narrative_response_schema.py for malformed JSON.\n- Update mechanics_system_instruction.md to include standard 5e cumulative XP table and remove ambiguous guidance; include the prompt text above about authoritative XP/level.\n- Implement GameState validation hooks: level/XP consistency (auto-correct or warn) and time monotonicity (warn/reject backwards time).\n","status":"closed","priority":3,"issue_type":"task","assignee":"c3","created_at":"2025-12-12T11:59:23.318533-05:00","updated_at":"2025-12-14T16:39:03.261108-08:00","closed_at":"2025-12-14T16:39:03.261108-08:00","source_repo":"."}
{"id":"worktree_worker3-620","content_hash":"c09fc720be1e157ac3a377253f4e092057ddf474de37775f8ba6e4513888605e","title":"Update llm_service.py to route by provider","description":"Modify _call_llm_api() to:\n1. Determine provider from model name\n2. Call appropriate provider's generate_content_with_tool_loop()\n3. Pass DICE_ROLL_TOOLS to all providers","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T10:18:19.024753-05:00","updated_at":"2025-12-13T14:06:05.865182-05:00","closed_at":"2025-12-13T14:06:05.865182-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-620","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:19.025281-05:00","created_by":"daemon"},{"issue_id":"worktree_worker3-620","depends_on_id":"worktree_worker3-8pt","type":"blocks","created_at":"2025-12-11T10:18:29.718478-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-67y","content_hash":"b6e572582cc638db3d9e4334397b405fecd17e56f6bee763a468897ffaa65e1e","title":"Unconditional two-phase dice flow doubles API calls","description":"Current routing in llm_service forces native_two_phase for Gemini 2.x default, Cerebras, and OpenRouter even when no tool calls are needed. Every turn now triggers two provider requests (Phase 1 tools + Phase 2 JSON), doubling latency/cost and rate-limit usage for all users by default. Add conditions/flags to keep single-call JSON flow when dice are not required or when models support tool_requests; only run two-phase when tools are requested or required.","notes":"Ping @code. Problem: two-phase dice flow is forced even when no dice/tool_calls are needed, doubling API calls, latency, and cost. Proposed mitigations: (1) gate two-phase on explicit dice need; (2) keep JSON-first tool_requests for Gemini 2.x; (3) if Phase-1 returns no tool_calls, reuse response and skip Phase-2; (4) add feature flag ENABLE_NATIVE_DICE_TOOLS default off; (5) cost/latency guard to fall back to single-call when over budget.","status":"closed","priority":2,"issue_type":"bug","assignee":"code","created_at":"2025-12-17T01:44:19.940202-08:00","updated_at":"2025-12-17T21:07:09.413813-08:00","closed_at":"2025-12-17T21:07:09.413813-08:00","source_repo":".","labels":["cost","dice","latency","performance","pr-2353"]}
{"id":"worktree_worker3-6lm","content_hash":"8313be06bac055a19d81b253b743bfe8752f630b9cb1a0941a6f78f32c73e92e","title":"Harden social encounter tests: preflight tool_config and fail clearly","description":"Add preflight checks in social encounter real API tests to ensure required tool_config is present; when missing, fail fast with a clear message to avoid misattributing LLM behavior to config gaps.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T02:47:57.063209-08:00","updated_at":"2025-12-18T17:45:52.16578-08:00","closed_at":"2025-12-18T17:45:52.16578-08:00","source_repo":"."}
{"id":"worktree_worker3-6tg","content_hash":"9146505a6b70a2475708cef1a8288d1afde9899e4790d58a0313709f32c444d9","title":"Open questions: dice roll count mismatch \u0026 empty-narrative root cause","description":"Track risks from latest MCP smoke evidence: (1) roll counter reports 1 while evidence shows attack+damage for OpenRouter defaultWorld; unclear expected counting; (2) prior defaultWorld empty narrative failure cause unknown; need root-cause and mitigation to prevent recurrence.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-17T02:35:21.62277-08:00","updated_at":"2025-12-17T02:35:21.62277-08:00","source_repo":"."}
{"id":"worktree_worker3-6ws","content_hash":"bdc758a034df0bbe91ff2de5ac1f5a6346ec0c2ef631696c0b39c3d1c07f4f5a","title":"Docs/test policy alignment and clock-skew safety","description":"Docs \u0026 policy fixes:\n- .claude/skills/end2end-testing.md: correct test file list/paths to match repo; remove references to missing files.\n- CLAUDE.md No Silent Test Skipping: change FAIL LOUDLY example from pytest.skip to pytest.fail/raise; soften enforcement language to reflect current automation.\n- narrative_system_instruction.md: wording on choice keys (snake_case vs god:option_1) to avoid inconsistency.\n- clock_skew_credentials.py: adjust TESTING guard so WORLDAI creds still require dev/test mode per review suggestion.\n","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-13T20:06:27.548302-05:00","updated_at":"2025-12-14T16:32:22.310981-08:00","closed_at":"2025-12-14T16:32:22.310981-08:00","source_repo":"."}
{"id":"worktree_worker3-7k2","content_hash":"864e3465dd2a8ebcbee49ec8945e9ba8c7e9708eda0fb15d303ca9a677975167","title":"Gemini 2.x AUTO tool mode risks skipping dice tools","description":"Commit 0c915737c changed Gemini native tool flow from function_calling_config mode 'ANY' to 'AUTO'. In AUTO the model can choose not to call dice/skill tools, breaking the requirement that server executes all dice rolls. Risk: silent fake/no dice rolls in combat/skill checks. Fix: revert to ANY or enforce tool usage for dice-critical paths.","status":"closed","priority":1,"issue_type":"bug","assignee":"code","created_at":"2025-12-17T20:26:54.593073-08:00","updated_at":"2025-12-17T20:32:26.233773-08:00","closed_at":"2025-12-17T20:32:26.233773-08:00","source_repo":".","labels":["dice","gemini","p0","pr-2353"]}
{"id":"worktree_worker3-82m","content_hash":"b73b4882cfda502f9e6f61d11ca3c9d27e6df8ecd26f7b90124df1dc7c999426","title":"Implement Native Two-Phase Tool Calling for All Non-Gemini Models","description":"Replace prompt-based tool_requests approach with native API tool calling for Cerebras/OpenRouter providers.\n\n## Problem\n- Current approach uses JSON schema with `tool_requests` field via prompt instructions\n- GLM-4.6 and other models ignore this because they're trained for native tool calling\n- API limitation: `tools` + `response_format` cannot be used together\n\n## Solution\nImplement true two-phase native tool calling:\n- Phase 1: `tools` parameter (no JSON schema) → get `tool_calls` in response\n- Phase 2: `response_format` parameter (no tools) → get structured JSON with results\n\n## Scope\n- Gemini 2.0/3.0: Keep single-phase code_execution (supports both together)\n- Gemini 2.5: Native two-phase\n- All Cerebras: Native two-phase  \n- All OpenRouter: Native two-phase","design":"## Architecture\n\n### Strategy Selection (constants.py)\n```python\ndef get_dice_roll_strategy(model_name, provider):\n    if model_name in {\"gemini-2.0-flash\", \"gemini-3-pro-preview\"}:\n        return \"code_execution\"  # Single phase\n    return \"native_two_phase\"  # All others\n```\n\n### Native Two-Phase Flow\n1. Phase 1: Call with `tools=DICE_ROLL_TOOLS`, no response_format\n2. Extract `tool_calls` from response.choices[0].message.tool_calls\n3. Execute tools using execute_dice_tool()\n4. Phase 2: Call with `response_format=JSON_SCHEMA`, include tool results as message\n\n### Files to Modify\n- constants.py: Simplify get_dice_roll_strategy()\n- cerebras_provider.py: Add generate_content_with_native_tools()\n- openrouter_provider.py: Add generate_content_with_native_tools()\n- gemini_provider.py: Add native_two_phase for 2.5\n- llm_service.py: Route to correct strategy","acceptance_criteria":"- [ ] All Cerebras models use native tool calling\n- [ ] All OpenRouter models use native tool calling\n- [ ] Gemini 2.0/3.0 keep single-phase code_execution\n- [ ] Gemini 2.5 uses native two-phase\n- [ ] GLM-4.6 produces dice rolls in combat\n- [ ] Smoke tests pass for all providers\n- [ ] No regression in existing functionality","notes":"Implementation complete. All providers updated to use native two-phase tool calling:\n- constants.py: Simplified get_dice_roll_strategy() to return only code_execution or native_two_phase\n- cerebras_provider.py: Added generate_content_with_native_tools()\n- openrouter_provider.py: Added generate_content_with_native_tools()  \n- gemini_provider.py: Added generate_content_with_native_tools() for Gemini 2.5\n- llm_service.py: Updated routing to use correct strategies\n- test_code_execution_dice_rolls.py: Updated tests for new architecture\n\n50 tests passing. Needs smoke test validation with live APIs to confirm GLM-4.6 produces dice rolls.","status":"in_progress","priority":1,"issue_type":"feature","assignee":"claude","created_at":"2025-12-16T22:14:10.97962-08:00","updated_at":"2025-12-16T22:29:11.578447-08:00","source_repo":".","labels":["architecture","dice-rolls","pr-2353","tool-calling"]}
{"id":"worktree_worker3-8f1","content_hash":"161b615a2253a8c08ceeee7ba8767328cfdebc86a11bcce13a9dfbe54aa9340f","title":"Phase 2 Skip Optimization - Redesign with Schema Validation","description":"Redesign Phase 2 skip optimization with proper schema validation and tool enforcement.\n\nCONTEXT: Initial optimization (0c915737c) reverted due to critical regressions:\n1. Schema bypass: Skipped Phase 2 without validating required fields (planning_block, session_header, dice_rolls)\n2. Tool mode regression: Changed mode='ANY' to mode='AUTO', allowing LLM to skip mandatory dice rolls\n\nGOAL: Achieve ~25-30% token reduction for narrative-only turns while maintaining:\n- Mandatory dice rolls (mode='ANY')\n- Schema compliance (all required fields)\n- No client-side KeyErrors or missing data","design":"## Approach: Schema-Validated Phase 2 Skip\n\n### Implementation Strategy\n1. Keep tool_config mode='ANY' (force tools, preserve dice authority)\n2. Add schema validation before Phase 2 skip\n3. Only skip Phase 2 when:\n   - No function_calls returned from Phase 1\n   - Phase 1 text is valid JSON\n   - All required fields present (narrative, planning_block, session_header, etc.)\n\n### Code Pattern\n```python\nif not function_calls:\n    try:\n        parsed = json.loads(phase1_text)\n        required_fields = ['narrative', 'planning_block', 'session_header']\n        \n        if all(field in parsed for field in required_fields):\n            logging_util.info(\"Phase 1 response schema-valid, skipping Phase 2\")\n            return response1\n    except (json.JSONDecodeError, KeyError):\n        logging_util.info(\"Phase 1 response invalid, proceeding to Phase 2\")\n        \n# Run Phase 2 for formatting and schema enforcement\nreturn run_phase2(...)\n```\n\n### Testing Requirements\n- Test Phase 2 skip with complete JSON (should skip)\n- Test Phase 2 skip with missing planning_block (should NOT skip)\n- Test Phase 2 skip with missing session_header (should NOT skip)\n- Test that dice rolls still forced in combat (mode='ANY' preserved)\n- Integration test: verify no KeyErrors in UI with optimization active","acceptance_criteria":"MUST:\n- [ ] mode='ANY' preserved for all providers (gemini, openrouter, cerebras)\n- [ ] Schema validation includes ALL required fields before Phase 2 skip\n- [ ] Tests verify missing fields force Phase 2 execution\n- [ ] Combat/skill checks still use server-executed dice\n- [ ] No KeyErrors in UI from missing fields\n\nSHOULD:\n- [ ] Achieve ~25-30% token reduction for narrative-only turns\n- [ ] Log when Phase 2 skipped vs executed for debugging\n- [ ] Add metrics to track Phase 2 skip rate\n\nMUST NOT:\n- [ ] Use mode='AUTO' (allows dice skip)\n- [ ] Skip Phase 2 without schema validation\n- [ ] Ship incomplete JSON to clients","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-17T20:31:40.112282-08:00","updated_at":"2025-12-17T20:31:40.112282-08:00","source_repo":"."}
{"id":"worktree_worker3-8gv","content_hash":"05838a4cdd4bea1e2dd6ff281ae018e5b2829373b83d058c7a50b47dd8233252","title":"NPC death state not persisting (Marcus elimination issue)","description":"NPC death state not persisting between turns. User kills Marcus but game still presents options to kill him.\n\nROOT CAUSE ANALYSIS (CONFIRMED):\n\n**TWO SEPARATE ISSUES:**\n\n1. **apply_automatic_combat_cleanup NOT called in main story flow**\n   - world_logic.py line 905: `update_state_with_changes` called\n   - NO `apply_automatic_combat_cleanup` call after it\n   - Cleanup only called in GOD_MODE flows (lines 1817, 1887)\n   - Result: combat_state HP=0 deaths are not synced to npc_data\n\n2. **cleanup_defeated_enemies DELETES instead of marking dead**\n   - game_state.py line 729: `del self.npc_data[enemy_name]`\n   - For generic enemies (goblins): deletion is correct\n   - For named NPCs (Marcus): need `status: [\"dead\"]` to persist\n   - Without status, LLM can't know NPC is dead\n\n**WHY THIS HAPPENS:**\n- npc_data EXCLUDED from LLM context (to save tokens - ~500/NPC)\n- entity_tracking_data is READ-ONLY trimmed data\n- LLM can't see death status → offers to kill dead NPCs\n\n**FIX REQUIRED:**\n1. Add `apply_automatic_combat_cleanup` call after line 905 in main story flow\n2. Modify cleanup to mark named NPCs as dead instead of deleting","acceptance_criteria":"- NPC deaths update npc_data.status = 'dead'\n- Dead NPCs not offered as targets in planning blocks\n- State persists across sessions","notes":"Traced to commit ded8efa84 which excluded npc_data from context. Cleanup function exists but is not called in main flow. This is a pre-existing bug on origin/main, not from PR #2353.","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-17T01:43:36.616356-08:00","updated_at":"2025-12-17T01:56:23.526357-08:00","source_repo":".","labels":["bug","game-state","npc"]}
{"id":"worktree_worker3-8pt","content_hash":"c80486cbf421ca33c02e078f6d7c0e9721e4cdba6d974af6fe3dc64efe7af19f","title":"Add Gemini tool loop with phase separation","description":"Implement generate_content_with_tool_loop() for Gemini provider with special handling:\n- Phase 1: tools=ON, json_mode=OFF (function calling)\n- Phase 2: tools=OFF, json_mode=ON (structured output)\n\nThis works around Gemini API limitation that rejects tools + JSON mode together.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T10:18:17.738164-05:00","updated_at":"2025-12-13T14:06:06.971061-05:00","closed_at":"2025-12-13T14:06:06.971061-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-8pt","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:17.738798-05:00","created_by":"daemon"},{"issue_id":"worktree_worker3-8pt","depends_on_id":"worktree_worker3-bkl","type":"blocks","created_at":"2025-12-11T10:18:28.75882-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-8qz","content_hash":"0950fc2056e30f915891bc4dff6e0b32db63dfa99aebff2d4c6c827abe5954a7","title":"Smoke test tool loops for all providers","description":"Run smoke tests against:\n- Gemini (phase-separated tool loop)\n- Cerebras (unified tool loop)\n- OpenRouter (unified tool loop)\n\nVerify LLM can call roll_attack(), roll_dice(), roll_skill_check(), roll_saving_throw() and results appear in final JSON response.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T10:18:19.55518-05:00","updated_at":"2025-12-13T14:06:35.068691-05:00","closed_at":"2025-12-13T14:06:35.068691-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-8qz","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:19.555715-05:00","created_by":"daemon"},{"issue_id":"worktree_worker3-8qz","depends_on_id":"worktree_worker3-620","type":"blocks","created_at":"2025-12-11T10:18:30.196946-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-8zk","content_hash":"324ef098167547dcfc29b72f1a4dfc5175f126a75144b2647e1c8654b70a3b41","title":"Route Gemini 2.x through JSON-first tool_requests flow","description":"Prompt docs emphasize JSON-first tool_requests two-phase. llm_service currently routes Gemini 2.x to native tool-calling, which can ignore tool_requests if model follows prompt literally.","acceptance_criteria":"- llm_service routes Gemini 2.x (native_two_phase strategy) to gemini_provider.generate_content_with_tool_requests\n- Update/unit tests reflect new routing\n- End2end tests still pass","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-18T17:35:58.537481-08:00","updated_at":"2025-12-18T17:38:38.516315-08:00","closed_at":"2025-12-18T17:38:38.516315-08:00","source_repo":"."}
{"id":"worktree_worker3-9xp","content_hash":"818dcb5c06483789b2103ccbfa2af5e5655f27a7e34f8aa0aa26f06e8f5586fb","title":"Remove forced tool-calling; only call dice tools when needed","description":"We currently force at least one tool call in some provider flows (Gemini native tools uses FunctionCallingConfig(mode='ANY'); Cerebras/OpenRouter set tool_choice='required'). This adds latency/cost and can create unnecessary dice actions. Gemini 3 uses code_execution + JSON in a single call and does not need forced function tool calling for dice tools.\n\nScope:\n- Revisit/relax forced tool calling behavior across providers.\n- Ensure no-roll turns work without any tool call.\n- Preserve correctness for turns that do require rolls.\n\nNotes:\n- Gemini 3 path uses built-in code_execution (not server dice tools) and shouldn't require tool forcing.\n- If forced tool calling remains for Gemini 2.5 native tools, ensure model can choose declare_no_roll_needed reliably, or switch to a JSON-first tool_requests flow where no tool call is allowed when unnecessary.\n\nUpdate (2025-12-18): Gemini native tool calling no longer forces a function call (mode='AUTO' instead of 'ANY') and new unit tests cover no-roll path still returning JSON. Remaining: decide whether to relax OpenRouter/Cerebras tool_choice='required'.","acceptance_criteria":"- Gemini 3 (code_execution strategy) does not force any server dice tool call.\n- Gemini native_two_phase (2.x/2.5) does not force tool calls for prompts that do not require dice; tests cover this.\n- Cerebras/OpenRouter tool calling is not globally forced; tool calls are optional unless explicitly required by the prompt.\n- Add/adjust unit/integration tests to prevent regressions (e.g., a no-roll prompt produces zero tool calls and still returns valid JSON).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T14:28:12.372821-08:00","updated_at":"2025-12-18T17:43:26.618141-08:00","closed_at":"2025-12-18T17:43:26.618141-08:00","source_repo":"."}
{"id":"worktree_worker3-a08","content_hash":"3a79c5796e59a96c4615c0e9de2c017ab2e50aea27472bb81af8d6a84c850db8","title":"Frontend PII logging and system actor handling","description":"Fix frontend review items:\n- Remove or redact user email logging in mvp_site/frontend_v1/api.js fetchApi error path (PII leak).\n- Add explicit handling for 'system' actor in appendToStory or avoid using that actor to prevent mislabelled UI messages in app.js error handling.\n","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-13T20:06:08.567991-05:00","updated_at":"2025-12-14T16:32:17.316218-08:00","closed_at":"2025-12-14T16:32:17.316218-08:00","source_repo":"."}
{"id":"worktree_worker3-b3v","content_hash":"a9e91df810c93be80e57833fc210ea94a4ffaa117e4add5620ef7baa52989568","title":"Optimize Cerebras: Skip Phase 2 when no tool_calls with fallback","description":"Implement conditional Phase 2 skip for Cerebras to reduce latency when tools aren't needed, while maintaining schema enforcement as fallback.","design":"## Problem\nCurrent Cerebras implementation always runs Phase 2 for schema enforcement, even when Phase 1 returns no tool_calls and valid JSON text.\n\n## Solution\nConditionally skip Phase 2 when safe, with fallback to schema enforcement:\n\n```\nPhase 1 (tools + text generation)\n    ↓\nHas tool_calls? ─Yes→ Execute tools → Phase 2 (with schema)\n    │\n    No\n    ↓\nTry parse text as JSON\n    ↓\nValid + matches schema? ─Yes→ Use directly (skip Phase 2)\n    │\n    No\n    ↓\nPhase 2 (with schema enforcement)\n```\n\n## Benefits\n- Single-call for non-tool turns (majority of LLM calls)\n- Schema enforcement preserved as safety net\n- No risk of malformed JSON reaching game state\n\n## Implementation Notes\n- Add JSON schema validation utility\n- Track metrics: Phase 2 skip rate, fallback rate\n- Consider feature flag for gradual rollout","acceptance_criteria":"- [ ] Phase 1 text is parsed as JSON when no tool_calls\n- [ ] Schema validation runs on parsed JSON\n- [ ] Valid JSON skips Phase 2 call\n- [ ] Invalid JSON falls back to Phase 2\n- [ ] Metrics track skip/fallback rates\n- [ ] No regression in response quality\n- [ ] Latency improvement measured","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-17T11:08:44.123137-08:00","updated_at":"2025-12-17T21:07:08.863918-08:00","closed_at":"2025-12-17T21:07:08.863918-08:00","source_repo":"."}
{"id":"worktree_worker3-ber","content_hash":"58a12d571fc26f66342e29209fb9081924e91c952380a4ff7ab2396695e26ee1","title":"Consider removing tool_choice='required' from native tools flows","description":"OpenRouter/Cerebras generate_content sets tool_choice='required' when tools are passed. Even though llm_service routes those providers through JSON-first tool_requests, the native tools entrypoints remain and could force unnecessary tool calls if used.","acceptance_criteria":"- Decide whether to keep required vs auto\n- If changed, add tests to ensure combat still triggers dice when appropriate","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-18T17:36:15.649701-08:00","updated_at":"2025-12-18T17:40:38.117236-08:00","closed_at":"2025-12-18T17:40:38.117236-08:00","source_repo":"."}
{"id":"worktree_worker3-bkl","content_hash":"c0ac59ca6db9728010db5be820adf8a9ef43b7c9f892de0a23320435f172a4b2","title":"Revert commit 9b70c1ff9 (tool loop deletion)","description":"git revert 9b70c1ff9 to restore ~1,400 lines of tool loop infrastructure:\n- DICE_ROLL_TOOLS array\n- execute_dice_tool() function\n- generate_content_with_tool_loop() in cerebras/openrouter providers\n- process_tool_calls() in both providers\n- MODELS_WITH_TOOL_USE set\n- get_dice_roll_strategy() function","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-11T10:18:17.005724-05:00","updated_at":"2025-12-13T14:06:04.72984-05:00","closed_at":"2025-12-13T14:06:04.72984-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-bkl","depends_on_id":"worktree_worker3-np8","type":"blocks","created_at":"2025-12-11T10:18:17.006728-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-c1","content_hash":"65a3e81a0853305f1bc0136099a8ae233058ead6e78de4d1199e2e79b213bf52","title":"Performance: Two-phase optimization + conditional tool injection","description":"Optimize native two-phase flow to reduce unnecessary API calls and token usage.\n\n**Tasks:**\n1. Skip Phase 2 when Phase 1 returns no tool_calls AND text is valid JSON\n2. Make tool/schema injection conditional in llm_service.py ONLY\n3. Add heuristic: check prompt/user input for dice/skill/save keywords\n4. Add tests for reduced payload in non-dice turns\n\n**Impact:** Halves API calls for non-dice turns, reduces tokens/latency\n\n**Files (NO OVERLAP):**\n- mvp_site/llm_service.py ONLY\n- Tests related to llm_service.py\n\n**Note:** Provider-level changes moved to c2","status":"closed","priority":1,"issue_type":"task","assignee":"c1","created_at":"2025-12-17T12:20:45.968561-08:00","updated_at":"2025-12-17T21:01:18.281211-08:00","closed_at":"2025-12-17T21:01:18.281211-08:00","source_repo":".","labels":["optimization","performance","pr-2353"]}
{"id":"worktree_worker3-c2","content_hash":"2805139ddb7c21aded1f7fc65b6482f1a708dc84371643a6261c870800c528a8","title":"Provider Hygiene: Imports, validation, response_format compatibility","description":"Clean up ALL provider code to prevent crashes and improve maintainability.\n\n**Tasks:**\n1. Move all inline execute_dice_tool imports to module scope in cerebras_provider.py\n2. Add type checks/coercion in execute_tool_requests (all providers)\n3. Fix test arg key to `notation` in tool_request tests\n4. Make response_format conditional when tools present in openrouter_provider.py OR document compatibility\n5. Add validation for malformed tool_requests to prevent crashes\n6. Implement Phase 2 skip optimization when no tool_calls (provider level)\n\n**Impact:** Prevents crashes, improves code quality, performance gains\n\n**Files (NO OVERLAP):**\n- mvp_site/llm_providers/cerebras_provider.py\n- mvp_site/llm_providers/openrouter_provider.py\n- mvp_site/llm_providers/gemini_provider.py\n- Tests for provider functions\n\n**Note:** game_state.py moved to c3, llm_service.py assigned to c1","status":"closed","priority":1,"issue_type":"task","assignee":"c2","created_at":"2025-12-17T12:21:00.382163-08:00","updated_at":"2025-12-17T21:01:18.936899-08:00","closed_at":"2025-12-17T21:01:18.936899-08:00","source_repo":".","labels":["code-quality","pr-2353","validation"]}
{"id":"worktree_worker3-c3","content_hash":"0a13672f808aa1b31659876555b6de35f302c005ac59d18cc6a59363fd57b03b","title":"Dead Code Cleanup: Remove unused helpers and obsolete paths","description":"Remove unused code to reduce confusion and improve maintainability.\n\n**Tasks:**\n1. Remove unused game_state.py helpers:\n   - calculate_initiative\n   - calculate_complication_chance\n   - check_complication_triggers\n   - calculate_death_save\n   - calculate_hp_for_class\n2. Add validation to execute_tool_requests in game_state.py (type checks)\n3. Remove stray calculate_damage stub in testing_llm/test_ai_development_workflow.md\n4. Consolidate or remove redundant test files with sys.path hacks\n5. Clean up unused imports revealed by deletions\n\n**Impact:** Reduces confusion, smaller codebase, better validation\n\n**Files (NO OVERLAP):**\n- mvp_site/game_state.py ONLY (execute_tool_requests validation)\n- testing_llm/test_ai_development_workflow.md\n- Test files with sys.path hacks\n\n**Note:** Gemini provider dead code removal moved to c2 since c2 handles ALL providers","status":"closed","priority":2,"issue_type":"task","assignee":"c3","created_at":"2025-12-17T12:21:14.768442-08:00","updated_at":"2025-12-17T21:01:19.541694-08:00","closed_at":"2025-12-17T21:01:19.541694-08:00","source_repo":".","labels":["cleanup","code-quality","pr-2353"]}
{"id":"worktree_worker3-c4","content_hash":"824ff3dd7b47acb9b9ff515f1aa5b1c0e941c0c95955a263f9caec2bea0924c2","title":"Frontend/Docs Polish + clock_skew fix","description":"Polish frontend, docs, and fix local development blocker.\n\n**Tasks:**\n1. **clock_skew_credentials.py fix (BLOCKER):**\n   - Fix validate_deployment_config to allow TESTING=true to bypass guard\n   - OR keep guard and document WORLDAI_DEV_MODE requirement in local env\n   - Decision: Allow TESTING bypass for CI/local parity\n\n2. **Frontend PII cleanup:**\n   - Remove/redact user_email logging in mvp_site/static/js/api.js\n   - Handle 'system' actor in appendToStory or use different actor in app.js error path\n\n3. **Docs updates:**\n   - Update end2end-testing.md paths\n   - CLAUDE.md fail-loud example to pytest.fail\n   - Soften enforcement wording\n   - narrative_system_instruction choice-key wording\n\n4. **Optional minor:**\n   - Add bounds check in roll_dice to reject num_dice \u003c 1\n\n**Impact:** Unblocks local development, improves privacy, better docs\n\n**Files:**\n- mvp_site/util/clock_skew_credentials.py\n- mvp_site/static/js/api.js\n- mvp_site/static/js/app.js\n- docs/end2end-testing.md\n- CLAUDE.md\n\n**Related:** msg 151 from codev, bead 6ws, bead a08","status":"closed","priority":1,"issue_type":"task","assignee":"c4","created_at":"2025-12-17T12:21:33.260495-08:00","updated_at":"2025-12-17T21:01:20.187307-08:00","closed_at":"2025-12-17T21:01:20.187307-08:00","source_repo":".","labels":["blocker","docs","frontend","pr-2353"]}
{"id":"worktree_worker3-c9g","content_hash":"3fc3f15899d68e2c98ae002af891ba648efeaec0d8761cd39e2b31c29b8bf014","title":"Unify planning_block schema: Single source of truth in Python","description":"**Problem:** Two sources of truth for planning_block structure that are out of sync:\n1. `game_state_instruction.md` (lines 33-53, 72-75) - Detailed, correct\n2. `provider_utils.py:NARRATIVE_RESPONSE_SCHEMA` - Vague ({type: object})\n\nThe JSON schema only says `planning_block: {type: object, additionalProperties: true}` which allows empty `{}`. The LLM satisfies the schema constraint but ignores the prompt's detailed structure requirements.\n\n**Solution (Option B):** Single source in Python, generate prompt section\n\n1. Define full planning_block schema in `provider_utils.py`:\n```python\nPLANNING_BLOCK_SCHEMA = {\n    \"type\": \"object\",\n    \"properties\": {\n        \"thinking\": {\"type\": \"string\", \"description\": \"GM tactical analysis\"},\n        \"context\": {\"type\": \"string\", \"description\": \"Current scenario context\"},\n        \"choices\": {\n            \"type\": \"object\",\n            \"description\": \"Player choices with snake_case keys\",\n            \"additionalProperties\": {\n                \"type\": \"object\",\n                \"properties\": {\n                    \"text\": {\"type\": \"string\"},\n                    \"description\": {\"type\": \"string\"},\n                    \"risk_level\": {\"type\": \"string\"}\n                },\n                \"required\": [\"text\", \"description\"]\n            }\n        }\n    },\n    \"required\": [\"thinking\", \"choices\"]\n}\n```\n\n2. Add helper function to generate prompt-ready JSON example from schema\n3. Update `game_state_instruction.md` to reference or import from Python (or add sync comment)\n4. Consider using the schema for validation in `narrative_response_schema.py`\n\n**Files:**\n- `mvp_site/llm_providers/provider_utils.py` - Define detailed schema\n- `mvp_site/prompts/game_state_instruction.md` - Add sync reference\n- `mvp_site/narrative_response_schema.py` - May use schema for validation","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T17:10:06.787493-05:00","updated_at":"2025-12-12T17:18:51.746665-05:00","closed_at":"2025-12-12T17:18:51.746665-05:00","source_repo":".","labels":["architecture","planning-block","schema"]}
{"id":"worktree_worker3-cma","content_hash":"d370cb35f6c5b13130e1f0a37a6f151e8e097d23f5bb6ec3985220f15937f3ca","title":"Sanitize labeled modifier strings for injection prevention","description":"Labeled modifiers (e.g., '+2 STR') could be injection vectors if labels contain user input. Risk of log injection, XSS, or command injection in UI/backend.","acceptance_criteria":"- All modifier labels escaped before storage/rendering\n- Labels treated as untrusted data\n- No labels used in conditional logic","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-17T01:43:35.603188-08:00","updated_at":"2025-12-17T01:43:35.603188-08:00","source_repo":".","labels":["pr-2353","secondo-review","security"]}
{"id":"worktree_worker3-cwm","content_hash":"50d4addce59646ca0e0d007d2584c6e5e5280b45343a8be674b74a6cf74ef8ae","title":"Add end2end test skill to Claude skills directory","description":"Create a dedicated Claude skill file documenting the end2end test architecture, philosophy, and patterns. Currently this info is scattered across mvp_site/tests/README*.md but not in .claude/skills/.","design":"Create .claude/skills/end2end-testing.md with:\n1. Testing philosophy: Mock external APIs (Firestore, Gemini), NOT internal services\n2. Fake implementations: FakeFirestoreClient, FakeLLMResponse patterns\n3. Test file locations: test_end2end/, test_*_e2e.py\n4. Commands: /teste (mock), /tester (real), /4layer (TDD)\n5. Firestore nested collection structure\n6. Multi-phase function testing with side_effect","acceptance_criteria":"- Skill file created at .claude/skills/end2end-testing.md\n- Contains all E2E testing patterns from README_END2END_TESTS.md\n- Includes references to /teste, /tester, /4layer commands\n- Documents fake service implementation patterns","status":"closed","priority":2,"issue_type":"task","assignee":"claude","created_at":"2025-12-12T22:56:35.356329-05:00","updated_at":"2025-12-12T22:57:50.254195-05:00","closed_at":"2025-12-12T22:57:50.254195-05:00","source_repo":"."}
{"id":"worktree_worker3-d7r","content_hash":"a73cd05f6043aa130a8b9c91589f01a3ea5dbe03520b6fea6d74d7fce61a8466","title":"MOCK_SERVICES_MODE Firestore should persist across requests","description":"In MOCK_SERVICES_MODE, firestore_service.get_db returns a new _InMemoryFirestoreClient() each call, so campaigns created in one request are not visible in subsequent requests (e.g., create_campaign then process_action =\u003e Campaign not found).","acceptance_criteria":"- In MOCK_SERVICES_MODE, get_db returns a singleton in-memory client\n- Add a unit test ensuring create_campaign + process_action works in mock mode (or at least get_db identity is stable)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-18T17:36:07.776915-08:00","updated_at":"2025-12-18T17:39:48.497665-08:00","closed_at":"2025-12-18T17:39:48.497665-08:00","source_repo":"."}
{"id":"worktree_worker3-ft0","content_hash":"b122bd87073d27b0fcdada99c84f5124ef34a290dc4bed096fcedaca74f5508c","title":"Validate game state at tool execution time","description":"Risk of state desynchronization between Phase 1 (planning) and Phase 2 (execution). Game conditions like buffs/debuffs may change during the phase gap, making executed action invalid or exploitable.","acceptance_criteria":"- State validation occurs at execution time, not just planning\n- Detect state drift between phases\n- Reject execution if state materially changed","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-17T01:43:34.609453-08:00","updated_at":"2025-12-17T01:43:34.609453-08:00","source_repo":".","labels":["pr-2353","secondo-review","security"]}
{"id":"worktree_worker3-ftw","content_hash":"2367fb7697b0bf7c2b02155f58841b8c424b535dd77cbf24e5434c5fa17f0cd8","title":"Decide single-call strategy for Gemini 2.0 Flash","description":"Evaluate whether Gemini 2.0 Flash should use a single-call path (code_execution + JSON-like output without official schema) when no tool_calls are needed, to avoid the two-phase latency/cost. Define rules: when to allow single-call, what validation/reprompt to keep, and how to fall back to two-phase when tools/dice are required. Output a clear decision and implementation plan.","notes":"Scope: Decide if/when Gemini 2.0 Flash can run single-call (code_execution + JSON-like output, no official schema) to save latency/cost, and define fallback to two-phase when tools/dice are needed. Add guidelines for validation/reprompt.","status":"open","priority":2,"issue_type":"task","assignee":"code","created_at":"2025-12-17T02:41:51.386416-08:00","updated_at":"2025-12-17T02:41:58.983798-08:00","source_repo":".","labels":["architecture","gemini","performance","pr-2353"]}
{"id":"worktree_worker3-gv1","content_hash":"8b23a00e324c799de546e1d8455649db91d1673f9bbe878dc71554332d10047e","title":"Add timeout handling for two-phase tool calling","description":"Second opinion analysis identified risk of hung states in two-phase tool calling architecture. If coordinator fails between phases, clients may hang indefinitely.","acceptance_criteria":"- Transaction timeouts implemented for tool_requests phase\n- Idempotent rollback logic on timeout\n- Persistent transaction logs for recovery","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-17T01:43:33.834263-08:00","updated_at":"2025-12-17T01:43:33.834263-08:00","source_repo":".","labels":["pr-2353","secondo-review","security"]}
{"id":"worktree_worker3-hiq","content_hash":"d9e9ce7bc26f23ebbb16eabe6c0f35fbcd04a8a41f5c50a858249453f3651546","title":"Write E2E tests for JSON-first tool_requests flow (PR #2353)","description":"Add comprehensive E2E tests for the new generate_content_with_tool_requests() function in Cerebras and OpenRouter providers. Current tests mock the function itself rather than testing internal logic.","design":"Add tests to test_code_execution_dice_rolls.py:\n1. Path 1: No tool_requests in response - returns Phase 1 directly\n2. Path 2: tool_requests present - executes tools, Phase 2 call\n3. Path 3: Invalid JSON response - returns as-is\n4. Path 4: Tool execution errors - captured in results\n5. execute_tool_requests() helper tests\n\nMock external API (requests.post) with side_effect for sequential responses.\nDO NOT mock generate_content_with_tool_requests() - test internal logic.","acceptance_criteria":"- Tests added to test_code_execution_dice_rolls.py\n- Covers all 5 code paths in generate_content_with_tool_requests()\n- Uses side_effect for Phase 1 / Phase 2 mock responses\n- All tests pass: TESTING=true python3 -m pytest\n- Pushed to PR #2353","status":"closed","priority":2,"issue_type":"task","assignee":"claude","created_at":"2025-12-12T22:56:36.068789-05:00","updated_at":"2025-12-12T23:03:50.227133-05:00","closed_at":"2025-12-12T23:03:50.227133-05:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker3-hiq","depends_on_id":"worktree_worker3-cwm","type":"blocks","created_at":"2025-12-12T22:56:42.66083-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-jp2","content_hash":"1d18c4fbf0dfdbbbabf156ad35104c3b6751bcc764e5ac4344aea16f969c6f41","title":"Gemini provider JSON-first alignment and cleanup","description":"Fix Gemini 2.x provider to align with JSON-first tool_requests flow and address review items:\n- Switch generate_content_with_tool_loop to JSON-first schema call (tools=None) + tool_requests execution + second JSON call; ensure Phase 2 passes built history as contents.\n- Handle tool messages properly; remove system_instruction types.Part misuse (pass string); add defensive tool validation; move inline imports (execute_dice_tool, json) to module scope.\n- Update docstrings to reflect two-phase behavior; remove sys.path hacks/new test file policy violations by relocating tests to existing files; clean unused imports/vars in Gemini tests.\n- Replace regex salvage in json_utils only if Gemini path can still emit malformed JSON (coordinate with planning_block task).\nTests: add/adjust Gemini E2E to cover non-dice turn schema compliance and history passing.\n","notes":"## Analysis by c2 (2025-12-14)\n\n**Items Already Addressed:**\n1. ✅ JSON-first tool_requests flow - `generate_content_with_tool_requests()` (lines 288-392)\n2. ✅ system_instruction passes string directly (line 124)\n3. ✅ Defensive tool validation in `execute_tool_requests()` (lines 206-228)\n4. ✅ Module-scope imports (json line 9, execute_dice_tool line 17)\n5. ✅ Two-phase docstrings (lines 296-314)\n6. ✅ Bracket-aware parsing in json_utils for malformed JSON safety net\n\n**Systemic Issues (Not Gemini-specific):**\n- sys.path hacks: Present in 133 test files codebase-wide\n- Test relocation would require larger refactoring effort\n\n**Recommendation:** Close jp2 as substantially complete. sys.path cleanup is a separate codebase-wide refactoring task.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-13T20:04:51.976245-05:00","updated_at":"2025-12-14T16:35:14.567079-08:00","closed_at":"2025-12-14T16:35:14.567079-08:00","source_repo":"."}
{"id":"worktree_worker3-m5p","content_hash":"c50faeb8431ca018cc8b966b21e7036394cc76d00bc760a60cff47eab8d7ba9e","title":"Schema bypass from Phase-2 skip optimization","description":"Commit 0c915737c skips Phase 2 whenever Phase 1 JSON parses, without any schema/required-field validation. This lets syntactically-valid but incomplete responses (missing planning_block, session_header, dice results, etc.) reach clients, reintroducing missing-field regressions. Restore validation: require schema/required fields before skipping; otherwise fall back to Phase 2.","status":"closed","priority":1,"issue_type":"bug","assignee":"code","created_at":"2025-12-17T20:26:48.865763-08:00","updated_at":"2025-12-17T20:32:26.828398-08:00","closed_at":"2025-12-17T20:32:26.828398-08:00","source_repo":".","labels":["p0","pr-2353","schema","validation"]}
{"id":"worktree_worker3-np8","content_hash":"e8a3b2c90e8f6fd780af685a5654046478519b0b835aceacedb88eae7dfcfd7b","title":"Unified Two-Phase Dice Architecture - Revert to Tool Loops","description":"Revert pre-computed dice approach back to LLM-driven tool loops. All providers use two-phase inference where LLM decides what dice to roll, server executes, LLM narrates result.\n\nKey insight: Gemini can use function calling, just not WITH JSON mode simultaneously. Solution: Phase 1 with tools (no JSON), Phase 2 with JSON (no tools).\n\nRoadmap: roadmap/unified_two_phase_dice_architecture.md","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-11T10:17:58.910614-05:00","updated_at":"2025-12-13T14:06:09.290726-05:00","closed_at":"2025-12-13T14:06:09.290726-05:00","source_repo":".","labels":["architecture","dice","pr-2353","tool-loops"]}
{"id":"worktree_worker3-sn2","content_hash":"72fbe03db9f8802c2cdaece718a871328c3b5f9580fa4e6de3706074529c9118","title":"BUG: clock_skew_credentials.py blocks test collection on import","description":"**Problem:**\n`world_logic.py` imports `clock_skew_credentials` and calls `apply_clock_skew_patch()` at module level (line 35). This triggers `validate_deployment_config()` which raises `ValueError` if `WORLDAI_GOOGLE_APPLICATION_CREDENTIALS` is set without `WORLDAI_DEV_MODE=true`.\n\n**Impact:**\n- Test collection fails for any test that imports `world_logic`\n- CI \"passes\" because CI doesn't have the env var - tests never run\n- Local devs with service account keys cannot run tests without setting extra env vars\n\n**Files Affected:**\n- `mvp_site/clock_skew_credentials.py:40-44` - The raising code\n- `mvp_site/world_logic.py:35` - Module-level call to `apply_clock_skew_patch()`\n- `mvp_site/tests/test_game_state.py:88` - Import fails here\n\n**Root Cause:**\nValidation logic runs at import time, not runtime. This is a design flaw - module imports should NEVER raise based on env vars.\n\n**Fix Required:**\n1. Make `validate_deployment_config()` return status, not raise\n2. OR defer validation until actual Firebase operation\n3. OR respect `TESTING=true` to skip validation entirely","acceptance_criteria":"- [ ] Tests can be collected without WORLDAI_DEV_MODE\n- [ ] TESTING=true bypasses clock skew validation\n- [ ] test_game_state.py runs in CI\n- [ ] Local devs can run tests with service account keys","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-11T06:01:18.00365-05:00","updated_at":"2025-12-11T06:03:03.560481-05:00","closed_at":"2025-12-11T06:03:03.560481-05:00","source_repo":".","labels":["bug","p0","testing"],"dependencies":[{"issue_id":"worktree_worker3-sn2","depends_on_id":"worktree_worker3-1hz","type":"related","created_at":"2025-12-11T06:01:23.566645-05:00","created_by":"daemon"}]}
{"id":"worktree_worker3-xke","content_hash":"56ada47896328be9002b8ee33573423ed6a86cb26d1221c43e6ce4ac70b3f496","title":"Add social encounter E2E tests for Intimidation/Deception and wire into CI","description":"Extend social encounter real API tests to cover Intimidation and Deception roll_skill_check calls, and enable these tests in CI/nightly so regressions are caught automatically.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-17T02:47:53.396259-08:00","updated_at":"2025-12-17T21:31:39.837868-08:00","closed_at":"2025-12-17T21:31:39.837868-08:00","source_repo":"."}
