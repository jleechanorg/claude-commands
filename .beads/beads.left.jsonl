{"id":"worktree_worker2-3gc","content_hash":"9cf95aacfa1d8e27e9af55a90e5aadaef14ce78afe3deb727e5b7b41ee53f2c1","title":"Finished combat phase lists inconsistent across enforcement and agent triggers","description":"finished_phases differ between RewardsAgent/GameState and server enforcement. RewardsAgent/GameState include {ended, concluding, concluded, finished, complete, completed, resolved, victory}, but _enforce_rewards_processed_flag uses only (ended, finished, resolved, complete, victory). If LLM sets phase like concluded/completed, enforcement won't set rewards_processed, risking duplicate processing or cleanup mismatches. See mvp_site/world_logic.py and mvp_site/agents.py/game_state.py.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-28T13:32:09.932832-05:00","updated_at":"2025-12-28T17:52:47.160195-05:00","closed_at":"2025-12-28T17:52:47.160195-05:00","source_repo":"."}
{"id":"worktree_worker2-bv9","content_hash":"5ef2128a688f44b7a4a03f358b44db65009d8a645c7150947a5ce9d456e3213e","title":"Fix LLM prompts to produce visible XP/level-up feedback","description":"Server-side level-up detection and combat turn processing work correctly, but LLM output doesn't always produce user-visible feedback.\n\n## Problems Identified\n\n1. **combat_summary missing**: LLM not generating combat_summary block with XP earned\n2. **No explicit XP text**: Narrative doesn't say \"You earned X XP!\" \n3. **Silent level-up**: Level increases without visible notification in narrative\n4. **Text prompts missing**: LLM uses structured planning_block but doesn't include \"Level up now/later?\" text\n\n## Evidence\n\n- combat_rewards_level_up: `combat_summary.present: false`, `level_up_detection.in_narrative: false`\n- narrative_xp_level_up: Level 4â†’5 silently, no rewards_pending shown\n- level_up_planning_block: `has_level_up_message: false`, `has_choice_prompt: false`\n\n## Root Cause\n\nPrompt instructions don't strictly require these outputs. LLM follows instructions loosely.","acceptance_criteria":"- [ ] combat_summary block generated after combat with XP earned\n- [ ] Narrative includes explicit \"You earned X XP\" or similar text\n- [ ] Level-up triggers visible notification in narrative (not silent)\n- [ ] Planning block includes text prompt for level-up choice\n- [ ] All test assertions pass with stricter criteria","status":"in_progress","priority":1,"issue_type":"bug","assignee":"claude","created_at":"2025-12-31T22:20:02.338634-08:00","updated_at":"2025-12-31T22:20:09.87737-08:00","source_repo":".","labels":["combat","level-up","llm-prompts","ux"]}
{"id":"worktree_worker2-chu","content_hash":"ecf01102816b1f2a708e6f0bdab76ff4790970f1f5b3cc1ba707c6b1f0b622a2","title":"Reduce duplication between GOD_MODE_UPDATE_STATE and unified flow warnings/corrections","description":"Current code duplicates XP extraction + post-combat warning logic in world_logic (unified flow) and _handle_update_state_command. This risks drift and inconsistent behavior. Evaluate refactoring into a shared helper and ensure response schema consistency for GOD_MODE_UPDATE_STATE.","acceptance_criteria":"- A shared helper handles XP extraction + post-combat warning detection used by both paths\n- GOD_MODE_UPDATE_STATE response includes corrections/warnings consistently with unified flow\n- No behavior regressions in god mode validation tests","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-30T00:37:05.410663-05:00","updated_at":"2025-12-30T01:04:54.230407-05:00","closed_at":"2025-12-30T01:04:54.230407-05:00","source_repo":"."}
{"id":"worktree_worker2-dsq","content_hash":"61925bb8c084a0964fa739d2b554c35e67d006c1bd33ca7764b08298c60e3004","title":"RewardsAgent follow-up drops rewards_box (structured response not merged)","description":"When RewardsAgent follow-up runs in world_logic, only narrative text is appended to the original response. The structured response from rewards_response_obj (including rewards_box) is never merged into the unified response or stored structured_fields. This can cause API/Firestore to omit rewards_box even though rewards were generated. See mvp_site/world_logic.py around follow-up (REWARDS_FOLLOWUP) and structured_response extraction near response build.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-28T13:31:52.161357-05:00","updated_at":"2025-12-28T17:52:46.694158-05:00","closed_at":"2025-12-28T17:52:46.694158-05:00","source_repo":"."}
{"id":"worktree_worker2-rqp","content_hash":"710b336be2044a052fa138b5d7005358a38c5fc7d1907dd40b9d8e4023700c57","title":"Encounter rewards can be marked processed without RewardsAgent trigger","description":"_enforce_rewards_processed_flag sets encounter_state.rewards_processed when encounter_summary.xp_awarded exists even if encounter_completed is false. RewardsAgent matches only when encounter_completed == true, so rewards can be marked processed and RewardsAgent never runs, losing user-visible rewards. See mvp_site/world_logic.py encounter enforcement and mvp_site/agents.py RewardsAgent.matches_game_state.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-28T13:32:01.158943-05:00","updated_at":"2025-12-28T17:52:46.219086-05:00","closed_at":"2025-12-28T17:52:46.219086-05:00","source_repo":"."}
{"id":"worktree_worker2-ulv","content_hash":"d795a05274feca9c5bde385a41d4702075c9f6f761df03aadb5c115ee27a5427","title":"RewardsAgent rewards output inconsistent (2/4 E2E fail; rewards_box/rewards_processed missing)","description":"E2E rewards test in /tmp/worktree_worker2/claude_implement-rewards-agent-ChnfS/rewards_e2e/20251228_020823/ shows 2/4 failures: combat end rewards_processed false despite combat_summary.xp_awarded, narrative kill returns empty narrative and rewards_processed false. Recent changes: rewards_box added to JSON schema and prompts; rewards_box optional; RewardsAgent prompt stack trimmed (no DND SRD/mechanics). Need root-cause analysis: state cleanup timing, schema enforcement, prompt clarity, and provider JSON-mode behavior. Goal: ensure rewards are user-visible and rewards_processed set even with format variations, without retries/validation.","notes":"Updated validation shows original 2/4 failure may be fixed, but new/adjacent issues remain: rewards are not user-visible (rewards_check.has_rewards_box=false in all scenarios, narrative indicators mostly 0), XP mismatches vs claims (e.g., scenario1 xp_awarded=150 not 50), and evidence capture is incomplete (server_logs.txt has 0 lines, rewards_e2e metadata missing origin/main + diff + server PID/port/env). Latest bundles checked: /tmp/worktree_worker2/claude_implement-rewards-agent-ChnfS/rewards_e2e/20251228_035005 and /20251228_032615. evidence.json has data under scenarios.*.steps; claims should reference those paths.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-28T02:22:06.70204-05:00","updated_at":"2025-12-28T17:52:47.637663-05:00","closed_at":"2025-12-28T17:52:47.637663-05:00","source_repo":"."}
