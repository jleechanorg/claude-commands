{"id":"worktree_worker2-1gp","content_hash":"fd220c82f839156b433e2b969bd20f958b4f44b092926a037c4dd8a6c931de96","title":"LLM Schema Alignment - Close 15+ instruction/schema gaps","description":"Close gaps between LLM instructions (what the LLM is told to do) and Python schemas (what we validate). Per CLAUDE.md: Document BOTH Input and Output Schemas with explicit field mappings.","acceptance_criteria":"- All Priority 1 (Critical) gaps have TDD tests and validation\n- All Priority 2 (High) gaps have TDD tests and validation\n- Priority 3-4 gaps documented with warn-mode validation\n- No regression in existing campaign functionality","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-11T00:02:24.364226-08:00","updated_at":"2026-01-11T00:02:24.364226-08:00","source_repo":".","labels":["llm","schema","tdd","validation"]}
{"id":"worktree_worker2-2bq","content_hash":"9c6f7257a7a4d3f536a1553d8a91842e233f3b011d4628e4eb60da8694fc76ac","title":"Phase 0: Prompt order invariants + tests","description":"Establish deterministic prompt ordering and guardrails.\n\nTasks:\n- Add ordered prompt list per mode (not set)\n- Runtime validation for mandatory head: master → game_state → planning_protocol\n- Add minimal tests asserting order for each mode\n\nAcceptance:\n- Prompt order deterministic across all agents\n- Head ordering enforced at runtime\n- Tests cover order invariants for all modes","status":"closed","priority":2,"issue_type":"task","assignee":"think","created_at":"2026-01-03T23:10:53.245515-08:00","updated_at":"2026-01-03T23:23:49.368887-08:00","closed_at":"2026-01-03T23:23:49.368887-08:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker2-2bq","depends_on_id":"worktree_worker2-lb3","type":"parent-child","created_at":"2026-01-03T23:11:49.626403-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-3gc","content_hash":"9cf95aacfa1d8e27e9af55a90e5aadaef14ce78afe3deb727e5b7b41ee53f2c1","title":"Finished combat phase lists inconsistent across enforcement and agent triggers","description":"finished_phases differ between RewardsAgent/GameState and server enforcement. RewardsAgent/GameState include {ended, concluding, concluded, finished, complete, completed, resolved, victory}, but _enforce_rewards_processed_flag uses only (ended, finished, resolved, complete, victory). If LLM sets phase like concluded/completed, enforcement won't set rewards_processed, risking duplicate processing or cleanup mismatches. See mvp_site/world_logic.py and mvp_site/agents.py/game_state.py.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-28T13:32:09.932832-05:00","updated_at":"2025-12-28T17:52:47.160195-05:00","closed_at":"2025-12-28T17:52:47.160195-05:00","source_repo":"."}
{"id":"worktree_worker2-3uk","content_hash":"422931876ad801dae78031680dd48782bd157846061419a5a34e33a88481e403","title":"Connect REQUIRED_PROMPTS to PromptBuilder (single source of truth)","description":"Each agent class defines REQUIRED_PROMPTS in agents.py, but PromptBuilder in agent_prompts.py hard-codes the same prompts separately. This violates DRY.\n\nExample of duplication:\n- agents.py StoryModeAgent.REQUIRED_PROMPTS lists: master_directive, game_state, planning_protocol, dnd_srd\n- agent_prompts.py build_core_system_instructions() manually loads the same prompts\n\nProposed solution:\n- PromptBuilder should read from agent's REQUIRED_PROMPTS\n- Add build_instructions_for_agent(agent: BaseAgent) method\n- Agent classes become single source of truth for their prompt requirements\n\nImpact: Eliminates duplicate definitions, prevents desync bugs","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T22:35:16.735171-08:00","updated_at":"2026-01-03T23:12:53.13345-08:00","closed_at":"2026-01-03T23:12:53.13345-08:00","source_repo":".","labels":["centralization","high-effort","refactor"]}
{"id":"worktree_worker2-3v5","content_hash":"6604b3e09cd99ae778913589810e76a8700131fd80c85fc0c486ce185d59a8f7","title":"Unify mode builder methods into single generic builder","description":"Replace 6 duplicate build_*_mode_instructions() methods in agent_prompts.py with a single generic builder.\n\nCurrently there are 6 nearly identical methods (lines 359-546):\n- build_core_system_instructions\n- build_god_mode_instructions\n- build_info_mode_instructions\n- build_combat_mode_instructions\n- build_rewards_mode_instructions\n- build_think_mode_instructions\n\nAll follow the same pattern of appending prompt files to a list.\n\nProposed solution:\n```python\ndef build_mode_instructions(self, prompt_types: list[str], include_debug: bool = False) -\u003e list[str]:\n    parts = []\n    for prompt_type in prompt_types:\n        parts.append(_load_instruction_file(prompt_type))\n    if include_debug:\n        parts.append(_build_debug_instructions())\n    return parts\n```\n\nImpact: Reduces ~150 LOC, single point of maintenance","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T22:35:16.187395-08:00","updated_at":"2026-01-03T23:13:00.569548-08:00","closed_at":"2026-01-03T23:13:00.569548-08:00","source_repo":".","labels":["centralization","high-effort","refactor"],"dependencies":[{"issue_id":"worktree_worker2-3v5","depends_on_id":"worktree_worker2-3uk","type":"related","created_at":"2026-01-03T22:35:30.269922-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-4j3","content_hash":"314259640f7fe0f46ef206bfce164f46e65ccea460a455bb689dea5342f4e0fe","title":"[P1-Critical] Social HP Input→Output Mapping - TDD","description":"Gap #8: Document explicit mapping from INPUT (npc_data.tier) to OUTPUT (social_hp_challenge.npc_tier).\n\nRED: Write test that validates npc_tier extraction from npc_data\nGREEN: Add documentation in game_state_instruction.md with explicit INPUT→OUTPUT section\nREFACTOR: Consider adding Python validation in SOCIAL_HP_CHALLENGE_SCHEMA","acceptance_criteria":"- [ ] Test written first (RED)\n- [ ] INPUT section documents npc_data.tier field\n- [ ] OUTPUT section documents social_hp_challenge.npc_tier\n- [ ] Explicit mapping: \"OUTPUT.npc_tier = extract from INPUT.npc_data.tier\"\n- [ ] Test passes (GREEN)","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-11T00:02:47.012409-08:00","updated_at":"2026-01-11T00:02:47.012409-08:00","source_repo":".","labels":["priority-1","schema","tdd"],"dependencies":[{"issue_id":"worktree_worker2-4j3","depends_on_id":"worktree_worker2-1gp","type":"parent-child","created_at":"2026-01-11T00:03:01.343005-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-5jj","content_hash":"32ed9f36de4767d8be549ace221c9fa9459de4b481b97487d7e514f3f6e69360","title":"[P1-Critical] Combat State Schema Validation - TDD","description":"Gap #4: Add formal schema for combat_state validation.\n\nRED: Write tests for validate_combat_state() with valid/invalid cases\n- combat_phase enum validation (initiating/active/ended/fled)\n- combat_session_id format validation\n- initiative_order structure validation\nGREEN: Add COMBAT_STATE_SCHEMA and validate_combat_state() to narrative_response_schema.py\nREFACTOR: Integrate with _validate_state_updates(), strict mode","acceptance_criteria":"- [ ] Test class TestCombatStateSchema written first (RED)\n- [ ] validate_combat_state() function implemented\n- [ ] COMBAT_PHASE_ENUM validated\n- [ ] All tests pass (GREEN)\n- [ ] Integrated with NarrativeResponse validation chain","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-11T00:02:47.510606-08:00","updated_at":"2026-01-11T00:02:47.510606-08:00","source_repo":".","labels":["combat","priority-1","schema","tdd"],"dependencies":[{"issue_id":"worktree_worker2-5jj","depends_on_id":"worktree_worker2-1gp","type":"parent-child","created_at":"2026-01-11T00:03:01.823427-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-68v","content_hash":"140df663ec2361171026f04f22257bfb376c12e849bccf021300c80f877468d3","title":"Add Python schema validation for spell slots and resources","description":"Add explicit JSON schema input/output validation for spell slots, resources, and related D\u0026D 5rrative_response_schema.py`, following the pattern established in PR #3470State:**\n- Documentation exists in `game_state_instruction.md` showing structures but NO Python validation\n- `self.resources = self._validate_string_field(resources, \"resources\")` treats resources as string, not structured object\n- PR #2716based validation protocol but no Python schema validation\n\n**Gap Analysis:** See `roadmap/schema_validation_gaps_resources_spells.md` for comprehensive analysis\n\n**Priority 1 (Critical):**\n1. RESOURCES_SCHEMA - Validate resources structure (gold, hit_dice, spell_slots, class_features, consumables)\n2TS_SCHEMA - Validate spell_slots structure (`level_X: {current, max}`)\n3ATURES_SCHEMA - Validate class-specific resources (bardic_inspiration, ki_points, rage, etc.)\n\n**Priority 2 (High):**4_SCHEMA - Validate base_attributes vs attributes relationship\n5. EXPERIENCE_SCHEMA - Validate experience structure6VES_SCHEMA - Validate death_saves (successes: 0-3, failures: 0-3)\n7. SPELLS_KNOWN_SCHEMA - Validate spells_known array (must have name + level)\n\n**Priority 3 (Medium):**\n8. STATUS_CONDITIONS_SCHEMA - Validate status_conditions array\n9. ACTIVE_EFFECTS_SCHEMA - Validate active_effects array\n10. COMBAT_STATS_SCHEMA - Validate combat_stats structure\n11. ITEM_SCHEMAS - Validate weapon/armor/item structures\n\n**Implementation Pattern:** Follow PR #3470: define schema constants, create validation functions, integrate into `_validate_state_updates()`, add tests, document INPUT/OUTPUT schemas.","design":"**Comprehensive Schema Validation Gap Analysis**\n\nBased on D\u0026D SRD (`dnd_srd_instruction.md`) and game state documentation (`game_state_instruction.md`), the following structures need Python schema validation:\n\n**Priority 1 (Critical - Core Gameplay):**\n1. **RESOURCES_SCHEMA** - `player_character_data.resources`\n   - `gold`: int (\u003e= 0)\n   - `hit_dice`: `{used: int (0l: int (\u003e= 0)}`\n   - `spell_slots`: `{level_X: {current: int (0-max), max: int (\u003e= 0)}}`\n   - `class_features`: dict (varies by class)\n   - `consumables`: dict/array\n\n2. **SPELL_SLOTS_SCHEMA** - Validate `spell_slots` structure\n   - Format: `{level_1: {current, max}, level_2: {current, max}, ...}`\n   - Level keys: `level_1` through `level_9`\n   - Current/max must be integers, current \u003c= max, current \u003e= 0\n\n3. **CLASS_FEATURES_SCHEMA** - Validate class-specific resources\n   - `bardic_inspiration`: `{current: int, max: int}`\n   - `ki_points`: `{current: int, max: int}`\n   - `rage`: `{current: int, max: int}`\n   - `channel_divinity`: `{current: int, max: int}`\n   - `lay_on_hands`: `{current: int, max: int}` (pool = level × 5)\n   - `sorcery_points`: `{current: int, max: int}` (max = sorcerer level)\n   - `wild_shape`: `{current: int, max: int}` (max = 2)\n\n**Priority 2 (High - State Integrity):**\n4. **ATTRIBUTES_SCHEMA** - Validate base_attributes vs attributes relationship\n   - `base_attributes`: dict with STR/DEX/CON/INT/WIS/CHA (int, 1-30)\n   - `attributes`: dict with same keys (int, 1-30 - Validation: `attributes[stat] = base_attributes[stat] + sum(equipment bonuses)`\n   - Must satisfy: attributes \u003e= base_attributes (equipment can only add)\n\n5. **EXPERIENCE_SCHEMA** - Validate experience structure\n   - `current`: int (\u003e= 0)\n   - `needed_for_next_level`: int (\u003e= current)\n\n6_SAVES_SCHEMA** - Validate death saves\n   - `successes`: int (0-3)\n   - `failures`: int (0If successes == 3: stabilized\n   - If failures == 3: death\n\n7. **SPELLS_KNOWN_SCHEMA** - Validate spells_known array\n   - Array of dicts with required fields: `name` (str), `level` (int, 0-9)\n   - Optional: `school`, `casting_time`, `range`, `components`, `duration`\n\n**Priority 3 (Medium - Data Quality):**\n8. **STATUS_CONDITIONS_SCHEMA** - Validate status_conditions array\n   - Array of strings (Poisoned, Frightened, Prone, etc.)\n   - Should reference D\u0026D 59VE_EFFECTS_SCHEMA** - Validate active_effects array\n   - Array of strings describing persistent buffs/effects\n10 **COMBAT_STATS_SCHEMA** - Validate combat_stats structure\n    - `initiative`: int\n    - `speed`: int (\u003e=0eption`: int (\u003e= 0)11M_SCHEMAS** - Validate equipment items\n    - Weapon schema: `{name, type: \"weapon\", damage, damage_type, properties, bonus, weight, value_gp}`\n    - Armor schema: `{name, type: \"armor\", armor_class, armor_type, stealth_disadvantage, strength_requirement, weight, value_gp}`\n    - General item schema: `{name, type, effect, charges, weight, value_gp}`\n\n**Implementation Approach:**\n- Follow PR #3470 pattern: define schema constants, create validation functions, integrate into `_validate_state_updates()`\n- Document INPUT schema (what LLM receives from game_state) and OUTPUT schema (what LLM must return)\n- Add comprehensive test coverage for all validation functions\n- Handle edge cases (unhashable types, None values, type coercion)","acceptance_criteria":"1All Priority 1pell_slots, class_features) have Python validation functions\n2riority 2 schemas (attributes, experience, death_saves, spells_known) have Python validation functions\n3. Validation functions integrated into `_validate_state_updates()` method\n4. Comprehensive test coverage (minimum 3-5 tests per schema)\n5. INPUT/OUTPUT schema documentation added to `game_state_instruction.md` following PR #3470 pattern\n6ll validation functions handle unhashable types gracefully (isinstance checks before set membership)\n7. Validation warnings logged but don't block state updates (permissive validation pattern)","notes":"**PR Investigation Results:**\n\n**PR #2716 (MERGED 2025-12-29):** Added spell slot validation PROTOCOL (prompt-based instructions) but NO Python schema validation. Only modified `game_state_instruction.md` and added test file `test_resource_validation_real_api.py`. No changes to `narrative_response_schema.py`.\n\n**PR #2385 (MERGED 2025ized JSON schema documentation but did NOT add resources/spell slots validation. Only removed dead code and documented schema hierarchy.\n\n**PR #3470 schema validation for combat_state, reputation, relationships, world_time, encounter_state, frozen_plans, directives, equipment slots, arc_milestones, time_pressure_warnings - but did NOT include resources/spell slots.\n\n**Conclusion:** No PRs have attempted to add Python schema validation for spell slots and resources. This is a genuine gap that needs to be addressed.\n\n**D\u0026D SRD Analysis Results:**\nAnalyzed `dnd_srd_instruction.md` and `game_state_instruction.md` to identify additional structures that need schema validation:\n- Resources (spell_slots, hit_dice, class_features, consumables, gold)\n- Attributes (base_attributes vs attributes relationship validation)\n- Experience structure\n- Death saves (successes: 0-3, failures: 0-3)\n- Status conditions array\n- Active effects array\n- Spells known array (must have name + level)\n- Combat stats (initiative, speed, passive_perception)\n- Item schemas (weapons, armor, consumables)","status":"open","priority":2,"issue_type":"feature","created_at":"2026-01-11T01:49:53.698291-08:00","updated_at":"2026-01-11T02:01:45.415348-08:00","source_repo":"."}
{"id":"worktree_worker2-6je","content_hash":"424229000db2ab427fd23a4bcc8271840833356a3295068c12e669375ccbd0cd","title":"[P3-Medium] Equipment Slot Enum Validation","description":"Gap #13: Add valid slot validation and forbidden slot name checking.\n\nValid slots: head, body, armor, cloak, hands, feet, neck, ring_1, ring_2, belt, shield, main_hand, off_hand, instrument, weapons, backpack\nForbidden mappings: weapon_main→main_hand, boots→feet","acceptance_criteria":"- [ ] EQUIPMENT_SLOT_ENUM defined\n- [ ] Forbidden slot mappings documented\n- [ ] Add warn-mode validation","status":"open","priority":3,"issue_type":"chore","created_at":"2026-01-11T00:04:07.799047-08:00","updated_at":"2026-01-11T00:04:07.799047-08:00","source_repo":".","labels":["equipment","priority-3","schema"],"dependencies":[{"issue_id":"worktree_worker2-6je","depends_on_id":"worktree_worker2-1gp","type":"parent-child","created_at":"2026-01-11T00:04:22.564862-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-a01","content_hash":"fa03676c2d3f1d8616d835c97f641fc719043ef1ea547848487f09e2c5dca2fe","title":"Remove manual planning_protocol additions (5 places)","description":"planning_protocol is manually added at 5 different places in agent_prompts.py:\n- Line 377 (build_core_system_instructions)\n- Line 434 (build_info_mode_instructions)\n- Line 471 (build_combat_mode_instructions)\n- Line 507 (build_rewards_mode_instructions)\n- Line 536 (build_think_mode_instructions)\n\nThis is a symptom of the broader duplication issue.\n\nDepends on: Unified mode builder implementation\n\nOnce REQUIRED_PROMPTS drives the builder, planning_protocol will be loaded automatically when it's in the agent's requirements.\n\nImpact: No more forgetting to add planning_protocol to new modes","status":"closed","priority":3,"issue_type":"chore","created_at":"2026-01-03T22:35:18.894719-08:00","updated_at":"2026-01-03T22:52:50.534237-08:00","closed_at":"2026-01-03T22:52:50.534237-08:00","source_repo":".","labels":["centralization","low-effort","refactor"],"dependencies":[{"issue_id":"worktree_worker2-a01","depends_on_id":"worktree_worker2-3v5","type":"blocks","created_at":"2026-01-03T22:35:29.307604-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-b1a","content_hash":"ea9105c8e92ec8cc85f7d3b8044fbdb0673db4bc4a85d428f2d9bb73f4018c62","title":"Add PROMPT_ORDER configuration to agent classes","description":"Each mode has a specific loading order (master directive MUST be first). This order is currently implicit in code across multiple methods.\n\nProposed solution:\nAdd explicit PROMPT_ORDER list to each agent class:\n```python\nclass CombatAgent(BaseAgent):\n    PROMPT_ORDER = [\n        constants.PROMPT_TYPE_MASTER_DIRECTIVE,  # 1st: authority\n        constants.PROMPT_TYPE_GAME_STATE,         # 2nd: schema\n        constants.PROMPT_TYPE_COMBAT,             # 3rd: mode-specific\n        ...\n    ]\n    INCLUDE_DEBUG = True\n```\n\nThe generic builder then uses this order.\n\nImpact: Explicit, documented ordering; easier to modify per-agent","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:35:17.273614-08:00","updated_at":"2026-01-03T23:13:05.780234-08:00","closed_at":"2026-01-03T23:13:05.780234-08:00","source_repo":".","labels":["centralization","medium-effort","refactor"],"dependencies":[{"issue_id":"worktree_worker2-b1a","depends_on_id":"worktree_worker2-3v5","type":"blocks","created_at":"2026-01-03T22:35:29.789502-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-bff","content_hash":"349b8706ba84dbee8f759bdd9ca0b87234b5da102ce6957d4d149ad7ae1deff6","title":"Remove unused import in llm_service to avoid Ruff F401","description":"mvp_site/llm_service.py imports build_continuation_prompt but does not use it. With Ruff enabled, this likely triggers F401 and can fail CI/lint. File: mvp_site/llm_service.py:94-100.","acceptance_criteria":"- build_continuation_prompt import removed (or used) without introducing lint errors.\n- Ruff check passes for this file.","status":"closed","priority":4,"issue_type":"bug","created_at":"2026-01-04T16:55:00.05887-08:00","updated_at":"2026-01-04T16:58:27.254191-08:00","closed_at":"2026-01-04T16:58:27.254191-08:00","source_repo":"."}
{"id":"worktree_worker2-bv9","content_hash":"5ef2128a688f44b7a4a03f358b44db65009d8a645c7150947a5ce9d456e3213e","title":"Fix LLM prompts to produce visible XP/level-up feedback","description":"Server-side level-up detection and combat turn processing work correctly, but LLM output doesn't always produce user-visible feedback.\n\n## Problems Identified\n\n1. **combat_summary missing**: LLM not generating combat_summary block with XP earned\n2. **No explicit XP text**: Narrative doesn't say \"You earned X XP!\" \n3. **Silent level-up**: Level increases without visible notification in narrative\n4. **Text prompts missing**: LLM uses structured planning_block but doesn't include \"Level up now/later?\" text\n\n## Evidence\n\n- combat_rewards_level_up: `combat_summary.present: false`, `level_up_detection.in_narrative: false`\n- narrative_xp_level_up: Level 4→5 silently, no rewards_pending shown\n- level_up_planning_block: `has_level_up_message: false`, `has_choice_prompt: false`\n\n## Root Cause\n\nPrompt instructions don't strictly require these outputs. LLM follows instructions loosely.","acceptance_criteria":"- [ ] combat_summary block generated after combat with XP earned\n- [ ] Narrative includes explicit \"You earned X XP\" or similar text\n- [ ] Level-up triggers visible notification in narrative (not silent)\n- [ ] Planning block includes text prompt for level-up choice\n- [ ] All test assertions pass with stricter criteria","status":"closed","priority":1,"issue_type":"bug","assignee":"claude","created_at":"2025-12-31T22:20:02.338634-08:00","updated_at":"2025-12-31T22:25:36.957433-08:00","closed_at":"2025-12-31T22:25:36.957433-08:00","source_repo":".","labels":["combat","level-up","llm-prompts","ux"]}
{"id":"worktree_worker2-cf9","content_hash":"4f325b5433956319daf0f325a0a358d87e0b4f18f5b6b70173fdc574b0ef9eee","title":"Centralize mode detection functions in constants.py","description":"is_think_mode() is already in constants.py, but GodModeAgent.matches_input() and InfoAgent detection logic are scattered in agents.py.\n\nCurrently:\n- constants.is_think_mode() - centralized ✓\n- GodModeAgent.matches_input() - inline in agents.py\n- InfoAgent pattern matching - INFO_QUERY_PATTERNS in agents.py\n- STORY_ACTION_VERBS - in agents.py\n\nProposed solution:\nMove all mode detection to constants.py:\n```python\n# constants.py\ndef is_god_mode(user_input: str) -\u003e bool:\n    return user_input.strip().upper().startswith(\"GOD MODE:\")\n\ndef is_info_query(user_input: str) -\u003e bool:\n    # Move INFO_QUERY_PATTERNS logic here\n    ...\n```\n\nImpact: Single location for all mode detection logic","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T22:35:17.829377-08:00","updated_at":"2026-01-03T23:13:13.645359-08:00","closed_at":"2026-01-03T23:13:13.645359-08:00","source_repo":".","labels":["centralization","low-effort","refactor"]}
{"id":"worktree_worker2-chu","content_hash":"ecf01102816b1f2a708e6f0bdab76ff4790970f1f5b3cc1ba707c6b1f0b622a2","title":"Reduce duplication between GOD_MODE_UPDATE_STATE and unified flow warnings/corrections","description":"Current code duplicates XP extraction + post-combat warning logic in world_logic (unified flow) and _handle_update_state_command. This risks drift and inconsistent behavior. Evaluate refactoring into a shared helper and ensure response schema consistency for GOD_MODE_UPDATE_STATE.","acceptance_criteria":"- A shared helper handles XP extraction + post-combat warning detection used by both paths\n- GOD_MODE_UPDATE_STATE response includes corrections/warnings consistently with unified flow\n- No behavior regressions in god mode validation tests","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-30T00:37:05.410663-05:00","updated_at":"2025-12-30T01:04:54.230407-05:00","closed_at":"2025-12-30T01:04:54.230407-05:00","source_repo":"."}
{"id":"worktree_worker2-dsq","content_hash":"61925bb8c084a0964fa739d2b554c35e67d006c1bd33ca7764b08298c60e3004","title":"RewardsAgent follow-up drops rewards_box (structured response not merged)","description":"When RewardsAgent follow-up runs in world_logic, only narrative text is appended to the original response. The structured response from rewards_response_obj (including rewards_box) is never merged into the unified response or stored structured_fields. This can cause API/Firestore to omit rewards_box even though rewards were generated. See mvp_site/world_logic.py around follow-up (REWARDS_FOLLOWUP) and structured_response extraction near response build.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-28T13:31:52.161357-05:00","updated_at":"2025-12-28T17:52:46.694158-05:00","closed_at":"2025-12-28T17:52:46.694158-05:00","source_repo":"."}
{"id":"worktree_worker2-g10","content_hash":"4133476da933e15c708e036e7befd8d864c1c05e3a148a1b8f43bf62e890c6ee","title":"[P2-High] Relationship Schema Validation - TDD","description":"Gap #1: Add schema for trust_level range and disposition enum.\n\nRED: Write tests for validate_relationship() with:\n- trust_level range (-10 to +10)\n- disposition enum (hostile/antagonistic/cold/neutral/friendly/trusted/devoted/bonded)\n- history/debts/grievances as arrays\nGREEN: Add RELATIONSHIP_SCHEMA and validate_relationship() to narrative_response_schema.py\nREFACTOR: Integrate with _validate_state_updates(), strict mode","acceptance_criteria":"- [ ] Test class TestRelationshipSchema written first (RED)\n- [ ] validate_relationship() function implemented\n- [ ] trust_level range -10 to +10 validated\n- [ ] disposition enum validated\n- [ ] All tests pass (GREEN)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-11T00:03:24.944008-08:00","updated_at":"2026-01-11T00:03:24.944008-08:00","source_repo":".","labels":["priority-2","relationship","schema","tdd"],"dependencies":[{"issue_id":"worktree_worker2-g10","depends_on_id":"worktree_worker2-1gp","type":"parent-child","created_at":"2026-01-11T00:03:38.329616-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-gg3","content_hash":"4fca0808d7bfc8ba1509a67c28d20600c01bd3a3efeb5c61c689e1391c2dc3e8","title":"Resolve surrender XP vs combat-state consistency conflict","description":"Narrative prompt still mandates XP award on surrender, but combat prompt now flags any enemies_defeated with hp_current \u003e 0 as inconsistent and removed surrendered exception. This forces either invalid state or treating surrendered enemies as dead, risking XP suppression or state drift. Files: mvp_site/prompts/narrative_system_instruction.md (XP on surrender), mvp_site/prompts/combat_system_instruction.md (combat end checklist).","acceptance_criteria":"- Combat and narrative prompts define a single, consistent representation for surrendered enemies.\n- XP award behavior for surrender is explicitly specified and matches combat-state rules.\n- No instruction requires enemies to be both surrendered and hp_current \u003e 0 if that is considered invalid (or update the checklist to allow it with status).\n- Update/verify any related tests or docs if needed.","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-04T16:54:51.996043-08:00","updated_at":"2026-01-04T16:58:21.273261-08:00","closed_at":"2026-01-04T16:58:21.273261-08:00","source_repo":"."}
{"id":"worktree_worker2-ipj","content_hash":"39388af2d0a0c9d70b0ab6077671c698a86ea6d5232f54729062aa9445a5f68d","title":"[P2-High] Encounter State Schema Validation - TDD","description":"Gap #5: Add encounter_type enum validation.\n\nRED: Write tests for validate_encounter_state() with:\n- encounter_type enum (heist/social/stealth/puzzle/quest/narrative_victory)\n- encounter_id format validation\n- difficulty enum (easy/medium/hard/deadly)\nGREEN: Add ENCOUNTER_STATE_SCHEMA and validate_encounter_state()\nREFACTOR: Integrate with _validate_state_updates()","acceptance_criteria":"- [ ] Test class TestEncounterStateSchema written first (RED)\n- [ ] validate_encounter_state() function implemented\n- [ ] encounter_type enum validated\n- [ ] difficulty enum validated\n- [ ] All tests pass (GREEN)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-11T00:03:25.93811-08:00","updated_at":"2026-01-11T00:03:25.93811-08:00","source_repo":".","labels":["encounter","priority-2","schema","tdd"],"dependencies":[{"issue_id":"worktree_worker2-ipj","depends_on_id":"worktree_worker2-1gp","type":"parent-child","created_at":"2026-01-11T00:03:39.233952-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-ix3","content_hash":"a265f0c9baef8dbc64fd55490d6a75c87de894abc66ea4b342c64170c016ebe3","title":"Clean up unused parameter deletion pattern in agents","description":"All 6 agent classes delete the same unused parameters in build_system_instructions():\n\n```python\n# Lines 395-396, 506-508, 655-657, 765-767, 896-897\ndel selected_prompts, use_default_world, include_continuation_reminder, turn_number\ndel llm_requested_sections\n```\n\nThis is a code smell - the interface is too broad.\n\nOptions:\n1. Use **kwargs pattern for fixed-prompt agents\n2. Create FixedPromptAgent base class that ignores user selections\n3. Split interface: build_dynamic_instructions() vs build_fixed_instructions()\n\nImpact: Cleaner code, better type hints, self-documenting API","status":"closed","priority":3,"issue_type":"chore","created_at":"2026-01-03T22:35:18.366132-08:00","updated_at":"2026-01-03T23:13:19.466616-08:00","closed_at":"2026-01-03T23:13:19.466616-08:00","source_repo":".","labels":["code-quality","low-effort","refactor"]}
{"id":"worktree_worker2-iyz","content_hash":"3707784437132b6da963802055b7000d6ba46536d13f12d996d55357b2f44a05","title":"Resource Validation Test Investigation: PR #3474 Impact Analysis","description":"Investigating if PR #3474 (action_resolution REQUIRED) broke resource validation tests that were passing in PR #2716 (3/4 tests passing).\n\nWorktrees created:\n- worktree_test_main: origin/main (current state, after PR #3474)\n- worktree_test_before_3474: commit before PR #3474 (2fcd3c94a^)\n\nTest: test_resource_validation_real_api.py --start-local --real-services --spell-slots-only\n\nHypothesis: PR #3474 made action_resolution REQUIRED for ALL actions, adding cognitive load and pushing spell slot validation instructions 800+ lines later in prompt file, causing LLM to fail resource validation checks.","notes":"Worktree locations:\n- worktree_test_main: /Users/jleechan/projects/worktree_test_main (commit 2fcd3c94a - after PR #3474ee_test_before_3474ers/jleechan/projects/worktree_test_before_3474 (commit 30PR #3474)\n- worktree_test_after_2716echan/projects/worktree_test_after_2716 (commit ef50ce45e - PR #2716 merge commit, Dec 28, 2025: python test_resource_validation_real_api.py --start-local --real-services --spell-slots-only\n\nTest results (origin/main, after PR #3474):\n- 4/6 passed (67%)\n- 2 failed: Healing Word auto-upcast, Fireball not rejected\n\nTest results (before PR #3474):\n- 0/6 passed (0%)\n- All failed with regex error: \"nothing to repeat at position 116esting PR #2716mmit (ef50ce45","status":"open","priority":2,"issue_type":"bug","created_at":"2026-01-12T04:23:28.19892-08:00","updated_at":"2026-01-12T05:05:30.827652-08:00","source_repo":"."}
{"id":"worktree_worker2-jzm","content_hash":"d18d8ff4e4b022f2443efc798fc9d142949ff325572c742195cf724510b2a8c2","title":"Phase 4: API cleanup + test deduplication","description":"Clean interface and reduce test duplication.\n\nTasks:\n- Introduce FixedPromptAgent to avoid unused parameter deletions\n- Parametrize prompt tests, reduce duplication\n- Keep prompt-order invariants covered by minimal tests\n\nAcceptance:\n- No unused-parameter delete patterns in agent build methods\n- Tests are concise and focus on order/contents\n- All prompt-related tests remain green","status":"closed","priority":3,"issue_type":"task","assignee":"think","created_at":"2026-01-03T23:11:26.784364-08:00","updated_at":"2026-01-04T07:31:32.404279-08:00","closed_at":"2026-01-04T07:31:32.404279-08:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker2-jzm","depends_on_id":"worktree_worker2-lb3","type":"parent-child","created_at":"2026-01-03T23:12:14.085954-08:00","created_by":"daemon"},{"issue_id":"worktree_worker2-jzm","depends_on_id":"worktree_worker2-xgu","type":"blocks","created_at":"2026-01-03T23:12:46.449413-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-kg6","content_hash":"0fc02e8d5be0d2a50d2df2c4a14f86b4b15fa3997d7007432af94af023bafac1","title":"[P2-High] World Time Schema Validation - TDD","description":"Gap #7: Add validation for all 8 required world_time fields.\n\nRED: Write tests for validate_world_time() with:\n- year (integer)\n- month (string/integer)\n- day (1-31)\n- hour (0-23)\n- minute (0-59)\n- second (0-59)\n- microsecond (0-999999)\n- time_of_day enum (Dawn/Morning/Midday/Afternoon/Evening/Night/Deep Night)\nGREEN: Add WORLD_TIME_SCHEMA and validate_world_time() to narrative_response_schema.py\nREFACTOR: Integrate with state_updates.world_data validation","acceptance_criteria":"- [ ] Test class TestWorldTimeSchema written first (RED)\n- [ ] validate_world_time() function implemented\n- [ ] All 8 fields validated with correct ranges\n- [ ] time_of_day enum validated\n- [ ] All tests pass (GREEN)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-11T00:03:25.439132-08:00","updated_at":"2026-01-11T00:03:25.439132-08:00","source_repo":".","labels":["priority-2","schema","tdd","world-time"],"dependencies":[{"issue_id":"worktree_worker2-kg6","depends_on_id":"worktree_worker2-1gp","type":"parent-child","created_at":"2026-01-11T00:03:38.783586-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-lb3","content_hash":"c1abde0aa9829609e4bf27ff7c5e6b06140aa80a553cc958c57920b43dd96080","title":"Long-term: single-entry prompt builder with ordered prompt contracts","description":"Establish a clean, ordered prompt-loading architecture with a single entry point and minimal duplication.\n\n## Goal\n- One authoritative prompt-loading path\n- Explicit, ordered prompt contracts per mode\n- Clean, minimal tests that assert order + content\n\n## Plan (phased)\n### Phase 0: Order invariants\n- Add ordered prompt list per mode (not sets)\n- Runtime validation for mandatory head: master → game_state → planning_protocol\n- Add lightweight tests asserting order for each mode\n\n### Phase 1: Generic builder\n- Introduce `PromptBuilder.build_mode_instructions(order, *, include_debug, include_world)`\n- Replace per-mode builders with generic calls + flags\n- Preserve mode-specific behavior (info trimmed, combat/rewards debug, etc.)\n\n### Phase 2: Ordered agent contracts\n- Replace `REQUIRED_PROMPTS: frozenset` with `REQUIRED_PROMPT_ORDER: list[str]`\n- Optional prompts keep separate ordered list when loaded\n- Update tests to compare ordered lists\n\n### Phase 3: Agent→builder contract\n- Add `BaseAgent.prompt_order()` and `BaseAgent.builder_flags()`\n- Single entry point: `PromptBuilder.build_for_agent(agent)`\n- Golden tests per agent for instruction order\n\n### Phase 4: Cleanup\n- Remove `del unused params` via FixedPromptAgent base class\n- Parametrize tests to reduce duplication\n\n## Acceptance Criteria\n- Prompt order deterministic and validated\n- Single code path for prompt building per agent\n- Tests assert order + key content with minimal duplication\n- No regressions in prompt-loading E2E tests\n","notes":"Phased plan broken into beads: Phase0=2bq, Phase1=pgn, Phase2=u1b, Phase3=xgu, Phase4=jzm. Use lb3 as epic/umbrella.","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-03T22:54:14.371028-08:00","updated_at":"2026-01-04T07:31:32.88805-08:00","closed_at":"2026-01-04T07:31:32.88805-08:00","source_repo":"."}
{"id":"worktree_worker2-otq","content_hash":"f8df13bfbf40368efaf2d901f25dd6f4f41ed75bede6eac2029d1d0c0a9cb942","title":"[P4-Low] Arc Milestones Schema - Document Structure","description":"Gap #6: Document arc_milestones structure (status, phase, progress, timestamps).","acceptance_criteria":"- [ ] Document arc_milestones JSON structure","status":"open","priority":4,"issue_type":"chore","created_at":"2026-01-11T00:04:08.293548-08:00","updated_at":"2026-01-11T00:04:08.293548-08:00","source_repo":".","labels":["documentation","priority-4","schema"],"dependencies":[{"issue_id":"worktree_worker2-otq","depends_on_id":"worktree_worker2-1gp","type":"parent-child","created_at":"2026-01-11T00:04:23.026006-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-oy4","content_hash":"466ece1f12f05543bae1f7d574f896f31c4f166fcca60a58f06b7bd8ed1f2e0e","title":"[P1-Critical] Reputation Schema Validation - TDD","description":"Gap #2: Add schema for public/private reputation validation.\n\nRED: Write tests for validate_reputation() with:\n- public.score range (-100 to +100)\n- public.notoriety_level enum\n- private.\u003cfaction\u003e.score range (-10 to +10)\n- private.\u003cfaction\u003e.standing enum\nGREEN: Add REPUTATION_SCHEMA and validate_reputation() to narrative_response_schema.py\nREFACTOR: Integrate with _validate_state_updates(), strict mode","acceptance_criteria":"- [ ] Test class TestReputationSchema written first (RED)\n- [ ] validate_reputation() function implemented\n- [ ] Public score range -100 to +100 validated\n- [ ] Private faction score range -10 to +10 validated\n- [ ] Enum values validated for notoriety_level and standing\n- [ ] All tests pass (GREEN)","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-11T00:02:48.01384-08:00","updated_at":"2026-01-11T00:02:48.01384-08:00","source_repo":".","labels":["priority-1","reputation","schema","tdd"],"dependencies":[{"issue_id":"worktree_worker2-oy4","depends_on_id":"worktree_worker2-1gp","type":"parent-child","created_at":"2026-01-11T00:03:02.288657-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-pgn","content_hash":"792ddcdae3ce5945ae72a2fc9e83a9cf405e1ea1702fc3286ec47abd67a94e7e","title":"Phase 1: Generic prompt builder + mode flags","description":"Replace mode-specific builders with a generic builder while preserving behavior.\n\nTasks:\n- Add PromptBuilder.build_mode_instructions(order, *, include_debug, include_world)\n- Replace per-mode builders with generic calls + flags\n- Ensure mode-specific behavior unchanged (info trimmed, combat/rewards debug)\n\nAcceptance:\n- One generic builder used by all modes\n- No behavior regressions vs current prompt content/order\n- Existing prompt-loading tests still pass","status":"closed","priority":2,"issue_type":"task","assignee":"think","created_at":"2026-01-03T23:11:01.493023-08:00","updated_at":"2026-01-04T01:14:25.196224-08:00","closed_at":"2026-01-04T01:14:25.196224-08:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker2-pgn","depends_on_id":"worktree_worker2-lb3","type":"parent-child","created_at":"2026-01-03T23:11:57.124226-08:00","created_by":"daemon"},{"issue_id":"worktree_worker2-pgn","depends_on_id":"worktree_worker2-2bq","type":"blocks","created_at":"2026-01-03T23:12:21.73826-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-rqp","content_hash":"710b336be2044a052fa138b5d7005358a38c5fc7d1907dd40b9d8e4023700c57","title":"Encounter rewards can be marked processed without RewardsAgent trigger","description":"_enforce_rewards_processed_flag sets encounter_state.rewards_processed when encounter_summary.xp_awarded exists even if encounter_completed is false. RewardsAgent matches only when encounter_completed == true, so rewards can be marked processed and RewardsAgent never runs, losing user-visible rewards. See mvp_site/world_logic.py encounter enforcement and mvp_site/agents.py RewardsAgent.matches_game_state.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-28T13:32:01.158943-05:00","updated_at":"2025-12-28T17:52:46.219086-05:00","closed_at":"2025-12-28T17:52:46.219086-05:00","source_repo":"."}
{"id":"worktree_worker2-tuq","content_hash":"fb29b1eb35c5addce9667e3f57a98866ef47456572f5ebbdee2521e32171ecf4","title":"[P3-Medium] Directives Schema - Add/Drop Validation","description":"Gap #12: Add add/drop array validation for directives.\n\nCurrently directives is initialized to {} with no validation for add/drop structure.","acceptance_criteria":"- [ ] Validate directives.add is array of strings\n- [ ] Validate directives.drop is array of strings\n- [ ] Add warn-mode validation","status":"open","priority":3,"issue_type":"chore","created_at":"2026-01-11T00:04:07.28641-08:00","updated_at":"2026-01-11T00:04:07.28641-08:00","source_repo":".","labels":["priority-3","schema"],"dependencies":[{"issue_id":"worktree_worker2-tuq","depends_on_id":"worktree_worker2-1gp","type":"parent-child","created_at":"2026-01-11T00:04:22.108405-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-u1b","content_hash":"6b3905a6ee9410615c55e061ad9cbe3b4d5994204b80eaf2022e90e59c602ab9","title":"Phase 2: Ordered agent prompt contracts","description":"Make agents the ordered source of truth for required prompts.\n\nTasks:\n- Replace REQUIRED_PROMPTS set with REQUIRED_PROMPT_ORDER list per agent\n- Keep OPTIONAL_PROMPTS as set but load via ordered list when selected\n- Update tests to compare ordered lists\n\nAcceptance:\n- Agent prompt order is explicit and deterministic\n- Tests assert ordered requirements\n- No prompt order regressions","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T23:11:10.407905-08:00","updated_at":"2026-01-04T01:12:03.524541-08:00","closed_at":"2026-01-04T01:12:03.524541-08:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker2-u1b","depends_on_id":"worktree_worker2-lb3","type":"parent-child","created_at":"2026-01-03T23:12:02.268869-08:00","created_by":"daemon"},{"issue_id":"worktree_worker2-u1b","depends_on_id":"worktree_worker2-pgn","type":"blocks","created_at":"2026-01-03T23:12:30.313401-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-ulv","content_hash":"d795a05274feca9c5bde385a41d4702075c9f6f761df03aadb5c115ee27a5427","title":"RewardsAgent rewards output inconsistent (2/4 E2E fail; rewards_box/rewards_processed missing)","description":"E2E rewards test in /tmp/worktree_worker2/claude_implement-rewards-agent-ChnfS/rewards_e2e/20251228_020823/ shows 2/4 failures: combat end rewards_processed false despite combat_summary.xp_awarded, narrative kill returns empty narrative and rewards_processed false. Recent changes: rewards_box added to JSON schema and prompts; rewards_box optional; RewardsAgent prompt stack trimmed (no DND SRD/mechanics). Need root-cause analysis: state cleanup timing, schema enforcement, prompt clarity, and provider JSON-mode behavior. Goal: ensure rewards are user-visible and rewards_processed set even with format variations, without retries/validation.","notes":"Updated validation shows original 2/4 failure may be fixed, but new/adjacent issues remain: rewards are not user-visible (rewards_check.has_rewards_box=false in all scenarios, narrative indicators mostly 0), XP mismatches vs claims (e.g., scenario1 xp_awarded=150 not 50), and evidence capture is incomplete (server_logs.txt has 0 lines, rewards_e2e metadata missing origin/main + diff + server PID/port/env). Latest bundles checked: /tmp/worktree_worker2/claude_implement-rewards-agent-ChnfS/rewards_e2e/20251228_035005 and /20251228_032615. evidence.json has data under scenarios.*.steps; claims should reference those paths.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-28T02:22:06.70204-05:00","updated_at":"2025-12-28T17:52:47.637663-05:00","closed_at":"2025-12-28T17:52:47.637663-05:00","source_repo":"."}
{"id":"worktree_worker2-uyf","content_hash":"feb58f0ab7e609d50c49382ecc7674e5a32ca0c9eead59958b35b4d90fed4cec","title":"[P3-Medium] Frozen Plans Schema - Document Structure","description":"Gap #3: Document frozen_plans structure even if LLM-enforced.\n\nCurrently only has comment \"frozen_plans is LLM-enforced via prompts\" with no formal schema.\nAdd warn-mode validation for structure: failed_at, freeze_until, original_dc, freeze_hours, description.","acceptance_criteria":"- [ ] Document frozen_plans JSON structure in instruction file\n- [ ] Add warn-mode validation (log, don't reject)","status":"open","priority":3,"issue_type":"chore","created_at":"2026-01-11T00:04:06.508613-08:00","updated_at":"2026-01-11T00:04:06.508613-08:00","source_repo":".","labels":["documentation","priority-3","schema"],"dependencies":[{"issue_id":"worktree_worker2-uyf","depends_on_id":"worktree_worker2-1gp","type":"parent-child","created_at":"2026-01-11T00:04:21.647114-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-xgu","content_hash":"2af33ee79fe12090660754cb75efffc669208fbd6a2c0a1043a4eab9103247c4","title":"Phase 3: Single entry point build_for_agent","description":"Centralize agent→builder contract.\n\nTasks:\n- Add BaseAgent.prompt_order() and BaseAgent.builder_flags() (or dataclass)\n- Implement PromptBuilder.build_for_agent(agent)\n- Remove direct per-mode builder calls\n- Add golden prompt-order tests per agent\n\nAcceptance:\n- One entry point for all prompt building\n- No direct per-mode builder usage\n- Golden tests cover order/content for each agent","status":"closed","priority":2,"issue_type":"task","assignee":"think","created_at":"2026-01-03T23:11:19.237935-08:00","updated_at":"2026-01-04T01:16:57.054314-08:00","closed_at":"2026-01-04T01:16:57.054314-08:00","source_repo":".","dependencies":[{"issue_id":"worktree_worker2-xgu","depends_on_id":"worktree_worker2-lb3","type":"parent-child","created_at":"2026-01-03T23:12:07.418732-08:00","created_by":"daemon"},{"issue_id":"worktree_worker2-xgu","depends_on_id":"worktree_worker2-u1b","type":"blocks","created_at":"2026-01-03T23:12:35.47154-08:00","created_by":"daemon"}]}
{"id":"worktree_worker2-zjr","content_hash":"f83884974dd4586324ce064534ce8ebd1e8508df15de1b0b84f7474b19f9d021","title":"Centralize Planning Block Schema and Remove Duplication","description":"Centralize the planning_block schema and validation code to remove duplication across prompt files. Keep triggers separate (Think Mode = explicit THINK: prefix, Unprompted = LLM discretion).\n\n## Goal (Option A - Centralize Only)\n\n1. Single `PLANNING_BLOCK_SCHEMA` constant\n2. Single `planning_protocol.md` for structure rules\n3. Clean up unused function arguments\n4. **Keep triggers unchanged** - no merging of Think Mode and unprompted planning\n\n## NOT Doing (Removed from Scope)\n\n- ~~LLM-initiated enhanced planning~~ (keep unprompted at LLM discretion)\n- ~~Merge triggers~~ (Think Mode stays explicit)\n- ~~Intent field for time handling~~ (mode-based detection unchanged)\n\n## Files to Change\n\n- `narrative_response_schema.py` - Add PLANNING_BLOCK_SCHEMA\n- `prompts/planning_protocol.md` - New file, single source of structure rules\n- `think_mode_instruction.md` - Reference protocol, remove duplicate rules\n- `game_state_instruction.md` - Reference protocol, remove duplicate rules\n- `llm_service.py` - Clean up unused args","design":"## Architecture\n\n### Phase 1: Centralize Schema\n- Create `PLANNING_BLOCK_SCHEMA` in `narrative_response_schema.py`\n- All validation references this single definition\n\n### Phase 2: Unify Prompts\n- Create `planning_protocol.md` as the single source of planning rules\n- Update `think_mode_instruction.md` to reference it\n- Update `game_state_instruction.md` to reference it\n\n### Phase 3: Remove Unused Code\n- Clean up `_validate_and_enforce_planning_block` signature\n- Remove truly dead code paths\n- Consolidate detection logic\n\n### Phase 4: Always-On Planning\n- Remove requirement for THINK: prefix\n- LLM generates planning_block when appropriate\n- Frontend handles planning_block in any response","acceptance_criteria":"- [ ] Single `PLANNING_BLOCK_SCHEMA` definition\n- [ ] Single `planning_protocol.md` referenced by prompts\n- [ ] No duplicated planning rules across files\n- [ ] Unused function arguments removed\n- [ ] Tests pass\n- [ ] Triggers unchanged (Think Mode = explicit, Unprompted = LLM discretion)","notes":"## Progress (2026-01-04)\n\n### Phase 4 Groundwork Complete\n- `get_agent_for_input()` now accepts `mode` parameter\n- API clients can use `mode: \"think\"` without THINK: prefix\n- Frontend `think:return_story` handler fixed (sanitized ID comparison)\n\n### Bug Found \u0026 Fixed\n- `llm_validator.py` was missing `import re` (would cause NameError at runtime)\n\n### Roadmap Updated with Review Feedback\n- Added `intent` field (\"think\" | \"story\") to distinguish time handling\n- Renamed Phase 4: \"Unified Planning Features\" (not \"Always-On\")\n- Added dynamic schema injection via PromptBuilder\n- Added trigger guidelines (when/when-not)\n- Required think:return_story for spontaneous enhanced blocks\n- **Critical fix**: Time handling based on intent, NOT presence of planning_block\n\n### Commits\n- `3bbe919fb` - Fix Return to Story handler and API mode support\n- `8ac6484ef` - Add missing re import to llm_validator.py  \n- `cbc2f978a` - Incorporate review feedback into roadmap","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-03T18:49:55.810987-08:00","updated_at":"2026-01-03T19:36:08.455318-08:00","closed_at":"2026-01-03T19:36:08.455318-08:00","source_repo":".","labels":["centralization","refactor","think-mode"]}
{"id":"worktree_worker2-zk3","content_hash":"40341ba2b4187ff65b67e815ddefb9834d424591eb8b264dce790b6cfdde8a3d","title":"[P4-Low] Time Pressure System Schema - Document Structure","description":"Gap #11: Document time_sensitive_events, time_pressure_warnings, npc_agendas, world_resources structures.","acceptance_criteria":"- [ ] Document all time pressure system JSON structures","status":"open","priority":4,"issue_type":"chore","created_at":"2026-01-11T00:04:08.797589-08:00","updated_at":"2026-01-11T00:04:08.797589-08:00","source_repo":".","labels":["documentation","priority-4","schema"],"dependencies":[{"issue_id":"worktree_worker2-zk3","depends_on_id":"worktree_worker2-1gp","type":"parent-child","created_at":"2026-01-11T00:04:23.480612-08:00","created_by":"daemon"}]}
