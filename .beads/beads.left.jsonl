{"id":"worktree_inspect-0yl","content_hash":"47fb9ea1618f33e80d2e762fbdbbc660c691aac5e0ad79c840452c5d719a9edb","title":"Fix: Add error logging to capture_server_runtime instead of silent failures","description":"**File:** `testing_mcp/lib/evidence_utils.py:164-167`\n\n**Issue:** `capture_server_runtime` swallows all exceptions with `except Exception: pass`, returning None values with no indication of why collection failed.\n\n**Impact:** When evidence collection fails (lsof/ps unavailable, permissions, etc.), there's no error message, making debugging difficult.\n\n**Fix:** Add error field to returned dict when exceptions occur, similar to how `capture_git_provenance` stores `git_error`. For example:\n```python\nexcept Exception as e:\n    info[\"error\"] = str(e)\n    info[\"error_type\"] = type(e).__name__\n```\nThis keeps tests robust while still making provenance debugging possible.","status":"open","priority":2,"issue_type":"bug","created_at":"2026-01-07T19:37:12.064189-08:00","updated_at":"2026-01-07T19:37:12.064189-08:00","source_repo":"."}
{"id":"worktree_inspect-3e4","content_hash":"749920431be5a129d17c709a1ab6b0c493614b568b7116699d2b2227d4ac14b9","title":"Fix: Use local_server.log_path instead of hardcoded path in evidence bundle","description":"**File:** `testing_mcp/test_social_hp_all_tiers_real_api.py:1167`\n\n**Issue:** Uses hardcoded `/tmp/worldarchitect.ai/.../app.log` instead of `local_server_info.log_path`\n\n**Impact:** Evidence bundles will be missing server logs, making debugging test failures difficult or impossible.\n\n**Evidence:** Other tests (e.g., `test_story_pagination_real_e2e.py:900`) correctly use `local_server.log_path`\n\n**Fix:** Change line 1167 from:\n```python\nlog_path = Path(\"/tmp/worldarchitect.ai\") / provenance.get(\"git_branch\", \"unknown\") / \"app.log\"\n```\nto:\n```python\nlog_path = local_server_info.log_path if local_server_info else None\n```","status":"open","priority":2,"issue_type":"bug","created_at":"2026-01-07T19:37:10.859805-08:00","updated_at":"2026-01-07T19:37:10.859805-08:00","source_repo":"."}
{"id":"worktree_inspect-3jx","content_hash":"15837cfe85bc8de4f785765934263cbb92d1ea465d7e6edd335b1b587b78364a","title":"Plan: make resistance indicators required + progress counters enforced in Social HP test","description":"Update Social HP God-tier enforcement test so missing resistance indicators is a hard failure (not warning), and require progress counters to be present/validated. Evidence currently shows warnings only for missing indicators and possible false-positive matches on generic 'no'. Likely target: `testing_mcp/test_social_hp_god_tier_real_api.py` where resistance indicators are collected and warnings emitted; also validate progress counters in narrative/state updates. Do not implement yet; this is for planning next steps.","acceptance_criteria":"- Missing resistance indicators in narrative cause scenario failure (error) rather than warning\n- Progress counters (current/required) are required and validated in results output\n- Evidence output reflects these requirements (warnings removed or converted to errors)\n- Any false-positive 'no' matches are addressed or at least documented in the plan","notes":"User provided latest evidence bundle: /tmp/worldarchitect.ai/fix/social-hp-god-tier-enforcement/social_hp_final_evidence/ with metadata.git_head=4539c6b7fb806491e8a18ba854eb25c4c1d7f46b. They report 4/4 passing; submission scenario shows narrative 'Social HP: 14/45 | Progress: 5/5 successes needed | Status: YIELDING', state npc_empress_sariel_001.social_hp_max=45, and custom_campaign_state.social_challenges matches 45 max and request_type=submission. Incorporate this into planning (progress counter enforcement + resistance indicators required).","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-05T14:31:17.695172-08:00","updated_at":"2026-01-05T17:38:51.393846-08:00","source_repo":"."}
{"id":"worktree_inspect-51k","content_hash":"60aba3d66d2776ba6be078282ab956552d39365bda692b71306ac982d2adcbb5","title":"Native LLM Social HP Compliance - Remove Server-Side Enforcement","description":"Update prompts so LLM produces compliant Social HP output natively without server-side corrections. Currently server injects resistance indicators, syncs progress, and applies request-type scaling. LLM should handle all of this.","design":"## Design Summary\n\n### Problem\nLLM ignores several Social HP requirements:\n- Request-type scaling (submission=3x) - NOT in prompts\n- Progress calculation - NOT clearly defined\n- Resistance indicators - mentioned but ignored 75% of time\n\n### Solution: Full LLM Control\n\n**1. Request Severity \u0026 HP Scaling**\n- DC 10-15 = information (1x HP)\n- DC 16-20 = favor (2x HP)\n- DC 21+ = submission (3x HP)\n- Guidelines: cost to NPC determines severity\n\n**2. Progress Calculation**\n- Formula: `successes = social_hp_max - social_hp_current`\n- Damage: success=2, close fail=1, hard fail=0\n- Status: 0-1=RESISTING, 2-3=WAVERING, 4+=YIELDING\n\n**3. Resistance Indicators**\n- Concrete examples in prompt\n- New JSON field: `resistance_shown`\n\n**4. Updated JSON Schema**\n- Add: `request_severity`, `resistance_shown`\n- LLM outputs already-scaled `social_hp_max`\n\n### Files to Modify\n- `mvp_site/agent_prompts.py` - Add new sections\n- `mvp_site/narrative_response_schema.py` - Add fields\n- `mvp_site/prompts/game_state_instruction.md` - Update example\n- `mvp_site/llm_service.py` - Remove server enforcement","acceptance_criteria":"- [ ] LLM outputs `request_severity` field correctly\n- [ ] LLM applies HP scaling natively (no server correction)\n- [ ] LLM calculates progress correctly (no server sync)\n- [ ] LLM includes resistance indicators (no server injection)\n- [ ] All 4 test scenarios pass without server-side enforcement logs\n- [ ] Test: grep for SOCIAL_HP_INJECT/SCALE/SYNC shows 0 occurrences","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-06T14:27:10.390142-08:00","updated_at":"2026-01-07T08:08:58.143779-08:00","closed_at":"2026-01-07T08:08:58.143779-08:00","source_repo":"."}
{"id":"worktree_inspect-6s6","content_hash":"fd8f4ce8c8631d2707bd5d66e095cbbbb647f30c1de40b8685a819a74979736e","title":"Fix: Documentation contradiction - Progress line in Social HP box","description":"**File:** `mvp_site/prompts/narrative_system_instruction.md:14`\n\n**Issue:** Direct contradiction between two instructions:\n- Line 14 says: \"show [SOCIAL SKILL CHALLENGE: NPC] box in narrative with **Progress/HP/Status**\"\n- But `SOCIAL_HP_ENFORCEMENT_REMINDER` (agent_prompts.py:267) says: \"**DO NOT include a 'Progress:' line in this box. Use the Status line instead.**\"\n\n**Impact:** Conflicting instructions can confuse the LLM, causing it to include Progress lines when it shouldn't, breaking the intended format and potentially causing test failures.\n\n**Fix:** Update line 14 to remove \"Progress\" from the list, changing \"Progress/HP/Status\" to \"HP/Status\" to match the enforcement reminder.","status":"open","priority":2,"issue_type":"bug","created_at":"2026-01-07T19:37:10.777053-08:00","updated_at":"2026-01-07T19:37:10.777053-08:00","source_repo":"."}
{"id":"worktree_inspect-ocm","content_hash":"0e2e4e2255f511ab3c7cb278cc9d7eeb9a2778f43966885d08cc49657c50bd17","title":"King-tier Social HP complete lifecycle test (HP → 0 → success)","description":"Create and run test campaign demonstrating complete Social HP depletion: king-tier NPC (24 HP) worn down through multiple persuasion attempts until HP reaches 0 and NPC capitulates. Validates status transitions: RESISTING → WAVERING → YIELDING → PERSUADED.","design":"Test Structure:\n- King-tier NPC: Lord Commander (24 HP, military authority)\n- Scenario: Convince him to grant emergency passage through military checkpoint\n- Expected damage per attempt: ~3-5 HP (should complete in 5-8 turns)\n- Validate JSON backend tracks HP correctly\n- Validate status transitions at thresholds\n- Validate final success narrative when HP = 0\n\nImplementation:\n1. Create test campaign JSON with king-tier NPC\n2. Execute multiple persuasion attempts\n3. Capture all request/response pairs\n4. Verify HP decreases correctly\n5. Verify status changes at thresholds\n6. Verify success narrative when HP reaches 0","acceptance_criteria":"- [ ] Test campaign created with king-tier NPC (24 HP)\n- [ ] Multiple persuasion attempts executed (5-8 turns)\n- [ ] HP decreases with each attempt\n- [ ] Status transitions validated: RESISTING → WAVERING → YIELDING → PERSUADED\n- [ ] Final HP = 0 confirmed\n- [ ] Success narrative shows NPC capitulation\n- [ ] All evidence captured in test output","status":"in_progress","priority":1,"issue_type":"task","assignee":"genesis-coder","created_at":"2026-01-07T19:48:48.553881-08:00","updated_at":"2026-01-07T19:48:55.807873-08:00","source_repo":"."}
{"id":"worktree_inspect-p09","content_hash":"d2e1039d6cfc0efda18d4d210d5ecf8821f0b31265c71861cce55e0b975dee84","title":"Fix: Pass local_server.env to capture_provenance instead of empty dict","description":"**File:** `testing_mcp/test_social_hp_all_tiers_real_api.py:1216`\n\n**Issue:** Passes `{}` instead of `local_server.env` (which exists and is populated at `server_utils.py:185`)\n\n**Impact:** Provenance won't capture actual server environment variables (TESTING, WORLDAI_DEV_MODE, etc.), making it harder to reproduce issues.\n\n**Fix:** Change line 1216 from:\n```python\nsuccess = run_all_tests(\n    base_url,\n    models,\n    args.savetmp,\n    {},  # ← Empty dict\n    local_server,\n    args.work_name,\n)\n```\nto:\n```python\nsuccess = run_all_tests(\n    base_url,\n    models,\n    args.savetmp,\n    local_server.env if local_server else {},  # ← Use actual server env\n    local_server,\n    args.work_name,\n)\n```","status":"open","priority":2,"issue_type":"bug","created_at":"2026-01-07T19:37:11.473596-08:00","updated_at":"2026-01-07T19:37:11.473596-08:00","source_repo":"."}
