{"id":"W-0yd","content_hash":"73979165b09854b62abe7a1b36c05a9c65b59c9d5bf1dd54cb33fa857bb83910","title":"Add multi-era test coverage for world_time year validation","description":"Current test only covers Forgotten Realms (1492 DR). Add tests for:\n- Modern day campaigns (~2024)\n- Custom fantasy eras\n- Sci-fi settings (far future years)\n\nThis ensures the world_time fix works across all calendar systems.\n\nContext: PR #3694 fixed year corruption for FR campaigns.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-16T18:51:03.177274-08:00","updated_at":"2026-01-16T18:51:03.177274-08:00","source_repo":".","labels":["follow-up","testing","world-time"]}
{"id":"W-4fp","content_hash":"efc30179596baed80bf06c3840b0b0d2ebb3b9b68e30d90fb288cc8ce1c436cf","title":"Rewards enforcement can prematurely mark rewards_processed and skip rewards follow-up","description":"Server-side _enforce_rewards_processed_flag now sets rewards_processed when combat_summary/encounter_summary exists, even if XP/loot state changes did not apply. This can prevent _process_rewards_followup from running when rewards are only visible in narrative (rewards_visible=true) but state updates are missing, and the next turn cleanup will archive/clear combat_summary, making rewards unrecoverable.","acceptance_criteria":"- When rewards are visible but state updates are missing, rewards follow-up still runs or rewards_processed is not set prematurely.\n- rewards_processed is only set when evidence of applied rewards exists (e.g., XP delta, rewards_box, or validated state changes), or explicit design decision documented.\n- Add/adjust tests to cover the regression case (rewards_visible true + no state updates).","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-04T18:36:15.540548-08:00","updated_at":"2026-01-04T18:41:19.385487-08:00","closed_at":"2026-01-04T18:41:19.385487-08:00","source_repo":"."}
{"id":"W-88p","content_hash":"c90a6cc8e9e983b216b02da357c50c1f88045fa01111ca48e5f5c6b8724c6340","title":"Document supported month formats in world_time (numeric vs named)","description":"The world_time object accepts both numeric months (1-12) and named months (\"Hammer\", \"Mirtul\", etc). This is intentional but undocumented.\n\nConsider:\n- Documenting both formats in game_state_instruction.md\n- Adding schema validation that accepts either format\n- Ensuring session_header displays named months when available\n\nContext: Observed in PR #3694 testing - LLM uses numeric months but examples show named months.","status":"open","priority":3,"issue_type":"chore","created_at":"2026-01-16T18:51:12.506203-08:00","updated_at":"2026-01-16T18:51:12.506203-08:00","source_repo":".","labels":["documentation","follow-up","world-time"]}
{"id":"W-8ne","content_hash":"73f9745a4bc6243720bf81e5ea65c7a94eed32be643cde657f6dc49ff7ba2abd","title":"pending_system_corrections dropped for non-character modes after first persist","description":"In process_action_unified, pending_system_corrections is cleared and the first Firestore persist happens before new system_corrections are added. The later persist that would save pending_system_corrections only happens in MODE_CHARACTER, so COMBAT/other modes lose corrections and self-correction wonâ€™t carry to the next turn.","acceptance_criteria":"- pending_system_corrections is persisted for all modes when new system_corrections are detected\n- No duplicate Firestore writes per turn\n- Add or update a test to cover non-character (e.g., COMBAT) correction persistence","status":"open","priority":1,"issue_type":"bug","created_at":"2026-01-04T23:14:04.455997-08:00","updated_at":"2026-01-04T23:14:04.455997-08:00","source_repo":"."}
{"id":"W-e9b","content_hash":"d39ed6dc08d63b3bd281d3c2e6091dc0ac26b9ed0c96f3fe9b6395129f9e2065","title":"Add backend validation to reject timestamp_iso when world_time present","description":"When LLM returns both timestamp_iso and world_time, the backend should prefer world_time and log a warning. Currently timestamp_iso is accepted but may cause year corruption if LLM uses real-world year.\n\nContext: PR #3694 fixed the prompt to use world_time object instead of timestamp_iso, but backend still accepts both.","status":"open","priority":3,"issue_type":"chore","created_at":"2026-01-16T18:50:56.647577-08:00","updated_at":"2026-01-16T18:50:56.647577-08:00","source_repo":".","labels":["follow-up","validation","world-time"]}
{"id":"W-q1r","content_hash":"5c21a5bb874fd9c708163b51a7b48aaec6324852698b73d2eafc2271069656f4","title":"Add agent selection circuit breaker to prevent infinite loops","description":"## Problem\n\nIn campaign kuXKa6vrYY6P99MfhWBn, RewardsAgent was selected 52+ consecutive times because:\n1. combat_state.rewards_processed was stuck at False\n2. RewardsAgent.matches_game_state() kept returning True\n3. No mechanism existed to detect or break the infinite selection loop\n\n## Root Cause\n\nPR #2843 removed server-side enforcement of rewards_processed, assuming LLM reliability.\nWhen LLM failed to set the flag, there was no safety net.\n\n## Fixes Already Applied\n\n1. **NarrativeAgent class** (PR #3080): Ensures RewardsAgent triggers living world\n2. **Server-side enforcement restored**: world_logic.py now sets rewards_processed=True\n\n## Proposed Additional Safeguards\n\n### 1. Agent Selection Circuit Breaker (Priority: HIGH)\nTrack consecutive same-agent selections in get_agent_for_input():\n- If same agent selected \u003e 3 consecutive times, log warning\n- If same agent selected \u003e 5 consecutive times, force state transition\n- RewardsAgent specifically: auto-set rewards_processed=True after 3 selections\n\n### 2. Agent Selection Metrics (Priority: MEDIUM)\nAdd logging/metrics for:\n- Consecutive same-agent selection count\n- Agent selection distribution per session\n- Alert when same agent selected \u003e N times\n\n### 3. State Transition Watchdog (Priority: LOW)\nMonitor pending state transitions:\n- If combat_phase=\"ended\" + rewards_processed=False for \u003e 3 turns, auto-resolve\n- If encounter_completed=True for \u003e 3 turns, auto-resolve\n\n## Implementation Notes\n\n- Circuit breaker logic goes in agents.py::get_agent_for_input()\n- Store selection history in session state or game_state\n- Consider turn-based tracking (player_turn) rather than request-based","acceptance_criteria":"- [ ] Consecutive same-agent selections are tracked\n- [ ] Warning logged after 3+ consecutive same-agent selections\n- [ ] RewardsAgent auto-transitions after 5+ consecutive selections\n- [ ] E2E test verifies circuit breaker prevents infinite loops\n- [ ] Existing agent selection tests still pass","status":"open","priority":1,"issue_type":"feature","created_at":"2026-01-04T13:50:58.452055-08:00","updated_at":"2026-01-04T13:50:58.452055-08:00","source_repo":".","labels":["agent-selection","reliability","safety-net"]}
