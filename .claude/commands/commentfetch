#!/bin/bash
set -Eeuo pipefail
# /commentfetch - Intelligent comment fetching with natural language processing

echo "üöÄ EXECUTING: /commentfetch intelligent comment processing"

# Parse natural language instructions intelligently
ARGS="$*"
echo "üìù Processing instruction: $ARGS"

# Extract PR number from current branch if not specified
# Fixed: Only match explicit PR patterns (PR123, pr#123, #123) to avoid matching standalone numbers
if ! echo "$ARGS" | grep -qE '([Pp][Rr][#[:space:]]*|#)[0-9]+'; then
    PR_NUMBER=$(gh pr list --head $(git branch --show-current) --json number --jq '.[0].number' 2>/dev/null)
    if [ -z "$PR_NUMBER" ]; then
        echo "‚ùå ERROR: Could not determine PR number. Please specify PR number or run from PR branch."
        exit 1
    fi
    echo "üîç Auto-detected PR number: $PR_NUMBER"
else
    # Extract PR number from arguments using the improved pattern
    # Fixed: Use two-step extraction to get only the number portion from valid PR patterns
    PR_NUMBER=$(
      echo "$ARGS" \
      | grep -oE '([Pp][Rr][#[:space:]]*|#)[0-9]+' \
      | grep -oE '[0-9]+' \
      | head -1
    )
fi

# Determine output format and limits
PRINT_INLINE=false
LIMIT=""

if echo "$ARGS" | grep -qi "print\|show\|display"; then
    PRINT_INLINE=true
    echo "üì∫ Will display comments inline"
fi

if echo "$ARGS" | grep -o '[0-9]\+' | head -2 | tail -1 | grep -q .; then
    LIMIT=$(echo "$ARGS" | grep -o '[0-9]\+' | head -2 | tail -1)
    echo "üî¢ Comment limit: $LIMIT"
fi

echo "üöÄ Fetching comments for PR #$PR_NUMBER..."
python3 "$(dirname "$0")/_copilot_modules/commentfetch.py" "$PR_NUMBER"

# If user requested inline display, show the results
if [ "$PRINT_INLINE" = "true" ]; then
    BRANCH_NAME=$(git branch --show-current)
    COMMENTS_FILE="/tmp/$BRANCH_NAME/comments.json"

    if [ -f "$COMMENTS_FILE" ]; then
        echo ""
        echo "üìã UNRESPONDED COMMENTS (Last fetched: $(date)):"
        echo "=================================================="

        if [ -n "$LIMIT" ]; then
            # Show limited number of recent comments
            echo "üîç Showing last $LIMIT unresponded comments:"
            jq -r --argjson limit "$LIMIT" '.comments | sort_by(.created_at) | reverse | .[:$limit] | .[] | "üë§ \(.author) (\(.type)) - \(.created_at)\nüìù \(.body[0:200])...\nüìç \(.file // \"General\"):\(.line // \"\")\n---"' "$COMMENTS_FILE" 2>/dev/null || echo "‚ùå Error parsing comments JSON"
        else
            # Show all unresponded comments
            echo "üìä Total unresponded: $(jq '.metadata.unresponded_count' "$COMMENTS_FILE" 2>/dev/null || echo "unknown")"
            jq -r '.comments | sort_by(.created_at) | reverse | .[] | "üë§ \(.author) (\(.type)) - \(.created_at)\nüìù \(.body[0:200])...\nüìç \(.file // \"General\"):\(.line // \"\")\n---"' "$COMMENTS_FILE" 2>/dev/null || echo "‚ùå Error parsing comments JSON"
        fi
    else
        echo "‚ùå Comments file not found: $COMMENTS_FILE"
    fi
fi
