#!/bin/bash
set -Eeuo pipefail
# /commentreply command - systematic PR comment processing with proper threading
# Implements the functionality documented in commentreply.md

echo "üöÄ EXECUTING: /commentreply systematic comment processing"
echo "üìã PURPOSE: Process ALL PR comments with GitHub API threading"

# Preconditions
command -v python3 >/dev/null || { echo "‚ùå python3 not found on PATH"; exit 127; }
command -v gh >/dev/null || { echo "‚ùå gh CLI not found on PATH"; exit 127; }

# Intelligent argument processing with autodetection
if [ $# -eq 0 ]; then
    echo "üìù No arguments provided - auto-detecting from current PR context..."

    # Auto-detect repository info
    OWNER=$(gh repo view --json owner --jq .owner.login 2>/dev/null || echo "")
    REPO=$(gh repo view --json name --jq .name 2>/dev/null || echo "")
    PR_NUMBER=$(gh pr view --json number --jq .number 2>/dev/null || echo "")

    if [ -z "$OWNER" ] || [ -z "$REPO" ] || [ -z "$PR_NUMBER" ]; then
        echo "‚ùå ERROR: Could not auto-detect repository context. Please ensure you're in a PR branch or provide arguments:"
        echo "Usage: commentreply [owner] [repo] [pr_number]"
        echo "Example: commentreply jleechanorg worldarchitect.ai 1510"
        exit 1
    fi

    echo "üîç Auto-detected: $OWNER/$REPO PR #$PR_NUMBER"
    python3 "$(dirname "$0")/commentreply.py" "$OWNER" "$REPO" "$PR_NUMBER"
elif [ $# -eq 3 ]; then
    echo "üìã Using provided arguments: $1/$2 PR #$3"
    python3 "$(dirname "$0")/commentreply.py" "$@"
else
    echo "‚ùå ERROR: Invalid number of arguments"
    echo "Usage: commentreply [owner] [repo] [pr_number]"
    echo "   OR: commentreply (auto-detects from current PR context)"
    echo "Example: commentreply jleechanorg worldarchitect.ai 1510"
    exit 1
fi
