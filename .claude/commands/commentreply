#!/bin/bash
set -Eeuo pipefail
# /commentreply command - systematic PR comment processing with proper threading
# Implements the functionality documented in commentreply.md

echo "üöÄ EXECUTING: /commentreply systematic comment processing"
echo "üìã PURPOSE: Process ALL PR comments with GitHub API threading"

# Preconditions
command -v python3 >/dev/null || { echo "‚ùå python3 not found on PATH"; exit 127; }
command -v gh >/dev/null || { echo "‚ùå gh CLI not found on PATH"; exit 127; }

# Intelligent auto-detection (no manual arguments needed)
echo "üîç Auto-detecting repository context from current environment..."

# Auto-detect repository info
OWNER=$(gh repo view --json owner --jq .owner.login 2>/dev/null || echo "")
REPO=$(gh repo view --json name --jq .name 2>/dev/null || echo "")
PR_NUMBER=$(gh pr view --json number --jq .number 2>/dev/null || echo "")

if [ -z "$OWNER" ] || [ -z "$REPO" ] || [ -z "$PR_NUMBER" ]; then
    echo "‚ùå ERROR: Could not auto-detect repository context"
    echo "üí° Ensure you're in a Git repo with GitHub remote and current PR branch"
    echo "üí° Check: 'gh repo view' and 'gh pr view' work correctly"
    exit 1
fi

echo "‚úÖ Detected: $OWNER/$REPO PR #$PR_NUMBER"
python3 "$(dirname "$0")/commentreply.py" "$OWNER" "$REPO" "$PR_NUMBER"
